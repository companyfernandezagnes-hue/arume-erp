<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>ARUME V151 ¬∑ SUPABASE PRO</title>
    <meta name="description" content="Sistema Integral Hosteler√≠a - Cloud Edition">
    <meta name="theme-color" content="#0f172a">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* === BASE === */
        :root { --primary: #4f46e5; --dark: #0f172a; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: #f1f5f9; 
            padding-bottom: 120px; 
            -webkit-tap-highlight-color: transparent; 
            user-select: none; 
            overscroll-behavior-y: none; 
        }

        /* === EST√âTICA DIAMOND (CRISTAL) === */
        .glass-card { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255,255,255,0.5); 
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.08); 
            border-radius: 24px; 
            padding: 24px; 
            margin-bottom: 20px; 
            position: relative;
            overflow: hidden;
        }

        /* === BOTONES PRO === */
        .btn-premium { 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); 
            color: white; padding: 16px; border-radius: 16px; 
            font-weight: 700; font-size: 0.9rem;
            box-shadow: 0 8px 20px -5px rgba(15, 23, 42, 0.3); 
            width: 100%; display: flex; justify-content: center; align-items: center; gap: 8px; cursor: pointer;
            transition: transform 0.1s, box-shadow 0.2s; border: none; letter-spacing: 0.5px;
        }
        .btn-premium:active { transform: scale(0.98); box-shadow: 0 4px 10px rgba(15, 23, 42, 0.2); }

        .btn-action { background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%); box-shadow: 0 8px 20px -5px rgba(79, 70, 229, 0.4); } 
        .btn-whatsapp { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; box-shadow: 0 8px 20px -5px rgba(34, 197, 94, 0.4); }
        
        .btn-ghost { background: #f8fafc; color: #64748b; font-weight: 700; padding: 12px; border-radius: 12px; width: 100%; cursor: pointer; border: 1px solid #e2e8f0; transition: 0.2s; }
        .btn-ghost:active { background: #e2e8f0; }
        
        .btn-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 12px; font-size: 1.1rem; cursor: pointer; border: none; transition: 0.2s; }
        .btn-icon:active { transform: scale(0.9); }
        .btn-edit { background: #eff6ff; color: #3b82f6; } 
        .btn-delete { background: #fef2f2; color: #ef4444; } 
        .btn-merma { background: #fff7ed; color: #f97316; } 
        .btn-log { background: #f0fdf4; color: #16a34a; }

        /* === INPUTS === */
        .input-premium { 
            width: 100%; padding: 14px; background: #f8fafc; 
            border: 2px solid #e2e8f0; border-radius: 14px; 
            outline: none; font-size: 14px; font-weight: 600; color: #334155;
            transition: 0.2s;
        }
        .input-premium:focus { border-color: #4f46e5; background: white; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); }
        label { display: block; font-size: 0.7rem; font-weight: 800; color: #94a3b8; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }

        /* === NAVEGACI√ìN === */
        nav { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: rgba(255,255,255,0.9); backdrop-filter: blur(20px);
            padding: 12px 0; display: flex; justify-content: space-around; 
            box-shadow: 0 -10px 40px rgba(0,0,0,0.05); 
            z-index: 50; border-top: 1px solid rgba(255,255,255,0.5);
            padding-bottom: max(12px, env(safe-area-inset-bottom));
        }
        nav button { flex: 1; background: none; border: none; color: #cbd5e1; display: flex; flex-direction: column; align-items: center; font-size: 0.65rem; font-weight: 700; transition: 0.3s; cursor: pointer; -webkit-tap-highlight-color: transparent; }
        nav button.active { color: #0f172a; transform: translateY(-4px); }
        nav button.active svg { fill: #0f172a; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2)); }
        nav button svg { width: 26px; height: 26px; fill: #cbd5e1; margin-bottom: 6px; transition: 0.3s; }
        nav button.locked { opacity: 0.3; pointer-events: none; filter: grayscale(1); }

        /* === UI EXTRA === */
        .modal { background: white; width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto; border-radius: 32px; padding: 24px; box-shadow: 0 40px 60px -20px rgba(0,0,0,0.3); animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.2s; }
        .overlay:not(.hidden) { opacity: 1; pointer-events: auto; }
        .hidden { display: none !important; }

        /* === IMPRESI√ìN === */
        @media print {
            body { padding: 0; background: white; }
            nav, header, .btn-premium, .btn-ghost, .btn-icon, .input-premium, button, input, select, .overlay { display: none !important; }
            .overlay:not(.hidden) { position: static; background: none; display: block !important; opacity: 1; }
            .modal { box-shadow: none; border: none; width: 100%; max-width: 100%; padding: 0; overflow: visible; height: auto; }
            .overlay:not(.hidden) ~ main { display: none; }
            body, h1, h2, h3, div, span, p { color: black !important; -webkit-print-color-adjust: exact; }
            .glass-card, .modal { border: 1px solid #000; box-shadow: none; border-radius: 0; }
            p, li { page-break-inside: avoid; }
        }
    </style>
</head>
<body>

    <div id="loading-overlay" class="hidden fixed inset-0 bg-white/90 z-[300] flex justify-center items-center flex-col backdrop-blur-sm">
        <div class="w-12 h-12 border-4 border-slate-200 border-t-indigo-600 rounded-full animate-spin mb-4"></div>
        <div class="font-black text-slate-400 tracking-[0.3em] text-xs animate-pulse">SINCRONIZANDO NUBE...</div>
    </div>

    <div id="toast-container" class="fixed top-6 left-1/2 -translate-x-1/2 z-[400] w-max pointer-events-none space-y-2"></div>
    <input type="file" id="backup-input" class="hidden" onchange="restoreBackup(this)">

    <header class="sticky top-0 z-40 px-6 py-4 flex justify-between items-center bg-white/80 backdrop-blur-xl border-b border-white/50 shadow-sm">
        <div>
            <h1 class="text-2xl font-black text-slate-900 tracking-tighter">ARUME <span class="text-emerald-500">PRO</span></h1>
            <p class="text-[9px] text-slate-400 font-bold tracking-widest uppercase">Supabase Cloud System</p>
        </div>
        <div class="bg-slate-100 px-3 py-1.5 rounded-full text-xs font-bold text-slate-600 flex items-center gap-2 cursor-pointer hover:bg-slate-200 transition border border-slate-200" onclick="logout()">
            <div id="sync-dot" class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div> 
            <span id="user-name">Login</span>
        </div>
    </header>

    <main id="app" class="px-4 py-6 max-w-2xl mx-auto"></main>
    <nav id="navbar"></nav>

    <div id="modal-overlay" class="overlay hidden">
        <div class="modal">
            <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                <h3 id="m-title" class="text-lg font-black text-slate-800 uppercase tracking-tight"></h3>
                <button onclick="closeModal()" class="w-8 h-8 flex items-center justify-center bg-slate-50 rounded-full text-slate-400 hover:bg-slate-200 hover:text-slate-800 text-lg font-bold transition">‚úï</button>
            </div>
            <div id="m-body"></div>
        </div>
    </div>

    <div id="pin-screen" class="hidden bg-slate-950 fixed inset-0 z-[200] flex flex-col items-center justify-center text-white">
        <div class="mb-12 text-center">
            <h2 class="text-6xl font-black tracking-tighter mb-2">ARUME</h2>
            <p class="text-indigo-500 text-xs tracking-[0.5em] uppercase font-bold">Base de Datos en Tiempo Real</p>
        </div>
        <div id="pin-display" class="text-5xl font-mono mb-12 tracking-[0.5em] h-12 text-center opacity-80 font-bold">****</div>
        <div class="grid grid-cols-3 gap-4 w-72">
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold hover:bg-white/10 active:scale-95 transition" onclick="pin(1)">1</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold hover:bg-white/10 active:scale-95 transition" onclick="pin(2)">2</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold hover:bg-white/10 active:scale-95 transition" onclick="pin(3)">3</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold hover:bg-white/10 active:scale-95 transition" onclick="pin(4)">4</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold hover:bg-white/10 active:scale-95 transition" onclick="pin(5)">5</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold hover:bg-white/10 active:scale-95 transition" onclick="pin(6)">6</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold hover:bg-white/10 active:scale-95 transition" onclick="pin(7)">7</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold hover:bg-white/10 active:scale-95 transition" onclick="pin(8)">8</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold hover:bg-white/10 active:scale-95 transition" onclick="pin(9)">9</button>
            <button class="w-20 h-20 rounded-full bg-red-500/20 border border-red-500/50 text-red-400 font-bold active:scale-95 transition" onclick="pin('C')">C</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold hover:bg-white/10 active:scale-95 transition" onclick="pin(0)">0</button>
            <button class="w-20 h-20 rounded-full bg-emerald-500 text-white font-bold shadow-lg shadow-emerald-500/50 active:scale-95 transition" onclick="pin('OK')">OK</button>
       </div>
    </div>

<script>
/* =============================================================
   ‚ö†Ô∏è CONFIGURACI√ìN SUPABASE ‚ö†Ô∏è
   ============================================================= */
const SUPABASE_URL = "https://awbgboucnbsuzojocbuy.supabase.co"; 
const SUPABASE_KEY = "sb_publishable_drOQ5PsFA8eox_aRTXNATQ_5kibM6ST";
const CONFIG = { COST_HOUR: 15 };

// Inicializamos el cliente Supabase
const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

/* === UTILIDADES === */
const Num = {
    parse: (str) => { if(!str)return 0; if(typeof str==='number')return str; let clean=String(str).replace(/[^0-9.,-]/g,'').replace(',','.'); return parseFloat(clean)||0; },
    fmt: (n) => (n||0).toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2}),
    csv: (n) => String(n||0).replace('.',',')
};
function clean(str) { return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
const generateID = () => Math.random().toString(36).substr(2,9);
const getISO = () => new Date().toLocaleDateString('en-CA');
const getTS = () => new Date().toLocaleString('es-ES');

// CONVERSOR DE UNIDADES (MEJORADO)
const UnitConverter = {
    normalize: (u) => {
        if(!u) return 'ud';
        u = String(u).toLowerCase().trim().replace('.','');
        if(['kg','kilo','k'].includes(u)) return 'kg';
        if(['g','gr','gramos'].includes(u)) return 'g';
        if(['l','litro','lt'].includes(u)) return 'l';
        if(['ml','mili','cl'].includes(u)) return 'ml';
        return 'ud';
    },
    convert: (q, from, to) => {
        from = UnitConverter.normalize(from); to = UnitConverter.normalize(to);
        if(from===to) return q;
        if(from==='kg' && to==='g') return q*1000;
        if(from==='g' && to==='kg') return q/1000;
        if(from==='l' && to==='ml') return q*1000;
        if(from==='ml' && to==='l') return q/1000;
        // Aproximaciones
        if(from==='kg' && to==='l') return q; 
        if(from==='l' && to==='kg') return q;
        return q;
    }
};

/* === BASE DE DATOS INICIAL === */
const DB_INIT = { 
    users: [{id:'u1', n:'Gerencia', pin:'MDE1MA==', role:'admin'}, {id:'u2', n:'Equipo', pin:'MTExMQ==', role:'staff'}], 
    ingredientes: [], recetas: [], proveedores: [{id:'p1', n:'Makro', tel:'', fam:'General'}], 
    albaranes: [], facturas: [], diario: [], mermas: [], kardex: [], sales_history: [], lastSync: 0 
};
const secure = { enc: d => btoa(encodeURIComponent(JSON.stringify(d))), dec: d => JSON.parse(decodeURIComponent(atob(d))) };

// Variables Globales
let db = DB_INIT, currentUser = null, currentPin = "", tempItems = [], activeAdminTab = 'dash', searchFilter = "";
let currentDiarioDate = getISO(), inventoryMode = false, activeFamily = 'Todos';
let fiscalYear = new Date().getFullYear(), fiscalQuarter = Math.floor(new Date().getMonth()/3)+1;
const ALLERGENS = [{k:'glu',i:'üåæ'},{k:'cru',i:'ü¶ê'},{k:'hue',i:'ü•ö'},{k:'pes',i:'üêü'},{k:'cac',i:'ü•ú'},{k:'soj',i:'ü´ò'},{k:'lac',i:'ü•õ'},{k:'fru',i:'üå∞'},{k:'api',i:'ü•¨'},{k:'mos',i:'üå≠'},{k:'ses',i:'üå±'},{k:'sul',i:'üç∑'},{k:'alt',i:'ü´ò'},{k:'mol',i:'üêô'}];
const FAMILIES = ['General','Carne','Pescado','Verdura','Secos','L√°cteos','Congelado','Bebida','Alcohol','Limpieza','Packaging'];
    /* === 4. SISTEMA CLOUD SUPABASE (SINCRONIZACI√ìN REAL) === */
async function syncDown() {
    try {
        const { data, error } = await sb.from('arume_data').select('data').eq('id', 1).single();
        
        if (data && data.data) {
            const cloudDB = data.data;
            // Si la nube es m√°s nueva que lo local, actualizamos
            if (cloudDB.lastSync > (db.lastSync || 0)) {
                // Si hay un modal abierto (usuario escribiendo), NO interrumpimos
                if (!document.getElementById('modal-overlay').classList.contains('hidden')) return; 
                
                db = cloudDB;
                localStorage.setItem('arume_v151', secure.enc(db));
                refreshCurrentView();
                toast("‚òÅÔ∏è Datos actualizados");
            }
        } else if (error && error.code === 'PGRST116') {
            // Primera vez: Crear fila en Supabase
            console.log("Inicializando DB en Nube...");
            await sb.from('arume_data').insert([{ id: 1, data: db }]);
        }
    } catch (e) { console.error("Sync Error", e); }
}

async function save(msg) {
    loading(true);
    try {
        db.lastSync = Date.now();
        localStorage.setItem('arume_v151', secure.enc(db)); // Backup Local inmediato
        
        const { error } = await sb.from('arume_data').upsert({ id: 1, data: db });
        if (error) throw error;
        
        if (msg) toast(msg, 'success');
    } catch (e) {
        toast("Error red. Guardado local OK.", "info");
        console.error(e);
    } finally { loading(false); }
}

function refreshCurrentView() {
    const activeBtn = document.querySelector('nav button.active');
    const view = activeBtn ? activeBtn.id.replace('btn-', '') : 'Cocina';
    render(view);
}

/* === 5. UI & L√ìGICA DE NAVEGACI√ìN === */
function loading(s) { document.getElementById('loading-overlay').classList.toggle('hidden', !s); }
function toast(m, t='info') { const c=document.getElementById('toast-container'); const el=document.createElement('div'); el.className=`${t==='error'?'bg-red-500':'bg-slate-800'} text-white px-6 py-3 rounded-full shadow-xl font-bold text-xs animate-bounce mb-2`; el.innerText=m; c.appendChild(el); setTimeout(()=>el.remove(),3000); }
function isInPeriod(d) { if(!d)return false; const [y,m]=d.split('-'); if(parseInt(y)!==fiscalYear)return false; if(fiscalQuarter===0)return true; return Math.ceil(parseInt(m)/3)===fiscalQuarter; }

function init() {
    // Intentar cargar datos locales primero
    try { const s = localStorage.getItem('arume_v151'); if(s) db = secure.dec(s); } catch(e){}
    if(!db.users) db = DB_INIT;
    
    // Comprobar si ya hay usuario logueado
    const u = localStorage.getItem('arume_user');
    if(u) { try { currentUser = db.users.find(x=>x.id===JSON.parse(u).id); } catch(e){} }

    if(currentUser) {
        document.getElementById('pin-screen').classList.add('hidden');
        loadApp();
        syncDown(); 
    } else {
        document.getElementById('pin-screen').classList.remove('hidden');
    }
    // Sincronizar cada 3s (Tiempo Real)
    setInterval(syncDown, 3000);
}

function pin(n) {
    if(n==='C') currentPin="";
    else if(n==='OK') {
        const u = db.users.find(x=>x.pin === btoa(currentPin));
        if(u) { currentUser=u; localStorage.setItem('arume_user', JSON.stringify(u)); document.getElementById('pin-screen').classList.add('hidden'); loadApp(); syncDown(); }
        else { toast("PIN Incorrecto","error"); currentPin=""; }
    } else if(currentPin.length<4) currentPin+=n;
    document.getElementById('pin-display').innerText = currentPin ? '*'.repeat(currentPin.length) : '****';
}

function logout(){ if(confirm("¬øCerrar sesi√≥n?")){ localStorage.removeItem('arume_user'); location.reload(); }}
function loadApp() { document.getElementById('user-name').innerText=currentUser.n; renderNav(); render(currentUser.role==='admin'?'Admin':'Cocina'); }

function renderNav() {
    const adm = currentUser?.role==='admin';
    const b = (id,l,i,lk) => `<button id="btn-${id}" class="${lk?'locked':''}" onclick="render('${id}')"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">${i}</svg><span>${l}</span></button>`;
    document.getElementById('navbar').innerHTML = 
        b('Diario','Caja','<path d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>',!adm) +
        b('Admin','Gesti√≥n','<path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>',!adm) +
        b('Cocina','Cocina','<path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>',false) +
        b('Stock','Stock','<path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>',false);
}
function render(v) {
    if((v==='Diario'||v==='Admin') && currentUser.role!=='admin') return toast("‚õî Solo Gerencia","error");
    document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
    document.getElementById(`btn-${v}`)?.classList.add('active');
    const app = document.getElementById('app');
    if(v==='Diario') renderDiario(app); else if(v==='Admin') renderAdmin(app); else if(v==='Cocina') renderCocina(app); else if(v==='Stock') renderStock(app);
}

/* === 6. ADMINISTRACI√ìN Y GESTI√ìN === */
function renderAdmin(app) {
    const tot = db.diario.filter(d=>isInPeriod(d.date)).reduce((a,b)=>a+(b.total||0),0);
    const compras = db.albaranes.filter(a=>isInPeriod(a.date)).reduce((a,b)=>a+(b.subtotal||0),0);
    
    // Controles de Trimestre y A√±o
    const qCtrl = `<div class="flex items-center justify-between bg-white p-2 rounded-2xl shadow-sm mb-4 border border-slate-100"><div class="flex items-center gap-2 bg-slate-100 rounded-lg px-2 py-1"><button class="w-8 h-8 flex items-center justify-center hover:bg-white rounded-full transition font-bold" onclick="fiscalYear--;renderAdmin(document.getElementById('app'))">‚Äπ</button><span class="font-black text-slate-700 text-sm tracking-widest">${fiscalYear}</span><button class="w-8 h-8 flex items-center justify-center hover:bg-white rounded-full transition font-bold" onclick="fiscalYear++;renderAdmin(document.getElementById('app'))">‚Ä∫</button></div><div class="flex gap-1 overflow-x-auto no-scrollbar"><button class="px-2 py-1 rounded ${fiscalQuarter===1?'bg-slate-800 text-white':'bg-slate-100 text-slate-500'} text-xs font-bold" onclick="fiscalQuarter=1;renderAdmin(document.getElementById('app'))">1T</button><button class="px-2 py-1 rounded ${fiscalQuarter===2?'bg-slate-800 text-white':'bg-slate-100 text-slate-500'} text-xs font-bold" onclick="fiscalQuarter=2;renderAdmin(document.getElementById('app'))">2T</button><button class="px-2 py-1 rounded ${fiscalQuarter===3?'bg-slate-800 text-white':'bg-slate-100 text-slate-500'} text-xs font-bold" onclick="fiscalQuarter=3;renderAdmin(document.getElementById('app'))">3T</button><button class="px-2 py-1 rounded ${fiscalQuarter===4?'bg-slate-800 text-white':'bg-slate-100 text-slate-500'} text-xs font-bold" onclick="fiscalQuarter=4;renderAdmin(document.getElementById('app'))">4T</button><button class="px-2 py-1 rounded ${fiscalQuarter===0?'bg-slate-800 text-white':'bg-slate-100 text-slate-500'} text-xs font-bold" onclick="fiscalQuarter=0;renderAdmin(document.getElementById('app'))">A√ëO</button></div></div>`;

    app.innerHTML = `${qCtrl}<div class="flex gap-2 mb-6 bg-white p-1 rounded-2xl shadow-sm border border-slate-100 overflow-x-auto no-scrollbar"><button class="flex-1 min-w-[80px] py-2.5 rounded-xl font-bold text-xs transition ${activeAdminTab==='dash'?'bg-slate-800 text-white shadow-md':'text-slate-500 hover:bg-slate-50'}" onclick="activeAdminTab='dash';renderAdmin(document.getElementById('app'))">DASHBOARD</button><button class="flex-1 min-w-[80px] py-2.5 rounded-xl font-bold text-xs transition ${activeAdminTab==='albs'?'bg-slate-800 text-white shadow-md':'text-slate-500 hover:bg-slate-50'}" onclick="activeAdminTab='albs';renderAdmin(document.getElementById('app'))">ALBARANES</button><button class="flex-1 min-w-[80px] py-2.5 rounded-xl font-bold text-xs transition ${activeAdminTab==='prov'?'bg-slate-800 text-white shadow-md':'text-slate-500 hover:bg-slate-50'}" onclick="activeAdminTab='prov';renderAdmin(document.getElementById('app'))">PROVEEDORES</button></div>
    
    ${activeAdminTab==='dash' ? `<div class="glass-card bg-gradient-to-br from-indigo-900 to-slate-900 text-white mb-4"><h3 class="text-xs uppercase tracking-widest mb-4 font-bold opacity-70">Resultados ${fiscalQuarter===0?'A√ëO':fiscalQuarter+'T'}</h3><div class="flex justify-between items-end mb-2"><div><div class="text-3xl font-black">${Num.fmt(tot-compras)}‚Ç¨</div><div class="text-[10px] uppercase font-bold">Margen Bruto</div></div><div class="text-right"><div class="text-xl font-bold">${Num.fmt(tot)}‚Ç¨</div><div class="text-[10px] uppercase font-bold">Ventas</div></div></div></div><div class="grid grid-cols-2 gap-3"><button class="btn-ghost" onclick="downloadBackup()">üíæ BACKUP</button><button class="btn-ghost text-indigo-600" onclick="document.getElementById('backup-input').click()">üì§ RESTAURAR</button></div>` : ''}
    ${activeAdminTab==='albs' ? renderAlbs() : ''}
    ${activeAdminTab==='prov' ? renderProvs() : ''}`;
}

function renderProvs() { return `<div class="glass-card"><div class="flex justify-between mb-4"><h3 class="font-bold">PROVEEDORES</h3><button class="btn-premium w-auto px-3 py-1 text-xs" onclick="editProv()">+ NUEVO</button></div><div class="space-y-2">${db.proveedores.map(p => `<div class="bg-white p-3 rounded-xl border flex justify-between items-center" onclick="editProv('${p.id}')"><b>${clean(p.n)}</b><span class="text-xs bg-slate-100 px-2 rounded">${p.fam}</span></div>`).join('')}</div></div>`; }
function editProv(id) { const p = id ? db.proveedores.find(x=>x.id===id) : {id:generateID(), n:'', tel:'', fam:'General'}; showModal('Proveedor', `<input id="ep-n" value="${clean(p.n)}" class="input-premium mb-2" placeholder="Nombre"><input id="ep-t" value="${clean(p.tel)}" class="input-premium mb-2" placeholder="Tel√©fono"><button class="btn-premium" onclick="saveProv('${p.id}')">GUARDAR</button>`); }
function saveProv(id) { const n=document.getElementById('ep-n').value; if(n) { const p={id, n, tel:document.getElementById('ep-t').value, fam:'General'}; const idx=db.proveedores.findIndex(x=>x.id===id); if(idx>=0) db.proveedores[idx]=p; else db.proveedores.push(p); save("Guardado"); closeModal(); renderAdmin(document.getElementById('app')); } }

function renderAlbs() {
    return `<div class="glass-card"><h3 class="font-bold mb-4">ALBARANES</h3><button class="btn-premium mb-4" onclick="addAlb()">+ INTRODUCIR ALBAR√ÅN</button><div class="space-y-2">${db.albaranes.filter(a=>isInPeriod(a.date)).slice().reverse().map(a=>`<div class="bg-white p-3 rounded-xl border flex justify-between"><div><b>${clean(a.prov)}</b><div class="text-xs text-slate-400">${a.date}</div></div><b>${Num.fmt(a.total)}‚Ç¨</b></div>`).join('')}</div></div>`;
}
function addAlb() {
    // Albar√°n Simplificado para asegurar estabilidad
    showModal('Nuevo Albar√°n', `<input id="na-p" class="input-premium mb-2" placeholder="Proveedor" list="prov-list"><datalist id="prov-list">${db.proveedores.map(p=>`<option value="${p.n}">`).join('')}</datalist><input id="na-d" type="date" value="${getISO()}" class="input-premium mb-2"><input id="na-t" type="number" class="input-premium mb-4" placeholder="Total ‚Ç¨"><button class="btn-premium" onclick="saveAlb()">GUARDAR</button>`);
}
function saveAlb() {
    const p=document.getElementById('na-p').value; const t=parseFloat(document.getElementById('na-t').value);
    if(p && t) { 
        db.albaranes.push({id:generateID(), prov:p, date:document.getElementById('na-d').value, total:t, subtotal:t, taxes:0}); 
        // Crear proveedor si no existe
        if(!db.proveedores.find(x=>x.n===p)) db.proveedores.push({id:generateID(), n:p, tel:'', fam:'General'});
        save("Albar√°n OK"); closeModal(); renderAdmin(document.getElementById('app')); 
    }
}
    /* === 7. OMNES (INGENIER√çA DE MEN√ö) === */
function renderOmnes(c) {
    if (!db.recetas || db.recetas.length === 0) { 
        c.innerHTML = `<div class="glass-card text-center"><h3 class="font-bold text-slate-800">No hay datos</h3><p class="text-xs text-slate-400 mb-4">Crea recetas y registra ventas primero.</p><button class="btn-premium" onclick="render('Cocina')">IR A COCINA</button></div>`; 
        return; 
    }

    // 1. C√°lculos de Ingenier√≠a
    let totalSold = 0, totalRev = 0, totalCost = 0;
    const salesMap = {};
    
    // Sumar ventas del periodo
    db.sales_history.filter(log => isInPeriod(log.date)).forEach(log => {
        log.items.forEach(it => {
            const rid = it.rid || db.recetas.find(r => r.n === it.n)?.id;
            if (rid) salesMap[rid] = (salesMap[rid] || 0) + it.q;
        });
    });

    const data = db.recetas.map(r => {
        const cost = calcRecipe(r).t;
        const sales = salesMap[r.id] || 0; // Usar ventas reales del periodo, no hist√≥ricas totales
        totalSold += sales;
        totalRev += sales * r.pvp;
        totalCost += sales * cost;
        return { r, sales, cost, margin: r.pvp - cost, pvp: r.pvp };
    });

    if (totalSold === 0) {
        c.innerHTML = `<div class="glass-card text-center p-8 border-2 border-dashed"><h3 class="text-slate-400">Sin ventas este trimestre</h3><button class="btn-premium mt-4" onclick="editSales()">üìù REGISTRAR SERVICIO</button></div>`;
        return;
    }

    const avgMargin = (totalRev - totalCost) / totalSold;
    const popLimit = (100 / data.length) * 0.7; // Regla Omnes (70% de la media)

    // 2. Renderizado de la Matriz
    let html = data.sort((a,b) => b.sales - a.sales).map(d => {
        if (d.sales === 0) return '';
        const mix = (d.sales / totalSold) * 100;
        const isPop = mix >= popLimit;
        const isRich = d.margin >= avgMargin;
        
        let type = isPop ? (isRich ? 'üåü ESTRELLA' : 'üêé CABALLO') : (isRich ? 'üß© PUZZLE' : 'üêï PERRO');
        let color = isPop ? (isRich ? 'border-l-4 border-yellow-400' : 'border-l-4 border-blue-400') : (isRich ? 'border-l-4 border-green-400' : 'border-l-4 border-red-400');

        return `
        <div class="bg-white p-3 rounded-xl shadow-sm mb-2 flex justify-between items-center ${color}">
            <div class="flex-1">
                <div class="font-bold text-slate-700 text-sm">${clean(d.r.n)}</div>
                <div class="text-[10px] font-bold text-slate-400">${type}</div>
            </div>
            <div class="text-right">
                <div class="font-black text-slate-800">${d.sales} <span class="text-[9px] font-normal text-slate-400">ut</span></div>
                <div class="text-[10px] text-slate-500">Mg: ${Num.fmt(d.margin)}‚Ç¨</div>
            </div>
        </div>`;
    }).join('');

    c.innerHTML = `
    <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-slate-800">MATRIZ OMNES</h3>
        <button class="btn-premium btn-action w-auto px-4 py-2 text-xs" onclick="editSales()">üìù REGISTRAR SERVICIO</button>
    </div>
    <div class="grid grid-cols-2 gap-2 mb-4 text-center">
        <div class="bg-slate-50 p-2 rounded-lg"><div class="text-[10px] text-slate-400">Margen Medio</div><div class="font-bold">${Num.fmt(avgMargin)}‚Ç¨</div></div>
        <div class="bg-slate-50 p-2 rounded-lg"><div class="text-[10px] text-slate-400">Ticket Medio</div><div class="font-bold">${Num.fmt(totalRev/totalSold)}‚Ç¨</div></div>
    </div>
    ${html}`;
}

function editSales() {
    // Modal para introducir ventas r√°pidas del d√≠a
    if (!db.recetas.length) return toast("No hay recetas", "error");
    const list = db.recetas.map(r => `
        <div class="flex justify-between items-center py-2 border-b">
            <span class="text-sm font-medium w-1/2">${clean(r.n)}</span>
            <input type="number" min="0" placeholder="0" id="sale-${r.id}" class="bg-slate-50 border rounded-lg w-20 text-center py-2 font-bold focus:bg-white outline-none">
        </div>`).join('');
        
    showModal('Registro de Ventas', `
        <div class="bg-blue-50 p-3 rounded-lg text-blue-800 text-xs mb-4">
            Introduce las ventas de hoy para descontar stock y calcular Omnes.
        </div>
        <div class="max-h-[50vh] overflow-y-auto pr-1 mb-4">${list}</div>
        <button class="btn-premium btn-action" onclick="commitSales()">PROCESAR Y GUARDAR</button>
    `);
}

function commitSales() {
    let log = { id: generateID(), date: getTS(), items: [] };
    let hasData = false;
    
    db.recetas.forEach(r => {
        const el = document.getElementById(`sale-${r.id}`);
        const qty = Num.parse(el.value);
        
        if (qty > 0) {
            hasData = true;
            // 1. Registrar venta para Omnes
            log.items.push({ rid: r.id, n: r.n, q: qty });
            
            // 2. Descontar Stock (Escandallo)
            r.items.forEach(it => {
                if (it.type === 'ing') {
                    const ing = db.ingredientes.find(x => x.id === it.id);
                    if (ing) {
                        const factor = UnitConverter.convert(1, it.unit||ing.unit, ing.unit);
                        const totalNeeded = (it.q * factor * qty) / (it.merma ? (1-(it.merma/100)) : 1);
                        ing.stock -= totalNeeded;
                        logStock(ing.id, totalNeeded, 'OUT', `Venta: ${r.n}`, ing.cost);
                    }
                }
            });
        }
    });

    if (hasData) {
        db.sales_history.push(log);
        save("Ventas procesadas y Stock actualizado");
        closeModal();
        renderAdmin(document.getElementById('app'));
    } else {
        toast("No has introducido cantidades", "error");
    }
}

/* === 8. DIARIO (CIERRE DE CAJA) === */
function renderDiario(app) {
    const r = db.diario.find(d => d.date === currentDiarioDate) || { cash:0, visa:0, tpv:0, amex:0, glovo:0, uber:0, apper:0, expenses:0 };
    const total = (r.cash||0)+(r.visa||0)+(r.tpv||0)+(r.amex||0)+(r.glovo||0)+(r.uber||0)+(r.apper||0);
    const realCash = (r.cash||0) - (r.expenses||0);

    // Historial
    const history = db.diario.filter(d => isInPeriod(d.date)).sort((a,b) => b.date.localeCompare(a.date)).map(d => 
        `<div class="flex justify-between py-3 border-b hover:bg-slate-50 px-2 cursor-pointer" onclick="currentDiarioDate='${d.date}';render('Diario')">
            <span class="font-bold text-slate-700">üìÖ ${d.date}</span>
            <span class="font-mono font-bold text-indigo-600">${Num.fmt(d.total)}‚Ç¨</span>
        </div>`
    ).join('');

    app.innerHTML = `
    <div class="glass-card">
        <div class="flex justify-between items-center mb-6">
            <h3 class="font-bold text-slate-800">CIERRE DE CAJA</h3>
            <input type="date" value="${currentDiarioDate}" class="bg-slate-100 rounded-lg p-2 font-bold text-indigo-600 outline-none" onchange="currentDiarioDate=this.value;render('Diario')">
        </div>
        
        <div class="space-y-4">
            <div class="bg-emerald-50/50 p-4 rounded-xl border border-emerald-100">
                <div class="text-[10px] font-bold text-emerald-600 mb-2 uppercase">üíµ Efectivo</div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label>Venta Efectivo</label><input type="number" id="z-cash" value="${r.cash||0}" class="input-premium text-center text-lg font-bold" onchange="calcTotal()"></div>
                    <div><label class="text-red-400">Gastos Caja</label><input type="number" id="z-exp" value="${r.expenses||0}" class="input-premium text-center text-lg font-bold text-red-500" onchange="calcTotal()"></div>
                </div>
                <div class="text-right mt-2 text-xs font-bold text-emerald-700">En Caj√≥n: <span id="z-real" class="text-lg">${Num.fmt(realCash)}</span>‚Ç¨</div>
            </div>

            <div class="bg-blue-50/50 p-4 rounded-xl border border-blue-100">
                <div class="text-[10px] font-bold text-blue-600 mb-2 uppercase">üí≥ Tarjetas</div>
                <div class="grid grid-cols-3 gap-2">
                    <div><label>Visa</label><input type="number" id="z-visa" value="${r.visa||0}" class="input-premium text-center" onchange="calcTotal()"></div>
                    <div><label>TPV</label><input type="number" id="z-tpv" value="${r.tpv||0}" class="input-premium text-center" onchange="calcTotal()"></div>
                    <div><label>Amex</label><input type="number" id="z-amex" value="${r.amex||0}" class="input-premium text-center" onchange="calcTotal()"></div>
                </div>
            </div>

            <div class="bg-orange-50/50 p-4 rounded-xl border border-orange-100">
                <div class="text-[10px] font-bold text-orange-600 mb-2 uppercase">üõµ Delivery</div>
                <div class="grid grid-cols-3 gap-2">
                    <div><label>Glovo</label><input type="number" id="z-glo" value="${r.glovo||0}" class="input-premium text-center" onchange="calcTotal()"></div>
                    <div><label>Uber</label><input type="number" id="z-ube" value="${r.uber||0}" class="input-premium text-center" onchange="calcTotal()"></div>
                    <div><label>Apper</label><input type="number" id="z-app" value="${r.apper||0}" class="input-premium text-center" onchange="calcTotal()"></div>
                </div>
            </div>

            <div class="flex justify-between items-center pt-4 border-t mt-2">
                <span class="font-bold text-slate-400 text-xs uppercase">TOTAL D√çA</span>
                <span id="z-total" class="text-4xl font-black text-slate-800">${Num.fmt(total)}‚Ç¨</span>
            </div>
        </div>
        <button class="btn-premium mt-6" onclick="saveZ()">üíæ GUARDAR CIERRE</button>
    </div>

    <div class="glass-card">
        <h4 class="text-xs font-bold text-slate-400 uppercase mb-4">Historial ${fiscalQuarter}T</h4>
        <div class="max-h-40 overflow-y-auto mb-4">${history}</div>
    </div>`;
}

function calcTotal() {
    const v = (id) => parseFloat(document.getElementById(id).value)||0;
    const cash = v('z-cash'), exp = v('z-exp');
    const tot = cash + v('z-visa') + v('z-tpv') + v('z-amex') + v('z-glo') + v('z-ube') + v('z-app');
    document.getElementById('z-total').innerText = Num.fmt(tot)+'‚Ç¨';
    document.getElementById('z-real').innerText = Num.fmt(cash - exp);
}

function saveZ() {
    const v = (id) => parseFloat(document.getElementById(id).value)||0;
    const data = {
        date: currentDiarioDate,
        cash: v('z-cash'), expenses: v('z-exp'),
        visa: v('z-visa'), tpv: v('z-tpv'), amex: v('z-amex'),
        glovo: v('z-glo'), uber: v('z-ube'), apper: v('z-app'),
        total: parseFloat(document.getElementById('z-total').innerText.replace(/[^\d.-]/g, ''))
    };
    
    // Buscar si ya existe ese d√≠a para actualizar o crear
    const idx = db.diario.findIndex(d => d.date === currentDiarioDate);
    if(idx >= 0) db.diario[idx] = data; else db.diario.push(data);
    
    save("Cierre guardado correctamente");
}

/* === 9. FUNCIONES EXTRA (MODALES Y UTILS) === */
function downloadBackup(){ const d=secure.enc(db); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([d],{type:'text/plain'})); a.download=`Arume_Backup_${getISO()}.arume`; a.click(); }
function restoreBackup(input){ const r=new FileReader(); r.onload=e=>{ try{ db=secure.dec(e.target.result); save("Restaurado y subido a Supabase"); loadApp(); }catch(err){ toast("Error archivo","error"); } }; r.readAsText(input.files[0]); }
function showModal(t,c){ document.getElementById('m-title').innerText=t; document.getElementById('m-body').innerHTML=c; document.getElementById('modal-overlay').classList.remove('hidden'); }
function closeModal(){ document.getElementById('modal-overlay').classList.add('hidden'); }

/* === INIT FINAL === */
init();
</script>
</body>
</html>
