<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>ARUME V110 ¬∑ Sistema Integral</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* --- ESTILOS PREMIUM PERSONALIZADOS --- */
        body { font-family: 'Poppins', sans-serif; background: #f8fafc; padding-bottom: 120px; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        /* TARJETAS CRISTAL */
        .glass-card { 
            background: rgba(255,255,255,0.95); 
            backdrop-filter: blur(20px); 
            border: 1px solid white; 
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.05); 
            border-radius: 24px; 
            padding: 20px; 
            margin-bottom: 20px; 
            transition: transform 0.2s;
        }
        
        /* BOTONES */
        .btn-premium { 
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); 
            color: white; padding: 14px; border-radius: 16px; 
            font-weight: 700; box-shadow: 0 8px 20px -5px rgba(79, 70, 229, 0.4); 
            width: 100%; display: flex; justify-content: center; align-items: center; gap: 8px; cursor: pointer;
        }
        .btn-premium:active { transform: scale(0.97); }

        .btn-ghost { background: white; border: 1px solid #e2e8f0; color: #475569; font-weight: 600; padding: 10px; border-radius: 12px; width: 100%; cursor: pointer; transition: 0.2s; }
        .btn-ghost:active { background: #f1f5f9; }

        /* INPUTS */
        .input-premium { 
            width: 100%; padding: 12px; background: #f1f5f9; 
            border: 2px solid #e2e8f0; border-radius: 12px; 
            outline: none; transition: 0.3s; font-size: 15px;
        }
        .input-premium:focus { border-color: #4f46e5; background: white; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }

        /* LOADING SPINNER */
        #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid #4f46e5; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* MODAL */
        .overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(4px); z-index: 100; display: flex; align-items: center; justify-content: center; }
        .modal { background: white; width: 95%; max-width: 800px; max-height: 90vh; overflow-y: auto; border-radius: 24px; padding: 24px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        
        /* NAVEGACI√ìN INFERIOR */
        nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 450px; background: white; padding: 10px; border-radius: 24px; display: flex; justify-content: space-between; box-shadow: 0 20px 40px rgba(0,0,0,0.1); z-index: 50; border: 1px solid rgba(0,0,0,0.05); }
        nav button { flex: 1; background: none; border: none; color: #94a3b8; display: flex; flex-direction: column; align-items: center; font-size: 0.65rem; font-weight: 700; transition: 0.3s; cursor: pointer; }
        nav button.active { color: #4f46e5; transform: translateY(-4px); }
        nav button svg { width: 26px; height: 26px; fill: currentColor; margin-bottom: 2px; }

        /* PANTALLA PIN */
        #pin-screen { background: #1e1b4b; position: fixed; inset: 0; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .pin-btn { width: 70px; height: 70px; border-radius: 50%; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .pin-btn:active { background: rgba(255,255,255,0.3); transform: scale(0.95); }

        .hidden { display: none !important; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
    </style>
</head>
<body>

    <div id="loading-overlay" class="hidden">
        <div class="spinner mb-4"></div>
        <div class="font-bold text-gray-500 tracking-widest text-xs animate-pulse">PROCESANDO...</div>
    </div>

    <div id="toast-container" class="fixed top-5 left-1/2 -translate-x-1/2 z-[300] pointer-events-none"></div>
    
    <input type="file" id="backup-input" class="hidden" onchange="restoreBackup(this)">

    <header class="sticky top-0 z-40 px-6 py-4 flex justify-between items-center bg-white/90 backdrop-blur border-b border-gray-100">
        <div>
            <h1 class="text-2xl font-black text-gray-800 tracking-tight">ARUME <span class="text-indigo-600">V110</span></h1>
            <p class="text-[10px] text-gray-400 font-bold tracking-widest uppercase">Total Control</p>
        </div>
        <div class="bg-gray-100 px-3 py-1 rounded-full text-xs font-bold text-gray-600 flex items-center gap-2 cursor-pointer hover:bg-gray-200 transition" onclick="logout()">
            <div id="sync-dot" class="w-2 h-2 rounded-full bg-gray-400"></div> <span id="user-name">Login</span>
        </div>
    </header>

    <main id="app" class="px-4 py-6 max-w-4xl mx-auto"></main>
    
    <nav id="navbar"></nav>

    <div id="modal-overlay" class="overlay hidden">
        <div class="modal">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h3 id="m-title" class="text-lg font-black text-gray-800 uppercase tracking-wide"></h3>
                <button onclick="closeModal()" class="w-8 h-8 flex items-center justify-center bg-gray-100 rounded-full text-gray-500 hover:bg-gray-200 text-lg font-bold">‚úï</button>
            </div>
            <div id="m-body"></div>
        </div>
    </div>

    <div id="pin-screen" class="hidden">
        <div class="mb-10 text-center">
            <h2 class="text-5xl font-black tracking-tighter mb-2">ARUME</h2>
            <p class="text-indigo-200 text-xs tracking-widest uppercase">Acceso Seguro</p>
        </div>
        <div id="pin-display" class="text-4xl font-mono mb-10 tracking-[1em] h-10 text-center">****</div>
        <div class="grid grid-cols-3 gap-6 w-64">
            <button class="pin-btn" onclick="pin(1)">1</button><button class="pin-btn" onclick="pin(2)">2</button><button class="pin-btn" onclick="pin(3)">3</button>
            <button class="pin-btn" onclick="pin(4)">4</button><button class="pin-btn" onclick="pin(5)">5</button><button class="pin-btn" onclick="pin(6)">6</button>
            <button class="pin-btn" onclick="pin(7)">7</button><button class="pin-btn" onclick="pin(8)">8</button><button class="pin-btn" onclick="pin(9)">9</button>
            <button class="pin-btn bg-red-500/20 text-red-200 text-sm font-bold" onclick="pin('C')">C</button>
            <button class="pin-btn" onclick="pin(0)">0</button>
            <button class="pin-btn bg-green-500/20 text-green-200 text-sm font-bold" onclick="pin('OK')">OK</button>
        </div>
    </div>

<script>
/* ================= 1. CONFIGURACI√ìN ================= */
const CONFIG = { 
    GOOGLE_URL: "https://script.google.com/macros/s/AKfycbxL0hWPiYmQ_590bkFjd1B9xwsfrYQXQtEuUpP2Nraq973bDr2rpEgVnaJCpI3-DH8z/exec", 
    COST_HOUR: 15,
    DEFAULT_IVA: 10
};

const ALLERGENS = [
    {k:'glu', i:'üåæ'}, {k:'cru', i:'ü¶ê'}, {k:'hue', i:'ü•ö'}, {k:'pes', i:'üêü'}, 
    {k:'cac', i:'ü•ú'}, {k:'soj', i:'ü´ò'}, {k:'lac', i:'ü•õ'}, {k:'fru', i:'üå∞'}, 
    {k:'api', i:'ü•¨'}, {k:'mos', i:'üå≠'}, {k:'ses', i:'üå±'}, {k:'sul', i:'üç∑'}, 
    {k:'alt', i:'ü´ò'}, {k:'mol', i:'üêô'}
];

const DB_INIT = {
    users: [{id:'u1', n:'Gerencia', pin:'0150', role:'admin'}],
    ingredientes: [], recetas: [], proveedores: [{n:'Makro'}],
    albaranes: [], facturas: [], diario: [], mermas: [], lastSync: 0
};

// Cifrado para seguridad de datos
const secure = {
    enc: (d) => btoa(encodeURIComponent(JSON.stringify(d))),
    dec: (d) => JSON.parse(decodeURIComponent(atob(d)))
};

let db = DB_INIT;
let currentUser = null, currentPin = "", tempItems = [], activeAdminTab = 'albaranes', searchFilter = "";

/* ================= 2. CORE SYSTEM ================= */
const generateID = () => Math.random().toString(36).substr(2, 9);
const getISO = () => new Date().toLocaleDateString('en-CA');
function clean(str) { if(!str) return ''; return String(str).replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

function loading(show) { document.getElementById('loading-overlay').classList.toggle('hidden', !show); }

function toast(msg, type='info') {
    const box = document.getElementById('toast-container');
    const bg = type==='error' ? 'bg-red-500' : 'bg-slate-800';
    const el = document.createElement('div');
    el.className = `${bg} text-white px-6 py-3 rounded-full shadow-xl font-bold text-sm mb-3 animate-bounce text-center backdrop-blur`;
    el.innerText = msg; box.appendChild(el); setTimeout(() => el.remove(), 3000);
}

function init() {
    try {
        const stored = localStorage.getItem('arume_v110');
        if(stored) db = secure.dec(stored);
        else {
            const old = localStorage.getItem('arume_v105'); 
            if(old) db = secure.dec(old);
        }
    } catch(e) { console.warn("DB reset"); }
    
    if(!db.users || !db.users.length) db.users = DB_INIT.users;

    const u = localStorage.getItem('arume_user');
    if(u) { currentUser=JSON.parse(u); document.getElementById('pin-screen').classList.add('hidden'); loadApp(); }
    else { document.getElementById('pin-screen').classList.remove('hidden'); }
    if(CONFIG.GOOGLE_URL) sync();
}

async function save(msg){
    loading(true);
    db.lastSync = Date.now();
    localStorage.setItem('arume_v110', secure.enc(db));
    if(CONFIG.GOOGLE_URL) await fetch(CONFIG.GOOGLE_URL, {method:'POST', mode:'no-cors', body:JSON.stringify(db)}).catch(()=>{});
    loading(false);
    if(msg) toast(msg);
}

async function sync(){
    if(!CONFIG.GOOGLE_URL) return;
    const dot = document.getElementById('sync-dot');
    if(dot) dot.className="w-2 h-2 rounded-full bg-yellow-400 animate-pulse";
    try {
        const r = await fetch(CONFIG.GOOGLE_URL);
        const c = await r.json();
        if(c && c.lastSync > (db.lastSync||0)) { db=c; localStorage.setItem('arume_v110', secure.enc(db)); location.reload(); }
        if(dot) dot.className="w-2 h-2 rounded-full bg-green-500 shadow-lg shadow-green-500/50";
    } catch(e){ if(dot) dot.className="w-2 h-2 rounded-full bg-red-500"; }
}

function pin(n){
    if(n==='C') currentPin=""; else if(n==='OK') {
        const u = db.users.find(x=>x.pin===currentPin);
        if(u){ currentUser=u; localStorage.setItem('arume_user', JSON.stringify(u)); document.getElementById('pin-screen').classList.add('hidden'); loadApp(); }
        else { toast("PIN Incorrecto", "error"); currentPin=""; document.getElementById('pin-display').innerText='****'; }
    } else if(currentPin.length<4) currentPin+=n;
    document.getElementById('pin-display').innerText = currentPin ? '*'.repeat(currentPin.length) : '****';
}
function logout(){ if(confirm("¬øCerrar sesi√≥n?")){ localStorage.removeItem('arume_user'); location.reload(); }}

/* ================= 4. UI RENDER ================= */
function loadApp() { document.getElementById('user-name').innerText = currentUser.n; renderNav(); render('Admin'); }

function renderNav() {
    const views = [
        {id:'Diario', l:'Caja', i:'<path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>'},
        {id:'Admin', l:'Gesti√≥n', i:'<path d="M12 2L3 5v6c0 5 3.8 9.7 9 11 5.2-1.3 9-6 9-11V5l-9-3z"/>'},
        {id:'Cocina', l:'Cocina', i:'<path d="M12 2C8.1 6 7 8 7 11c0 3.9 3.1 7 7 7s7-3.1 7-7c0-3-1.1-5-5-9z"/>'},
        {id:'Stock', l:'Stock', i:'<path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 1-1-.45-1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 1-1-.45-1-1z"/>'}
    ];
    document.getElementById('navbar').innerHTML = views.map(v => `<button id="btn-${v.id}" onclick="render('${v.id}')"><svg viewBox="0 0 24 24">${v.i}</svg><span>${v.l}</span></button>`).join('');
}

function render(view) {
    document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
    document.getElementById(`btn-${view}`)?.classList.add('active');
    const app = document.getElementById('app');
    if(view==='Diario') renderDiario(app);
    if(view==='Admin') renderAdmin(app);
    if(view==='Cocina') renderCocina(app);
    if(view==='Stock') renderStock(app);
}

/* ================= 5. GESTI√ìN (PANEL) ================= */
function renderAdmin(app) {
    app.innerHTML = `
        <div class="flex gap-2 mb-6 bg-white p-1 rounded-2xl shadow-sm border border-gray-100">
            <button class="flex-1 py-2.5 rounded-xl font-bold text-xs transition ${activeAdminTab==='albaranes'?'bg-indigo-100 text-indigo-700 shadow-sm':''}" onclick="activeAdminTab='albaranes';renderAdmin(document.getElementById('app'))">ENTRADAS</button>
            <button class="flex-1 py-2.5 rounded-xl font-bold text-xs transition ${activeAdminTab==='facturas'?'bg-indigo-100 text-indigo-700 shadow-sm':''}" onclick="activeAdminTab='facturas';renderAdmin(document.getElementById('app'))">FACTURAS</button>
            <button class="flex-1 py-2.5 rounded-xl font-bold text-xs transition ${activeAdminTab==='omnes'?'bg-indigo-100 text-indigo-700 shadow-sm':''}" onclick="activeAdminTab='omnes';renderAdmin(document.getElementById('app'))">OMNES 4P</button>
        </div>
        <div id="adm-c"></div>
    `;
    const c = document.getElementById('adm-c');
    if(activeAdminTab==='omnes') renderOmnes(c);
    if(activeAdminTab==='albaranes') renderAlbaranes(c);
    if(activeAdminTab==='facturas') renderFacturas(c);
}

// --- ALBARANES (CORREGIDO: BORRAR Y EDITAR) ---
function renderAlbaranes(c) {
    c.innerHTML = `
        <div class="glass-card">
            <h3 class="font-bold text-gray-700 mb-4 text-sm uppercase flex justify-between items-center">
                <span>Nuevo Albar√°n</span>
                <span id="edit-mode-indicator" class="hidden text-[10px] bg-yellow-100 text-yellow-700 px-2 py-1 rounded">‚úèÔ∏è EDITANDO</span>
            </h3>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div><label>Proveedor</label><input list="prov-list" id="alb-prov" class="input-premium" placeholder="..."><datalist id="prov-list">${db.proveedores.map(p=>`<option value="${clean(p.n)}">`).join('')}</datalist></div>
                <div><label>Fecha</label><input type="date" id="alb-date" value="${getISO()}" class="input-premium"></div>
            </div>
            <textarea id="alb-input" rows="4" class="input-premium font-mono text-xs" placeholder="Pegar: Producto Cantidad Precio"></textarea>
            <button class="btn-ghost mb-4" onclick="parseAlb()">ü™Ñ Leer Texto</button>
            <div id="alb-grid" class="space-y-2 mb-4"></div>
            <div class="text-right font-black text-2xl mb-4 text-indigo-600" id="alb-total">0.00‚Ç¨</div>
            <button class="btn-premium" onclick="commitAlb()">CONFIRMAR ENTRADA</button>
        </div>
        
        <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
            <h4 class="font-bold text-xs text-gray-400 mb-4 uppercase tracking-wider">Historial (Editable)</h4>
            ${db.albaranes.slice().reverse().map(a => `
                <div class="flex justify-between items-center py-3 border-b border-gray-50 last:border-0">
                    <div><div class="font-bold text-gray-800 text-sm">${clean(a.prov)}</div><div class="text-[10px] text-gray-400 font-bold">${a.date}</div></div>
                    <div class="flex items-center gap-2">
                        <span class="font-mono font-bold text-gray-700">${a.total.toFixed(2)}‚Ç¨</span>
                        <button class="bg-blue-50 text-blue-500 p-2 rounded-lg hover:bg-blue-100 text-xs shadow-sm font-bold" onclick="editAlb('${a.id}')">‚úèÔ∏è</button>
                        <button class="bg-red-50 text-red-500 p-2 rounded-lg hover:bg-red-100 text-xs shadow-sm font-bold" onclick="deleteAlb('${a.id}')">üóëÔ∏è</button>
                        ${a.invoiced ? '<span class="text-[10px] bg-green-100 text-green-700 px-2 py-1 rounded font-bold">Fac.</span>' : ''}
                    </div>
                </div>
            `).join('')}
        </div>`;
}

function parseAlb() {
    const txt = document.getElementById('alb-input').value; tempItems = [];
    txt.split(/\r?\n/).forEach(l => { 
        const p=l.split(/\s{2,}|\t/); let n=p[0], q=1, pr=0;
        if(p.length>=2) { const nums=p.slice(1).map(x=>parseFloat(x.replace(',','.'))).filter(n=>!isNaN(n)); if(nums.length>=2){q=nums[0];pr=nums[1]}else if(nums.length===1)pr=nums[0]; }
        else { const t=l.split(/\s+/); const nums=t.filter(x=>!isNaN(x.replace(',','.'))).map(x=>parseFloat(x.replace(',','.'))); if(nums.length) pr=nums[nums.length-1]; }
        if(pr>0) tempItems.push({n:n.trim(), q, p:pr}); 
    });
    renderAlbGrid();
}

function renderAlbGrid() {
    document.getElementById('alb-grid').innerHTML = tempItems.map((it,i)=>`<div class="flex items-center gap-2 bg-white p-2 rounded-xl border border-gray-100"><input value="${it.n}" class="flex-1 bg-transparent text-sm font-bold outline-none" onchange="tempItems[${i}].n=this.value"><input type="number" value="${it.q}" class="w-12 bg-gray-50 rounded text-center text-xs p-1" onchange="tempItems[${i}].q=parseFloat(this.value);renderAlbGrid()"><input type="number" value="${it.p}" class="w-16 bg-gray-50 rounded text-center text-xs p-1" onchange="tempItems[${i}].p=parseFloat(this.value);renderAlbGrid()"><span class="text-red-400 cursor-pointer px-2" onclick="tempItems.splice(${i},1);renderAlbGrid()">‚úï</span></div>`).join('');
    document.getElementById('alb-total').innerText = tempItems.reduce((a,b)=>a+(b.p*b.q),0).toFixed(2)+'‚Ç¨';
}

function commitAlb() {
    if(!tempItems.length) return toast("Lista vac√≠a", "error");
    const prov = document.getElementById('alb-prov').value;
    if(!prov) return toast("Falta Proveedor", "error");
    if(!db.proveedores.find(p=>p.n===prov)) db.proveedores.push({n:prov});

    // Actualizar Stock
    tempItems.forEach(it => {
        let i = db.ingredientes.find(x => x.n.toLowerCase() === it.n.toLowerCase());
        if(i) { i.cost=((i.stock*i.cost)+(it.q*it.p))/(i.stock+it.q); i.stock+=it.q; }
        else { db.ingredientes.push({id:generateID(), n:it.n, stock:it.q, cost:it.p, min:0, unit:'ud', aller:[]}); }
    });

    db.albaranes.push({id:generateID(), date:document.getElementById('alb-date').value, prov, items:[...tempItems], total:parseFloat(document.getElementById('alb-total').innerText), invoiced:false});
    save("Entrada guardada"); 
    tempItems = []; 
    renderAdmin(document.getElementById('app'));
}

function deleteAlb(id) {
    const alb = db.albaranes.find(a => a.id === id);
    if(!alb) return;
    
    // Aviso si est√° facturado pero permite borrar
    let warning = "¬øBorrar y RESTAR stock?";
    if (alb.invoiced) warning = "‚ö†Ô∏è ¬°EST√Å FACTURADO! \nSi borras esto, la factura perder√° su origen.\n¬øBorrar igualmente y restar stock?";

    if(confirm(warning)) {
        alb.items.forEach(it => {
            const i = db.ingredientes.find(x => x.n.toLowerCase() === it.n.toLowerCase());
            if(i) i.stock = Math.max(0, i.stock - it.q);
        });
        db.albaranes = db.albaranes.filter(a => a.id !== id);
        save("Borrado y Stock corregido");
        renderAdmin(document.getElementById('app'));
    }
}

function editAlb(id) {
    const alb = db.albaranes.find(a => a.id === id);
    if(!alb) return;
    if(confirm("¬øEditar? Se revertir√° el stock para que corrijas.")) {
        alb.items.forEach(it => {
            const i = db.ingredientes.find(x => x.n.toLowerCase() === it.n.toLowerCase());
            if(i) i.stock = Math.max(0, i.stock - it.q);
        });
        tempItems = JSON.parse(JSON.stringify(alb.items));
        document.getElementById('alb-prov').value = alb.prov;
        document.getElementById('alb-date').value = alb.date;
        document.getElementById('edit-mode-indicator').classList.remove('hidden');
        renderAlbGrid();
        db.albaranes = db.albaranes.filter(a => a.id !== id);
        toast("Modo Edici√≥n"); window.scrollTo(0,0);
    }
}

// FACTURAS
function renderFacturas(c) {
    const pends = db.albaranes.filter(a=>!a.invoiced);
    const groups={}; pends.forEach(a=>{ if(!groups[a.prov]) groups[a.prov]={c:0,t:0,ids:[]}; groups[a.prov].c++; groups[a.prov].t+=a.total; groups[a.prov].ids.push(a.id); });
    
    c.innerHTML = `
    ${Object.keys(groups).length ? `<div class="glass-card"><h3 class="font-bold text-xs text-gray-400 mb-3 uppercase">Pendiente Facturar</h3>${Object.entries(groups).map(([p,d])=>`<div class="flex justify-between items-center py-2 border-b last:border-0"><div><div class="font-bold text-gray-800">${clean(p)}</div><div class="text-xs text-gray-400">${d.c} entradas</div></div><div class="flex items-center gap-3"><span class="font-bold">${d.t.toFixed(2)}‚Ç¨</span><button class="bg-indigo-600 text-white px-3 py-1 rounded-lg text-xs font-bold shadow-sm" onclick="invoice('${p}','${d.ids}')">GENERAR</button></div></div>`).join('')}</div>` : ''}
    
    <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
        <h3 class="font-bold text-xs text-gray-400 mb-4 uppercase">Hist√≥rico</h3>
        ${db.facturas.slice().reverse().map(f => `<div class="flex justify-between items-center py-3 border-b border-gray-50 last:border-0"><div><div class="font-bold text-gray-800">${clean(f.prov)}</div><div class="text-[10px] text-gray-400">${f.date}</div></div><div class="text-right"><div class="font-mono font-bold text-gray-700">${f.total.toFixed(2)}‚Ç¨</div><div class="text-[10px] font-bold cursor-pointer ${f.paid?'text-green-500':'text-red-500'}" onclick="togglePaid('${f.id}')">${f.paid?'PAGADO':'PENDIENTE'}</div></div></div>`).join('')}
    </div>
    <button class="btn-ghost mt-6" onclick="downloadBackup()">üíæ COPIA SEGURIDAD</button>`;
}
function invoice(p,ids){ const l=ids.split(','); l.forEach(id=>{ const a=db.albaranes.find(x=>x.id===id); if(a) a.invoiced=true; }); const t=l.reduce((ac,id)=>ac+(db.albaranes.find(x=>x.id===id)?.total||0),0); db.facturas.push({id:generateID(), date:getISO(), prov:p, total:t, paid:false}); save("Factura creada"); renderAdmin(document.getElementById('app')); }
function togglePaid(id){ const f=db.facturas.find(x=>x.id===id); if(f){ f.paid=!f.paid; save(); renderAdmin(document.getElementById('app')); }}

// OMNES & BCG
function renderOmnes(c) {
    const prices = (db.recetas||[]).map(r=>r.pvp).filter(p=>p>0).sort((a,b)=>a-b);
    const minP = prices[0]||0, maxP = prices[prices.length-1]||0;
    const gama = minP>0 ? (maxP/minP).toFixed(1) : 0;
    
    let totalSales=0, stars=0, plows=0, puzzles=0, dogs=0;
    (db.recetas||[]).forEach(r => totalSales += (r.sales||0));
    const avgPop = totalSales > 0 ? (100/db.recetas.length)*0.7 : 0;

    (db.recetas||[]).forEach(r => {
        const cost = calcRecipe(r).t;
        const margin = (r.pvp||0) - cost;
        const pop = totalSales>0 ? ((r.sales||0)/totalSales)*100 : 0;
        if(pop>=avgPop && margin>=6) stars++; else if(pop>=avgPop && margin<6) plows++;
        else if(pop<avgPop && margin>=6) puzzles++; else dogs++;
    });

    c.innerHTML = `
        <div class="glass-card">
            <div class="flex justify-between items-center bg-gray-50 p-4 rounded-xl mb-4">
                <div class="text-center"><div class="text-[10px] text-gray-400 font-bold">RANGO OMNES</div><div class="text-2xl font-black text-gray-800">${gama}</div></div>
                <div class="h-8 w-px bg-gray-200"></div>
                <div class="text-center"><div class="text-[10px] text-gray-400 font-bold">ESTADO</div><div class="text-sm font-bold ${gama<=3?'text-green-500':'text-red-500'}">${gama<=3?'OPTIMIZADO':'DESBALANCEADO'}</div></div>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-emerald-50 text-emerald-800 p-3 rounded-xl text-center border border-emerald-100"><div class="text-2xl font-black">${stars}</div><div class="text-[10px] font-bold">ESTRELLAS</div></div>
                <div class="bg-amber-50 text-amber-800 p-3 rounded-xl text-center border border-amber-100"><div class="text-2xl font-black">${plows}</div><div class="text-[10px] font-bold">CABALLOS</div></div>
                <div class="bg-blue-50 text-blue-800 p-3 rounded-xl text-center border border-blue-100"><div class="text-2xl font-black">${puzzles}</div><div class="text-[10px] font-bold">PUZZLES</div></div>
                <div class="bg-red-50 text-red-800 p-3 rounded-xl text-center border border-red-100"><div class="text-2xl font-black">${dogs}</div><div class="text-[10px] font-bold">PERROS</div></div>
            </div>
            <button class="btn-premium mt-6" onclick="editSales()">üìù ACTUALIZAR VENTAS (TPV)</button>
        </div>
    `;
}
function editSales() {
    const html = db.recetas.map(r => `<div class="flex justify-between items-center py-3 border-b border-gray-100"><span>${clean(r.n)}</span><input type="number" min="0" value="${r.sales||0}" class="bg-gray-50 border border-gray-200 rounded-lg w-20 text-center py-2 font-bold" onchange="updateSale('${r.id}', this.value)"></div>`).join('');
    showModal('Ventas Periodo', `<div class="max-h-[50vh] overflow-y-auto pr-2">${html}</div><button class="btn-premium mt-4" onclick="closeModal();renderAdmin(document.getElementById('app'))">Guardar y Recalcular</button>`);
}
function updateSale(id,v){ const r=db.recetas.find(x=>x.id===id); if(r){ r.sales=Math.max(0,parseFloat(v)); save(); }}

/* ================= 6. COCINA PRO (FICHA T√âCNICA) ================= */
function renderCocina(app) {
    app.innerHTML = `<div class="glass-card"><div class="flex justify-between items-center mb-4"><h2 class="font-black text-xl text-gray-800">RECETARIO</h2><button class="btn-premium w-auto px-4 py-2 text-xs" onclick="editRec()">+ NUEVA</button></div>
    ${db.recetas.map(r => {
        const c = calcRecipe(r);
        return `<div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm mb-2 cursor-pointer hover:shadow-md transition" onclick="viewRec('${r.id}')">
            <div class="flex justify-between">
                <div class="font-bold text-gray-800">${clean(r.n)}</div>
                <div class="font-black text-indigo-600">${c.t.toFixed(2)}‚Ç¨</div>
            </div>
            <div class="text-xs text-gray-400 mt-1">${c.all.map(k=>ALLERGENS.find(a=>a.k==k)?.i).join(' ')}</div>
        </div>`
    }).join('')}</div>`;
}

function calcRecipe(r) {
    let t=0, all=new Set();
    (r.items||[]).forEach(it => {
        if(it.type==='ing') {
            const i = db.ingredientes.find(x=>x.id===it.id);
            if(i) {
                const yieldFactor = (it.merma && it.merma > 0) ? (1 - (it.merma/100)) : 1;
                t += (it.q * i.cost) / yieldFactor; 
                (i.aller||[]).forEach(k=>all.add(k));
            }
        }
    });
    t += (r.time/60)*CONFIG.COST_HOUR;
    return {t, all:Array.from(all)};
}

function editRec(id) {
    const r = id ? db.recetas.find(x=>x.id===id) : {id:generateID(), n:'', pvp:0, time:10, items:[]};
    tempItems = JSON.parse(JSON.stringify(r.items));
    showModal('Ficha T√©cnica', `
        <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="col-span-2"><label>Nombre</label><input id="er-n" value="${clean(r.n)}" class="input-premium"></div>
            <div><label>PVP (‚Ç¨)</label><input type="number" id="er-pvp" value="${r.pvp}" class="input-premium"></div>
            <div><label>MO (min)</label><input type="number" id="er-time" value="${r.time}" class="input-premium"></div>
        </div>
        <div class="bg-gray-50 p-4 rounded-xl mb-4"><div id="er-list" class="space-y-2"></div></div>
        <div class="flex gap-2 items-end bg-white border border-gray-200 p-3 rounded-xl shadow-sm">
            <div class="flex-1"><label>Ingrediente</label><select id="er-sel" class="input-premium mb-0 bg-transparent border-0 p-0 text-sm font-bold"></select></div>
            <div class="w-16"><label>Kg</label><input id="er-q" type="number" class="input-premium mb-0 p-1 text-center" placeholder="0"></div>
            <div class="w-16"><label>Merma %</label><input id="er-m" type="number" class="input-premium mb-0 p-1 text-center" placeholder="0"></div>
            <button class="bg-indigo-600 text-white rounded-lg w-8 h-8 flex items-center justify-center font-bold" onclick="addItemToRec()">+</button>
        </div>
        <button class="btn-premium mt-6" onclick="saveRec('${r.id}')">GUARDAR FICHA</button>
    `);
    document.getElementById('er-sel').innerHTML = db.ingredientes.map(i=>`<option value="${i.id}">${clean(i.n)}</option>`).join('');
    renderRecItems();
}

function addItemToRec() {
    const id = document.getElementById('er-sel').value;
    const q = parseFloat(document.getElementById('er-q').value);
    const m = parseFloat(document.getElementById('er-m').value) || 0;
    if(id && q>0) { tempItems.push({type:'ing', id, q, merma:m}); renderRecItems(); }
}

function renderRecItems() {
    document.getElementById('er-list').innerHTML = tempItems.map((it, i) => {
        const ing = db.ingredientes.find(x=>x.id===it.id);
        const realQty = it.q / (1 - (it.merma/100)); 
        const cost = realQty * (ing?.cost || 0);
        return `<div class="flex justify-between items-center text-sm border-b border-gray-200 pb-2"><div><div class="font-bold text-gray-700">${clean(ing?.n)}</div><div class="text-xs text-gray-400">Bruto: ${it.q}kg | Merma: ${it.merma}%</div></div><div class="text-right"><div class="font-mono font-bold">${cost.toFixed(2)}‚Ç¨</div><button onclick="tempItems.splice(${i},1);renderRecItems()" class="text-red-400 text-xs">Borrar</button></div></div>`;
    }).join('');
}

function saveRec(id) {
    const idx = db.recetas.findIndex(x=>x.id===id);
    const r = { id, n:document.getElementById('er-n').value, pvp:parseFloat(document.getElementById('er-pvp').value), time:parseFloat(document.getElementById('er-time').value), items:tempItems, sales:(db.recetas.find(x=>x.id===id)?.sales || 0) };
    if(idx>=0) db.recetas[idx]=r; else db.recetas.push(r);
    save("Ficha Guardada"); closeModal(); render('Cocina');
}

function viewRec(id) {
    const r = db.recetas.find(x=>x.id===id); const c = calcRecipe(r);
    showModal(clean(r.n), `
        <div class="flex justify-around mb-6 bg-gray-50 p-4 rounded-xl">
            <div class="text-center"><div class="text-xs text-gray-400 font-bold">COSTE</div><div class="text-2xl font-black text-gray-800">${c.t.toFixed(2)}‚Ç¨</div></div>
            <div class="text-center"><div class="text-xs text-gray-400 font-bold">MARGEN</div><div class="text-2xl font-black text-indigo-600">${r.pvp > 0 ? ((1-(c.t/r.pvp))*100).toFixed(0) : 0}%</div></div>
        </div>
        <div class="flex flex-wrap gap-2 mb-6 justify-center">${c.all.map(k=>`<span class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-xs border border-blue-100">${ALLERGENS.find(a=>a.k==k)?.i} ${ALLERGENS.find(a=>a.k==k)?.n}</span>`).join('')}</div>
        <button class="btn-ghost w-full" onclick="editRec('${id}')">EDITAR DATOS T√âCNICOS</button>
    `);
}

/* ================= 7. STOCK & MERMAS (CONTROL TOTAL) ================= */
function renderStock(app) {
    const filtered = db.ingredientes.filter(i => i.n.toLowerCase().includes(searchFilter.toLowerCase()));
    app.innerHTML = `
        <div class="glass-card">
            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-800">ALMAC√âN</h3><button class="btn-ghost w-auto text-xs px-3 py-1" onclick="verMermas()">üìâ Ver Mermas</button></div>
            <input placeholder="üîç Buscar..." onkeyup="searchFilter=this.value;render('Stock')" value="${searchFilter}" class="input-premium">
            <div class="max-h-[60vh] overflow-y-auto">
                ${filtered.map(i => `
                    <div class="bg-white p-3 rounded-xl mb-2 border border-gray-100 shadow-sm flex justify-between items-center">
                        <div onclick="editIng('${i.id}')" class="flex-1 cursor-pointer">
                            <div class="font-bold text-gray-800">${clean(i.n)}</div>
                            <div class="text-xs text-gray-400">${i.stock} ${i.unit} ¬∑ ${i.cost.toFixed(2)}‚Ç¨</div>
                        </div>
                        <button class="bg-red-50 text-red-500 rounded p-2 text-xs font-bold" onclick="regMerma('${i.id}')">üóëÔ∏è</button>
                    </div>
                `).join('')}
            </div>
            <button class="btn-premium mt-4" onclick="editIng(generateID())">+ A√ëADIR PRODUCTO</button>
        </div>
    `;
}

function regMerma(id) {
    const i = db.ingredientes.find(x=>x.id===id);
    showModal('Registrar Merma', `
        <p class="text-sm text-gray-500 mb-4">Producto: <b>${clean(i.n)}</b></p>
        <label>Cantidad Perdida</label><input type="number" id="m-q" class="input-premium">
        <label>Motivo</label><select id="m-r" class="input-premium"><option>Caducidad</option><option>Rotura</option><option>Error Cocina</option><option>Otro</option></select>
        <button class="btn-danger w-full mt-4" onclick="saveMerma('${id}')">CONFIRMAR P√âRDIDA</button>
    `);
}

function saveMerma(id) {
    const i = db.ingredientes.find(x=>x.id===id);
    const q = parseFloat(document.getElementById('m-q').value);
    const r = document.getElementById('m-r').value;
    if(q>0) {
        i.stock -= q;
        db.mermas.push({ date:getISO(), n:i.n, q, reason:r, loss: q*i.cost });
        save("Merma registrada"); closeModal(); render('Stock');
    }
}

function verMermas() {
    const totalLoss = db.mermas.reduce((a,b)=>a+(b.loss||0),0);
    showModal('Historial de Mermas', `
        <div class="text-center mb-4"><h3 class="text-2xl font-black text-red-500">${totalLoss.toFixed(2)}‚Ç¨</h3><small>P√âRDIDAS TOTALES</small></div>
        <div class="max-h-64 overflow-y-auto">
            ${db.mermas.slice().reverse().map(m => `<div class="flex justify-between border-b py-2 text-sm"><span>${m.date} <b>${clean(m.n)}</b></span><span class="text-red-500 font-bold">-${m.loss.toFixed(2)}‚Ç¨</span></div>`).join('')}
        </div>
    `);
}

function editIng(id) {
    const i = db.ingredientes.find(x=>x.id===id) || {id, n:'', cost:0, stock:0, unit:'kg', aller:[]};
    showModal('Editar Stock', `
        <label>Nombre</label><input id="ei-n" value="${clean(i.n)}" class="input-premium">
        <div class="grid grid-cols-2 gap-4"><div><label>Coste</label><input id="ei-c" type="number" value="${i.cost}" class="input-premium"></div><div><label>Stock</label><input id="ei-s" type="number" value="${i.stock}" class="input-premium"></div></div>
        <label>Al√©rgenos</label><div class="flex flex-wrap gap-2 mt-2">${ALLERGENS.map(a=>`<div class="p-2 border rounded cursor-pointer ${i.aller.includes(a.k)?'bg-blue-100 border-blue-500':''}" onclick="this.classList.toggle('bg-blue-100');this.classList.toggle('border-blue-500');this.classList.toggle('active')">${a.i}</div>`).join('')}</div>
        <button class="btn-premium mt-6" onclick="saveIng('${i.id}')">GUARDAR</button>
    `);
    setTimeout(() => { const d = document.querySelectorAll('#m-body .flex div'); i.aller.forEach(k=>{ const idx=ALLERGENS.findIndex(a=>a.k===k); if(d[idx]) d[idx].classList.add('active','bg-blue-100','border-blue-500'); }); }, 50);
}

function saveIng(id) {
    const divs = document.querySelectorAll('#m-body .flex div');
    const aller = []; divs.forEach((d,i)=>{ if(d.classList.contains('active')) aller.push(ALLERGENS[i].k) });
    const ing = { id, n:document.getElementById('ei-n').value, cost:parseFloat(document.getElementById('ei-c').value), stock:parseFloat(document.getElementById('ei-s').value), unit:'kg', aller };
    const idx = db.ingredientes.findIndex(x=>x.id===id);
    if(idx>=0) db.ingredientes[idx]=ing; else db.ingredientes.push(ing);
    save(); closeModal(); render('Stock');
}

/* ================= 8. DIARIO (CAJA COMPLETA RECUPERADA) ================= */
function renderDiario(app){
    const today = getISO();
    const rep = db.diario.find(d => d.date === today) || {cash:0, card:0, other:0};
    const total = (rep.cash||0) + (rep.card||0) + (rep.other||0);
    
    app.innerHTML = `
    <div class="glass-card">
        <div class="section-header"><div class="title">CIERRE CAJA</div><div class="text-indigo-600 font-bold">${today}</div></div>
        <div class="space-y-3">
            <div><label>Efectivo</label><input type="number" id="z-cash" value="${rep.cash||0}" class="input-premium text-right font-bold" oninput="calcTotal()"></div>
            <div><label>Tarjeta</label><input type="number" id="z-card" value="${rep.card||0}" class="input-premium text-right font-bold" oninput="calcTotal()"></div>
            <div><label>Otros/Invit.</label><input type="number" id="z-other" value="${rep.other||0}" class="input-premium text-right font-bold" oninput="calcTotal()"></div>
            <div class="flex justify-between items-center pt-2 border-t mt-2">
                <span class="font-bold text-gray-500">TOTAL D√çA</span>
                <span id="z-total-display" class="text-2xl font-black text-indigo-600">${total.toFixed(2)}‚Ç¨</span>
            </div>
        </div>
        <button class="btn-premium mt-4" onclick="saveZ()">GUARDAR CIERRE</button>
    </div>
    <div class="glass-card"><canvas id="chartZ"></canvas></div>`;
    
    new Chart(document.getElementById('chartZ'), {
        type:'bar', 
        data:{
            labels:db.diario.slice(-7).map(d=>d.date.slice(5)), 
            datasets:[{label:'Ventas', data:db.diario.slice(-7).map(d=>d.total), backgroundColor:'#6366f1', borderRadius:6}]
        }
    });
}

function calcTotal() {
    const c = parseFloat(document.getElementById('z-cash').value)||0;
    const t = parseFloat(document.getElementById('z-card').value)||0;
    const o = parseFloat(document.getElementById('z-other').value)||0;
    document.getElementById('z-total-display').innerText = (c+t+o).toFixed(2) + '‚Ç¨';
}

function saveZ(){ 
    const cash = parseFloat(document.getElementById('z-cash').value)||0;
    const card = parseFloat(document.getElementById('z-card').value)||0;
    const other = parseFloat(document.getElementById('z-other').value)||0;
    const total = cash + card + other;
    
    const idx = db.diario.findIndex(d => d.date === getISO());
    if(idx >= 0) db.diario[idx] = { date: getISO(), cash, card, other, total };
    else db.diario.push({ date: getISO(), cash, card, other, total });
    
    save("Cierre OK"); render('Diario'); 
}

/* ================= 9. MODAL & UTILS ================= */
function showModal(t,c){ document.getElementById('m-title').innerText=t; document.getElementById('m-body').innerHTML=c; document.getElementById('modal-overlay').classList.remove('hidden'); }
function closeModal(){ document.getElementById('modal-overlay').classList.add('hidden'); }
function downloadBackup(){ const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(db)], {type:'application/json'})); a.download = `Arume_${getISO()}.json`; a.click(); }
function restoreBackup(input){ const r = new FileReader(); r.onload = e => { db=secure.dec(e.target.result); save("Restaurado"); location.reload(); }; r.readAsText(input.files[0]); }

init();
</script>
</body>
</html>
