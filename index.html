<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>ARUME V152 ¬∑ FINAL</title>
    <meta name="theme-color" content="#0f172a">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* === BASE === */
        :root { --primary: #4f46e5; --dark: #0f172a; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f1f5f9; padding-bottom: 120px; -webkit-tap-highlight-color: transparent; user-select: none; overscroll-behavior-y: none; }

        /* === DIAMOND UI === */
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.5); box-shadow: 0 10px 30px -10px rgba(0,0,0,0.08); border-radius: 24px; padding: 24px; margin-bottom: 20px; position: relative; overflow: hidden; }
        .btn-premium { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white; padding: 16px; border-radius: 16px; font-weight: 700; font-size: 0.9rem; box-shadow: 0 8px 20px -5px rgba(15, 23, 42, 0.3); width: 100%; display: flex; justify-content: center; align-items: center; gap: 8px; cursor: pointer; border: none; transition: 0.1s; }
        .btn-premium:active { transform: scale(0.98); }
        .btn-action { background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%); } 
        .btn-whatsapp { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); }
        .btn-ghost { background: #f8fafc; color: #64748b; font-weight: 700; padding: 12px; border-radius: 12px; width: 100%; cursor: pointer; border: 1px solid #e2e8f0; }
        .input-premium { width: 100%; padding: 14px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 14px; outline: none; font-weight: 600; color: #334155; }
        .input-premium:focus { border-color: #4f46e5; background: white; }
        .btn-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 12px; cursor: pointer; }
        .btn-edit { background: #eff6ff; color: #3b82f6; } .btn-delete { background: #fef2f2; color: #ef4444; } .btn-merma { background: #fff7ed; color: #f97316; } 
        label { display: block; font-size: 0.7rem; font-weight: 800; color: #94a3b8; margin-bottom: 4px; text-transform: uppercase; }

        /* === NAV === */
        nav { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); padding: 12px 0; display: flex; justify-content: space-around; box-shadow: 0 -10px 40px rgba(0,0,0,0.05); z-index: 50; border-top: 1px solid rgba(255,255,255,0.5); padding-bottom: max(12px, env(safe-area-inset-bottom)); }
        nav button { flex: 1; background: none; border: none; color: #cbd5e1; display: flex; flex-direction: column; align-items: center; font-size: 0.65rem; font-weight: 700; transition: 0.3s; cursor: pointer; }
        nav button.active { color: #0f172a; transform: translateY(-4px); }
        nav button.active svg { fill: #0f172a; }
        nav button svg { width: 26px; height: 26px; fill: #cbd5e1; margin-bottom: 6px; }
        nav button.locked { opacity: 0.3; pointer-events: none; filter: grayscale(1); }

        /* === MODAL === */
        .modal { background: white; width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto; border-radius: 32px; padding: 24px; box-shadow: 0 40px 60px -20px rgba(0,0,0,0.3); animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.2s; }
        .hidden { display: none !important; }
        .overlay:not(.hidden) { opacity: 1; pointer-events: auto; }

        @media print {
            body { background: white; padding: 0; }
            nav, header, .btn-premium, .btn-ghost, .btn-icon, .input-premium, button, .overlay { display: none !important; }
            .overlay:not(.hidden) { position: static; display: block !important; opacity: 1; }
            .modal { box-shadow: none; border: none; width: 100%; height: auto; }
            .overlay:not(.hidden) ~ main { display: none; }
        }
    </style>
</head>
<body>

    <div id="loading-overlay" class="hidden fixed inset-0 bg-white/90 z-[300] flex justify-center items-center flex-col backdrop-blur-sm">
        <div class="w-12 h-12 border-4 border-slate-200 border-t-indigo-600 rounded-full animate-spin mb-4"></div>
        <div class="font-black text-slate-400 tracking-[0.3em] text-xs animate-pulse">GUARDANDO EN NUBE...</div>
    </div>

    <div id="toast-container" class="fixed top-6 left-1/2 -translate-x-1/2 z-[400] w-max pointer-events-none space-y-2"></div>
    <input type="file" id="backup-input" class="hidden" onchange="restoreBackup(this)">

    <header class="sticky top-0 z-40 px-6 py-4 flex justify-between items-center bg-white/80 backdrop-blur-xl border-b border-white/50 shadow-sm">
        <div>
            <h1 class="text-2xl font-black text-slate-900 tracking-tighter">ARUME <span class="text-emerald-500">V152</span></h1>
            <p class="text-[9px] text-slate-400 font-bold tracking-widest uppercase">Sistema Cloud Supabase</p>
        </div>
        <div class="bg-slate-100 px-3 py-1.5 rounded-full text-xs font-bold text-slate-600 flex items-center gap-2 cursor-pointer border border-slate-200" onclick="logout()">
            <div id="sync-dot" class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div> 
            <span id="user-name">Login</span>
        </div>
    </header>

    <main id="app" class="px-4 py-6 max-w-2xl mx-auto"></main>
    <nav id="navbar"></nav>

    <div id="modal-overlay" class="overlay hidden">
        <div class="modal">
            <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                <h3 id="m-title" class="text-lg font-black text-slate-800 uppercase tracking-tight"></h3>
                <button onclick="closeModal()" class="w-8 h-8 flex items-center justify-center bg-slate-50 rounded-full text-slate-400 hover:bg-slate-200 font-bold">‚úï</button>
            </div>
            <div id="m-body"></div>
        </div>
    </div>

    <div id="pin-screen" class="hidden bg-slate-950 fixed inset-0 z-[200] flex flex-col items-center justify-center text-white">
        <div class="mb-12 text-center">
            <h2 class="text-6xl font-black tracking-tighter mb-2">ARUME</h2>
            <p class="text-indigo-500 text-xs tracking-[0.5em] uppercase font-bold">Base de Datos en Tiempo Real</p>
        </div>
        <div id="pin-display" class="text-5xl font-mono mb-12 tracking-[0.5em] h-12 text-center opacity-80 font-bold">****</div>
        <div class="grid grid-cols-3 gap-4 w-72">
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold active:scale-95" onclick="pin(1)">1</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold active:scale-95" onclick="pin(2)">2</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold active:scale-95" onclick="pin(3)">3</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold active:scale-95" onclick="pin(4)">4</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold active:scale-95" onclick="pin(5)">5</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold active:scale-95" onclick="pin(6)">6</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold active:scale-95" onclick="pin(7)">7</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold active:scale-95" onclick="pin(8)">8</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold active:scale-95" onclick="pin(9)">9</button>
            <button class="w-20 h-20 rounded-full bg-red-500/20 text-red-400 font-bold active:scale-95" onclick="pin('C')">C</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold active:scale-95" onclick="pin(0)">0</button>
            <button class="w-20 h-20 rounded-full bg-emerald-500 text-white font-bold active:scale-95" onclick="pin('OK')">OK</button>
        </div>
    </div>

<script>
/* === 1. CONFIGURACI√ìN DEL MOTOR === */
const SUPABASE_URL = "https://awbgboucnbsuzojocbuy.supabase.co"; 
const SUPABASE_KEY = "sb_publishable_drOQ5PsFA8eox_aRTXNATQ_5kibM6ST";
const CONFIG = { COST_HOUR: 15 };

const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

/* === 2. UTILIDADES Y MOTORES === */
const Num = {
    parse: (str) => { if(!str)return 0; if(typeof str==='number')return str; let clean=String(str).replace(/[^0-9.,-]/g,'').replace(',','.'); return parseFloat(clean)||0; },
    fmt: (n) => (n||0).toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2}),
    csv: (n) => String(n||0).replace('.',',')
};
function clean(str) { return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
const generateID = () => Math.random().toString(36).substr(2,9);
const getISO = () => new Date().toLocaleDateString('en-CA');
const getTS = () => new Date().toLocaleString('es-ES');

// CONVERSOR UNIDADES MEJORADO
const UnitConverter = {
    normalize: (u) => {
        if(!u) return 'ud';
        u = String(u).toLowerCase().trim().replace('.','');
        if(['kg','kilo','k'].includes(u)) return 'kg';
        if(['g','gr','gramos'].includes(u)) return 'g';
        if(['l','litro','lt'].includes(u)) return 'l';
        if(['ml','mili','cl'].includes(u)) return 'ml';
        return 'ud';
    },
    convert: (q, from, to) => {
        from = UnitConverter.normalize(from); to = UnitConverter.normalize(to);
        if(from===to) return q;
        if(from==='kg' && to==='g') return q*1000;
        if(from==='g' && to==='kg') return q/1000;
        if(from==='l' && to==='ml') return q*1000;
        if(from==='ml' && to==='l') return q/1000;
        if(from==='kg' && to==='l') return q; 
        if(from==='l' && to==='kg') return q;
        return q;
    }
};

/* === 3. BASE DE DATOS INICIAL === */
const DB_INIT = { 
    users: [{id:'u1', n:'Gerencia', pin:'MDE1MA==', role:'admin'}, {id:'u2', n:'Equipo', pin:'MTExMQ==', role:'staff'}], 
    ingredientes: [], recetas: [], proveedores: [{id:'p1', n:'Makro', tel:'', fam:'General'}], 
    albaranes: [], facturas: [], diario: [], mermas: [], kardex: [], sales_history: [], lastSync: 0 
};
const secure = { enc: d => btoa(encodeURIComponent(JSON.stringify(d))), dec: d => JSON.parse(decodeURIComponent(atob(d))) };

// Variables Globales
let db = DB_INIT, currentUser = null, currentPin = "", tempItems = [], activeAdminTab = 'dash', searchFilter = "";
let currentDiarioDate = getISO(), inventoryMode = false, activeFamily = 'Todos';
let fiscalYear = new Date().getFullYear(), fiscalQuarter = Math.floor(new Date().getMonth()/3)+1;
const ALLERGENS = [{k:'glu',i:'üåæ'},{k:'cru',i:'ü¶ê'},{k:'hue',i:'ü•ö'},{k:'pes',i:'üêü'},{k:'cac',i:'ü•ú'},{k:'soj',i:'ü´ò'},{k:'lac',i:'ü•õ'},{k:'fru',i:'üå∞'},{k:'api',i:'ü•¨'},{k:'mos',i:'üå≠'},{k:'ses',i:'üå±'},{k:'sul',i:'üç∑'},{k:'alt',i:'ü´ò'},{k:'mol',i:'üêô'}];
const FAMILIES = ['General','Carne','Pescado','Verdura','Secos','L√°cteos','Congelado','Bebida','Alcohol','Limpieza','Packaging'];
    /* === 4. SINCRONIZACI√ìN SUPABASE (EL CEREBRO) === */
async function syncDown() {
    try {
        const { data, error } = await sb.from('arume_data').select('data').eq('id', 1).single();
        if (data && data.data) {
            const cloudDB = data.data;
            if (cloudDB.lastSync > (db.lastSync || 0)) {
                // Si hay un modal abierto (usuario escribiendo), NO interrumpimos para no borrarle el trabajo
                if (!document.getElementById('modal-overlay').classList.contains('hidden')) return;
                
                db = cloudDB;
                localStorage.setItem('arume_v152', secure.enc(db));
                refreshCurrentView();
                toast("‚òÅÔ∏è Datos actualizados");
            }
        } else if (error && error.code === 'PGRST116') {
            console.log("Creando base de datos inicial...");
            await sb.from('arume_data').insert([{ id: 1, data: db }]);
        }
    } catch (e) { console.error("Sync Error", e); }
}

async function save(msg) {
    loading(true);
    try {
        db.lastSync = Date.now();
        localStorage.setItem('arume_v152', secure.enc(db)); // Copia de seguridad local instant√°nea
        
        const { error } = await sb.from('arume_data').upsert({ id: 1, data: db });
        if (error) throw error;
        
        if (msg) toast(msg, 'success');
    } catch (e) {
        toast("Error red. Guardado local OK.", "info");
        console.error(e);
    } finally { loading(false); }
}

function refreshCurrentView() {
    const activeBtn = document.querySelector('nav button.active');
    const view = activeBtn ? activeBtn.id.replace('btn-', '') : 'Cocina';
    render(view);
}

/* === 5. SISTEMA BASE (LOGIN & NAV) === */
function loading(s) { document.getElementById('loading-overlay').classList.toggle('hidden', !s); }
function toast(m, t='info') { const c=document.getElementById('toast-container'); const el=document.createElement('div'); el.className=`${t==='error'?'bg-red-500':'bg-slate-800'} text-white px-6 py-3 rounded-full shadow-xl font-bold text-xs animate-bounce mb-2`; el.innerText=m; c.appendChild(el); setTimeout(()=>el.remove(),3000); }
function isInPeriod(d) { if(!d)return false; const [y,m]=d.split('-'); if(parseInt(y)!==fiscalYear)return false; if(fiscalQuarter===0)return true; return Math.ceil(parseInt(m)/3)===fiscalQuarter; }

function init() {
    try { const s = localStorage.getItem('arume_v152'); if(s) db = secure.dec(s); } catch(e){}
    if(!db.users) db = DB_INIT;
    
    const u = localStorage.getItem('arume_user');
    if(u) { try { currentUser = db.users.find(x=>x.id===JSON.parse(u).id); } catch(e){} }

    if(currentUser) {
        document.getElementById('pin-screen').classList.add('hidden');
        loadApp();
        syncDown(); // Descargar datos al entrar
    } else {
        document.getElementById('pin-screen').classList.remove('hidden');
    }
    setInterval(syncDown, 3000); // Sincronizar cada 3 segundos
}

function pin(n) {
    if(n==='C') currentPin="";
    else if(n==='OK') {
        const u = db.users.find(x=>x.pin === btoa(currentPin));
        if(u) { currentUser=u; localStorage.setItem('arume_user', JSON.stringify(u)); document.getElementById('pin-screen').classList.add('hidden'); loadApp(); syncDown(); }
        else { toast("PIN Incorrecto","error"); currentPin=""; }
    } else if(currentPin.length<4) currentPin+=n;
    document.getElementById('pin-display').innerText = currentPin ? '*'.repeat(currentPin.length) : '****';
}

function logout(){ if(confirm("¬øCerrar sesi√≥n?")){ localStorage.removeItem('arume_user'); location.reload(); }}
function loadApp() { document.getElementById('user-name').innerText=currentUser.n; renderNav(); render(currentUser.role==='admin'?'Admin':'Cocina'); }

function renderNav() {
    const adm = currentUser?.role==='admin';
    const b = (id,l,i,lk) => `<button id="btn-${id}" class="${lk?'locked':''}" onclick="render('${id}')"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">${i}</svg><span>${l}</span></button>`;
    document.getElementById('navbar').innerHTML = 
        b('Diario','Caja','<path d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>',!adm) +
        b('Admin','Gesti√≥n','<path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>',!adm) +
        b('Cocina','Cocina','<path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>',false) +
        b('Stock','Stock','<path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>',false);
}
function render(v) {
    if((v==='Diario'||v==='Admin') && currentUser.role!=='admin') return toast("‚õî Solo Gerencia","error");
    document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
    document.getElementById(`btn-${v}`)?.classList.add('active');
    const app = document.getElementById('app');
    if(v==='Diario') renderDiario(app); else if(v==='Admin') renderAdmin(app); else if(v==='Cocina') renderCocina(app); else if(v==='Stock') renderStock(app);
}

/* === 6. ADMINISTRACI√ìN Y GESTI√ìN (OMNES, FACTURAS, ALBARANES) === */
function renderAdmin(app) {
    const tot = db.diario.filter(d=>isInPeriod(d.date)).reduce((a,b)=>a+(b.total||0),0);
    const periodAlbs = db.albaranes.filter(a=>isInPeriod(a.date));
    const compras = periodAlbs.reduce((a,b)=>a+(b.subtotal||0),0);
    const taxes = periodAlbs.reduce((a,b)=>a+(b.taxes||0),0);
    
    // C√°lculo te√≥rico de Food Cost
    let theoreticalCost = 0;
    db.sales_history.filter(log => isInPeriod(log.date)).forEach(log => {
        log.items.forEach(soldItem => {
            const rec = db.recetas.find(r => r.id === soldItem.rid);
            if(rec) theoreticalCost += (calcRecipe(rec).t * soldItem.q);
        });
    });
    const theoreticalMargin = tot - theoreticalCost;
    const foodCostPercent = tot > 0 ? (theoreticalCost / tot) * 100 : 0;
    const cashFlow = tot - (compras + taxes);

    const qCtrl = `<div class="flex items-center justify-between bg-white p-2 rounded-2xl shadow-sm mb-4 border border-slate-100"><div class="flex items-center gap-2 bg-slate-100 rounded-lg px-2 py-1"><button class="w-8 h-8 flex items-center justify-center hover:bg-white rounded-full transition font-bold" onclick="fiscalYear--;renderAdmin(document.getElementById('app'))">‚Äπ</button><span class="font-black text-slate-700 text-sm tracking-widest">${fiscalYear}</span><button class="w-8 h-8 flex items-center justify-center hover:bg-white rounded-full transition font-bold" onclick="fiscalYear++;renderAdmin(document.getElementById('app'))">‚Ä∫</button></div><div class="flex gap-1 overflow-x-auto no-scrollbar"><button class="px-2 py-1 rounded ${fiscalQuarter===1?'bg-slate-800 text-white':'bg-slate-100 text-slate-500'} text-xs font-bold" onclick="fiscalQuarter=1;renderAdmin(document.getElementById('app'))">1T</button><button class="px-2 py-1 rounded ${fiscalQuarter===2?'bg-slate-800 text-white':'bg-slate-100 text-slate-500'} text-xs font-bold" onclick="fiscalQuarter=2;renderAdmin(document.getElementById('app'))">2T</button><button class="px-2 py-1 rounded ${fiscalQuarter===3?'bg-slate-800 text-white':'bg-slate-100 text-slate-500'} text-xs font-bold" onclick="fiscalQuarter=3;renderAdmin(document.getElementById('app'))">3T</button><button class="px-2 py-1 rounded ${fiscalQuarter===4?'bg-slate-800 text-white':'bg-slate-100 text-slate-500'} text-xs font-bold" onclick="fiscalQuarter=4;renderAdmin(document.getElementById('app'))">4T</button><button class="px-2 py-1 rounded ${fiscalQuarter===0?'bg-slate-800 text-white':'bg-slate-100 text-slate-500'} text-xs font-bold" onclick="fiscalQuarter=0;renderAdmin(document.getElementById('app'))">A√ëO</button></div></div>`;

    app.innerHTML = `${qCtrl}
    <div class="flex gap-2 mb-6 bg-white p-1 rounded-2xl shadow-sm border border-slate-100 overflow-x-auto no-scrollbar">
        <button class="flex-1 min-w-[80px] py-2.5 rounded-xl font-bold text-xs transition ${activeAdminTab==='dash'?'bg-slate-800 text-white shadow-md':'text-slate-500 hover:bg-slate-50'}" onclick="activeAdminTab='dash';renderAdmin(document.getElementById('app'))">DASHBOARD</button>
        <button class="flex-1 min-w-[80px] py-2.5 rounded-xl font-bold text-xs transition ${activeAdminTab==='omnes'?'bg-slate-800 text-white shadow-md':'text-slate-500 hover:bg-slate-50'}" onclick="activeAdminTab='omnes';renderAdmin(document.getElementById('app'))">OMNES</button>
        <button class="flex-1 min-w-[80px] py-2.5 rounded-xl font-bold text-xs transition ${activeAdminTab==='albs'?'bg-slate-800 text-white shadow-md':'text-slate-500 hover:bg-slate-50'}" onclick="activeAdminTab='albs';renderAdmin(document.getElementById('app'))">COMPRAS</button>
        <button class="flex-1 min-w-[80px] py-2.5 rounded-xl font-bold text-xs transition ${activeAdminTab==='facturas'?'bg-slate-800 text-white shadow-md':'text-slate-500 hover:bg-slate-50'}" onclick="activeAdminTab='facturas';renderAdmin(document.getElementById('app'))">FACTURAS</button>
        <button class="flex-1 min-w-[80px] py-2.5 rounded-xl font-bold text-xs transition ${activeAdminTab==='prov'?'bg-slate-800 text-white shadow-md':'text-slate-500 hover:bg-slate-50'}" onclick="activeAdminTab='prov';renderAdmin(document.getElementById('app'))">AGENDA</button>
    </div>
    
    ${activeAdminTab==='dash' ? `
        <div class="glass-card bg-gradient-to-br from-indigo-900 to-slate-900 text-white mb-4">
            <h3 class="text-xs uppercase tracking-widest mb-4 font-bold opacity-70">Resultados ${fiscalQuarter===0?'A√ëO':fiscalQuarter+'T'}</h3>
            <div class="flex justify-between items-end mb-4">
                <div><div class="text-3xl font-black">${Num.fmt(theoreticalMargin)}‚Ç¨</div><div class="text-[10px] uppercase font-bold">Margen Bruto</div></div>
                <div class="text-right"><div class="text-xl font-bold ${foodCostPercent>35?'text-red-400':'text-emerald-400'}">${Num.fmt(foodCostPercent)}%</div><div class="text-[10px] uppercase font-bold">Food Cost %</div></div>
            </div>
            <div class="flex text-[10px] gap-4 font-bold text-indigo-200/50 uppercase tracking-wide border-t border-white/10 pt-2">
                <span>Ventas: ${Num.fmt(tot)}‚Ç¨</span><span>Consumo: ${Num.fmt(theoreticalCost)}‚Ç¨</span>
            </div>
        </div>
        <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm mb-6">
            <h3 class="text-[10px] font-bold text-slate-400 uppercase mb-3">Flujo de Caja</h3>
            <div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-slate-600">Entradas</span><span class="font-bold text-emerald-600">+${Num.fmt(tot)}‚Ç¨</span></div>
            <div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-slate-600">Salidas (IVA inc)</span><span class="font-bold text-red-500">-${Num.fmt(compras+taxes)}‚Ç¨</span></div>
            <div class="border-t border-slate-100 pt-2 mt-2 flex justify-between items-center"><span class="text-xs font-black text-slate-800 uppercase">Saldo</span><span class="font-black text-lg ${cashFlow>=0?'text-slate-800':'text-red-600'}">${Num.fmt(cashFlow)}‚Ç¨</span></div>
        </div>
        <div class="grid grid-cols-2 gap-3"><button class="btn-ghost" onclick="downloadBackup()">üíæ BACKUP</button><button class="btn-ghost text-indigo-600" onclick="document.getElementById('backup-input').click()">üì§ RESTAURAR</button></div>
    ` : ''}
    <div id="adm-c"></div>`;

    const c = document.getElementById('adm-c');
    if(activeAdminTab==='omnes') renderOmnes(c);
    if(activeAdminTab==='albaranes') renderAlbaranes(c);
    if(activeAdminTab==='facturas') renderFacturas(c);
    if(activeAdminTab==='prov') renderProvs(c);
}

function renderProvs(c) { 
    const spendMap={}; db.albaranes.forEach(a=>{if(isInPeriod(a.date))spendMap[a.prov]=(spendMap[a.prov]||0)+a.total;});
    c.innerHTML = `<div class="glass-card"><div class="flex justify-between mb-4"><h3 class="font-bold">PROVEEDORES</h3><button class="btn-premium w-auto px-3 py-1 text-xs" onclick="editProv()">+ NUEVO</button></div><div class="space-y-2">${db.proveedores.map(p => `<div class="bg-white p-3 rounded-xl border flex justify-between items-center" onclick="editProv('${p.id}')"><div><div class="font-bold text-slate-800">${clean(p.n)}</div><div class="text-[10px] bg-slate-100 px-2 rounded inline-block">${p.fam}</div></div><div class="text-right font-bold text-slate-700">${Num.fmt(spendMap[p.n])}‚Ç¨</div></div>`).join('')}</div></div>`; 
}
function editProv(id) { const p = id ? db.proveedores.find(x=>x.id===id) : {id:generateID(), n:'', tel:'', fam:'General'}; const fams=FAMILIES.map(f=>`<option ${p.fam===f?'selected':''}>${f}</option>`).join(''); showModal('Proveedor', `<label>Nombre</label><input id="ep-n" value="${clean(p.n)}" class="input-premium mb-2" placeholder="Nombre"><label>Tel√©fono</label><input id="ep-t" value="${clean(p.tel)}" class="input-premium mb-2" placeholder="Tel√©fono"><label>Familia</label><select id="ep-f" class="input-premium mb-4">${fams}</select><div class="flex gap-2"><button class="btn-premium flex-1" onclick="saveProv('${p.id}')">GUARDAR</button>${id?`<button class="btn-ghost text-red-500 w-auto" onclick="delProv('${id}')">üóëÔ∏è</button>`:''}</div>`); }
function saveProv(id) { const n=document.getElementById('ep-n').value; if(n) { const p={id, n, tel:document.getElementById('ep-t').value, fam:document.getElementById('ep-f').value}; const idx=db.proveedores.findIndex(x=>x.id===id); if(idx>=0) db.proveedores[idx]=p; else db.proveedores.push(p); save("Guardado"); closeModal(); renderAdmin(document.getElementById('app')); } }
function delProv(id) { if(confirm("¬øBorrar?")) { db.proveedores=db.proveedores.filter(x=>x.id!==id); save("Borrado"); closeModal(); renderAdmin(document.getElementById('app')); } }

function renderAlbaranes(c) {
    const list = db.albaranes.filter(a=>isInPeriod(a.date)).slice().reverse();
    c.innerHTML = `<div class="glass-card"><h3 class="font-bold mb-4">ALBARANES</h3><button class="btn-premium mb-4" onclick="addAlb()">+ INTRODUCIR ALBAR√ÅN</button><div class="space-y-2">${list.map(a=>`<div class="bg-white p-3 rounded-xl border flex justify-between items-center"><div><div class="font-bold">${clean(a.prov)}</div><div class="text-xs text-slate-400">${a.date}</div></div><div class="text-right"><div class="font-bold">${Num.fmt(a.total)}‚Ç¨</div>${a.invoiced?'<span class="text-[9px] text-emerald-500 font-bold">FACTURADO</span>':`<button class="text-[9px] text-red-400 font-bold" onclick="deleteAlb('${a.id}')">BORRAR</button>`}</div></div>`).join('')}</div></div>`;
}
function addAlb() {
    showModal('Nuevo Albar√°n', `<input id="na-p" class="input-premium mb-2" placeholder="Proveedor" list="prov-list"><datalist id="prov-list">${db.proveedores.map(p=>`<option value="${p.n}">`).join('')}</datalist><input id="na-d" type="date" value="${getISO()}" class="input-premium mb-2"><input id="na-t" type="number" class="input-premium mb-4" placeholder="Total ‚Ç¨ (IVA inc)"><button class="btn-premium" onclick="saveAlb()">GUARDAR</button>`);
}
function saveAlb() {
    const p=document.getElementById('na-p').value; const t=parseFloat(document.getElementById('na-t').value);
    if(p && t) { 
        db.albaranes.push({id:generateID(), prov:p, date:document.getElementById('na-d').value, total:t, subtotal:t/1.10, taxes:t-(t/1.10), invoiced:false}); 
        if(!db.proveedores.find(x=>x.n===p)) db.proveedores.push({id:generateID(), n:p, tel:'', fam:'General'});
        save("Albar√°n OK"); closeModal(); renderAdmin(document.getElementById('app')); 
    }
}
function deleteAlb(id) { if(confirm("¬øBorrar?")) { db.albaranes = db.albaranes.filter(a=>a.id!==id); save("Borrado"); renderAdmin(document.getElementById('app')); } }

function renderFacturas(c) {
    const pends = db.albaranes.filter(a=>!a.invoiced);
    const groups={}; pends.forEach(a=>{ if(!groups[a.prov]) groups[a.prov]={c:0,t:0,ids:[]}; groups[a.prov].c++; groups[a.prov].t+=a.total; groups[a.prov].ids.push(a.id); });
    const hist = db.facturas.filter(f=>isInPeriod(f.date)).slice().reverse();
    c.innerHTML = `${Object.keys(groups).length ? `<div class="glass-card"><h3 class="font-bold text-xs text-slate-400 mb-3 uppercase">Pendientes de Factura</h3>${Object.entries(groups).map(([p,d])=>`<div class="flex justify-between items-center py-2 border-b"><div><div class="font-bold text-slate-800">${clean(p)}</div><div class="text-xs text-slate-400">${d.c} albaranes</div></div><div class="flex items-center gap-3"><span class="font-bold">${Num.fmt(d.t)}‚Ç¨</span><button class="bg-indigo-600 text-white px-3 py-1 rounded-lg text-xs font-bold" onclick="invoice('${p}','${d.ids}')">GENERAR</button></div></div>`).join('')}</div>` : ''} <div class="glass-card"><h3 class="font-bold text-xs text-slate-400 mb-4 uppercase">Facturas ${fiscalQuarter}T</h3>${hist.map(f=>`<div class="flex justify-between py-2 border-b"><div><b>${clean(f.prov)}</b><div class="text-[10px]">${f.date}</div></div><div class="text-right"><b>${Num.fmt(f.total)}‚Ç¨</b><div onclick="togglePaid('${f.id}')" class="text-[9px] font-bold cursor-pointer ${f.paid?'text-emerald-500':'text-red-500'}">${f.paid?'PAGADO':'PENDIENTE'}</div></div></div>`).join('')}</div>`;
}
function invoice(p,ids) {
    const l=ids.split(','); let t=0;
    l.forEach(id=>{ const a=db.albaranes.find(x=>x.id===id); if(a){a.invoiced=true; t+=a.total;} });
    db.facturas.push({id:generateID(), date:getISO(), prov:p, total:t, paid:false});
    save("Factura Generada"); renderAdmin(document.getElementById('app'));
}
function togglePaid(id) { const f=db.facturas.find(x=>x.id===id); if(f){f.paid=!f.paid; save(); renderAdmin(document.getElementById('app'));} }

/* === 7. OMNES (INGENIER√çA DE MEN√ö) === */
function renderOmnes(c) {
    if (!db.recetas || db.recetas.length === 0) { c.innerHTML = `<div class="glass-card text-center"><h3>Sin datos</h3></div>`; return; }
    let totalSold=0, totalRev=0, totalCost=0; const salesMap={};
    db.sales_history.filter(log => isInPeriod(log.date)).forEach(log => { log.items.forEach(it => { const rid = it.rid || db.recetas.find(r => r.n === it.n)?.id; if (rid) salesMap[rid] = (salesMap[rid] || 0) + it.q; }); });
    const data = db.recetas.map(r => { const cost = calcRecipe(r).t; const sales = salesMap[r.id] || 0; totalSold += sales; totalRev += sales * r.pvp; totalCost += sales * cost; return { r, sales, cost, margin: r.pvp - cost }; });
    if (totalSold === 0) { c.innerHTML = `<div class="glass-card text-center"><h3 class="text-slate-400">Sin ventas</h3><button class="btn-premium mt-4" onclick="editSales()">REGISTRAR SERVICIO</button></div>`; return; }
    const avgMargin = (totalRev - totalCost) / totalSold; const popLimit = (100 / data.length) * 0.7;
    c.innerHTML = `<div class="glass-card bg-white"><div class="flex justify-between mb-4"><h3 class="font-bold">MATRIZ OMNES</h3><button class="btn-premium w-auto px-3 py-1 text-xs" onclick="editSales()">SERVICIOS</button></div>${data.sort((a,b)=>b.sales-a.sales).map(d => { if(d.sales===0)return ''; const isPop=(d.sales/totalSold)*100>=popLimit; const isRich=d.margin>=avgMargin; const type=isPop?(isRich?'üåü ESTRELLA':'üêé CABALLO'):(isRich?'üß© PUZZLE':'üêï PERRO'); return `<div class="flex justify-between py-2 border-b"><div><b>${clean(d.r.n)}</b><div class="text-[10px] text-slate-500">${type}</div></div><div class="text-right"><b>${d.sales}</b> <span class="text-xs">ut</span><div class="text-[10px]">Mg: ${Num.fmt(d.margin)}‚Ç¨</div></div></div>`; }).join('')}</div>`;
}
function editSales() {
    if (!db.recetas.length) return toast("No hay recetas", "error");
    const list = db.recetas.map(r => `<div class="flex justify-between items-center py-2 border-b"><span class="text-sm font-medium w-1/2">${clean(r.n)}</span><input type="number" min="0" placeholder="0" id="sale-${r.id}" class="bg-slate-50 border rounded-lg w-20 text-center py-2 font-bold outline-none"></div>`).join('');
    showModal('Ventas del D√≠a', `<div class="bg-blue-50 p-2 text-xs mb-4 text-blue-800">Introduce ventas para descontar stock.</div><div class="max-h-[50vh] overflow-y-auto pr-1 mb-4">${list}</div><button class="btn-premium" onclick="commitSales()">PROCESAR</button>`);
}
function commitSales() {
    let log = { id: generateID(), date: getTS(), items: [] }; let hasData = false;
    db.recetas.forEach(r => {
        const qty = Num.parse(document.getElementById(`sale-${r.id}`).value);
        if (qty > 0) {
            hasData = true; log.items.push({ rid: r.id, n: r.n, q: qty });
            r.items.forEach(it => {
                if (it.type === 'ing') {
                    const ing = db.ingredientes.find(x => x.id === it.id);
                    if (ing) {
                        const factor = UnitConverter.convert(1, it.unit||ing.unit, ing.unit);
                        const needed = (it.q * factor * qty) / (it.merma ? (1-(it.merma/100)) : 1);
                        ing.stock -= needed;
                        logStock(ing.id, needed, 'OUT', `Venta: ${r.n}`, ing.cost);
                    }
                }
            });
        }
    });
    if (hasData) { db.sales_history.push(log); save("Ventas procesadas"); closeModal(); renderAdmin(document.getElementById('app')); }
}

/* === COCINA & RECETAS === */
function renderCocina(app) {
    const list = db.recetas.sort((a,b)=>a.n.localeCompare(b.n));
    app.innerHTML = `<div class="glass-card"><div class="flex justify-between items-center mb-4"><h2 class="font-black text-xl text-slate-800">ESCANDALLOS</h2><button class="btn-premium w-auto px-4 py-3 text-xs" onclick="editRec()">Ôºã NUEVA</button></div><input placeholder="üîç Buscar..." onkeyup="filterRec(this.value)" class="input-premium mb-4"><div id="rec-grid" class="space-y-3">${renderRecGrid(list)}</div></div>`;
}
function renderRecGrid(list) {
    if(!list.length) return '<div class="text-center p-8 text-slate-400 border-2 border-dashed rounded-xl">Sin recetas.</div>';
    return list.map(r => {
        const c = calcRecipe(r); const fc = r.pvp>0 ? (c.t/r.pvp)*100 : 0;
        return `<div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm cursor-pointer flex justify-between items-center" onclick="viewRec('${r.id}')"><div><div class="font-bold text-slate-800">${clean(r.n)}</div><div class="text-xs text-slate-400">${r.items.length} Ingredientes ¬∑ ${r.time} min</div></div><div class="text-right"><div class="font-black text-slate-700">${Num.fmt(c.t)}‚Ç¨</div><div class="text-[10px] font-bold ${fc>35?'text-red-500':'text-emerald-500'}">FC: ${fc.toFixed(1)}%</div></div></div>`;
    }).join('');
}
function filterRec(txt) { document.getElementById('rec-grid').innerHTML = renderRecGrid(db.recetas.filter(r=>r.n.toLowerCase().includes(txt.toLowerCase()))); }
function calcRecipe(r, visited=new Set()) {
    if(!r || visited.has(r.id)) return {t:0}; visited.add(r.id);
    let t=0;
    (r.items||[]).forEach(it => {
        const yieldF = it.merma ? (1-(it.merma/100)) : 1;
        if(it.type==='ing'){
            const i = db.ingredientes.find(x=>x.id===it.id);
            if(i) t += (UnitConverter.convert(it.q, it.unit||i.unit, i.unit) * i.cost) / yieldF;
        } else if(it.type==='rec'){
            const sub = db.recetas.find(x=>x.id===it.id);
            if(sub) t += calcRecipe(sub, new Set(visited)).t * it.q;
        }
    });
    return {t: t + (r.time/60)*CONFIG.COST_HOUR};
}
function editRec(id) {
    const r = id ? db.recetas.find(x=>x.id===id) : {id:generateID(), n:'', pvp:0, time:10, items:[], inst:''};
    tempItems = JSON.parse(JSON.stringify(r.items||[]));
    showModal('Receta', `<div class="grid grid-cols-12 gap-3 mb-2"><div class="col-span-8"><label>Nombre</label><input id="er-n" value="${clean(r.n)}" class="input-premium font-bold"></div><div class="col-span-4"><label>PVP</label><input id="er-pvp" type="number" value="${r.pvp}" class="input-premium text-center"></div></div><label>Tiempo (min)</label><input id="er-time" type="number" value="${r.time}" class="input-premium mb-4"><div class="bg-slate-50 p-3 rounded-xl border mb-4"><div class="flex gap-2 mb-2"><select id="er-sel" class="input-premium text-sm" onchange="updUnit()"></select><input id="er-q" type="number" class="input-premium w-20 text-center" placeholder="Cant"><select id="er-u" class="input-premium w-20 text-xs bg-slate-200"></select><button class="bg-indigo-600 text-white rounded-lg w-10 font-bold" onclick="addItem()">+</button></div><div id="er-list" class="max-h-40 overflow-y-auto"></div></div><label>Instrucciones</label><textarea id="er-inst" class="input-premium mb-4" rows="3">${clean(r.inst)}</textarea><div class="flex gap-2"><button class="btn-premium flex-1" onclick="saveRec('${r.id}')">GUARDAR</button>${id?`<button class="btn-ghost w-auto text-red-500" onclick="delRec('${id}')">üóëÔ∏è</button>`:''}</div>`);
    renderRecTypes(); renderRecItems();
}
function renderRecTypes() {
    const sel = document.getElementById('er-sel');
    sel.innerHTML = db.ingredientes.sort((a,b)=>a.n.localeCompare(b.n)).map(i=>`<option value="${i.id}" data-t="ing">${clean(i.n)}</option>`).join('') + db.recetas.map(r=>`<option value="${r.id}" data-t="rec">ü•£ ${clean(r.n)}</option>`).join('');
    updUnit();
}
function updUnit() {
    const sel = document.getElementById('er-sel'); const uSel = document.getElementById('er-u');
    const type = sel.options[sel.selectedIndex]?.dataset.t; const id = sel.value;
    let opts = ['ud'];
    if(type==='ing') {
        const i = db.ingredientes.find(x=>x.id===id);
        if(i) {
            const u = UnitConverter.normalize(i.unit);
            if(['kg','g'].includes(u)) opts=['g','kg']; else if(['l','ml'].includes(u)) opts=['ml','l','cl']; else opts=[u];
        }
    } else opts=['rac'];
    uSel.innerHTML = opts.map(u=>`<option>${u}</option>`).join('');
}
function addItem() {
    const sel = document.getElementById('er-sel'); const type = sel.options[sel.selectedIndex].dataset.t;
    const q = parseFloat(document.getElementById('er-q').value);
    if(q>0) { tempItems.push({type, id:sel.value, q, unit:document.getElementById('er-u').value, merma:0}); renderRecItems(); }
}
function renderRecItems() {
    document.getElementById('er-list').innerHTML = tempItems.map((it,i) => {
        let n="?", icon="üì¶"; 
        if(it.type==='ing'){ const x=db.ingredientes.find(z=>z.id===it.id); if(x)n=x.n; } 
        else { const x=db.recetas.find(z=>z.id===it.id); if(x){n=x.n; icon="ü•£";} }
        return `<div class="flex justify-between py-2 border-b text-sm items-center"><div><span class="mr-2">${icon}</span><b>${n}</b></div><span>${it.q} ${it.unit}</span><button class="text-red-400 ml-2" onclick="tempItems.splice(${i},1);renderRecItems()">‚úï</button></div>`;
    }).join('');
}
function saveRec(id) {
    const n = document.getElementById('er-n').value; if(!n) return;
    const r = { id, n, pvp:parseFloat(document.getElementById('er-pvp').value)||0, time:parseFloat(document.getElementById('er-time').value)||0, items:tempItems, inst:document.getElementById('er-inst').value };
    const idx = db.recetas.findIndex(x=>x.id===id);
    if(idx>=0) db.recetas[idx]=r; else db.recetas.push(r);
    save("Ficha Guardada"); closeModal(); render('Cocina');
}
function delRec(id) { if(confirm("¬øBorrar?")) { db.recetas=db.recetas.filter(x=>x.id!==id); save("Borrada"); closeModal(); render('Cocina'); } }
function viewRec(id) {
    const r = db.recetas.find(x=>x.id===id); if(!r)return;
    window.renderIngsForCalc = (f) => r.items.map(it => {
        let n="?", q=it.q*f;
        if(it.type==='ing'){ const i=db.ingredientes.find(x=>x.id===it.id); if(i)n=i.n; } else { const s=db.recetas.find(x=>x.id===it.id); if(s)n="ü•£ "+s.n; }
        return `<li class="flex justify-between py-1 border-b border-slate-50"><span>${n}</span><span class="font-bold text-indigo-600">${Num.fmt(q)} ${it.unit}</span></li>`;
    }).join('');
    const c = calcRecipe(r);
    showModal(clean(r.n), `<div class="flex justify-between text-center mb-4 bg-slate-50 p-3 rounded-xl border"><div class="flex-1 border-r"><h6>COSTE</h6><b>${Num.fmt(c.t)}‚Ç¨</b></div><div class="flex-1"><h6>PVP</h6><b>${Num.fmt(r.pvp)}‚Ç¨</b></div></div><div class="bg-indigo-50 p-3 rounded-xl mb-4 flex items-center justify-between"><span>Multiplicador</span><input type="number" value="1" class="w-16 text-center font-bold text-xl bg-white rounded border border-indigo-200" oninput="document.getElementById('v-list').innerHTML=window.renderIngsForCalc(this.value)"></div><ul id="v-list" class="text-sm mb-4">${window.renderIngsForCalc(1)}</ul><p class="text-sm text-slate-600 bg-yellow-50 p-3 rounded-xl mb-4">${clean(r.inst)}</p><div class="flex gap-2"><button class="btn-ghost flex-1" onclick="window.print()">üñ®Ô∏è IMPRIMIR</button><button class="btn-premium flex-1" onclick="editRec('${id}')">EDITAR</button></div>`);
}

/* === STOCK & PEDIDOS === */
function renderStock(app) {
    const list = db.ingredientes.filter(i=>i.n.toLowerCase().includes(searchFilter.toLowerCase())).sort((a,b)=>a.n.localeCompare(b.n));
    app.innerHTML = `<div class="glass-card ${inventoryMode?'border-l-4 border-orange-500':''}"><div class="flex justify-between items-center mb-4"><h3 class="font-bold">${inventoryMode?'üìã AUDITOR√çA':'üì¶ ALMAC√âN'}</h3><div class="flex gap-2">${!inventoryMode?`<button class="btn-whatsapp text-xs px-3" onclick="sendWhatsApp()">üìû PEDIDO</button>`:''}<button class="btn-ghost text-xs px-3" onclick="toggleInventoryMode()">${inventoryMode?'SALIR':'AUDITAR'}</button></div></div><input class="input-premium mb-3" placeholder="Buscar..." onkeyup="searchFilter=this.value;render('Stock')" value="${searchFilter}"><div class="max-h-[60vh] overflow-y-auto space-y-2">${list.map(i => {
        const low = i.stock<(i.min||0);
        if(inventoryMode) return `<div class="bg-white p-3 rounded-xl border shadow-sm flex justify-between items-center"><div class="flex-1"><b>${clean(i.n)}</b><div class="text-[10px] text-slate-400">Te√≥rico: ${i.stock} ${i.unit}</div></div><div class="flex gap-2"><input id="rs-${i.id}" placeholder="${i.stock}" class="w-20 text-center bg-orange-50 border p-1 rounded font-bold"><button class="bg-emerald-500 text-white rounded w-8 h-8 font-bold" onclick="adjStock('${i.id}')">‚úî</button></div></div>`;
        return `<div class="bg-white p-3 rounded-xl border ${low?'border-red-300 bg-red-50':''} shadow-sm flex justify-between items-center"><div class="flex-1" onclick="editIng('${i.id}')"><b>${clean(i.n)}</b><div class="text-xs text-slate-500">${i.stock} ${i.unit}</div></div><div class="flex gap-2"><button class="btn-icon btn-merma" onclick="regMerma('${i.id}')">üìâ</button><button class="btn-icon btn-edit" onclick="editIng('${i.id}')">‚úèÔ∏è</button></div></div>`;
    }).join('')}</div>${!inventoryMode?`<button class="btn-premium mt-4" onclick="editIng(generateID())">+ PRODUCTO</button>`:''}</div>`;
}
function toggleInventoryMode() { inventoryMode=!inventoryMode; render('Stock'); if(inventoryMode) toast("Modo Auditor√≠a Activo"); }
function adjStock(id) {
    const v = parseFloat(document.getElementById(`rs-${id}`).value);
    const i = db.ingredientes.find(x=>x.id===id);
    if(!isNaN(v) && i) {
        logStock(i.id, Math.abs(v-i.stock), 'ADJ', 'Auditor√≠a', i.cost);
        i.stock = v; save("Stock Actualizado"); render('Stock');
    }
}
function sendWhatsApp() {
    const list = db.ingredientes.filter(i => i.stock < (i.min||0));
    if(!list.length) return toast("Stock Correcto ‚úÖ");
    const txt = "üõí *PEDIDO " + getTS() + "*\n\n" + list.map(i => `- ${Math.ceil((i.min-i.stock)*1.2)} ${i.unit} ${i.n}`).join('\n');
    window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`);
}
function logStock(id,q,t,r,p=0) { db.kardex.push({id:generateID(), date:getTS(), ingId:id, type:t, qty:q, reason:r, price:p}); }
function regMerma(id) {
    const i = db.ingredientes.find(x => x.id === id);
    showModal('Merma', `<p class="mb-4">Producto: <b>${clean(i.n)}</b></p><label>Cantidad (${i.unit})</label><input type="number" id="m-q" class="input-premium mb-4"><label>Motivo</label><select id="m-r" class="input-premium mb-4"><option>Caducidad</option><option>Rotura</option><option>Error</option></select><button class="btn-premium bg-red-500" onclick="saveMerma('${id}')">REGISTRAR P√âRDIDA</button>`);
}
function saveMerma(id) {
    const q=parseFloat(document.getElementById('m-q').value);
    if(q>0) { 
        const i=db.ingredientes.find(x=>x.id===id); 
        i.stock-=q; 
        db.mermas.push({date:getISO(), n:i.n, q, r:document.getElementById('m-r').value}); 
        logStock(id, q, 'OUT', 'Merma'); 
        save("Merma registrada"); closeModal(); render('Stock'); 
    }
}
function editIng(id) {
    const i = db.ingredientes.find(x=>x.id===id) || {id, n:'', cost:0, stock:0, min:0, unit:'kg', fam:'General'};
    showModal('Producto', `<label>Nombre</label><input id="ei-n" value="${clean(i.n)}" class="input-premium mb-2"><label>Familia</label><select id="ei-f" class="input-premium mb-2">${FAMILIES.map(f=>`<option ${i.fam===f?'selected':''}>${f}</option>`).join('')}</select><div class="grid grid-cols-3 gap-2"><div><label>Coste</label><input id="ei-c" type="number" value="${i.cost}" class="input-premium"></div><div><label>Stock</label><input id="ei-s" type="number" value="${i.stock}" class="input-premium"></div><div><label>M√≠n</label><input id="ei-m" type="number" value="${i.min}" class="input-premium"></div></div><label>Unidad</label><select id="ei-u" class="input-premium mb-4"><option ${i.unit==='kg'?'selected':''}>kg</option><option ${i.unit==='g'?'selected':''}>g</option><option ${i.unit==='l'?'selected':''}>l</option><option ${i.unit==='ml'?'selected':''}>ml</option><option ${i.unit==='ud'?'selected':''}>ud</option></select><button class="btn-premium" onclick="saveIng('${id}')">GUARDAR</button>${db.ingredientes.find(x=>x.id===id)?`<button class="btn-ghost text-red-500 mt-2" onclick="delIng('${id}')">BORRAR</button>`:''}`);
}
function saveIng(id) {
    const n=document.getElementById('ei-n').value; if(!n) return;
    const obj={id, n, fam:document.getElementById('ei-f').value, cost:parseFloat(document.getElementById('ei-c').value)||0, stock:parseFloat(document.getElementById('ei-s').value)||0, min:parseFloat(document.getElementById('ei-m').value)||0, unit:document.getElementById('ei-u').value};
    const idx=db.ingredientes.findIndex(x=>x.id===id);
    if(idx>=0) db.ingredientes[idx]=obj; else db.ingredientes.push(obj);
    save("Guardado"); closeModal(); render('Stock');
}
function delIng(id) { if(confirm("Borrar?")) { db.ingredientes=db.ingredientes.filter(x=>x.id!==id); save("Borrado"); closeModal(); render('Stock'); } }

/* === DIARIO (CAJA) === */
function renderDiario(app) {
    const r = db.diario.find(d => d.date === currentDiarioDate) || { cash:0, visa:0, total:0 };
    const hist = db.diario.filter(d=>isInPeriod(d.date)).sort((a,b)=>b.date.localeCompare(a.date)).map(d=>`<div class="flex justify-between py-2 border-b"><span>${d.date}</span><b>${Num.fmt(d.total)}‚Ç¨</b></div>`).join('');
    app.innerHTML = `<div class="glass-card"><div class="flex justify-between items-center mb-6"><h3 class="font-bold text-slate-800">CIERRE CAJA</h3><input type="date" value="${currentDiarioDate}" class="bg-slate-100 border-0 rounded-lg p-2 font-bold" onchange="currentDiarioDate=this.value;render('Diario')"></div><div class="space-y-4"><div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100"><h6>EFECTIVO</h6><input type="number" id="z-c" value="${r.cash}" class="input-premium text-center font-bold text-lg" onchange="calcZ()"></div><div class="bg-blue-50 p-4 rounded-xl border border-blue-100"><h6>TARJETAS</h6><input type="number" id="z-v" value="${r.visa}" class="input-premium text-center font-bold text-lg" onchange="calcZ()"></div><div class="flex justify-between pt-4 border-t"><span class="font-bold">TOTAL</span><span class="text-2xl font-black" id="z-t">${Num.fmt(r.total)}‚Ç¨</span></div><button class="btn-premium mt-4" onclick="saveZ()">GUARDAR CIERRE</button></div></div><div class="glass-card"><h3>Historial</h3>${hist}</div>`;
}
function calcZ() {
    const c=parseFloat(document.getElementById('z-c').value)||0; const v=parseFloat(document.getElementById('z-v').value)||0;
    document.getElementById('z-t').innerText = Num.fmt(c+v)+'‚Ç¨';
}
function saveZ() {
    const c=parseFloat(document.getElementById('z-c').value)||0; const v=parseFloat(document.getElementById('z-v').value)||0;
    const data = { date: currentDiarioDate, cash:c, visa:v, total:c+v };
    const idx = db.diario.findIndex(d=>d.date===currentDiarioDate);
    if(idx>=0) db.diario[idx]=data; else db.diario.push(data);
    save("Cierre Guardado"); render('Diario');
}

/* === UTILS === */
function downloadBackup(){ const d=secure.enc(db); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([d],{type:'text/plain'})); a.download=`Arume_Backup_${getISO()}.arume`; a.click(); }
function restoreBackup(input){ const r=new FileReader(); r.onload=e=>{ try{ db=secure.dec(e.target.result); save("Restaurado OK"); loadApp(); }catch(err){ toast("Error archivo","error"); } }; r.readAsText(input.files[0]); }
function showModal(t,c){ document.getElementById('m-title').innerText=t; document.getElementById('m-body').innerHTML=c; document.getElementById('modal-overlay').classList.remove('hidden'); }
function closeModal(){ document.getElementById('modal-overlay').classList.add('hidden'); }

// Init
init();
</script>
</body>
</html>
