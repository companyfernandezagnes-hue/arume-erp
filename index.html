<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>ARUME V160 ¬∑ Phoenix</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* EST√âTICA ORIGINAL RECUPERADA & MEJORADA */
        body { font-family: 'Poppins', sans-serif; background: #f0f4f8; padding-bottom: 120px; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        .glass-card { 
            background: rgba(255, 255, 255, 0.95); 
            border: 1px solid rgba(255, 255, 255, 0.6); 
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
            backdrop-filter: blur(8px);
            border-radius: 24px; 
            padding: 24px; 
            margin-bottom: 24px; 
        }
        
        /* BOTONES PREMIUM */
        .btn-premium { 
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); 
            color: white; padding: 16px; border-radius: 16px; 
            font-weight: 700; box-shadow: 0 10px 20px -5px rgba(15, 23, 42, 0.3); 
            width: 100%; display: flex; justify-content: center; align-items: center; gap: 8px; cursor: pointer;
            transition: all 0.2s; border: none;
        }
        .btn-premium:active { transform: scale(0.96); box-shadow: 0 4px 10px -2px rgba(0,0,0,0.3); }

        .btn-action { background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%); box-shadow: 0 10px 20px -5px rgba(79, 70, 229, 0.3); } 
        .btn-whatsapp { background: linear-gradient(135deg, #22c55e 0%, #15803d 100%); box-shadow: 0 10px 20px -5px rgba(34, 197, 94, 0.3); }
        .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); box-shadow: 0 10px 20px -5px rgba(239, 68, 68, 0.3); }
        
        .btn-ghost { background: #f1f5f9; color: #475569; font-weight: 600; padding: 12px; border-radius: 12px; width: 100%; cursor: pointer; border: 1px solid #cbd5e1; transition: 0.2s; }
        .btn-ghost:active { background: #e2e8f0; }

        .btn-icon { width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; border-radius: 12px; font-size: 1.1rem; cursor: pointer; border: none; transition: 0.2s; }
        .btn-edit { background: #eff6ff; color: #3b82f6; } 
        .btn-delete { background: #fef2f2; color: #ef4444; } 
        .btn-merma { background: #fff7ed; color: #f97316; } 
        .btn-log { background: #f0fdf4; color: #16a34a; }

        .input-premium { 
            width: 100%; padding: 14px; background: #f8fafc; 
            border: 2px solid #e2e8f0; border-radius: 14px; 
            outline: none; font-size: 15px; font-weight: 600; color: #334155;
            transition: 0.3s;
        }
        .input-premium:focus { border-color: #4f46e5; background: white; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); }

        /* NAV BAR */
        nav { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: rgba(255,255,255,0.95); backdrop-filter: blur(12px);
            padding: 12px 0; display: flex; justify-content: space-around; 
            box-shadow: 0 -4px 25px rgba(0,0,0,0.06); 
            z-index: 50; border-top: 1px solid #e2e8f0;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
        }
        nav button { flex: 1; background: none; border: none; color: #94a3b8; display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; font-weight: 600; transition: 0.2s; cursor: pointer; padding: 4px; }
        nav button.active { color: #4f46e5; transform: translateY(-4px); }
        nav button.active svg { fill: #4f46e5; filter: drop-shadow(0 4px 6px rgba(79,70,229,0.3)); }
        nav button svg { width: 26px; height: 26px; fill: #94a3b8; margin-bottom: 4px; transition: 0.2s; }
        nav button.locked { opacity: 0.3; filter: grayscale(1); pointer-events: none; }

        /* UTILS */
        #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.98); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 50px; height: 50px; border: 5px solid #e2e8f0; border-top: 5px solid #4f46e5; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(4px); z-index: 100; display: flex; align-items: center; justify-content: center; }
        .modal { background: white; width: 95%; max-width: 800px; max-height: 90vh; overflow-y: auto; border-radius: 28px; padding: 24px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        .hidden { display: none !important; }
        
        /* AL√âRGENOS RECUPERADOS */
        .aller-tag { 
            display: inline-flex; width: 26px; height: 26px; 
            align-items: center; justify-content: center; 
            background: #e0e7ff; border-radius: 50%; 
            font-size: 0.9rem; margin-right: 4px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .tax-pill { font-size: 10px; padding: 2px 6px; border-radius: 6px; background: #f1f5f9; color: #64748b; font-weight: 700; border: 1px solid #e2e8f0; }
        
        /* PERIOD SELECTOR */
        .period-btn { font-size: 11px; padding: 8px 12px; border-radius: 20px; font-weight: bold; background: #f1f5f9; color: #64748b; transition:0.2s; border: none; cursor: pointer; }
        .period-btn.active { background: #0f172a; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transform: translateY(-1px); }

        /* OMNES BADGES */
        .omnes-card { border-left: 6px solid; }
        .omnes-star { border-color: #10b981; background: #ecfdf5; }
        .omnes-plow { border-color: #f59e0b; background: #fffbeb; }
        .omnes-puzz { border-color: #3b82f6; background: #eff6ff; }
        .omnes-dog  { border-color: #ef4444; background: #fef2f2; }
    </style>
</head>
<body>

    <div id="loading-overlay" class="hidden">
        <div class="spinner mb-4"></div>
        <div class="font-bold text-gray-500 tracking-widest text-xs animate-pulse">CARGANDO...</div>
    </div>

    <div id="toast-container" class="fixed top-5 left-1/2 -translate-x-1/2 z-[300] pointer-events-none w-max"></div>
    <input type="file" id="backup-input" class="hidden" onchange="restoreBackup(this)">

    <header class="sticky top-0 z-40 px-6 py-4 flex justify-between items-center bg-white/90 backdrop-blur border-b border-gray-100">
        <div>
            <h1 class="text-3xl font-black text-slate-900 tracking-tight">ARUME <span class="text-indigo-600">V160</span></h1>
            <p class="text-[10px] text-gray-400 font-bold tracking-widest uppercase">Phoenix Edition</p>
        </div>
        <div class="bg-slate-100 px-4 py-2 rounded-full text-xs font-bold text-slate-600 flex items-center gap-2 cursor-pointer hover:bg-slate-200 transition" onclick="logout()">
            <div id="sync-dot" class="w-2 h-2 rounded-full bg-gray-400"></div> <span id="user-name">Login</span>
        </div>
    </header>

    <main id="app" class="px-4 py-6 max-w-4xl mx-auto"></main>
    <nav id="navbar"></nav>

    <div id="modal-overlay" class="overlay hidden">
        <div class="modal">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h3 id="m-title" class="text-xl font-black text-slate-800 uppercase tracking-wide"></h3>
                <button onclick="closeModal()" class="w-10 h-10 flex items-center justify-center bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200 text-xl font-bold transition hover:scale-110">‚úï</button>
            </div>
            <div id="m-body"></div>
        </div>
    </div>

    <div id="pin-screen" class="hidden bg-slate-900 fixed inset-0 z-[200] flex flex-col items-center justify-center text-white">
        <div class="mb-10 text-center">
            <h2 class="text-7xl font-black tracking-tighter mb-2 text-transparent bg-clip-text bg-gradient-to-r from-white to-slate-400">ARUME</h2>
            <p class="text-indigo-400 text-xs tracking-[0.5em] uppercase">Sistema Integral</p>
        </div>
        <div id="pin-display" class="text-5xl font-mono mb-12 tracking-[0.5em] h-12 text-center opacity-80">****</div>
        <div class="grid grid-cols-3 gap-6 w-72">
            <button class="pin-btn w-16 h-16 rounded-full border border-white/10 text-xl font-bold hover:bg-white/10 transition active:scale-95" onclick="pin(1)">1</button>
            <button class="pin-btn w-16 h-16 rounded-full border border-white/10 text-xl font-bold hover:bg-white/10 transition active:scale-95" onclick="pin(2)">2</button>
            <button class="pin-btn w-16 h-16 rounded-full border border-white/10 text-xl font-bold hover:bg-white/10 transition active:scale-95" onclick="pin(3)">3</button>
            <button class="pin-btn w-16 h-16 rounded-full border border-white/10 text-xl font-bold hover:bg-white/10 transition active:scale-95" onclick="pin(4)">4</button>
            <button class="pin-btn w-16 h-16 rounded-full border border-white/10 text-xl font-bold hover:bg-white/10 transition active:scale-95" onclick="pin(5)">5</button>
            <button class="pin-btn w-16 h-16 rounded-full border border-white/10 text-xl font-bold hover:bg-white/10 transition active:scale-95" onclick="pin(6)">6</button>
            <button class="pin-btn w-16 h-16 rounded-full border border-white/10 text-xl font-bold hover:bg-white/10 transition active:scale-95" onclick="pin(7)">7</button>
            <button class="pin-btn w-16 h-16 rounded-full border border-white/10 text-xl font-bold hover:bg-white/10 transition active:scale-95" onclick="pin(8)">8</button>
            <button class="pin-btn w-16 h-16 rounded-full border border-white/10 text-xl font-bold hover:bg-white/10 transition active:scale-95" onclick="pin(9)">9</button>
            <button class="pin-btn w-16 h-16 rounded-full bg-red-500/20 border border-red-500/50 text-red-300 font-bold active:scale-95" onclick="pin('C')">C</button>
            <button class="pin-btn w-16 h-16 rounded-full border border-white/10 text-xl font-bold hover:bg-white/10 transition active:scale-95" onclick="pin(0)">0</button>
            <button class="pin-btn w-16 h-16 rounded-full bg-emerald-500/20 border border-emerald-500/50 text-emerald-300 font-bold active:scale-95" onclick="pin('OK')">OK</button>
        </div>
        <p class="mt-8 text-slate-500 text-xs font-mono">0150: Gerencia | 1111: Equipo</p>
    </div>

<script>
/* ================= 1. UTILS ================= */
const Num={parse:s=>{if(!s)return 0;if(typeof s==='number')return s;return parseFloat(String(s).replace(/\./g,'').replace(',','.').replace(/[^\d\.\-]/g,''))||0},fmt:n=>(Number(n)||0).toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2}),csv:n=>String(n||0).replace('.',',')};
function clean(s){if(!s)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
const generateID=()=>Math.random().toString(36).substr(2,9);
const getISO=()=>new Date().toLocaleDateString('en-CA');
const getTS=()=>new Date().toLocaleString('es-ES');

/* ================= 2. CONFIG & DB ================= */
const CONFIG = { GOOGLE_URL: "https://script.google.com/macros/s/AKfycbxL0hWPiYmQ_590bkFjd1B9xwsfrYQXQtEuUpP2Nraq973bDr2rpEgVnaJCpI3-DH8z/exec" };
const ALLERGENS = [
    {k:'glu',i:'üåæ'},{k:'cru',i:'ü¶ê'},{k:'hue',i:'ü•ö'},{k:'pes',i:'üêü'},{k:'cac',i:'ü•ú'},{k:'soj',i:'ü´ò'},{k:'lac',i:'ü•õ'},
    {k:'fru',i:'üå∞'},{k:'api',i:'ü•¨'},{k:'mos',i:'üå≠'},{k:'ses',i:'üå±'},{k:'sul',i:'üç∑'},{k:'alt',i:'ü´ò'},{k:'mol',i:'üêô'}
];
const DB_INIT = { users:[{id:'u1',n:'Gerencia',pin:'0150',role:'admin'},{id:'u2',n:'Equipo',pin:'1111',role:'staff'}], ingredientes:[], recetas:[], proveedores:[{n:'Makro'}], albaranes:[], facturas:[], diario:[], mermas:[], kardex:[], sales_history:[], lastSync:0 };
const secure = { enc:d=>btoa(encodeURIComponent(JSON.stringify(d))), dec:d=>JSON.parse(decodeURIComponent(atob(d))) };

let db=DB_INIT, currentUser=null, currentPin="", tempItems=[], activeAdminTab='dash', searchFilter="", currentDiarioDate=getISO(), inventoryMode=false;
let fiscalYear = new Date().getFullYear(), fiscalQuarter = Math.floor(new Date().getMonth()/3)+1;

/* ================= 3. SYSTEM ================= */
function loading(s){document.getElementById('loading-overlay').classList.toggle('hidden',!s)}
function toast(m,t='info'){const b=document.getElementById('toast-container'),e=document.createElement('div');e.className=`${t==='error'?'bg-red-500':'bg-slate-800'} text-white px-6 py-4 rounded-xl shadow-2xl font-bold text-sm mb-4 animate-bounce text-center backdrop-blur border border-white/20`;e.innerText=m;b.appendChild(e);setTimeout(()=>e.remove(),3000)}
function isInPeriod(d){if(!d)return false; if(fiscalQuarter===0)return new Date(d).getFullYear()===fiscalYear; const date=new Date(d); return date.getFullYear()===fiscalYear && (Math.floor(date.getMonth()/3)+1)===fiscalQuarter;}

function init(){
    try{const s=localStorage.getItem('arume_v125');if(s)db=secure.dec(s);}catch(e){console.warn("Reset DB");db=DB_INIT;}
    if(!db.users)db.users=DB_INIT.users; if(!db.kardex)db.kardex=[]; if(!db.sales_history)db.sales_history=[];
    const u=localStorage.getItem('arume_user');
    if(u){currentUser=JSON.parse(u);document.getElementById('pin-screen').classList.add('hidden');loadApp();}
    else document.getElementById('pin-screen').classList.remove('hidden');
    if(CONFIG.GOOGLE_URL) sync();
}
async function save(msg){
    loading(true); try{db.lastSync=Date.now();localStorage.setItem('arume_v125',secure.enc(db));
    if(CONFIG.GOOGLE_URL){const c=new AbortController();setTimeout(()=>c.abort(),4000);await fetch(CONFIG.GOOGLE_URL,{method:'POST',mode:'no-cors',body:JSON.stringify(db),signal:c.signal}).catch(()=>{});}
    if(msg)toast(msg,'success');}catch(e){toast("Error guardando","error");}finally{loading(false);}
}
async function sync(){if(!CONFIG.GOOGLE_URL)return;try{const r=await fetch(CONFIG.GOOGLE_URL);const c=await r.json();if(c&&c.lastSync>(db.lastSync||0)){db=c;localStorage.setItem('arume_v125',secure.enc(db));loadApp();toast("Sincronizado");}}catch(e){}}

function pin(n){
    if(n==='C')currentPin=""; else if(n==='OK'){const u=db.users.find(x=>x.pin===currentPin);if(u){currentUser=u;localStorage.setItem('arume_user',JSON.stringify(u));document.getElementById('pin-screen').classList.add('hidden');loadApp();}else{toast("PIN Incorrecto","error");currentPin="";}}
    else if(String(currentPin).length<6)currentPin+=n; document.getElementById('pin-display').innerText=currentPin?'*'.repeat(currentPin.length):'****';
}
function logout(){if(confirm("¬øCerrar sesi√≥n?")){localStorage.removeItem('arume_user');location.reload();}}

/* ================= 4. LOGIC ================= */
const UnitConverter = {
    normalize: u => {if(!u)return 'ud';u=u.toLowerCase().trim();if(['kg','kilo'].includes(u))return 'kg';if(['g','gr'].includes(u))return 'g';if(['l','litro'].includes(u))return 'l';if(['ml'].includes(u))return 'ml';return 'ud';},
    convert: (v,f,t)=>{f=UnitConverter.normalize(f);t=UnitConverter.normalize(t);if(f===t)return v;if(f==='kg'&&t==='g')return v*1000;if(f==='g'&&t==='kg')return v/1000;if(f==='l'&&t==='ml')return v*1000;if(f==='ml'&&t==='l')return v/1000;return v;}
};
function logStock(ingId,q,t,r,p=0){const i=db.ingredientes.find(x=>x.id===ingId);if(i)db.kardex.push({id:generateID(),ts:Date.now(),date:getTS(),ingId,n:i.n,type:t,qty:q,unit:i.unit,price:p,reason:r,user:currentUser?.n});}

/* ================= 5. UI ================= */
function loadApp(){document.getElementById('user-name').innerText=currentUser?.n;renderNav();render(currentUser?.role==='admin'?'Admin':'Cocina');}
function renderNav(){
    const a=currentUser?.role==='admin';
    const v=[{id:'Diario',l:'Caja',i:`<path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>`,r:!a},{id:'Admin',l:'Gesti√≥n',i:`<path d="M12 2L3 5v6c0 5 3.8 9.7 9 11 5.2-1.3 9-6 9-11V5l-9-3z"/>`,r:!a},{id:'Cocina',l:'Cocina',i:`<path d="M12 2C8.1 6 7 8 7 11c0 3.9 3.1 7 7 7s7-3.1 7-7c0-3-1.1-5-5-9z"/>`,r:false},{id:'Stock',l:'Stock',i:`<path d="M20 6H6v13h14V6zM4 4h15l1 1v16H3V4z"/>`,r:false}];
    document.getElementById('navbar').innerHTML=v.map(x=>`<button id="btn-${x.id}" class="${x.r?'locked':''}" onclick="render('${x.id}')"><svg viewBox="0 0 24 24">${x.i}</svg><span>${x.l}</span></button>`).join('');
}
function render(v){
    if((v==='Diario'||v==='Admin')&&currentUser?.role!=='admin')return toast("‚õî Acceso Restringido","error");
    document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));document.getElementById(`btn-${v}`)?.classList.add('active');
    const app=document.getElementById('app');
    if(v==='Diario')renderDiario(app);else if(v==='Admin')renderAdmin(app);else if(v==='Cocina')renderCocina(app);else if(v==='Stock')renderStock(app);
}

/* ================= 6. ADMIN ================= */
function renderAdmin(app){
    const s=db.diario.filter(d=>isInPeriod(d.date)).reduce((a,d)=>a+(d.total||0),0);
    const c=db.albaranes.filter(a=>isInPeriod(a.date)).reduce((a,d)=>a+(d.total||0),0);
    const tx=db.albaranes.filter(a=>isInPeriod(a.date)).reduce((a,d)=>a+(d.taxes||0),0);
    const p=s-c;
    const qC=`<div class="flex justify-center gap-2 mb-4">${[0,1,2,3,4].map(q=>`<button class="period-btn ${fiscalQuarter===q?'active':''}" onclick="fiscalQuarter=${q};renderAdmin(document.getElementById('app'))">${q===0?'A√ëO':'T'+q}</button>`).join('')}</div>`;
    app.innerHTML=`<div class="text-center font-bold text-slate-400 mb-2">${fiscalYear}</div>${qC}
    <div class="flex gap-2 mb-6 bg-white p-1 rounded-2xl shadow-sm border border-slate-100">${['dash','omnes','albaranes','facturas'].map(t=>`<button class="flex-1 py-2 rounded-xl font-bold text-xs ${activeAdminTab===t?'bg-slate-800 text-white':''}" onclick="activeAdminTab='${t}';renderAdmin(document.getElementById('app'))">${t.toUpperCase()}</button>`).join('')}</div><div id="adm-c"></div>`;
    const C=document.getElementById('adm-c');
    if(activeAdminTab==='dash')C.innerHTML=`<div class="glass-card bg-gradient-to-br from-slate-900 to-slate-800 text-white border-0"><div class="flex justify-between items-end mb-6"><div><div class="text-3xl font-black ${p>=0?'text-emerald-400':'text-red-400'}">${Num.fmt(p)}‚Ç¨</div><div class="text-xs opacity-60">Beneficio</div></div><div class="text-right"><div class="text-lg font-bold">${Num.fmt(s)}‚Ç¨</div><div class="text-xs opacity-60">Ventas</div></div></div><div class="h-2 bg-slate-700 rounded-full overflow-hidden flex"><div class="bg-emerald-500 h-full" style="width:${(s/(s+c)*100)||50}%"></div></div><div class="flex justify-between text-[10px] mt-2 font-bold text-slate-400"><span>INGRESOS</span><span>GASTOS (${Num.fmt(c)}‚Ç¨)</span></div></div><div class="glass-card"><div class="flex justify-between items-center"><span class="font-bold text-slate-600">IVA Soportado</span><span class="font-black text-xl text-indigo-600">${Num.fmt(tx)}‚Ç¨</span></div></div><button class="btn-ghost w-full" onclick="downloadBackup()">üíæ Copia Seguridad</button>`;
    else if(activeAdminTab==='omnes')renderOmnes(C);else if(activeAdminTab==='albaranes')renderAlbaranes(C);else if(activeAdminTab==='facturas')renderFacturas(C);
}

/* OMNES */
function renderOmnes(c){
    if(!db.recetas.length){c.innerHTML=`<div class="glass-card text-center"><p>Sin recetas</p><button class="btn-premium" onclick="render('Cocina')">Ir a Cocina</button></div>`;return;}
    let tS=0, tR=0, tC=0;
    const pSM={}; db.sales_history.filter(l=>isInPeriod(l.date)).forEach(l=>{l.items.forEach(i=>{const rid=i.rid||db.recetas.find(r=>r.n===i.n)?.id;if(rid)pSM[rid]=(pSM[rid]||0)+i.q})});
    const rD=db.recetas.map(r=>{const cd=calcRecipe(r);const s=db.sales_history.length?(pSM[r.id]||0):(r.sales||0);tS+=s;tR+=s*(r.pvp||0);tC+=s*cd.cost;return{r,s,m:(r.pvp||0)-cd.cost,c:cd.cost}});
    const aM=tS>0?(tR-tC)/tS:0; const pL=(tS>0?100/rD.length:0)*0.7;
    let h=''; rD.sort((a,b)=>b.s-a.s).forEach(d=>{if(d.s>0){const pop=(tS>0?(d.s/tS)*100:0)>=pL, rich=d.m>=aM, css=pop?(rich?'omnes-star':'omnes-plow'):(rich?'omnes-puzz':'omnes-dog'), typ=pop?(rich?'ESTRELLA':'CABALLO'):(rich?'PUZZLE':'PERRO');h+=`<div class="bg-white p-3 rounded-xl omnes-card mb-2 shadow-sm flex justify-between items-center ${css}"><div class="flex-1"><div class="font-bold text-slate-700">${clean(d.r.n)}</div><div class="text-[10px] font-bold opacity-70">${typ}</div></div><div class="text-right"><div class="font-black text-lg">${d.s}</div><div class="text-[10px]">VENDIDOS</div></div></div>`}});
    c.innerHTML=`<div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-800">An√°lisis</h3><button class="btn-premium btn-action w-auto px-4 py-2 text-xs" onclick="editSales()">üìù REGISTRAR SERVICIO</button></div>${h||'<div class="text-center p-8 border-2 border-dashed rounded-xl">Sin ventas</div>'}`;
}
function editSales(){
    if(!db.recetas.length)return toast("No hay recetas","error");
    const h=db.recetas.map(r=>`<div class="flex justify-between items-center py-2 border-b"><span class="text-sm font-medium w-1/2">${clean(r.n)}</span><input type="number" min="0" placeholder="0" id="sale-${r.id}" onclick="this.select()" class="input-premium w-20 text-center font-bold"></div>`).join('');
    showModal('Ventas del D√≠a',`<div class="bg-blue-50 p-3 rounded text-blue-800 text-xs mb-4">Introduce solo las ventas de hoy.</div><div class="max-h-60 overflow-auto pr-2">${h}</div><button class="btn-premium btn-action mt-4 w-full" onclick="commitSales()">PROCESAR</button>`);
}
function commitSales(){
    if(!confirm("¬øConfirmar? Se descontar√° stock."))return;
    let l={id:generateID(),date:getTS(),items:[]}, has=false;
    db.recetas.forEach(r=>{
        const q=Num.parse(document.getElementById(`sale-${r.id}`).value);
        if(q>0){ has=true; r.items.forEach(it=>{if(it.type==='ing'){const i=db.ingredientes.find(x=>x.id===it.id);if(i){let n=it.q*q;if(it.merma)n=n/(1-(it.merma/100));i.stock=(i.stock||0)-UnitConverter.convert(n,r.unit||'kg',i.unit);logStock(i.id,-n,'OUT',`Venta ${r.n}`)}}}); r.sales=(r.sales||0)+q; l.items.push({rid:r.id,n:r.n,q}); }
    });
    if(has){db.sales_history.push(l);save("Ventas procesadas");closeModal();renderAdmin(document.getElementById('app'));}else toast("Sin cantidades","error");
}

/* ALBARANES */
function renderAlbaranes(c){
    const pA=db.albaranes.filter(a=>isInPeriod(a.date)).slice().reverse();
    const pO=db.proveedores.map(p=>`<option value="${clean(p.n)}">`).join(''); const iO=db.ingredientes.map(i=>`<option value="${clean(i.n)}">`).join('');
    c.innerHTML=`<div class="glass-card"><h3 class="font-bold text-slate-700 text-sm mb-3">NUEVO ALBAR√ÅN <span id="edit-ind" class="hidden text-amber-500">(EDIT)</span></h3>
    <div class="grid grid-cols-2 gap-3 mb-3"><div><label>Prov</label><input id="alb-p" list="l-p" class="input-premium"><datalist id="l-p">${pO}</datalist></div><div><label>Fecha</label><input id="alb-d" type="date" class="input-premium" value="${getISO()}"></div><div><label>Ref</label><input id="alb-n" class="input-premium"></div><div><label>Prod</label><input id="alb-pr" class="input-premium"></div></div>
    <div class="mb-3"><textarea id="alb-txt" class="input-premium" rows="3" placeholder="Paste: Producto; Cant; Unidad; Precio; IVA"></textarea><div class="flex gap-2 mt-2"><button class="btn-premium btn-action" onclick="parseAlb()">Parsear</button><button class="btn-ghost" onclick="tempItems=[];renderAlbGrid()">Borrar</button></div></div>
    <datalist id="l-i">${iO}</datalist><div id="alb-g" class="mb-3"></div><div class="text-right font-bold text-xl mb-3" id="alb-t">0.00‚Ç¨</div><button class="btn-premium" onclick="commitAlb()">GUARDAR</button></div>
    <div class="glass-card"><h3 class="font-bold text-sm mb-2">HIST√ìRICO</h3><div>${pA.map(a=>`<div class="py-2 border-b flex justify-between"><div><b>${clean(a.prov)}</b> ${a.date}</div><div>${Num.fmt(a.total)}‚Ç¨ <button class="btn-ghost text-xs" onclick="viewAlb('${a.id}')">Ver</button>${!a.invoiced?` <button class="btn-ghost text-xs" onclick="editAlb('${a.id}')">Edit</button> <button class="btn-ghost text-xs text-red-500" onclick="delAlb('${a.id}')">X</button>`:''}</div></div>`).join('')}</div></div>`; renderAlbGrid();
}
function parseAlb(){ const t=document.getElementById('alb-txt').value.trim(); if(!t)return toast("Vac√≠o","error"); tempItems=[]; t.split(/\r?\n/).forEach(l=>{const p=l.split(';');if(p.length>=4)tempItems.push({n:p[0],q:Num.parse(p[1]),unit:UnitConverter.normalize(p[2]),p:Num.parse(p[3]),tax:Num.parse(p[4])})}); renderAlbGrid(); }
function renderAlbGrid(){ const e=document.getElementById('alb-g'); if(!e)return; e.innerHTML=tempItems.map((i,x)=>`<div class="bg-white p-2 rounded border mb-2 flex flex-wrap gap-2 items-center"><input list="l-i" value="${clean(i.n)}" onchange="tempItems[${x}].n=this.value" class="input-premium w-32"><input type="number" value="${i.q}" onchange="tempItems[${x}].q=parseFloat(this.value);renderAlbGrid()" class="input-premium w-20"><input type="number" value="${i.p}" onchange="tempItems[${x}].p=parseFloat(this.value);renderAlbGrid()" class="input-premium w-20"><select onchange="tempItems[${x}].tax=parseFloat(this.value);renderAlbGrid()" class="input-premium w-16"><option value="10" ${i.tax==10?'selected':''}>10</option><option value="21" ${i.tax==21?'selected':''}>21</option><option value="4" ${i.tax==4?'selected':''}>4</option></select><button class="text-red-500" onclick="tempItems.splice(${x},1);renderAlbGrid()">X</button></div>`).join(''); const t=tempItems.reduce((a,b)=>a+(b.q*b.p)*(1+(b.tax||0)/100),0); document.getElementById('alb-t').innerText=Num.fmt(t)+'‚Ç¨'; }
function commitAlb(){
    if(!tempItems.length)return toast("Vac√≠o","error"); const p=document.getElementById('alb-p').value, d=document.getElementById('alb-d').value;
    if(!p||!d)return toast("Faltan datos","error"); if(!db.proveedores.find(x=>x.n===p))db.proveedores.push({n:p});
    tempItems.forEach(it=>{
        const cn=it.n.trim(); let i=db.ingredientes.find(x=>x.n.trim().toLowerCase()===cn.toLowerCase()&&x.unit===it.unit);
        if(!i){i={id:generateID(),n:cn,stock:0,cost:0,unit:it.unit,aller:[]};db.ingredientes.push(i);}
        const cq=Math.max(0,i.stock||0), nq=cq+it.q; i.cost=nq>0?((cq*(i.cost||0))+(it.q*it.p))/nq:it.p; i.stock=(i.stock||0)+it.q; logStock(i.id,it.q,'IN',`Alb: ${p}`,it.p);
    });
    const b=tempItems.reduce((a,x)=>a+(x.q*x.p),0), tx=tempItems.reduce((a,x)=>a+(x.q*x.p)*((x.tax||0)/100),0);
    db.albaranes.push({id:generateID(),num:document.getElementById('alb-n').value,prov:p,productor:document.getElementById('alb-pr').value,date:d,items:JSON.parse(JSON.stringify(tempItems)),total:b+tx,taxes:tx,invoiced:false});
    save("Guardado"); tempItems=[]; renderAdmin(document.getElementById('app'));
}
function editAlb(id){ const a=db.albaranes.find(x=>x.id===id); if(!a)return; if(confirm("¬øEditar? Se revertir√° stock.")){ a.items.forEach(it=>{const i=db.ingredientes.find(x=>x.n.trim().toLowerCase()===it.n.trim().toLowerCase()&&x.unit===it.unit);if(i){i.stock-=it.q;logStock(i.id,-it.q,'REV',`Rev Alb`)}}); tempItems=JSON.parse(JSON.stringify(a.items)); db.albaranes=db.albaranes.filter(x=>x.id!==id); document.getElementById('alb-p').value=a.prov; document.getElementById('alb-d').value=a.date; document.getElementById('alb-n').value=a.num; document.getElementById('edit-ind').classList.remove('hidden'); renderAlbGrid(); window.scrollTo(0,0); } }
function delAlb(id){ const a=db.albaranes.find(x=>x.id===id); if(!a)return; if(confirm("¬øBorrar?")){ a.items.forEach(it=>{const i=db.ingredientes.find(x=>x.n.trim().toLowerCase()===it.n.trim().toLowerCase()&&x.unit===it.unit);if(i){i.stock-=it.q;logStock(i.id,-it.q,'DEL',`Del Alb`)}}); db.albaranes=db.albaranes.filter(x=>x.id!==id); save("Borrado"); renderAdmin(document.getElementById('app')); } }
function viewAlb(id){ const a=db.albaranes.find(x=>x.id===id); showModal('Detalle',`<table class="w-full text-sm"><thead><tr><th>P</th><th>Q</th><th>‚Ç¨</th></tr></thead><tbody>${a.items.map(i=>`<tr><td>${i.n}</td><td>${i.q}${i.unit}</td><td>${Num.fmt(i.p)}</td></tr>`).join('')}</tbody></table><div class="text-right font-bold mt-2">${Num.fmt(a.total)}‚Ç¨</div>`); }
function renderFacturas(c){ const p=db.albaranes.filter(a=>!a.invoiced); c.innerHTML=`<div class="glass-card"><h3 class="font-bold">Pendientes</h3><div class="mt-2">${p.map(a=>`<div class="py-2 border-b flex justify-between"><span>${a.prov} (${Num.fmt(a.total)}‚Ç¨)</span><button class="btn-ghost text-xs" onclick="inv('${a.id}')">Facturar</button></div>`).join('')||'Nada pendiente'}</div></div><div class="glass-card"><h3 class="font-bold">Hist√≥rico</h3><div>${db.facturas.filter(f=>isInPeriod(f.date)).slice().reverse().map(f=>`<div class="py-2 border-b flex justify-between"><span>${f.prov} - ${f.date}</span><span>${Num.fmt(f.total)}‚Ç¨</span></div>`).join('')}</div></div>`; }
function inv(id){ const a=db.albaranes.find(x=>x.id===id); if(a){ a.invoiced=true; db.facturas.push({id:generateID(),date:getISO(),prov:a.prov,total:a.total,paid:false}); save("Facturado"); renderAdmin(document.getElementById('app')); } }

/* ================= 7. COCINA ================= */
function renderCocina(app){
    app.innerHTML=`<div class="glass-card"><div class="flex justify-between items-center mb-4"><h2 class="font-black text-xl text-slate-800">RECETARIO</h2><button class="btn-premium w-auto px-4 py-2" onclick="editRec()">+ NUEVA</button></div><div class="space-y-2">${db.recetas.map(r=>{const c=calcRecipe(r); return `<div class="bg-white p-3 rounded-xl flex justify-between items-center shadow-sm"><div><div class="font-bold">${clean(r.n)}</div><div class="text-xs text-slate-400">PVP ${Num.fmt(r.pvp)} ‚Ä¢ Coste ${Num.fmt(c.cost)}</div><div class="mt-1">${c.aller.map(k=>`<span class="aller-tag">${ALLERGENS.find(a=>a.k==k)?.i}</span>`).join('')}</div></div><div><button class="btn-ghost text-xs" onclick="editRec('${r.id}')">Edit</button> <button class="btn-ghost text-xs text-red-500" onclick="delRec('${r.id}')">X</button></div></div>`}).join('')}</div></div>`;
}
function calcRecipe(r){ let cost=0, aller=new Set(); r.items.forEach(it=>{if(it.type==='ing'){const i=db.ingredientes.find(x=>x.id===it.id);if(i){let n=it.q; if(it.merma)n=n/(1-(it.merma/100)); cost+=(i.cost||0)*UnitConverter.convert(n,r.unit||'kg',i.unit); (i.aller||[]).forEach(a=>aller.add(a));}}}); return {cost,aller:Array.from(aller)}; }
function editRec(id){
    const r = id?db.recetas.find(x=>x.id===id):{id:generateID(),n:'',pvp:0,time:0,items:[],sales:0}; tempItems=JSON.parse(JSON.stringify(r.items));
    const opts=db.ingredientes.sort((a,b)=>a.n.localeCompare(b.n)).map(i=>`<option value="${i.id}">${i.n} (${i.unit})</option>`).join('');
    showModal('Receta',`<input id="rn" class="input-premium mb-2" value="${clean(r.n)}" placeholder="Nombre"><input id="rp" type="number" class="input-premium mb-2" value="${r.pvp}" placeholder="PVP"><div class="flex gap-2 mb-2"><select id="rsi" class="input-premium">${opts}</select><input id="rsq" type="number" class="input-premium w-20" placeholder="Cant"><input id="rsm" type="number" class="input-premium w-20" placeholder="Merma%"><button class="btn-premium w-auto" onclick="addIR()">+</button></div><div id="rl" class="max-h-40 overflow-auto mb-3"></div><button class="btn-premium" onclick="saveRec('${r.id}')">Guardar</button>`); renderRL();
}
function addIR(){ const id=document.getElementById('rsi').value, q=Num.parse(document.getElementById('rsq').value), m=Num.parse(document.getElementById('rsm').value); if(id&&q>0){ const i=db.ingredientes.find(x=>x.id===id); tempItems.push({type:'ing',id,n:i.n,q,merma:m}); renderRL(); } }
function renderRL(){ document.getElementById('rl').innerHTML=tempItems.map((i,x)=>`<div class="flex justify-between py-1 border-b text-sm"><span>${i.n} (${i.q})</span><button class="text-red-500" onclick="tempItems.splice(${x},1);renderRL()">x</button></div>`).join(''); }
function saveRec(id){ const idx=db.recetas.findIndex(x=>x.id===id); const r={id,n:document.getElementById('rn').value,pvp:Num.parse(document.getElementById('rp').value),items:tempItems,sales:db.recetas.find(x=>x.id===id)?.sales||0}; if(idx>=0)db.recetas[idx]=r; else db.recetas.push(r); save("Guardado"); closeModal(); render('Cocina'); }
function delRec(id){ if(confirm("¬øBorrar?")){db.recetas=db.recetas.filter(x=>x.id!==id); save("Borrado"); render('Cocina');} }

/* ================= 8. STOCK ================= */
function renderStock(app){
    const f = db.ingredientes.filter(i=>i.n.toLowerCase().includes(searchFilter.toLowerCase())).sort((a,b)=>a.n.localeCompare(b.n));
    const wa = f.filter(i=>i.stock<(i.min||0)).map(i=>`- ${i.n}: ${((i.min||0)-i.stock).toFixed(2)} ${i.unit}`).join('%0A');
    app.innerHTML = `<div class="glass-card"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-800">ALMAC√âN</h3><div class="flex gap-2"><button class="btn-whatsapp text-xs px-3 py-1 rounded" onclick="window.open('https://wa.me/?text=Pedido:%0A${wa}','_blank')">üìû PEDIDO</button><button class="btn-ghost text-xs" onclick="toggleInv()">${inventoryMode?'Salir':'Audit'}</button></div></div><input placeholder="üîç" onkeyup="searchFilter=this.value;render('Stock')" class="input-premium mb-4"><div class="max-h-[60vh] overflow-y-auto space-y-2">${f.map(i=>`<div class="bg-white p-3 rounded-xl border flex justify-between items-center ${i.stock<(i.min||0)?'border-red-300':''}"><div><div class="font-bold">${clean(i.n)}</div><div class="text-xs text-slate-500">${(i.aller||[]).map(k=>`<span class="aller-tag">${ALLERGENS.find(a=>a.k==k)?.i}</span>`).join('')} ${Num.fmt(i.stock)} ${i.unit}</div></div><div class="flex gap-2">${inventoryMode?`<input id="adj-${i.id}" type="number" class="w-20 border rounded p-1" placeholder="${i.stock}"><button class="btn-premium px-2" onclick="adjS('${i.id}')">OK</button>`:`<button class="btn-merma btn-icon" onclick="regM('${i.id}')">üìâ</button><button class="btn-edit btn-icon" onclick="editI('${i.id}')">‚úèÔ∏è</button>`}</div></div>`).join('')}</div>${currentUser.role==='admin' && !inventoryMode?`<button class="btn-premium mt-4" onclick="editI(generateID())">+ PRODUCTO</button>`:''}</div>`;
}
function toggleInv(){inventoryMode=!inventoryMode;render('Stock');}
function adjS(id){ const v=Num.parse(document.getElementById(`adj-${id}`).value); const i=db.ingredientes.find(x=>x.id===id); if(i && !isNaN(v)){ logStock(id,v-i.stock,'ADJ','Audit'); i.stock=v; save("Ajustado"); render('Stock'); } }
function regM(id){ showModal('Merma',`<input id="mq" type="number" class="input-premium mb-2" placeholder="Cant"><input id="mr" class="input-premium mb-2" placeholder="Motivo"><button class="btn-danger btn-premium" onclick="saveM('${id}')">Guardar</button>`); }
function saveM(id){ const i=db.ingredientes.find(x=>x.id===id), q=Num.parse(document.getElementById('mq').value), r=document.getElementById('mr').value; if(i&&q>0){ i.stock-=q; db.mermas.push({date:getTS(),n:i.n,q,r}); logStock(id,-q,'MERMA',r); save("Merma OK"); closeModal(); render('Stock'); } }
function editI(id){ const i=db.ingredientes.find(x=>x.id===id)||{id,n:'',stock:0,cost:0,min:0,unit:'kg',aller:[]}; const als=ALLERGENS.map((a,x)=>`<label class="mr-2 inline-block"><input type="checkbox" id="al-${x}" ${i.aller.includes(a.k)?'checked':''}> ${a.i}</label>`).join(''); showModal('Ingrediente',`<input id="in" class="input-premium mb-2" value="${clean(i.n)}" placeholder="Nombre"><div class="grid grid-cols-2 gap-2 mb-2"><input id="ic" type="number" class="input-premium" value="${i.cost}" placeholder="Coste"><input id="is" type="number" class="input-premium" value="${i.stock}" placeholder="Stock"></div><div class="grid grid-cols-2 gap-2 mb-2"><input id="im" type="number" class="input-premium" value="${i.min}" placeholder="Min"><select id="iu" class="input-premium"><option value="kg" ${i.unit=='kg'?'selected':''}>kg</option><option value="ud" ${i.unit=='ud'?'selected':''}>ud</option><option value="l" ${i.unit=='l'?'selected':''}>l</option></select></div><div class="mb-4">${als}</div><button class="btn-premium" onclick="saveI('${id}')">Guardar</button>`); }
function saveI(id){ const i=db.ingredientes.find(x=>x.id===id)||{id}; i.n=document.getElementById('in').value; i.cost=Num.parse(document.getElementById('ic').value); i.stock=Num.parse(document.getElementById('is').value); i.min=Num.parse(document.getElementById('im').value); i.unit=document.getElementById('iu').value; i.aller=[]; ALLERGENS.forEach((a,x)=>{if(document.getElementById(`al-${x}`).checked)i.aller.push(a.k)}); if(!db.ingredientes.find(x=>x.id===id))db.ingredientes.push(i); save("Guardado"); closeModal(); render('Stock'); }

/* ================= 9. DIARIO ================= */
function renderDiario(app){
    const r = db.diario.find(d => d.date === currentDiarioDate) || { cash:0, visa:0, tpv:0, amex:0, glovo:0, uber:0, apper:0, expenses:0 };
    const totalVenta = (r.cash||0) + (r.visa||0) + (r.tpv||0) + (r.amex||0) + (r.glovo||0) + (r.uber||0) + (r.apper||0);
    const realCash = (r.cash||0) - (r.expenses||0);
    const hist = db.diario.filter(d => isInPeriod(d.date)).sort((a,b) => b.date.localeCompare(a.date)).map(d => `<div class="py-2 border-b flex justify-between text-sm"><span>${d.date}</span><span>${Num.fmt(d.total)}‚Ç¨</span></div>`).join('');

    app.innerHTML = `<div class="glass-card"><div class="flex justify-between items-center mb-4"><h3 class="font-bold">CIERRE CAJA</h3><input type="date" value="${currentDiarioDate}" class="bg-transparent font-bold text-right" onchange="currentDiarioDate=this.value;render('Diario')"></div>
    <div class="space-y-3">
        <div class="bg-emerald-50 p-3 rounded-xl border border-emerald-100"><div class="text-xs font-bold text-emerald-800 uppercase">Efectivo</div><div class="grid grid-cols-2 gap-2 mt-1"><input id="z-cash" class="input-premium text-center" value="${r.cash||0}" oninput="calcZ()"><input id="z-exp" class="input-premium text-center text-red-500" value="${r.expenses||0}" oninput="calcZ()"></div><div class="text-right text-xs font-bold mt-1 text-emerald-700">Caj√≥n: <span id="z-real">${Num.fmt(realCash)}</span>‚Ç¨</div></div>
        <div class="bg-blue-50 p-3 rounded-xl border border-blue-100"><div class="text-xs font-bold text-blue-800 uppercase">Tarjetas</div><div class="grid grid-cols-3 gap-2 mt-1"><input id="z-visa" class="input-premium text-center" value="${r.visa||0}" oninput="calcZ()"><input id="z-tpv" class="input-premium text-center" value="${r.tpv||0}" oninput="calcZ()"><input id="z-amex" class="input-premium text-center" value="${r.amex||0}" oninput="calcZ()"></div></div>
        <div class="bg-orange-50 p-3 rounded-xl border border-orange-100"><div class="text-xs font-bold text-orange-800 uppercase">Apps</div><div class="grid grid-cols-3 gap-2 mt-1"><input id="z-glovo" class="input-premium text-center" value="${r.glovo||0}" oninput="calcZ()"><input id="z-uber" class="input-premium text-center" value="${r.uber||0}" oninput="calcZ()"><input id="z-apper" class="input-premium text-center" value="${r.apper||0}" oninput="calcZ()"></div></div>
        <div class="flex justify-between pt-2 border-t"><span class="font-bold">TOTAL</span><span id="z-total" class="font-black text-xl">${Num.fmt(totalVenta)}‚Ç¨</span></div>
    </div><button class="btn-premium mt-4" onclick="saveZ()">GUARDAR</button></div>
    <div class="glass-card"><h3 class="font-bold text-sm mb-2">Hist√≥rico</h3><div class="max-h-40 overflow-auto">${hist}</div></div>`;
}
function calcZ(){ 
    const v = id => Num.parse(document.getElementById(id).value); 
    const t = v('z-cash')+v('z-visa')+v('z-tpv')+v('z-amex')+v('z-glovo')+v('z-uber')+v('z-apper'); 
    document.getElementById('z-total').innerText = Num.fmt(t)+'‚Ç¨'; document.getElementById('z-real').innerText = Num.fmt(v('z-cash')-v('z-exp')); 
}
function saveZ(){
    const v = id => Num.parse(document.getElementById(id).value);
    const d = { date:currentDiarioDate, cash:v('z-cash'), expenses:v('z-exp'), visa:v('z-visa'), tpv:v('z-tpv'), amex:v('z-amex'), glovo:v('z-glovo'), uber:v('z-uber'), apper:v('z-apper') };
    d.total = d.cash+d.visa+d.tpv+d.amex+d.glovo+d.uber+d.apper;
    const idx = db.diario.findIndex(x=>x.date===d.date); if(idx>=0) db.diario[idx]=d; else db.diario.push(d);
    save("Cierre guardado"); render('Diario');
}

init();
</script>
</body>
</html>
