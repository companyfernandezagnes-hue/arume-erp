<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>ARUME V152 ¬∑ SUPABASE DIAMOND</title>
    <meta name="description" content="Sistema Integral de Gesti√≥n Hosteler√≠a">
    <meta name="theme-color" content="#0f172a">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> ```

    <style>
        /* === BASE === */
        :root { --primary: #4f46e5; --dark: #0f172a; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: #f1f5f9; 
            padding-bottom: 120px; /* Espacio para el men√∫ inferior */
            -webkit-tap-highlight-color: transparent; 
            user-select: none; 
            overscroll-behavior-y: none; /* Evita rebote en m√≥vil */
        }

        /* === EST√âTICA DIAMOND (CRISTAL) === */
        .glass-card { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255,255,255,0.5); 
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.08); 
            border-radius: 24px; 
            padding: 24px; 
            margin-bottom: 20px; 
            position: relative;
            overflow: hidden;
        }

        /* === BOTONES PRO === */
        .btn-premium { 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); 
            color: white; padding: 16px; border-radius: 16px; 
            font-weight: 700; font-size: 0.9rem;
            box-shadow: 0 8px 20px -5px rgba(15, 23, 42, 0.3); 
            width: 100%; display: flex; justify-content: center; align-items: center; gap: 8px; cursor: pointer;
            transition: transform 0.1s, box-shadow 0.2s; border: none;
            letter-spacing: 0.5px;
        }
        .btn-premium:active { transform: scale(0.98); box-shadow: 0 4px 10px rgba(15, 23, 42, 0.2); }

        .btn-action { background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%); box-shadow: 0 8px 20px -5px rgba(79, 70, 229, 0.4); } 
        .btn-whatsapp { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; box-shadow: 0 8px 20px -5px rgba(34, 197, 94, 0.4); }
        
        .btn-ghost { background: #f8fafc; color: #64748b; font-weight: 700; padding: 12px; border-radius: 12px; width: 100%; cursor: pointer; border: 1px solid #e2e8f0; transition: 0.2s; }
        .btn-ghost:active { background: #e2e8f0; }
        
        .btn-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 12px; font-size: 1.1rem; cursor: pointer; border: none; transition: 0.2s; }
        .btn-icon:active { transform: scale(0.9); }
        .btn-edit { background: #eff6ff; color: #3b82f6; } 
        .btn-delete { background: #fef2f2; color: #ef4444; } 
        .btn-merma { background: #fff7ed; color: #f97316; } 
        .btn-log { background: #f0fdf4; color: #16a34a; }

        /* === INPUTS MEJORADOS === */
        .input-premium { 
            width: 100%; padding: 14px; background: #f8fafc; 
            border: 2px solid #e2e8f0; border-radius: 14px; 
            outline: none; font-size: 14px; font-weight: 600; color: #334155;
            transition: 0.2s;
        }
        .input-premium:focus { border-color: #4f46e5; background: white; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); }
        label { display: block; font-size: 0.7rem; font-weight: 800; color: #94a3b8; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }

        /* === BARRA DE NAVEGACI√ìN === */
        nav { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: rgba(255,255,255,0.9); backdrop-filter: blur(20px);
            padding: 12px 0; display: flex; justify-content: space-around; 
            box-shadow: 0 -10px 40px rgba(0,0,0,0.05); 
            z-index: 50; border-top: 1px solid rgba(255,255,255,0.5);
            padding-bottom: max(12px, env(safe-area-inset-bottom));
        }
        nav button { flex: 1; background: none; border: none; color: #cbd5e1; display: flex; flex-direction: column; align-items: center; font-size: 0.65rem; font-weight: 700; transition: 0.3s; cursor: pointer; -webkit-tap-highlight-color: transparent; }
        nav button.active { color: #0f172a; transform: translateY(-4px); }
        nav button.active svg { fill: #0f172a; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2)); }
        nav button svg { width: 26px; height: 26px; fill: #cbd5e1; margin-bottom: 6px; transition: 0.3s; }
        nav button.locked { opacity: 0.3; pointer-events: none; filter: grayscale(1); }

        /* === UI ELEMENTS === */
        .modal { background: white; width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto; border-radius: 32px; padding: 24px; box-shadow: 0 40px 60px -20px rgba(0,0,0,0.3); animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.2s; }
        .overlay:not(.hidden) { opacity: 1; pointer-events: auto; }
        .hidden { display: none !important; }

        .tag { font-size: 0.65rem; font-weight: 800; padding: 4px 8px; border-radius: 6px; text-transform: uppercase; }
        .tag-green { background: #dcfce7; color: #166534; }
        .tag-red { background: #fee2e2; color: #991b1b; }

        /* === MODO IMPRESI√ìN (PAPEL) === */
        @media print {
            body { padding: 0; background: white; }
            nav, header, .btn-premium, .btn-ghost, .btn-icon, .input-premium, button, input, select, .overlay { display: none !important; }
            
            /* Forzar visualizaci√≥n del Modal si est√° abierto */
            .overlay:not(.hidden) { position: static; background: none; display: block !important; opacity: 1; }
            .modal { box-shadow: none; border: none; width: 100%; max-width: 100%; padding: 0; overflow: visible; height: auto; }
            
            /* Si hay modal abierto, ocultar el fondo (la app principal) */
            .overlay:not(.hidden) ~ main { display: none; }

            body, h1, h2, h3, div, span, p { color: black !important; -webkit-print-color-adjust: exact; }
            .glass-card, .modal { border: 1px solid #000; box-shadow: none; border-radius: 0; }
            p, li { page-break-inside: avoid; }
        }
        .contenedor-menu { 
        position: relative; 
        display: inline-block; 
        font-family: Arial, sans-serif; 
    }
    
    .btn-principal { 
        background-color: #4CAF50; 
        color: white; 
        padding: 12px 24px; 
        font-size: 16px; 
        border: none; 
        cursor: pointer; 
        border-radius: 5px; 
    }
    
    .btn-principal:hover { 
        background-color: #3e8e41; 
    }
    
    .contenido-opciones { 
        display: none; 
        position: absolute; 
        background-color: #f1f1f1; 
        min-width: 160px; 
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); 
        z-index: 1; 
        border-radius: 5px; 
        margin-top: 5px; 
    }
    
    .contenido-opciones a { 
        color: black; 
        padding: 12px 16px; 
        text-decoration: none; 
        display: block; 
    }
    
    .contenido-opciones a:hover { 
        background-color: #ddd; 
        border-radius: 5px; 
    }
    
    .mostrar { 
        display: block; 
    }
        /* Ocultar scrollbar pero permitir scroll (Est√©tica limpia) */
.no-scrollbar::-webkit-scrollbar { display: none; }
.no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

/* Scrollbar personalizada fina */
.custom-scrollbar::-webkit-scrollbar { width: 4px; }
.custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
.custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

/* Animaci√≥n suave */
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.animate-fade-in { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body>

    <div id="loading-overlay" class="hidden fixed inset-0 bg-white/90 z-[300] flex justify-center items-center flex-col backdrop-blur-sm">
        <div class="w-12 h-12 border-4 border-slate-200 border-t-indigo-600 rounded-full animate-spin mb-4"></div>
        <div class="font-black text-slate-400 tracking-[0.3em] text-xs animate-pulse">GUARDANDO EN NUBE...</div>
    </div>

    <div id="toast-container" class="fixed top-6 left-1/2 -translate-x-1/2 z-[400] w-max pointer-events-none space-y-2"></div>
    
    <input type="file" id="backup-input" class="hidden" onchange="restoreBackup(this)">

   <header class="sticky top-0 z-40 px-6 py-4 flex justify-between items-center bg-white/80 backdrop-blur-xl border-b border-white/50 shadow-sm">
    <div>
        <h1 class="text-2xl font-black text-slate-900 tracking-tighter">ARUME <span class="text-emerald-500">PRO</span></h1>
        <p class="text-[9px] text-slate-400 font-bold tracking-widest uppercase">Sistema Cloud Supabase</p>
    </div>

    <div class="contenedor-menu">
        <button onclick="mostrarOpciones()" class="btn-principal" style="padding: 8px 16px; font-size: 12px; background: #0f172a;">
            ‚öôÔ∏è Opciones ‚ñº
        </button>
        <div id="misOpciones" class="contenido-opciones">
            <a href="#" onclick="importProvsModal()">üì• Importar Proveedores</a>
            <a href="#" onclick="window.print()">üñ®Ô∏è Imprimir Pantalla</a>
            <a href="#" onclick="resetStockToZero()" style="color:red;">‚ö†Ô∏è Reset Stock</a>
        </div>
    </div>

    <div class="bg-slate-100 px-3 py-1.5 rounded-full text-xs font-bold text-slate-600 flex items-center gap-2 cursor-pointer hover:bg-slate-200 transition border border-slate-200" onclick="logout()">
        <div id="sync-dot" class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div> 
        <span id="user-name">Login</span>
    </div>
</header>
    <main id="app" class="p-4 pb-24 min-h-screen"></main>

<nav id="navbar"></nav> 

<div id="modal-overlay" class="overlay hidden">
        <div class="modal">
            <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                <h3 id="m-title" class="text-lg font-black text-slate-800 uppercase tracking-tight"></h3>
                <button onclick="closeModal()" class="w-8 h-8 flex items-center justify-center bg-slate-50 rounded-full text-slate-400 hover:bg-slate-200 hover:text-slate-800 text-lg font-bold transition">‚úï</button>
            </div>
            <div id="m-body"></div>
        </div>
    </div>

    <div id="pin-screen" class="hidden bg-slate-950 fixed inset-0 z-[200] flex flex-col items-center justify-center text-white">
        <div class="mb-12 text-center">
            <h2 class="text-6xl font-black tracking-tighter mb-2">ARUME</h2>
            <p class="text-indigo-500 text-xs tracking-[0.5em] uppercase font-bold">Gesti√≥n Integral</p>
        </div>
        <div id="pin-display" class="text-5xl font-mono mb-12 tracking-[0.5em] h-12 text-center opacity-80 font-bold">****</div>
        <div class="grid grid-cols-3 gap-4 w-72">
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold hover:bg-white/10 active:scale-95 transition" onclick="pin(1)">1</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold hover:bg-white/10 active:scale-95 transition" onclick="pin(2)">2</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold hover:bg-white/10 active:scale-95 transition" onclick="pin(3)">3</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold hover:bg-white/10 active:scale-95 transition" onclick="pin(4)">4</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold hover:bg-white/10 active:scale-95 transition" onclick="pin(5)">5</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold hover:bg-white/10 active:scale-95 transition" onclick="pin(6)">6</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold hover:bg-white/10 active:scale-95 transition" onclick="pin(7)">7</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold hover:bg-white/10 active:scale-95 transition" onclick="pin(8)">8</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold hover:bg-white/10 active:scale-95 transition" onclick="pin(9)">9</button>
            <button class="w-20 h-20 rounded-full bg-red-500/20 border border-red-500/50 text-red-400 font-bold active:scale-95 transition" onclick="pin('C')">C</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold hover:bg-white/10 active:scale-95 transition" onclick="pin(0)">0</button>
            <button class="w-20 h-20 rounded-full bg-emerald-500 text-white font-bold shadow-lg shadow-emerald-500/50 active:scale-95 transition" onclick="pin('OK')">OK</button>
       </div>
        <p class="mt-10 text-slate-800/20 text-[8px] font-mono uppercase tracking-[0.3em]">Acceso Restringido ¬∑ Diamond Audit</p>
    </div>
<script>
/* =============================================================
   ‚ö†Ô∏è 1. CONFIGURACI√ìN DEL MOTOR (SUPABASE & FINANZAS) ‚ö†Ô∏è
   ============================================================= */
const SUPABASE_URL = "https://awbgboucnbsuzojocbuy.supabase.co"; 
const SUPABASE_KEY = "sb_publishable_drOQ5PsFA8eox_aRTXNATQ_5kibM6ST";

// üî• CONFIGURACI√ìN DE COSTES FIJOS (AQU√ç EST√Å LA CLAVE) üî•
const CONFIG = { 
    COST_HOUR: 15,           // Coste hora cocinero
    FIXED_COST_MONTH: 40000, // TUS GASTOS FIJOS TOTALES (Alquiler, Luz, Personal...)
    EST_MONTHLY_SALES: 2500  // Raciones promedio que vendes al mes
};

// Inicializamos el cliente (El puente con la nube)
const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

/* === 2. UTILIDADES MATEM√ÅTICAS Y FORMATO (MEJORADO) === */

// üëáüëá PEGA ESTO AQU√ç (ES LO NUEVO) üëáüëá
const secure = { 
    enc: (data) => btoa(encodeURIComponent(JSON.stringify(data))), 
    dec: (str) => JSON.parse(decodeURIComponent(atob(str))) 
};
/* === 2. UTILIDADES MATEM√ÅTICAS Y FORMATO (MEJORADO) === */
const Num = {
    parse: (str) => { 
        if (!str) return 0; 
        if (typeof str === 'number') return str; 
        let clean = String(str).replace(/[^0-9.,-]/g, '').replace(/,/g, '.');
        const parts = clean.split('.');
        if (parts.length > 2) clean = parts.shift() + '.' + parts.join('');
        return parseFloat(clean) || 0; 
    },
    fmt: (n) => (n || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }),
    csv: (n) => String(n || 0).replace('.', ',')
};
function clean(str) { 
    return String(str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); 
}

const generateID = () => Math.random().toString(36).substr(2, 9);
const getISO = () => new Date().toLocaleDateString('en-CA');
const getTS = () => new Date().toLocaleString('es-ES');

/* === 3. CONVERSOR DE UNIDADES INTELIGENTE (MEJORADO) === */
const UnitConverter = {
    normalize: (u) => {
        if (!u) return 'ud';
        u = String(u).toLowerCase().trim().replace('.', '');
        if (['kg', 'kilo', 'k'].includes(u)) return 'kg';
        if (['g', 'gr', 'gramos'].includes(u)) return 'g';
        if (['mg', 'mili'].includes(u)) return 'mg';
        if (['lb', 'libra'].includes(u)) return 'lb';
        if (['oz', 'onza'].includes(u)) return 'oz';
        if (['l', 'litro', 'lt'].includes(u)) return 'l';
        if (['ml', 'mili'].includes(u)) return 'ml';
        if (['cl', 'centi'].includes(u)) return 'cl';
        return 'ud';
    },
    convert: (q, from, to) => {
        from = UnitConverter.normalize(from);
        to = UnitConverter.normalize(to);
        if (from === to) return q;
        const toG = { 'kg': 1000, 'g': 1, 'mg': 0.001, 'lb': 453.59, 'oz': 28.35 };
        const toMl = { 'l': 1000, 'ml': 1, 'cl': 10 };
        if (toG[from] && toG[to]) return q * (toG[from] / toG[to]);
        if (toMl[from] && toMl[to]) return q * (toMl[from] / toMl[to]);
        const valInBase = (toG[from] || toMl[from]) * q;
        if (valInBase) {
            const factorDestino = (toG[to] || toMl[to]);
            if (factorDestino) return valInBase / factorDestino;
        }
        return q; 
    }
};

/* === 4. ESTRUCTURA DE LA BASE DE DATOS === */
const DB_INIT = { 
    users: [
        {id:'u1', n:'Gerencia', pin:'MDE1MA==', role:'admin'}, 
        {id:'u2', n:'Equipo', pin:'MTExMQ==', role:'staff'}
    ], 
    ingredientes: [], recipes: [], proveedores: [{ id: 'p1', n: 'Makro', tel: '', fam: 'General' }], 
    albaranes: [], facturas: [], diario: [], mermas: [], kardex: [], sales_history: [], gastos_fijos: [], 
    eventos: [], listaSocios: ['Jeronimo', 'Pedro', 'Pau', 'Agnes'], lastSync: 0,
    config: { empresa: '', nif: '', iban: '', sufijo: '000' } // <--- NUEVO CAMPO SEGURO
};
/* === 5. VARIABLES GLOBALES DE ESTADO === */
let db = DB_INIT;
let currentUser = null;
let currentPin = "";
let tempItems = [];
let activeAdminTab = 'dash';
let searchFilter = "";
let currentDiarioDate = getISO();
let inventoryMode = false;
let activeFamily = 'Todos';
let tempAlgs = []; 
let fiscalYear = new Date().getFullYear();
let fiscalQuarter = Math.floor(new Date().getMonth() / 3) + 1;

const ALLERGENS = [{k:'glu',i:'üåæ'},{k:'cru',i:'ü¶ê'},{k:'hue',i:'ü•ö'},{k:'pes',i:'üêü'},{k:'cac',i:'ü•ú'},{k:'soj',i:'ü´ò'},{k:'lac',i:'ü•õ'},{k:'fru',i:'üå∞'},{k:'api',i:'ü•¨'},{k:'mos',i:'üå≠'},{k:'ses',i:'üå±'},{k:'sul',i:'üç∑'},{k:'alt',i:'ü´ò'},{k:'mol',i:'üêô'}];
const FAMILIES = ['General', 'Carne', 'Pescado', 'Verdura', 'Secos', 'L√°cteos', 'Congelado', 'Bebida', 'Alcohol', 'Limpieza', 'Packaging'];

/* =============================================================
   ‚ö†Ô∏è 6. MOTOR DE SINCRONIZACI√ìN (CON SEM√ÅFORO) ‚ö†Ô∏è
   ============================================================= */
let isSyncing = false;

// BAJAR DATOS
async function syncDown() {
    if (isSyncing) return; 
    isSyncing = true;
    try {
        const { data, error } = await sb.from('arume_data').select('data').eq('id', 1).single();
        if (data && data.data) {
            const cloudDB = data.data;
            if ((cloudDB.lastSync || 0) > (db.lastSync || 0)) {
                if (!document.getElementById('modal-overlay').classList.contains('hidden')) return;
                db = cloudDB;
                localStorage.setItem('arume_v152', secure.enc(db));
                refreshCurrentView();
                toast("‚òÅÔ∏è Datos actualizados", "success");
            }
        } else if (error && error.code === 'PGRST116') {
            await sb.from('arume_data').insert([{ id: 1, data: db }]);
        }
    } catch (e) { console.error("Error Sync:", e); } finally { isSyncing = false; }
}

// SUBIR DATOS
async function save(msg) {
    loading(true); isSyncing = true;
    try {
        db.lastSync = Date.now();
        localStorage.setItem('arume_v152', secure.enc(db)); 
        const { error } = await sb.from('arume_data').upsert({ id: 1, data: db });
        if (error) throw error;
        if (msg) toast(msg, 'success');
    } catch (e) { toast("Guardado local", "info"); console.error(e); } finally { loading(false); isSyncing = false; }
}

function refreshCurrentView() {
    const activeBtn = document.querySelector('nav button.active');
    const view = activeBtn ? activeBtn.id.replace('btn-', '') : 'Cocina';
    render(view);
}

/* === 7. HERRAMIENTAS VISUALES (UI HELPERS) === */
function loading(show) { document.getElementById('loading-overlay').classList.toggle('hidden', !show); }
function toast(msg, type = 'info') { 
    const container = document.getElementById('toast-container'); 
    const el = document.createElement('div'); 
    el.className = `${type === 'error' ? 'bg-red-500' : 'bg-slate-800'} text-white px-6 py-3 rounded-full shadow-xl font-bold text-xs tracking-wide animate-bounce mb-2`; 
    el.innerText = msg; container.appendChild(el); setTimeout(() => el.remove(), 3000); 
}
function isInPeriod(dateStr) { 
    if (!dateStr) return false; 
    const parts = dateStr.split('-'); 
    const year = parseInt(parts[0]); 
    const month = parseInt(parts[1]); 
    if (year !== fiscalYear) return false; 
    if (fiscalQuarter === 0) return true; 
    return Math.ceil(month / 3) === fiscalQuarter; 
}

/* === 8. L√ìGICA DE ARRANQUE Y LOGIN (PIN) === */
function init() {
    if (typeof db === 'undefined') window.db = {};
    try { const stored = localStorage.getItem('arume_v152'); if (stored) db = secure.dec(stored); } catch(e) { }
    
    // üõ°Ô∏è PARCHE DE SEGURIDAD GLOBAL: CREA CARPETAS SI NO EXISTEN
    if (!db.users) db.users = DB_INIT.users;
    if (!db.ingredientes) db.ingredientes = [];
    if (!db.recetas) db.recetas = [];
    if (!db.proveedores) db.proveedores = [{ id: 'p1', n: 'Makro', tel: '', fam: 'General' }];
    if (!db.albaranes) db.albaranes = [];
    if (!db.facturas) db.facturas = [];
    if (!db.diario) db.diario = [];
    if (!db.mermas) db.mermas = [];
    if (!db.kardex) db.kardex = [];
    if (!db.sales_history) db.sales_history = [];
    if (!db.gastos_fijos) db.gastos_fijos = [];
    if (!db.eventos) db.eventos = []; 
    if (!db.listaSocios) db.listaSocios = ['Jeronimo', 'Pedro', 'Pau', 'Agnes'];

    // üëá A√ëADIDO: CONFIGURACI√ìN FISCAL SEGURA üëá
    if (!db.config) db.config = { empresa: '', nif: '', iban: '', sufijo: '000' }; 

    const savedUser = localStorage.getItem('arume_user');
    if (savedUser) { 
        try { currentUser = db.users.find(x => x.id === JSON.parse(savedUser).id); } catch(e){} 
    }
    if (currentUser) {
        document.getElementById('pin-screen').classList.add('hidden');
        loadApp(); syncDown();
    } else {
        document.getElementById('pin-screen').classList.remove('hidden');
    }
    setInterval(syncDown, 10000); 
}
function pin(n) {
    if (n === 'C') { currentPin = ""; } 
    else if (n === 'OK') {
        const u = db.users.find(x => x.pin === btoa(currentPin));
        if (u) { 
            currentUser = u; 
            localStorage.setItem('arume_user', JSON.stringify(u)); 
            document.getElementById('pin-screen').classList.add('hidden'); 
            currentPin = ""; 
            loadApp(); 
            syncDown(); 
        } else { 
            toast("PIN Incorrecto", "error"); 
            currentPin = ""; 
        }
    } else if (currentPin.length < 4) { currentPin += n; }
    document.getElementById('pin-display').innerText = currentPin ? '*'.repeat(currentPin.length) : '****';
}

function logout() { 
    if (confirm("¬øCerrar sesi√≥n?")) { 
        localStorage.removeItem('arume_user'); 
        location.reload(); 
    } 
}
       /* =============================================================
   ‚ö†Ô∏è 9. SISTEMA DE NAVEGACI√ìN Y PANTALLAS ‚ö†Ô∏è
   ============================================================= */

// Carga la aplicaci√≥n con el nombre del usuario
function loadApp() {
    if (!currentUser) return; // Seguridad extra
    document.getElementById('user-name').innerText = currentUser.n;
    renderNav();
    // Si es admin va a Admin, si es cocinero va a Cocina
    render(currentUser.role === 'admin' ? 'Admin' : 'Cocina');
}

// Dibuja la barra de botones inferior seg√∫n permisos
function renderNav() {
    const adm = currentUser?.role === 'admin';
    
    // Helper para crear botones con HTML m√°s limpio
    const b = (id, label, iconPath, isLocked) => `
        <button id="btn-${id}" class="${isLocked ? 'locked' : ''}" onclick="render('${id}')">
            <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
                ${iconPath}
            </svg>
            <span>${label}</span>
        </button>`;

    // Definici√≥n de iconos (SVG)
    const icons = {
        diario: '<path d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>',
        admin: '<path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>',
        cocina: '<path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>',
        stock: '<path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>'
    };

    document.getElementById('navbar').innerHTML =
        b('Diario', 'Caja', icons.diario, !adm) +
        b('Admin', 'Gesti√≥n', icons.admin, !adm) +
        b('Cocina', 'Cocina', icons.cocina, false) +
        b('Stock', 'Stock', icons.stock, false);
}

// Controlador central de Vistas (El "Director de Orquesta")
function render(v) {
    // Protecci√≥n de seguridad
    if ((v === 'Diario' || v === 'Admin') && currentUser.role !== 'admin') {
        return toast("‚õî Solo Gerencia", "error");
    }

    // Efectos visuales de bot√≥n activo
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    const activeBtn = document.getElementById(`btn-${v}`);
    if (activeBtn) activeBtn.classList.add('active');

    const app = document.getElementById('app');

    // Enrutador (Router)
    if (v === 'Diario') renderDiario(app);
    else if (v === 'Admin') renderAdmin(app);
    else if (v === 'Cocina') renderCocina(app);
    else if (v === 'Stock') renderStock(app);
}
/* =============================================================
   ‚ö†Ô∏è 10. M√ìDULO DE ADMINISTRACI√ìN Y GESTI√ìN ‚ö†Ô∏è
   ============================================================= */
/* === WIDGET DE ALERTAS DE STOCK === */
function getStockAlerts() {
    // Filtramos productos por debajo del m√≠nimo definido
    const lowStock = db.ingredientes.filter(i => i.stock <= (i.min || 0));
    
    if (lowStock.length === 0) {
        return `
        <div class="bg-emerald-50 border border-emerald-100 p-4 rounded-2xl flex items-center gap-3 mb-6 shadow-sm">
            <div class="bg-emerald-100 p-2 rounded-full text-emerald-600">‚úÖ</div>
            <div>
                <h4 class="font-bold text-emerald-800 text-sm">Almac√©n Saludable</h4>
                <p class="text-[10px] text-emerald-600">Todo el stock est√° por encima del m√≠nimo.</p>
            </div>
        </div>`;
    }

    // Si hay alertas, las mostramos
    const itemsHtml = lowStock.map(i => {
        const percent = i.min > 0 ? (i.stock / i.min) * 100 : 0;
        let color = percent < 25 ? 'bg-red-500' : 'bg-orange-400';
        
        return `
        <div class="flex justify-between items-center py-2 border-b border-slate-50 last:border-0">
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full ${color} animate-pulse"></div>
                <span class="text-xs font-bold text-slate-700">${clean(i.n)}</span>
            </div>
            <div class="text-right">
                <span class="text-xs font-black text-slate-800">${parseFloat(i.stock).toFixed(1)} ${i.unit}</span>
                <div class="text-[9px] text-red-400 font-bold">M√≠n: ${i.min}</div>
            </div>
        </div>`;
    }).join('');

    return `
    <div class="bg-white border-l-4 border-red-500 shadow-md rounded-xl p-4 mb-6">
        <div class="flex justify-between items-center mb-3">
            <h3 class="font-black text-slate-800 text-xs uppercase tracking-widest flex items-center gap-2">
                ‚ö†Ô∏è ALERTA DE STOCK <span class="bg-red-100 text-red-600 px-2 py-0.5 rounded-full text-[9px]">${lowStock.length}</span>
            </h3>
            <button class="text-[10px] font-bold text-indigo-600 hover:underline" onclick="render('Stock')">VER ALMAC√âN</button>
        </div>
        <div class="max-h-40 overflow-y-auto pr-1 custom-scrollbar">
            ${itemsHtml}
        </div>
        <button class="w-full mt-3 btn-whatsapp text-[10px] py-2" onclick="sendWhatsApp()">üìû GENERAR PEDIDO AUTO</button>
    </div>`;
}

let myChart = null; // Variable global para el gr√°fico (UNA SOLA VEZ)

/* =============================================================
   ‚ö†Ô∏è DASHBOARD V8: CONTROL DE SOCIOS Y PERSONAL (LABOR COST) ‚ö†Ô∏è
   ============================================================= */

function renderAdmin(app) {
    // 1. DATA SAFEGUARDS
    if (!db.gastos_fijos) db.gastos_fijos = [];
    if (!db.eventos) db.eventos = [];

    // === A. CALCULAR INGRESOS ===
    const ventasCaja = db.diario.filter(d => isInPeriod(d.date)).reduce((a, b) => a + (b.total || 0), 0);
    const ingresosEventos = db.eventos.filter(e => isInPeriod(e.date)).reduce((a, b) => a + (Num.parse(b.ingreso) || 0), 0);
    const totalRevenue = ventasCaja + ingresosEventos;
    
    // Ticket Medio
    const totalPax = db.diario.filter(d => isInPeriod(d.date)).reduce((a,b) => a + (b.pax || 0), 0) + 
                     db.eventos.filter(e => isInPeriod(e.date)).reduce((a,b) => a + (e.pax || 0), 0);
    const ticketMedio = totalPax > 0 ? totalRevenue / totalPax : 0;

    // === B. SEPARACI√ìN EXTRICTA: RESTAURANTE VS SOCIOS ===
    let costeMateriaPrima = 0; 
    let gastosSocios = {};      
    let totalSocios = 0;

    // Recorremos TODOS los albaranes del periodo seleccionado
    db.albaranes.filter(a => isInPeriod(a.date)).forEach(a => {
        // Normalizamos el texto para evitar errores de may√∫sculas/min√∫sculas
        const socio = (a.socio || 'Arume').trim();
        
        if (socio === 'Arume' || socio === 'Restaurante') {
            costeMateriaPrima += a.total;
        } else {
            // Es un socio
            if (!gastosSocios[socio]) gastosSocios[socio] = 0;
            gastosSocios[socio] += a.total;
            totalSocios += a.total;
        }
    });

    // === C. ESTRUCTURA Y PERSONAL (LABOR COST) ===
    const monthlyFixed = db.gastos_fijos.reduce((a,b) => a + (b.freq==='mensual'?b.amount:b.amount/3), 0);
    const multiplier = fiscalQuarter === 0 ? 12 : 3; 
    const totalFijos = monthlyFixed * multiplier;

    // Personal: Asumimos un 40% de los gastos fijos como n√≥minas + el personal extra de eventos
    const personalFijoEstimado = totalFijos * 0.4; 
    const personalExtra = db.eventos.filter(e => isInPeriod(e.date)).reduce((a, b) => a + (Num.parse(b.personalExtra) || 0), 0);
    const totalPersonal = personalFijoEstimado + personalExtra;
    
    // Labor Cost % (Objetivo: < 35%)
    const laborCostPct = totalRevenue > 0 ? (totalPersonal / totalRevenue) * 100 : 0;

    // === D. KPIs FINANCIEROS ===
    const margenBruto = totalRevenue - costeMateriaPrima;
    const margenBrutoPct = totalRevenue > 0 ? (margenBruto / totalRevenue) * 100 : 0; // % Food Profit

    // Gastos Operativos Totales (Sin Socios)
    const gastosOperativos = totalFijos + personalExtra;
    const beneficioNeto = margenBruto - gastosOperativos;
    
    const margenContribucion = totalRevenue > 0 ? margenBruto / totalRevenue : 0;
    const breakEven = margenContribucion > 0 ? (totalFijos / margenContribucion) : 0;

    // Colores de estado
    const colorNeto = beneficioNeto > 0 ? 'text-emerald-400' : 'text-red-400';
    const colorLabor = laborCostPct > 35 ? 'text-red-500' : 'text-emerald-600';

    // Selector de Fecha
    const qCtrl = `
    <div class="flex items-center justify-between bg-white p-2 rounded-2xl shadow-sm mb-4 border border-slate-100">
        <div class="flex items-center gap-2 bg-slate-100 rounded-lg px-2 py-1">
            <button class="w-8 h-8 flex items-center justify-center hover:bg-white rounded-full transition font-bold" onclick="fiscalYear--;renderAdmin(document.getElementById('app'))">‚Äπ</button>
            <span class="font-black text-slate-700 text-sm tracking-widest">${fiscalYear}</span>
            <button class="w-8 h-8 flex items-center justify-center hover:bg-white rounded-full transition font-bold" onclick="fiscalYear++;renderAdmin(document.getElementById('app'))">‚Ä∫</button>
        </div>
        <div class="flex gap-1 overflow-x-auto no-scrollbar">
            ${[1, 2, 3, 4, 0].map(q => `
                <button class="px-3 py-1 rounded-lg ${fiscalQuarter === q ? 'bg-slate-800 text-white shadow-md' : 'bg-slate-100 text-slate-500'} text-xs font-bold transition" 
                onclick="fiscalQuarter=${q};renderAdmin(document.getElementById('app'))">
                    ${q === 0 ? 'ANUAL' : q + 'T'}
                </button>
            `).join('')}
        </div>
    </div>`;

    app.innerHTML = `
    ${qCtrl}
    
    <div class="flex gap-2 mb-6 bg-white p-1 rounded-2xl shadow-sm border border-slate-100 overflow-x-auto no-scrollbar">
        <button class="flex-1 min-w-[90px] py-2.5 rounded-xl font-bold text-[10px] transition ${activeAdminTab==='dash'?'bg-slate-800 text-white shadow-md':'text-slate-500 hover:bg-slate-50'}" onclick="activeAdminTab='dash';renderAdmin(document.getElementById('app'))">üìä DASHBOARD</button>
        <button class="flex-1 min-w-[90px] py-2.5 rounded-xl font-bold text-[10px] transition ${activeAdminTab==='albs'?'bg-slate-800 text-white shadow-md':'text-slate-500 hover:bg-slate-50'}" onclick="activeAdminTab='albs';renderAdmin(document.getElementById('app'))">üì¶ COMPRAS</button>
        <button class="flex-1 min-w-[90px] py-2.5 rounded-xl font-bold text-[10px] transition ${activeAdminTab==='facturas'?'bg-slate-800 text-white shadow-md':'text-slate-500 hover:bg-slate-50'}" onclick="activeAdminTab='facturas';renderAdmin(document.getElementById('app'))">üìÑ FACTURAS</button>
        <button class="flex-1 min-w-[90px] py-2.5 rounded-xl font-bold text-[10px] transition ${activeAdminTab==='fijos'?'bg-slate-800 text-white shadow-md':'text-slate-500 hover:bg-slate-50'}" onclick="activeAdminTab='fijos';renderAdmin(document.getElementById('app'))">üè† FIJOS</button>
        <button class="flex-1 min-w-[90px] py-2.5 rounded-xl font-bold text-[10px] transition ${activeAdminTab==='prov'?'bg-slate-800 text-white shadow-md':'text-slate-500 hover:bg-slate-50'}" onclick="activeAdminTab='prov';renderAdmin(document.getElementById('app'))">üìí PROV</button>
        <button class="flex-1 min-w-[90px] py-2.5 rounded-xl font-bold text-[10px] transition ${activeAdminTab==='omnes'?'bg-slate-800 text-white shadow-md':'text-slate-500 hover:bg-slate-50'}" onclick="activeAdminTab='omnes';renderAdmin(document.getElementById('app'))">üçΩÔ∏è MENU</button>
        <button class="flex-1 min-w-[90px] py-2.5 rounded-xl font-bold text-[10px] transition ${activeAdminTab==='eventos'?'bg-pink-600 text-white shadow-md':'text-slate-500 hover:bg-slate-50'}" onclick="activeAdminTab='eventos';renderAdmin(document.getElementById('app'))">üç∏ EVENTOS</button>
    </div>
    
    ${activeAdminTab === 'dash' ? `
        
        <div class="glass-card bg-slate-900 text-white mb-6 border-none shadow-2xl p-5 relative overflow-hidden">
            <div class="absolute -top-10 -right-10 w-40 h-40 bg-white/10 rounded-full blur-3xl"></div>
            
            <div class="relative z-10">
                <div class="flex justify-between items-end mb-2">
                    <div class="text-[10px] opacity-60 uppercase font-bold tracking-widest">Resultado Operativo</div>
                    <div class="text-[10px] font-bold bg-white/10 px-2 py-1 rounded">Ticket √ò: ${Num.fmt(ticketMedio)}‚Ç¨</div>
                </div>
                <div class="text-5xl font-black ${colorNeto} tracking-tighter mb-4">${Num.fmt(beneficioNeto)}‚Ç¨</div>
                
                <div class="grid grid-cols-3 gap-2 border-t border-white/10 pt-3">
                    <div>
                        <div class="text-[8px] opacity-50 uppercase">Ventas</div>
                        <div class="text-sm font-bold text-emerald-300">${Num.fmt(totalRevenue)}‚Ç¨</div>
                    </div>
                    <div>
                        <div class="text-[8px] opacity-50 uppercase">Food Cost</div>
                        <div class="text-sm font-bold text-red-300">-${Num.fmt(costeMateriaPrima)}‚Ç¨</div>
                    </div>
                    <div class="text-right">
                        <div class="text-[8px] opacity-50 uppercase">Operativos</div>
                        <div class="text-sm font-bold text-orange-300">-${Num.fmt(gastosOperativos)}‚Ç¨</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-gradient-to-r from-purple-50 to-white border-l-4 border-purple-600 p-4 rounded-r-xl shadow-md mb-6 relative overflow-hidden">
            <div class="flex justify-between items-center mb-3 relative z-10">
                <div>
                    <h3 class="text-xs font-black text-purple-900 uppercase tracking-widest flex items-center gap-2">
                        <span>üëî</span> CUENTA SOCIOS (Retiros)
                    </h3>
                    <p class="text-[9px] text-purple-500 font-bold mt-0.5">Gastos privados fuera del negocio</p>
                </div>
                <div class="text-right">
                    <span class="block font-black text-purple-700 text-xl">${Num.fmt(totalSocios)}‚Ç¨</span>
                </div>
            </div>

            ${totalSocios > 0 ? `
            <div class="bg-white/80 rounded-lg border border-purple-100 overflow-hidden backdrop-blur-sm relative z-10">
                <table class="w-full text-[10px]">
                    <thead class="bg-purple-100/50 text-purple-900">
                        <tr>
                            <th class="p-2 text-left">Socio</th>
                            <th class="p-2 text-right">Importe</th>
                            <th class="p-2 text-right">% Total</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-purple-50">
                        ${Object.entries(gastosSocios).map(([socio, amount]) => `
                            <tr>
                                <td class="p-2 font-bold text-slate-700">${socio}</td>
                                <td class="p-2 text-right font-mono text-purple-700 font-bold">${Num.fmt(amount)}‚Ç¨</td>
                                <td class="p-2 text-right text-slate-400">${((amount/totalSocios)*100).toFixed(0)}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            ` : `
            <div class="text-center py-2 border-2 border-dashed border-purple-200 rounded-lg bg-white/50">
                <div class="text-xs font-bold text-purple-400">Sin movimientos de socios</div>
                <div class="text-[9px] text-purple-300">En este periodo (${fiscalQuarter === 0 ? 'A√±o' : fiscalQuarter + 'T'})</div>
            </div>
            `}
        </div>

        <div class="grid grid-cols-2 gap-3 mb-6">
            <div class="bg-white p-3 rounded-2xl border border-slate-100 shadow-sm">
                <div class="text-[9px] font-bold text-slate-400 uppercase mb-1">Labor Cost (Personal)</div>
                <div class="text-2xl font-black ${colorLabor}">${laborCostPct.toFixed(1)}%</div>
                <div class="text-[8px] text-slate-400 mt-1">
                    Gasto: ${Num.fmt(totalPersonal)}‚Ç¨<br>Meta: < 35%
                </div>
            </div>
            <div class="bg-white p-3 rounded-2xl border border-slate-100 shadow-sm">
                <div class="text-[9px] font-bold text-slate-400 uppercase mb-1">Obj. Break Even</div>
                <div class="text-lg font-black text-slate-800">${Num.fmt(breakEven)}‚Ç¨</div>
                <div class="w-full bg-slate-100 h-1.5 rounded-full mt-2 overflow-hidden">
                    <div class="bg-indigo-500 h-full rounded-full" style="width: ${Math.min((totalRevenue/breakEven)*100, 100)}%"></div>
                </div>
                <div class="text-[8px] text-indigo-500 font-bold mt-1 text-right">${((totalRevenue/breakEven)*100).toFixed(0)}% Alcanzado</div>
            </div>
        </div>

        <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm mb-6 relative">
            <div class="flex justify-between items-center mb-4">
                <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Tendencia Financiera</h4>
                <div class="flex items-center gap-2 text-[9px] font-bold">
                    <span class="text-emerald-600">‚óè Ingresos</span>
                    <span class="text-red-500">‚óè Coste Negocio</span>
                </div>
            </div>
            <div class="h-56">
                <canvas id="financeChart"></canvas>
            </div>
        </div>

        <div class="glass-card mt-8">
            <h4 class="text-[10px] font-bold text-slate-400 uppercase mb-4 tracking-widest">Zona de Control</h4>
            <div class="grid grid-cols-2 gap-2 mb-2">
                <button class="btn-ghost text-[10px] border-slate-200" onclick="editConfig()">‚öôÔ∏è DATOS FISCALES</button>
                <button class="btn-ghost text-[10px]" onclick="downloadBackup()">üíæ BACKUP</button>
            </div>
            <div class="grid grid-cols-2 gap-2 mb-4">
                 <button class="btn-ghost text-indigo-600 text-[10px]" onclick="document.getElementById('backup-input').click()">üì§ RESTAURAR</button>
                 <button class="btn-ghost text-emerald-600 font-black border-emerald-200 bg-emerald-50 text-[10px]" onclick="forceCloudDownload()">‚òÅÔ∏è SINCRO</button>
            </div>
            <button class="btn-ghost text-red-500 border-red-100 bg-red-50 text-[10px] w-full hover:bg-red-500 hover:text-white transition" onclick="resetStockToZero()">‚ôªÔ∏è RESETEAR STOCK A CERO</button>
        </div>

    ` : ''}
    <div id="adm-c"></div>`;

    // Renderizar sub-m√≥dulos
    const c = document.getElementById('adm-c');
    if (activeAdminTab === 'fijos') renderGastosFijos(c);
    if (activeAdminTab === 'albs') renderAlbaranes(c);
    if (activeAdminTab === 'facturas') renderFacturas(c);
    if (activeAdminTab === 'omnes') renderOmnes(c);
    if (activeAdminTab === 'prov') renderProvs(c);
    if (activeAdminTab === 'eventos') renderEventos(c);

    // Inicializar gr√°fico si estamos en la pesta√±a principal
    if (activeAdminTab === 'dash') {
        setTimeout(initChart, 100);
    }
}
// --- SUB-M√ìDULO: PROVEEDORES (CON BOT√ìN IMPORTAR) ---
function renderProvs(c) { 
    // Calcular gasto por proveedor
    const spendMap = {}; 
    db.albaranes.forEach(a => { if (isInPeriod(a.date)) spendMap[a.prov] = (spendMap[a.prov] || 0) + a.total; });
    
    c.innerHTML = `
    <div class="glass-card">
        <div class="flex justify-between mb-4">
            <h3 class="font-bold text-slate-800">PROVEEDORES</h3>
            <div class="flex gap-2">
                <button class="btn-ghost w-auto px-3 py-1 text-[10px] bg-indigo-50 text-indigo-600 border-indigo-200" onclick="importProvsModal()">üì• IMPORTAR WASSAP</button>
                <button class="btn-premium w-auto px-3 py-1 text-xs" onclick="editProv()">+ NUEVO</button>
            </div>
        </div>
        <div class="space-y-2">
            ${db.proveedores.map(p => `
                <div class="bg-white p-3 rounded-xl border flex justify-between items-center group" onclick="editProv('${p.id}')">
                    <div>
                        <div class="font-bold text-slate-800">${clean(p.n)}</div>
                        <div class="text-[10px] bg-slate-100 px-2 rounded inline-block uppercase font-bold text-slate-500">${p.fam}</div>
                        ${p.tel ? `<div class="text-[10px] text-indigo-500 font-mono mt-1">üìû ${p.tel}</div>` : ''}
                    </div>
                    <div class="text-right font-bold text-slate-700">${Num.fmt(spendMap[p.n])}‚Ç¨</div>
                </div>
            `).join('')}
        </div>
    </div>`; 
}
function editProv(id) { 
    const p = id ? db.proveedores.find(x => x.id === id) : { id: generateID(), n: '', tel: '', fam: 'General', nif: '', iban: '' }; 
    const fams = FAMILIES.map(f => `<option ${p.fam === f ? 'selected' : ''}>${f}</option>`).join(''); 
    
    showModal('Ficha Proveedor', `
        <div class="grid grid-cols-2 gap-2 mb-2">
            <div><label>Nombre Fiscal</label><input id="ep-n" value="${clean(p.n)}" class="input-premium" placeholder="Nombre"></div>
            <div><label>NIF / CIF</label><input id="ep-nif" value="${clean(p.nif)}" class="input-premium" placeholder="B123..."></div>
        </div>
        <label>IBAN (Para Pagos/Remesas)</label>
        <input id="ep-iban" value="${clean(p.iban)}" class="input-premium mb-2 font-mono uppercase" placeholder="ES00 0000...">
        
        <div class="grid grid-cols-2 gap-2 mb-4">
            <div><label>Tel√©fono</label><input id="ep-t" value="${clean(p.tel)}" class="input-premium" placeholder="Tel"></div>
            <div><label>Familia</label><select id="ep-f" class="input-premium">${fams}</select></div>
        </div>

        <div class="flex gap-2">
            <button class="btn-premium flex-1" onclick="saveProv('${p.id}')">GUARDAR FICHA</button>
            ${id ? `<button class="btn-ghost text-red-500 w-auto" onclick="delProv('${id}')">üóëÔ∏è</button>` : ''}
        </div>
    `); 
}

function saveProv(id) { 
    const n = document.getElementById('ep-n').value; 
    if (n) { 
        const p = { 
            id, 
            n, 
            nif: document.getElementById('ep-nif').value.toUpperCase(),
            tel: document.getElementById('ep-t').value, 
            iban: document.getElementById('ep-iban').value.toUpperCase().replace(/\s/g, ''), // Quitamos espacios al guardar
            fam: document.getElementById('ep-f').value 
        }; 
        const idx = db.proveedores.findIndex(x => x.id === id); 
        if (idx >= 0) db.proveedores[idx] = p; else db.proveedores.push(p); 
        save("Proveedor Guardado"); closeModal(); renderAdmin(document.getElementById('app')); 
    } 
}
function delProv(id) { 
    if (confirm("¬øBorrar?")) { db.proveedores = db.proveedores.filter(x => x.id !== id); save("Borrado"); closeModal(); renderAdmin(document.getElementById('app')); } 
}
function renderAlbaranes(c) {
    const list = db.albaranes.filter(a => isInPeriod(a.date)).slice().reverse();
    const provOptions = db.proveedores.map(p => `<option value="${clean(p.n)}">`).join('');
    const ingOptions = db.ingredientes.map(i => `<option value="${clean(i.n)}">`).join('');
    
    // Lista de socios segura
    const listaSociosSegura = db.listaSocios || ['Jeronimo', 'Pedro', 'Pau', 'Agnes'];
    const socioOptions = `<option value="Arume" selected>üè† ARUME</option>` + 
                          `<option value="OnlyOne">üç∏ ONLYONE (Pau)</option>` +
                          listaSociosSegura.map(s => `<option value="${s}">${s}</option>`).join('');
    
    // --- 1. DEFINIMOS LA CHULETA DE AYUDA (NUEVO) ---
    const helpTip = `
    <div class="text-[9px] text-indigo-500 bg-indigo-50 p-2 rounded border border-indigo-100 mb-2 flex items-start gap-2">
        <span class="text-lg">üí°</span>
        <div>
            <span class="font-bold">FORMATO DE PEGADO:</span> Copia l√≠neas con este orden exacto:
            <div class="font-mono bg-white px-1 rounded mt-1 text-slate-600 border border-indigo-100 shadow-sm">
                Nombre &nbsp; Cantidad &nbsp; Precio &nbsp; (Dto) &nbsp; (IVA)
            </div>
            <div class="opacity-70 mt-0.5 italic">Ej: "Solomillo 5.5 22.90"</div>
        </div>
    </div>`;

    // --- 2. RENDERIZAMOS EL HTML (CON EL TIP INCLUIDO Y EL AVISO INTELIGENTE) ---
    c.innerHTML = `
    <div class="glass-card border-l-4 border-indigo-500" id="alb-form-anchor">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-slate-700 text-sm uppercase">Nuevo / Editar Albar√°n</h3>
            <span class="text-[9px] bg-indigo-50 text-indigo-400 px-2 py-1 rounded border border-indigo-100 font-bold">PRO MODE</span>
        </div>
        
        <div class="grid grid-cols-4 gap-2 mb-1">
            <div class="col-span-1">
                <label>Socio</label>
                <select id="alb-socio" class="input-premium px-1 text-sm font-bold text-indigo-600">
                    ${socioOptions}
                </select>
            </div>
            <div class="col-span-1">
                <label>Proveedor</label>
                <input list="prov-list" id="alb-prov" class="input-premium px-1 text-sm" placeholder="..." oninput="checkDuplicate()">
                <datalist id="prov-list">${provOptions}</datalist>
            </div>
            <div class="col-span-1">
                <label>Ref / Fra</label>
                <input id="alb-num" class="input-premium px-1 text-sm font-mono font-bold text-slate-700 transition-colors duration-300" oninput="checkDuplicate()" placeholder="Ref...">
            </div>
            <div class="col-span-1">
                <label>Fecha</label>
                <input type="date" id="alb-date" value="${getISO()}" class="input-premium px-1 text-sm">
            </div>
        </div>

        <div id="dup-status" class="hidden mb-4"></div>

        <datalist id="ing-list">${ingOptions}</datalist>
        
        ${helpTip}
        
        <textarea id="alb-input" rows="2" class="input-premium font-mono text-xs mb-2" placeholder="Pegar aqu√≠..."></textarea>
        
        <div class="flex gap-2 mb-4">
            <button class="btn-ghost" onclick="parseAlb()">ü™Ñ LEER TEXTO</button>
            <button class="btn-ghost text-red-400" onclick="tempItems=[];renderAlbGrid()">LIMPIAR</button>
        </div>

        <div class="grid grid-cols-12 gap-1 px-2 mb-1 text-[10px] font-bold text-slate-400 uppercase tracking-wider text-center">
            <div class="col-span-4 text-left">Producto</div><div class="col-span-2">Cant</div><div class="col-span-2">Precio</div><div class="col-span-1">Dto</div><div class="col-span-1">IVA</div><div class="col-span-2 text-right">Total</div>
        </div>
        
        <div id="alb-grid" class="space-y-2 mb-4 max-h-60 overflow-y-auto"></div>
        
        <div class="border-t border-slate-100 pt-3 text-right">
            <div class="text-xs text-slate-400 font-bold">TOTAL A PAGAR</div>
            <div class="text-3xl font-black text-slate-800"><span id="alb-total">0.00‚Ç¨</span></div>
        </div>

        <div class="mt-4 mb-4">
            <label class="text-red-400 font-bold">üìù NOTAS / INCIDENCIAS (Opcional)</label>
            <textarea id="alb-notes" class="input-premium bg-red-50 border-red-100 text-red-600 font-medium text-xs" rows="2" placeholder="Si escribes algo aqu√≠, se marcar√° en ROJO en facturaci√≥n para revisar..."></textarea>
        </div>
        
        <div class="grid grid-cols-2 gap-3 mt-2">
            <button class="btn-premium btn-action" onclick="commitAlb()">GUARDAR Y STOCK</button>
            <button class="btn-ghost" onclick="exportAlbCSV()">CSV</button>
        </div>
    </div>

    <div class="glass-card">
        <h4 class="text-xs font-bold text-slate-400 uppercase mb-4">Historial</h4>
        ${list.length ? list.map(a => `
            <div class="flex justify-between items-center py-3 border-b hover:bg-slate-50 transition px-2 rounded-lg ${a.notes ? 'bg-red-50 border-l-4 border-red-400' : ''}">
                <div class="text-sm font-bold text-slate-700">
                    ${clean(a.prov)} 
                    <span class="text-[10px] text-slate-400 font-normal">(${a.date})</span>
                    <span class="ml-2 text-[9px] bg-indigo-50 text-indigo-600 px-1.5 py-0.5 rounded font-bold border border-indigo-100">üë§ ${a.socio || '?'}</span>
                    <div class="text-[10px] text-slate-400 font-mono">Ref: ${a.num || '-'}</div>
                    ${a.notes ? `<div class="text-[10px] text-red-500 font-bold mt-1">‚ö†Ô∏è ${clean(a.notes)}</div>` : ''}
                </div>
                <div class="flex items-center gap-2">
                    <span class="font-bold text-sm mr-2">${Num.fmt(a.total)}‚Ç¨</span>
                    <button class="btn-icon btn-ghost" onclick="viewAlbDetails('${a.id}')">üëÅ</button>
                    ${!a.invoiced ? `
                        <button class="btn-icon btn-edit" onclick="editAlb('${a.id}')">‚úèÔ∏è</button>
                        <button class="btn-icon btn-delete" onclick="deleteAlb('${a.id}')">üóëÔ∏è</button>
                    ` : '<span class="text-[10px] bg-emerald-100 text-emerald-700 px-2 py-1 rounded font-bold">FACTURADO</span>'}
                </div>
            </div>`).join('') : '<div class="text-center p-4 text-slate-400">Sin registros</div>'}
    </div>`;
    
    renderAlbGrid();
}

function checkDuplicate() {
    const refInput = document.getElementById('alb-num');
    const provInput = document.getElementById('alb-prov');
    const statusDiv = document.getElementById('dup-status');

    // Limpieza de datos
    const ref = refInput.value.trim().toLowerCase();
    const prov = provInput.value.trim().toLowerCase();

    // Si faltan datos, limpiamos visuales y salimos
    if (!ref || !prov) {
        statusDiv.innerHTML = ''; 
        statusDiv.className = 'hidden';
        refInput.classList.remove('border-red-500', 'bg-red-50', 'border-emerald-500', 'bg-emerald-50', 'animate-pulse');
        return;
    }

    // Buscamos si existe
    const existingAlb = db.albaranes.find(a => 
        (a.num || '').toString().trim().toLowerCase() === ref && 
        (a.prov || '').toString().trim().toLowerCase() === prov
    );

    statusDiv.classList.remove('hidden');

    if (existingAlb) {
        // --- üõë DUPLICADO ---
        refInput.classList.remove('border-emerald-500', 'bg-emerald-50');
        refInput.classList.add('border-red-500', 'bg-red-50', 'animate-pulse');

        statusDiv.className = 'mt-2 p-3 bg-red-100 border-l-4 border-red-500 rounded text-xs flex justify-between items-center shadow-sm animate-bounce';
        statusDiv.innerHTML = `
            <div>
                <div class="font-bold text-red-700">‚õî FACTURA REPETIDA</div>
                <div class="text-red-500">Ya existe desde el ${existingAlb.date}</div>
            </div>
            <button class="bg-white text-red-600 border border-red-200 px-3 py-1 rounded-lg font-bold hover:bg-red-50 transition shadow-sm" onclick="viewAlbDetails('${existingAlb.id}')">
                üëÅÔ∏è VER ORIGINAL
            </button>
        `;
    } else {
        // --- ‚úÖ DISPONIBLE ---
        refInput.classList.remove('border-red-500', 'bg-red-50', 'animate-pulse');
        refInput.classList.add('border-emerald-500', 'bg-emerald-50');

        statusDiv.className = 'mt-1 text-[10px] font-bold text-emerald-600 flex items-center gap-1 pl-1';
        statusDiv.innerHTML = `<span>‚úÖ</span> Referencia disponible`;
    }
}
/* =============================================================
   ‚ö†Ô∏è MOTOR INTELIGENTE V5.0 (DETECTIVE MATEM√ÅTICO) ‚ö†Ô∏è
   ============================================================= */

/* --- 1. DETECTIVE DE PATRONES (Busca si A * B = C) --- */
function detectLinePattern(line) {
    // Limpieza: quitamos monedas y espacios dobles
    let clean = line.replace(/[‚Ç¨$¬£"]/g, '').replace(/\s{2,}/g, ' ').trim();
    
    // Extraer TODOS los n√∫meros de la l√≠nea (positivos y negativos)
    const rawNumbers = clean.match(/(-?\d+([.,]\d+)?)/g);
    
    // Si no hay n√∫meros, no es una l√≠nea v√°lida
    if (!rawNumbers || rawNumbers.length < 1) return null;

    // Convertimos a n√∫meros reales para operar
    const nums = rawNumbers.map(n => Num.parse(n));
    
    let q = 1, p = 0;
    let foundMath = false;

    // --- ESTRATEGIA A: VERIFICACI√ìN MATEM√ÅTICA ---
    // Si hay al menos 3 n√∫meros, comprobamos si (Cant * Precio = Total)
    if (nums.length >= 3) {
        // Asumimos que el total suele estar al final
        const total = nums[nums.length - 1]; 
        
        // Probamos todas las parejas posibles para ver si multiplican
        for (let i = 0; i < nums.length - 1; i++) {
            for (let j = i + 1; j < nums.length - 1; j++) {
                // Margen de error de 0.05 c√©ntimos por redondeos
                if (Math.abs((nums[i] * nums[j]) - total) < 0.05) {
                    // ¬°BINGO! Hemos encontrado la l√≥gica
                    // Normalmente el n√∫mero m√°s peque√±o o entero es la cantidad
                    if (nums[i] < nums[j] && nums[i] < 100) { q = nums[i]; p = nums[j]; }
                    else { q = nums[j]; p = nums[i]; }
                    
                    foundMath = true;
                    break;
                }
            }
            if (foundMath) break;
        }
    }

    // --- ESTRATEGIA B: POSICI√ìN (Si falla la matem√°tica) ---
    if (!foundMath) {
        if (nums.length >= 2) {
            q = nums[0]; // El primero suele ser cantidad
            // Si el √∫ltimo es mucho mayor que el pen√∫ltimo, asumimos √öltimo=Total, Pen√∫ltimo=Precio
            // Si no, asumimos Pen√∫ltimo=Precio Unitario
            p = nums[nums.length >= 3 ? nums.length - 2 : 1]; 
        } else {
            q = nums[0]; p = 0;
        }
    }

    // LIMPIEZA DEL NOMBRE
    // Quitamos los n√∫meros que hemos "usado" para dejar el texto limpio
    let name = clean;
    [q, p, (q*p)].forEach(val => {
        if(val > 0) {
            // Regex para quitar solo ese n√∫mero exacto
            name = name.replace(new RegExp(`\\b${String(val).replace('.', '[.,]')}\\b`, ''), '');
        }
    });
    
    // DETECTAR UNIDAD (kg, l, ud...)
    let unit = 'ud';
    const uMatch = clean.match(/\b(kg|kilo|gr|g|l|litro|ml|cl|oz|lb|caja|pack|botella|uds|ud|unid|barril|lata)\b/i);
    if (uMatch) {
        unit = UnitConverter.normalize(uMatch[0]);
        name = name.replace(uMatch[0], ''); // Quitamos la unidad del nombre
    }

    return { 
        name: name.replace(/[^\w\s√±√ë√°√©√≠√≥√∫√Å√â√ç√ì√ö%\-]/g, '').trim(), // Limpieza final de s√≠mbolos raros
        q, p, d: 0, t: null, unit 
    };
}

/* --- 2. PARSEADOR PRINCIPAL (ALBARANES) --- */
function parseAlb() {
    const txtInput = document.getElementById('alb-input');
    const txt = txtInput.value;
    
    if (!txt.trim()) return toast("‚ö†Ô∏è El √°rea de texto est√° vac√≠a", "error");

    loading(true); 

    setTimeout(() => {
        try {
            const lines = txt.split(/\r?\n/).filter(l => l.trim().length > 2);
            let count = 0;

            // Mapa optimizado para b√∫squeda r√°pida
            const ingMap = db.ingredientes.map(i => ({
                id: i.id, n: i.n.toLowerCase(), unit: i.unit, cost: i.cost, tax: i.tax || 10, ref: i
            }));

            lines.forEach(rawLine => {
                // Usamos el detective V5.0
                const result = detectLinePattern(rawLine);

                if (result && result.name.length > 1) {
                    const match = findBestMatchOptimized(result.name, ingMap);
                    
                    let finalUnit = result.unit;
                    let finalQty = result.q;
                    // IVA: Si es producto nuevo, intentamos adivinarlo por nombre
                    let finalTax = match ? (match.ref.tax || 10) : guessTax(result.name);
                    let status = 'new';

                    if (match) {
                        status = 'linked';
                        // Conversi√≥n autom√°tica de unidades si difieren (ej: Compras Cajas -> Stock Unidades)
                        if (match.unit !== finalUnit) {
                            const converted = tryConvertUnits(finalQty, finalUnit, match.unit);
                            if (converted !== null) {
                                finalQty = converted;
                                finalUnit = match.unit; // Normalizamos a la unidad del stock
                            } else {
                                status = 'conflict'; // Avisamos si no sabemos convertir
                            }
                        }
                    }

                    tempItems.push({
                        n: match ? match.ref.n : result.name,
                        q: parseFloat(finalQty) || 0,
                        p: parseFloat(result.p) || 0,
                        unit: finalUnit,
                        d: 0, 
                        tax: parseFloat(finalTax),
                        status: status,
                        originalUnit: result.unit 
                    });
                    count++;
                }
            });

            if (count > 0) {
                txtInput.value = ''; 
                renderAlbGrid();
                toast(`‚úÖ ${count} l√≠neas le√≠das correctamente.`, "success");
            } else {
                toast("‚ùå No pude leer nada. Revisa el formato.", "error");
            }

        } catch (e) {
            console.error(e);
            toast("‚ö†Ô∏è Error interno al leer.", "error");
        } finally {
            loading(false); 
        }
    }, 50); 
}
/* --- AUXILIAR: BUSCADOR OPTIMIZADO --- */
function findBestMatchOptimized(txt, map) {
    if (!txt || txt.length < 2) return null;
    const cleanTxt = txt.toLowerCase();
    // Coincidencia exacta o contenci√≥n fuerte
    return map.find(i => i.n === cleanTxt || cleanTxt.includes(i.n) || i.n.includes(cleanTxt));
}

/* --- AUXILIAR: CONVERSOR SEGURO --- */
function tryConvertUnits(val, from, to) {
    if (from === to) return val;
    from = UnitConverter.normalize(from);
    to = UnitConverter.normalize(to);
    
    if (to === 'kg') {
        if (from === 'g' || from === 'gr') return val / 1000;
        if (from === 'mg') return val / 1000000;
        if (from === 'lb') return val * 0.453592;
    }
    if (to === 'g' || to === 'gr') {
        if (from === 'kg') return val * 1000;
    }
    if (to === 'l') {
        if (from === 'ml') return val / 1000;
        if (from === 'cl') return val / 100;
    }
    if (to === 'ml') {
        if (from === 'l') return val * 1000;
        if (from === 'cl') return val * 10;
    }
    return null; // Imposible convertir (ej: Caja a Kg)
}

/* --- AUXILIAR: ADIVINADOR DE IVA --- */
function guessTax(name) {
    const n = name.toLowerCase();
    if (n.includes('vino') || n.includes('cerveza') || n.includes('licor') || n.includes('alcohol')) return 21;
    if (n.includes('refresco') || n.includes('coca') || n.includes('fanta') || n.includes('agua')) return 10; 
    if (n.includes('pan') || n.includes('leche') || n.includes('huevo') || n.includes('harina') || n.includes('fruta') || n.includes('verdura')) return 4;
    return 10; 
}
/* =============================================================
   ‚ö†Ô∏è RENDERIZADOR VISUAL DE ALBARANES (GRID INTERACTIVO) ‚ö†Ô∏è
   ============================================================= */

function renderAlbGrid() {
    const el = document.getElementById('alb-grid'); 
    if (!el) return;

    el.innerHTML = tempItems.map((it, i) => {
        const totalLine = (it.q * it.p * (1 - (it.d||0)/100)) * (1 + (it.tax||10)/100);
        
        // --- L√ìGICA VISUAL DE ESTADOS ---
        let rowClass = 'bg-white border-slate-100';
        let badge = '';
        let statusMsg = '';

        if (it.status === 'new') {
            rowClass = 'bg-blue-50 border-blue-200';
            badge = '<span class="text-[9px] bg-blue-100 text-blue-600 px-1 rounded ml-2 font-bold">NUEVO</span>';
            statusMsg = '<span class="text-[9px] text-blue-400 font-bold ml-1">Se crear√° ficha nueva</span>';
        } else if (it.status === 'conflict') {
            rowClass = 'bg-orange-50 border-orange-300 ring-1 ring-orange-200'; // Resaltado fuerte para llamar la atenci√≥n
            badge = '<span class="text-[9px] bg-orange-100 text-orange-600 px-1 rounded ml-2 font-bold">‚ö†Ô∏è REVISAR UNIDAD</span>';
            statusMsg = '<span class="text-[9px] text-orange-500 font-bold ml-1">Stock usa otra unidad</span>';
        } else {
            // Linked OK
            statusMsg = '<span class="text-[9px] text-emerald-500 font-bold ml-1">‚úì Vinculado a Stock</span>';
        }

        return `
        <div class="${rowClass} p-2 rounded-xl border grid grid-cols-12 gap-1 items-center shadow-sm text-xs transition mb-2 relative group">
            
            <div class="col-span-4 flex flex-col justify-center">
                <div class="flex items-center">
                    <input value="${clean(it.n)}" class="w-full bg-transparent font-bold outline-none text-slate-700 truncate placeholder-slate-400" placeholder="Nombre producto..." onchange="tempItems[${i}].n=this.value">
                    ${badge}
                </div>
                ${statusMsg}
            </div>
            
            <div class="col-span-2 flex gap-1 items-center">
                <input type="number" value="${it.q}" class="w-full bg-white/50 border border-slate-200 text-center rounded py-1 font-bold focus:bg-white focus:ring-2 ring-indigo-100 outline-none" onchange="tempItems[${i}].q=parseFloat(this.value);renderAlbGrid()">
                
                <select onchange="tempItems[${i}].unit=this.value; tempItems[${i}].status='linked'; renderAlbGrid()" class="w-14 bg-slate-100 rounded border-0 text-[10px] py-1 font-bold text-slate-500 cursor-pointer hover:bg-slate-200 outline-none">
                    <option ${it.unit==='kg'?'selected':''}>kg</option>
                    <option ${it.unit==='ud'?'selected':''}>ud</option>
                    <option ${it.unit==='l'?'selected':''}>l</option>
                    <option ${it.unit==='oz'?'selected':''}>oz</option>
                    <option ${it.unit==='g'?'selected':''}>g</option>
                    <option ${it.unit==='ml'?'selected':''}>ml</option>
                </select>
            </div>

            <div class="col-span-2">
                <input type="number" value="${it.p}" step="0.01" class="w-full bg-white/50 border border-slate-200 text-center rounded py-1 focus:bg-white outline-none" onchange="tempItems[${i}].p=parseFloat(this.value);renderAlbGrid()">
            </div>
            
            <div class="col-span-1">
                <input type="number" value="${it.d||0}" class="w-full bg-emerald-50 text-center rounded text-emerald-700 font-bold outline-none" placeholder="%" onchange="tempItems[${i}].d=parseFloat(this.value);renderAlbGrid()">
            </div>
            
            <div class="col-span-1">
                <select onchange="tempItems[${i}].tax=parseFloat(this.value);renderAlbGrid()" class="w-full bg-blue-50 rounded text-blue-700 font-bold text-[10px] outline-none">
                    <option ${it.tax===10?'selected':''} value="10">10%</option>
                    <option ${it.tax===21?'selected':''} value="21">21%</option>
                    <option ${it.tax===4?'selected':''} value="4">4%</option>
                    <option ${it.tax===0?'selected':''} value="0">0%</option>
                </select>
            </div>
            
            <div class="col-span-2 text-right font-mono font-black pr-2 text-slate-700 flex items-center justify-end h-full">
                ${Num.fmt(totalLine)}‚Ç¨
            </div>
            
            <button class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center opacity-0 group-hover:opacity-100 transition shadow-md hover:scale-110 z-10 cursor-pointer" onclick="tempItems.splice(${i},1);renderAlbGrid()">‚úï</button>
        </div>`;
    }).join('');
    
    // Calcular Total General Acumulado
    const total = tempItems.reduce((acc, it) => acc + (it.q * it.p * (1 - (it.d||0)/100)) * (1 + (it.tax||10)/100), 0);
    
    // Control de seguridad: Si el total es NaN (error de parseo), mostrar 0 para no romper la UI
    const safeTotal = isNaN(total) ? 0 : total;
    document.getElementById('alb-total').innerText = Num.fmt(safeTotal) + '‚Ç¨';
}
/* =============================================================
   ‚ö†Ô∏è COMMIT INTELIGENTE V4.0 (Aprende IVA y Proveedores) ‚ö†Ô∏è
   ============================================================= */
function commitAlb() {
    if (!tempItems.length) return toast("Albar√°n vac√≠o", "error");
    
    // Recogemos datos de la cabecera
    const socio = document.getElementById('alb-socio').value;
    const provName = document.getElementById('alb-prov').value.trim();
    const date = document.getElementById('alb-date').value;
    const num = document.getElementById('alb-num').value.trim() || `A-${Date.now().toString().slice(-6)}`;
    // NUEVO: Recoger notas
    const notes = document.getElementById('alb-notes').value.trim();
    
    if (!provName || !date) return toast("Faltan datos (Proveedor o Fecha)", "error");

    // 1. Asegurar Proveedor
    let provider = db.proveedores.find(p => p.n.toLowerCase() === provName.toLowerCase());
    if (!provider) {
        provider = { id: generateID(), n: provName, tel: '', fam: 'General' };
        db.proveedores.push(provider);
    }

    let subtotal = 0, taxes = 0;

    // 2. Procesar L√≠neas
    tempItems.forEach(it => {
        const cleanName = it.n.trim();
        let ing = db.ingredientes.find(x => x.n.toLowerCase() === cleanName.toLowerCase());
        const netPrice = it.p * (1 - (it.d || 0) / 100);
        const lineBase = it.q * netPrice;
        const lineTax = lineBase * (it.tax / 100);

        if (!ing) { 
            ing = { 
                id: generateID(), n: cleanName, stock: 0, cost: netPrice, unit: it.unit, fam: 'General', min: 0,
                tax: it.tax, lastProv: provName 
            }; 
            db.ingredientes.push(ing); 
        } else {
            if (Math.abs(ing.cost - netPrice) > 0.01) ing.lastCost = ing.cost;
            const totalVal = (ing.stock * ing.cost) + (it.q * netPrice);
            const totalQty = ing.stock + it.q;
            if (totalQty > 0) ing.cost = totalVal / totalQty;
            else if (it.q > 0) ing.cost = netPrice;
            ing.tax = it.tax; ing.lastProv = provName; 
        }

        ing.stock += it.q;
        logStock(ing.id, it.q, 'IN', `Alb: ${num} (${clean(provName)})`, netPrice);
        subtotal += lineBase;
        taxes += lineTax;
    });

    // 3. Guardar Albar√°n
    db.albaranes.push({ 
        id: generateID(), 
        num: num, 
        prov: provName, 
        date: date, 
        socio: socio,
        items: [...tempItems], 
        total: subtotal + taxes, 
        subtotal: subtotal, 
        taxes: taxes, 
        invoiced: false,
        notes: notes // <--- GUARDAMOS LA NOTA AQU√ç
    });
    
    clearCache();
    save(`‚úÖ Albar√°n ${num} guardado`);
    
    tempItems = []; 
    renderAdmin(document.getElementById('app'));
}
function viewAlbDetails(id) { 
    const a = db.albaranes.find(x => x.id === id); 
    if (a) showModal(`Detalle ${a.num || ''}`, `<div class="mb-2 text-xs font-bold text-slate-500">${a.prov} - ${a.date}</div><table class="w-full text-xs"><thead><tr class="text-left text-slate-400 border-b"><th>Prod</th><th>Cant</th><th>‚Ç¨/ud</th><th>Total</th></tr></thead><tbody>${a.items.map(i => { const net = i.p * (1-(i.d||0)/100); return `<tr><td class="py-1">${i.n}</td><td>${i.q}${i.unit}</td><td>${Num.fmt(net)}</td><td class="text-right">${Num.fmt(i.q * net * (1+(i.tax||10)/100))}</td></tr>`; }).join('')}</tbody></table><div class="text-right font-black text-xl mt-4">${Num.fmt(a.total)}‚Ç¨</div>`); 
}

function deleteAlb(id) {
    if (confirm("¬øBorrar Albar√°n? (Se descontar√° el stock a√±adido)")) {
        const alb = db.albaranes.find(a => a.id === id);
        if(alb) {
            alb.items.forEach(it => {
                const ing = db.ingredientes.find(x => x.n === it.n && x.unit === it.unit);
                if(ing) { ing.stock -= it.q; logStock(ing.id, it.q, 'OUT', `Anular Alb ${alb.num}`, ing.cost); }
            });
            db.albaranes = db.albaranes.filter(a => a.id !== id);
            save("Albar√°n Eliminado"); renderAdmin(document.getElementById('app'));
        }
    }
}
function editAlb(id) {
    const alb = db.albaranes.find(a => a.id === id);
    if (!alb) return;
    
    if (alb.invoiced) return toast("‚õî No se puede editar: Ya est√° facturado", "error");

    if(confirm("¬øModificar albar√°n? \nSe cargar√° arriba para editar y se recalcular√° el stock.")) {
        // 1. Devolver Stock (Deshacer movimientos)
        alb.items.forEach(it => {
            const ing = db.ingredientes.find(x => x.n === it.n && x.unit === it.unit);
            if(ing) {
                ing.stock -= it.q;
                logStock(ing.id, it.q, 'OUT', `Edici√≥n Alb: ${alb.num}`, ing.cost);
            }
        });

        // 2. Cargar datos en el formulario
        document.getElementById('alb-prov').value = alb.prov;
        document.getElementById('alb-num').value = alb.num;
        document.getElementById('alb-date').value = alb.date;
        if(alb.socio) document.getElementById('alb-socio').value = alb.socio;
        
        // === NUEVO: RECUPERAR NOTAS ===
        document.getElementById('alb-notes').value = alb.notes || ''; 

        // 3. Cargar items y borrar el antiguo
        tempItems = JSON.parse(JSON.stringify(alb.items));
        db.albaranes = db.albaranes.filter(a => a.id !== id);

        renderAdmin(document.getElementById('app')); 
        
        setTimeout(() => {
            document.getElementById('alb-form-anchor').scrollIntoView({ behavior: 'smooth' });
            toast("‚úèÔ∏è Datos cargados. Modifica y pulsa GUARDAR.", "info");
        }, 100);
    }
}
function exportAlbCSV() { 
    if (!tempItems.length) return toast("Tabla vac√≠a", "error"); 
    const rows = tempItems.map(it => [it.n, Num.csv(it.q), it.unit, Num.csv(it.p), Num.csv(it.d || 0), Num.csv((it.q * it.p) * (1 + it.tax / 100))]); 
    const csv = ['Producto;Cantidad;Unidad;Precio;Dto;Total', ...rows.map(r => r.join(';'))].join('\n'); 
    const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8' }); 
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Albaran_Import.csv'; a.click(); 
}
/* =============================================================
   ‚ö†Ô∏è 11. M√ìDULO DE FACTURACI√ìN (AGRUPADO + EXCEL + MODAL) ‚ö†Ô∏è
   ============================================================= */
// Variable temporal para guardar datos mientras est√° abierta la ventana modal
let tempInvoiceData = null;
function renderFacturas(c) {
    // 1. Agrupar Pendientes
    const pends = db.albaranes.filter(a => !a.invoiced);
    const groups = {}; 
    pends.forEach(a => { 
        if (!groups[a.prov]) groups[a.prov] = { c: 0, t: 0, ids: [], hasNotes: false }; 
        groups[a.prov].c++; 
        groups[a.prov].t += a.total; 
        groups[a.prov].ids.push(a.id);
        
        // === DETECTOR DE INCIDENCIAS ===
        // Si tiene notas, activamos la bandera 'hasNotes'
        if (a.notes && a.notes.trim().length > 0) {
            groups[a.prov].hasNotes = true;
        }
    });
    
    // 2. Historial (Facturas ya hechas)
    const hist = db.facturas.filter(f => isInPeriod(f.date)).sort((a,b) => b.date.localeCompare(a.date));
    const monthNames = ["", "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    const byMonth = {};
    const unpaidCount = hist.filter(f => !f.paid).length;

    hist.forEach(f => {
        const m = parseInt(f.date.split('-')[1]); 
        if(!byMonth[m]) byMonth[m] = { name: monthNames[m], total: 0, items: [] };
        byMonth[m].items.push(f);
        byMonth[m].total += f.total;
    });

    const remesaPanel = unpaidCount > 0 ? `
        <div class="glass-card mb-6 bg-indigo-50 border-indigo-100 p-4">
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="font-black text-indigo-900 text-sm uppercase tracking-widest">üè¶ REMESA BANCARIA (SEPA)</h3>
                    <p class="text-[10px] text-indigo-500">Selecciona facturas abajo y descarga el archivo para el banco.</p>
                </div>
                <button class="btn-premium w-auto px-4 py-2 text-xs shadow-indigo-200" onclick="downloadSEPA()">
                    üì• DESCARGAR XML
                </button>
            </div>
        </div>` : '';

    const htmlPends = Object.keys(groups).length ? 
        `<div class="glass-card mb-6 border-l-4 border-indigo-500">
            <h3 class="font-bold text-xs text-slate-400 mb-3 uppercase tracking-widest">‚ö†Ô∏è Pendientes de Facturar</h3>
            ${Object.entries(groups).map(([p, d]) => {
                // === L√ìGICA VISUAL DE ALERTA ===
                // Si hasNotes es true, cambiamos el estilo a ROJO y mostramos aviso
                const alertStyle = d.hasNotes 
                    ? 'bg-red-50 border-l-4 border-red-500 my-2 rounded-r-xl shadow-sm' 
                    : 'border-b border-slate-100 last:border-0';
                
                const alertBadge = d.hasNotes 
                    ? `<div class="text-[10px] font-black text-red-600 animate-pulse mt-1">‚ö†Ô∏è REVISAR NOTAS EN ALBAR√ÅN</div>` 
                    : '';

                return `
                <div class="flex justify-between items-center py-3 px-2 ${alertStyle}">
                    <div>
                        <div class="font-bold text-slate-800 text-sm">${clean(p)}</div>
                        <div class="text-[10px] text-slate-400 font-bold bg-white px-2 rounded inline-block border">${d.c} albaranes</div>
                        ${alertBadge}
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-black text-slate-700 text-sm">${Num.fmt(d.t)}‚Ç¨</span>
                        <button class="bg-indigo-600 text-white px-3 py-2 rounded-xl text-[10px] font-bold shadow-lg active:scale-95 transition" onclick="openInvoiceModal('${p}','${d.ids.join(',')}', ${d.t})">GENERAR FACTURA</button>
                    </div>
                </div>`
            }).join('')}
        </div>` : 
        `<div class="glass-card mb-6 flex items-center gap-4 p-4 opacity-70"><div class="bg-emerald-100 p-2 rounded-full text-emerald-600">‚úÖ</div><div class="text-xs font-bold text-slate-500">Todo facturado.</div></div>`;

    const htmlHist = Object.keys(byMonth).sort((a,b)=>b-a).map(mKey => {
        const mData = byMonth[mKey];
        return `
        <div class="glass-card mb-6">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-3">
                <div>
                    <h3 class="font-black text-slate-800 uppercase text-lg tracking-tight">${mData.name}</h3>
                    <div class="text-[10px] font-bold text-slate-400">Total Mes: ${Num.fmt(mData.total)}‚Ç¨</div>
                </div>
                <button class="bg-emerald-50 text-emerald-700 px-3 py-2 rounded-lg text-[10px] font-bold hover:bg-emerald-100 transition" onclick="downloadMonthCSV(${mKey}, '${mData.name}')">üì• EXCEL</button>
            </div>
            <div class="space-y-1">
            ${mData.items.map(f => `
                <div class="flex justify-between items-center py-2 px-2 hover:bg-slate-50 transition rounded-lg group">
                    <div class="flex items-center gap-3">
                        ${!f.paid ? `<input type="checkbox" class="sepa-check w-5 h-5 accent-indigo-600 cursor-pointer mr-1" value="${f.id}">` : '<span class="w-6"></span>'}
                        <div>
                            <div class="font-bold text-slate-700 text-sm leading-tight">${clean(f.prov)}</div>
                            <div class="text-[10px] text-slate-400 font-mono flex gap-2 items-center mt-1">
                                <span>${f.date}</span>
                                <span class="text-indigo-400 font-bold">Ref: ${clean(f.num)}</span>
                            </div>
                            ${f.base ? `<div class="text-[9px] text-slate-400 mt-0.5 font-mono tracking-tight">Base: ${Num.fmt(f.base)}‚Ç¨ | IVA: ${Num.fmt(f.tax)}‚Ç¨</div>` : ''}
                        </div>
                    </div>
                    <div class="text-right flex flex-col items-end gap-1">
                        <div class="font-black text-slate-800 text-sm">${Num.fmt(f.total)}‚Ç¨</div>
                        <div class="flex gap-1">
                            <button onclick="deleteInvoice('${f.id}')" class="text-[10px] bg-red-50 text-red-500 border border-red-100 px-2 py-1 rounded hover:bg-red-500 hover:text-white transition">üóëÔ∏è</button>
                            <button onclick="togglePaid('${f.id}')" class="text-[9px] font-bold px-2 py-1 rounded border transition ${f.paid ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : 'bg-red-50 text-red-500 border-red-100'}">${f.paid ? 'PAGADO' : 'PENDIENTE'}</button>
                        </div>
                    </div>
                </div>`).join('')}
            </div>
        </div>`;
    }).join('');

    c.innerHTML = remesaPanel + htmlPends + htmlHist;
}
// 1. Paso previo: Abrir ventana para pedir datos (N√∫mero de factura real)
function openInvoiceModal(provName, idsString, amount) {
    // Guardamos los datos en memoria temporal
    tempInvoiceData = { 
        prov: provName, 
        ids: idsString.split(','), 
        total: amount 
    };

    const today = getISO();

    showModal('Nueva Factura', `
        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 mb-4 text-center">
            <div class="text-xs text-indigo-400 font-bold uppercase mb-1">Proveedor</div>
            <div class="text-xl font-black text-indigo-900">${clean(provName)}</div>
            <div class="text-2xl font-black text-indigo-600 mt-2">${Num.fmt(amount)}‚Ç¨</div>
        </div>

        <label>N√∫mero de Factura (Obligatorio)</label>
        <input type="text" id="inv-num" class="input-premium mb-3 font-mono text-lg font-bold" placeholder="Ej: F-2024/001">
        
        <label>Fecha de Emisi√≥n</label>
        <input type="date" id="inv-date" value="${today}" class="input-premium mb-6">

        <button class="btn-premium btn-action shadow-indigo-200" onclick="confirmInvoice()">
            ‚úÖ CONFIRMAR Y GUARDAR
        </button>
    `);
    
    // Poner el foco en el input para escribir r√°pido
    setTimeout(() => document.getElementById('inv-num').focus(), 100);
}
function confirmInvoice() {
    if (!tempInvoiceData) return closeModal();

    const num = document.getElementById('inv-num').value.trim();
    const date = document.getElementById('inv-date').value;

    if (!num) return toast("‚ö†Ô∏è Falta el n√∫mero de factura", "error");
    if (!date) return toast("‚ö†Ô∏è Falta la fecha", "error");

    let totalBase = 0;
    let totalTax = 0;

    // 1. Procesar albaranes y sumar impuestos desglosados
    tempInvoiceData.ids.forEach(id => {
        const a = db.albaranes.find(x => x.id === id);
        if (a) {
            a.invoiced = true;
            // COMPATIBILIDAD: Si el albar√°n es viejo y no tiene subtotal, usamos el total como base
            totalBase += (a.subtotal !== undefined ? a.subtotal : a.total); 
            totalTax += (a.taxes || 0);     
        }
    });

    // 2. Crear la factura (Ahora guardamos base y tax para la contabilidad)
    db.facturas.push({
        id: generateID(),
        num: num,
        date: date,
        prov: tempInvoiceData.prov,
        base: totalBase,  // <-- Nuevo dato
        tax: totalTax,    // <-- Nuevo dato
        total: tempInvoiceData.total,
        paid: false
    });

    save(`Factura ${num} Generada ‚úÖ`);
    tempInvoiceData = null;
    closeModal();
    renderAdmin(document.getElementById('app'));
}
// Cambiar estado Pagado/Pendiente
function togglePaid(id) { 
    const f = db.facturas.find(x => x.id === id); 
    if (f) { 
        f.paid = !f.paid; 
        save(); 
        renderAdmin(document.getElementById('app')); 
    } 
}
function downloadMonthCSV(monthIndex, monthName) {
    const list = db.facturas.filter(f => {
        if (!isInPeriod(f.date)) return false; 
        const m = parseInt(f.date.split('-')[1]);
        return m === monthIndex;
    });

    if (!list.length) return toast("No hay datos para exportar", "error");

    // A√ëADIDAS COLUMNAS: BASE IMPONIBLE Y CUOTA IVA
    const headers = ['Fecha;Factura_Num;Proveedor;Estado;Base_Imponible;Cuota_IVA;Total_EUR'];
    
    const rows = list.map(f => {
        // COMPATIBILIDAD: Si es vieja y no tiene base, ponemos el total en base y 0 en IVA
        const base = f.base ? Num.csv(f.base) : Num.csv(f.total); 
        const tax = f.tax ? Num.csv(f.tax) : '0,00';
        
        return `${f.date};"${f.num}";"${clean(f.prov)}";${f.paid ? 'PAGADO' : 'PENDIENTE'};${base};${tax};${Num.csv(f.total)}`;
    });

    const csvContent = headers.concat(rows).join('\n');
    const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `Contabilidad_${monthName}_${fiscalYear}.csv`;
    a.click();
}
/* =============================================================
   üìä M√ìDULO INGENIER√çA DE MEN√ö (OMNES) - CORREGIDO
   ============================================================= */
/* =============================================================
   üìä M√ìDULO OMNES AVANZADO (MATRIZ + MARGEN REAL)
   ============================================================= */
function renderOmnes(c) {
    // 1. CABECERA CON NAVEGACI√ìN
    const headerHTML = `
    <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-slate-800 flex items-center gap-2">
            üìä MENU ENGINEERING 
            <span class="bg-indigo-600 text-white px-2 py-0.5 rounded text-[10px] tracking-widest font-black">${fiscalYear}</span>
        </h3>
        <div class="flex bg-slate-100 p-1 rounded-lg gap-1">
             <button class="w-8 h-8 flex items-center justify-center bg-white rounded shadow-sm text-xs font-bold hover:text-indigo-600 active:scale-95 transition" onclick="fiscalYear--;renderAdmin(document.getElementById('app'))">‚Äπ</button>
             <button class="w-8 h-8 flex items-center justify-center bg-white rounded shadow-sm text-xs font-bold hover:text-indigo-600 active:scale-95 transition" onclick="fiscalYear++;renderAdmin(document.getElementById('app'))">‚Ä∫</button>
        </div>
    </div>
    <div class="mb-6">
        <button class="btn-premium py-3 text-xs w-full bg-slate-800 text-white shadow-lg shadow-slate-300 flex items-center justify-center gap-2" onclick="openPasteModal()">
            <span>üìã</span> PEGAR VENTAS (IMPORTADOR)
        </button>
    </div>`;

    // 2. COMPROBACI√ìN DE DATOS
    if (!db.sales_history.length) {
        c.innerHTML = `${headerHTML}
        <div class="p-8 text-center border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50">
            <div class="text-4xl mb-2 opacity-50">üìâ</div>
            <p class="text-sm text-slate-400 font-bold">No hay datos de ventas en ${fiscalYear}.</p>
            <p class="text-xs text-slate-400 mt-1">Usa el bot√≥n negro de arriba para pegar tu Excel.</p>
        </div>`;
        return;
    }

    // 3. MOTOR DE C√ÅLCULO (MARGEN DE CONTRIBUCI√ìN)
    let totalQtySold = 0;
    let totalMarginGenerated = 0;
    const salesMap = {};

    // Agrupar ventas
    db.sales_history.filter(log => isInPeriod(log.date)).forEach(log => {
        log.items.forEach(it => {
            const rid = it.rid || db.recetas.find(r => r.n === it.n)?.id;
            if (rid) salesMap[rid] = (salesMap[rid] || 0) + it.q;
        });
    });

    // Crear Dataset Enriquecido
    const dataset = db.recetas.map(r => {
        const sales = salesMap[r.id] || 0;
        if (sales === 0) return null;

        const cost = calcRecipe(r).t; 
        const marginUnit = r.pvp - cost; 
        const totalMargin = marginUnit * sales; // ESTA ES LA CLAVE: Margen total que deja el plato

        totalQtySold += sales;
        totalMarginGenerated += totalMargin;

        return { r, sales, cost, pvp: r.pvp, marginUnit, totalMargin };
    }).filter(x => x !== null);

    if (dataset.length === 0) {
        c.innerHTML = `${headerHTML}<div class="p-4 bg-orange-50 text-orange-600 rounded border border-orange-200 text-xs font-bold">‚ö†Ô∏è Hay historial de ventas, pero no coinciden con las recetas activas. Revisa los nombres en Cocina.</div>`;
        return;
    }

    // 4. CLASIFICACI√ìN (MATRIZ DE BOSTON)
    const avgMargin = totalMarginGenerated / totalQtySold; // Eje Y
    const fairShare = (100 / dataset.length) * 0.7;        // Eje X (Popularidad Te√≥rica Ajustada)

    const matrix = { stars: [], plowhorses: [], puzzles: [], dogs: [] };
    dataset.forEach(d => {
        const mix = (d.sales / totalQtySold) * 100;
        const isPopular = mix >= fairShare;
        const isProfitable = d.marginUnit >= avgMargin;

        if (isPopular && isProfitable) matrix.stars.push(d);      
        else if (isPopular && !isProfitable) matrix.plowhorses.push(d); 
        else if (!isPopular && isProfitable) matrix.puzzles.push(d);    
        else matrix.dogs.push(d);                                       
    });

    // Helper para pintar las mini-listas dentro de los cuadrantes
    const miniList = (list) => list.sort((a,b)=>b.totalMargin-a.totalMargin).map(d => 
        `<div class="flex justify-between text-[9px] border-b border-black/5 py-1.5 last:border-0 items-center group cursor-help" title="Margen Total: ${Num.fmt(d.totalMargin)}‚Ç¨">
            <span class="truncate w-2/3 font-medium text-slate-700 group-hover:text-black transition">${clean(d.r.n)}</span>
            <span class="font-bold opacity-60 bg-white/60 px-1.5 rounded">${d.sales}</span>
        </div>`).join('');

    // 5. RENDERIZADO (GRID VISUAL)
    c.innerHTML = `
    ${headerHTML}

    <div class="flex justify-between text-[9px] font-bold text-slate-400 mb-2 uppercase tracking-wider px-1">
        <span>Rentabilidad Media: ${Num.fmt(avgMargin)}‚Ç¨</span>
        <span>Popularidad Obj: ${fairShare.toFixed(1)}%</span>
    </div>

    <div class="grid grid-cols-2 gap-2 mb-4 h-96">
        
        <div class="bg-gradient-to-br from-yellow-50 to-amber-100 rounded-xl p-3 border border-yellow-200 relative overflow-hidden flex flex-col shadow-sm">
            <div class="absolute -right-3 -top-3 text-7xl opacity-10 grayscale">üåü</div>
            <h4 class="font-black text-amber-700 text-[10px] uppercase mb-2 flex justify-between items-center border-b border-amber-200 pb-1">
                ESTRELLAS <span class="bg-white px-1.5 rounded shadow-sm text-amber-600">${matrix.stars.length}</span>
            </h4>
            <div class="flex-1 overflow-y-auto custom-scrollbar pr-1 relative z-10">${miniList(matrix.stars)}</div>
        </div>

        <div class="bg-gradient-to-br from-emerald-50 to-teal-100 rounded-xl p-3 border border-emerald-200 relative overflow-hidden flex flex-col shadow-sm">
            <div class="absolute -right-3 -top-3 text-7xl opacity-10 grayscale">üß©</div>
            <h4 class="font-black text-emerald-700 text-[10px] uppercase mb-2 flex justify-between items-center border-b border-emerald-200 pb-1">
                PUZZLES <span class="bg-white px-1.5 rounded shadow-sm text-emerald-600">${matrix.puzzles.length}</span>
            </h4>
            <div class="flex-1 overflow-y-auto custom-scrollbar pr-1 relative z-10">${miniList(matrix.puzzles)}</div>
        </div>

        <div class="bg-gradient-to-br from-blue-50 to-indigo-100 rounded-xl p-3 border border-blue-200 relative overflow-hidden flex flex-col shadow-sm">
            <div class="absolute -right-3 -top-3 text-7xl opacity-10 grayscale">üêé</div>
            <h4 class="font-black text-blue-700 text-[10px] uppercase mb-2 flex justify-between items-center border-b border-blue-200 pb-1">
                CABALLOS <span class="bg-white px-1.5 rounded shadow-sm text-blue-600">${matrix.plowhorses.length}</span>
            </h4>
            <div class="flex-1 overflow-y-auto custom-scrollbar pr-1 relative z-10">${miniList(matrix.plowhorses)}</div>
        </div>

        <div class="bg-gradient-to-br from-red-50 to-pink-100 rounded-xl p-3 border border-red-200 relative overflow-hidden flex flex-col shadow-sm">
            <div class="absolute -right-3 -top-3 text-7xl opacity-10 grayscale">üêï</div>
            <h4 class="font-black text-red-700 text-[10px] uppercase mb-2 flex justify-between items-center border-b border-red-200 pb-1">
                PERROS <span class="bg-white px-1.5 rounded shadow-sm text-red-600">${matrix.dogs.length}</span>
            </h4>
            <div class="flex-1 overflow-y-auto custom-scrollbar pr-1 relative z-10">${miniList(matrix.dogs)}</div>
        </div>
    </div>

    <div class="glass-card flex justify-around text-center py-4 mb-6 shadow-md border-0 bg-slate-800 text-white">
        <div>
            <div class="text-[9px] text-slate-400 uppercase font-bold">Margen Total</div>
            <div class="text-xl font-black text-emerald-400">${Num.fmt(totalMarginGenerated)}‚Ç¨</div>
        </div>
        <div>
            <div class="text-[9px] text-slate-400 uppercase font-bold">Ticket Medio (PVP)</div>
            <div class="text-xl font-black text-indigo-400">${Num.fmt((totalMarginGenerated/totalQtySold) + dataset.reduce((a,b)=>a+b.cost*b.sales,0)/totalQtySold)}‚Ç¨</div>
        </div>
    </div>
    
    <div class="glass-card border-t-4 border-orange-500">
        <h4 class="text-xs font-black text-orange-800 uppercase tracking-widest mb-3">‚öñÔ∏è An√°lisis de Precios (Omnes)</h4>
        ${renderOmnesPrinciples(dataset)}
    </div>
    `;
}
// Auxiliar Omnes
function renderOmnesPrinciples(data) {
    const prices = data.filter(d => d.pvp > 0).map(d => d.pvp).sort((a,b) => a - b);
    if(prices.length < 2) return '<div class="text-xs text-slate-400">Datos insuficientes.</div>';
    const min = prices[0], max = prices[prices.length-1];
    const rangeRatio = min > 0 ? max/min : 0;
    return `<div class="flex justify-between text-xs border-b border-dashed border-slate-200 pb-2"><span class="text-slate-600">Amplitud Gama (Max/Min)</span><span class="font-bold ${rangeRatio <= 3 ? 'text-emerald-600':'text-red-500'}">${rangeRatio.toFixed(2)} (Meta < 3)</span></div>`;
}
/* =============================================================
   ‚ö†Ô∏è 4. IMPORTADOR ESPECIALIZADO ARUME (VISUAL + EDICI√ìN) ‚ö†Ô∏è
   ============================================================= */

function processArumeExcel(input) {
    const file = input.files[0];
    if (!file) return;
    
    loading(true);
    const reader = new FileReader();
    
    reader.onload = e => {
        try {
            const content = e.target.result;
            const result = parseArumeCSV(content);
            if (result.items.length > 0) {
                // Aqu√≠ abrimos el modal para que el usuario verifique y edite
                showEditableImportModal(result.items, result.date);
            } else {
                toast("‚ùå Formato no reconocido. Usa el Excel de caja.", "error");
            }
        } catch (err) {
            console.error(err);
            toast("‚ùå Error cr√≠tico leyendo archivo", "error");
        } finally {
            loading(false);
            input.value = ''; 
        }
    };
    reader.readAsText(file, "ISO-8859-1"); 
}

function parseArumeCSV(text) {
    // Regex especial para cortar CSV respetando comillas (ej: "Ternera, setas")
    const splitCSV = (row) => row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
    
    const lines = text.split(/\r?\n/);
    let detectedDate = getISO();
    const itemsMap = new Map();

    // INDICES EXACTOS SEG√öN TUS ARCHIVOS (0-based)
    // Columna 4 (D) -> Index 3: Nombre
    // Columna 12 (L) -> Index 11: Cantidad
    // Columna 21 (U) -> Index 20: Importe Bruto (Total)
    const COL_NAME = 3;
    const COL_QTY = 11;
    const COL_TOTAL = 20;

    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        
        // A. Detectar Fecha (Ej: "D√≠a: 10/01/2026")
        const dateMatch = line.match(/(\d{2})[\/](\d{2})[\/](\d{4})/);
        if (dateMatch) {
            detectedDate = `${dateMatch[3]}-${dateMatch[2]}-${dateMatch[1]}`;
        }

        // B. Saltar l√≠neas basura
        if (!line.includes(',') || line.length < 15) continue;
        const cols = splitCSV(line);
        
        // Seguridad: Asegurar que la l√≠nea es lo suficientemente larga
        if (cols.length <= COL_TOTAL) continue;

        // C. Extraer y limpiar
        const rawName = cols[COL_NAME].replace(/"/g, '').trim();
        const rawQty = cols[COL_QTY].replace(/"/g, '').trim();
        const rawTotal = cols[COL_TOTAL].replace(/"/g, '').trim();

        // D. Filtros (Ignorar cabeceras y totales finales)
        if (!rawName || rawName.includes('Art√≠culo') || rawName.includes('Total:')) continue;
        
        const qty = parseFloat(rawQty);
        const total = parseFloat(rawTotal);

        // E. Agregar al mapa (suma duplicados si salen en varias l√≠neas)
        if (!isNaN(qty) && qty !== 0) {
            if (itemsMap.has(rawName)) {
                const prev = itemsMap.get(rawName);
                prev.q += qty;
                prev.t += total;
            } else {
                itemsMap.set(rawName, { q: qty, t: total || 0 });
            }
        }
    }

    // Convertir a lista y buscar enlace con BD
    const results = [];
    const normalize = (s) => s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();

    itemsMap.forEach((val, name) => {
        const cleanName = normalize(name);
        const pvpCalc = val.q !== 0 ? Math.abs(val.t / val.q) : 0; // PVP Unitario real
        
        const match = db.recetas.find(r => normalize(r.n) === cleanName);
        
        results.push({
            id: generateID(), // ID temporal UI
            name: name,       // Nombre original Excel
            qty: val.q,
            pvp: pvpCalc,
            matchId: match ? match.id : null, 
            status: match ? 'linked' : 'new'
        });
    });

    return { items: results, date: detectedDate };
}

// --- VISOR EDITABLE (EL MODAL M√ÅGICO) ---
function showEditableImportModal(items, dateStr) {
    tempImportData = items; 

    // Generar filas editables
    const rowsHTML = items.map((item, index) => {
        const isLinked = item.status === 'linked';
        const colorClass = isLinked ? 'bg-emerald-50/50' : 'bg-orange-50/50';
        const icon = isLinked ? '‚úÖ' : 'üÜï';
        
        return `
        <div class="grid grid-cols-12 gap-2 items-center border-b border-slate-100 py-2 px-1 text-xs ${colorClass}">
            <div class="col-span-1 text-center text-lg">${icon}</div>
            <div class="col-span-5">
                <input type="text" value="${clean(item.name)}" 
                    class="w-full bg-transparent font-bold text-slate-700 outline-none placeholder-slate-400" 
                    onchange="updateTempItem(${index}, 'name', this.value)">
                ${!isLinked ? '<div class="text-[9px] text-orange-500 font-bold">Se crear√° nueva receta</div>' : ''}
            </div>
            <div class="col-span-3">
                <input type="number" value="${item.qty}" 
                    class="w-full bg-white border border-slate-200 rounded px-1 py-1 text-center font-bold text-slate-800 focus:ring-2 ring-indigo-200 outline-none"
                    onchange="updateTempItem(${index}, 'qty', this.value)">
            </div>
            <div class="col-span-2 relative">
                <input type="number" step="0.01" value="${item.pvp.toFixed(2)}" 
                    class="w-full bg-white border border-slate-200 rounded px-1 py-1 text-center text-slate-500 text-[10px]"
                    onchange="updateTempItem(${index}, 'pvp', this.value)">
                <span class="absolute right-1 top-1.5 text-[8px] text-slate-400">‚Ç¨</span>
            </div>
            <div class="col-span-1 text-center">
                <button class="text-red-400 hover:text-red-600 font-bold px-2" onclick="removeTempItem(${index})">‚úï</button>
            </div>
        </div>`;
    }).join('');

    const totalImporte = items.reduce((sum, i) => sum + (i.qty * i.pvp), 0);

    showModal('üìù Revisar y Confirmar Carga', `
        <div class="bg-indigo-50 p-3 rounded-xl border border-indigo-100 mb-4">
            <div class="flex justify-between items-end mb-2">
                <div>
                    <label class="text-[10px] font-bold text-indigo-400 uppercase block mb-1">Fecha de Venta</label>
                    <input type="date" id="import-date-final" value="${dateStr}" class="bg-white/50 border-b-2 border-indigo-200 font-black text-indigo-900 text-lg outline-none w-full text-center rounded-t">
                </div>
                <div class="text-right">
                    <div class="text-[10px] font-bold text-slate-400 uppercase">Total Bruto</div>
                    <div class="text-xl font-black text-slate-800">${Num.fmt(totalImporte)}‚Ç¨</div>
                </div>
            </div>
            <div class="text-[10px] text-indigo-500 font-medium">
                ‚ÑπÔ∏è Puedes corregir cantidades o nombres aqu√≠ mismo antes de guardar.
            </div>
        </div>

        <div class="bg-white border border-slate-200 rounded-xl overflow-hidden mb-4 shadow-inner">
            <div class="grid grid-cols-12 gap-2 bg-slate-50 border-b border-slate-200 py-2 px-1 text-[9px] font-black text-slate-400 uppercase text-center tracking-wider">
                <div class="col-span-1">Est</div>
                <div class="col-span-5 text-left pl-1">Producto</div>
                <div class="col-span-3">Cantidad</div>
                <div class="col-span-2">Precio/Ud</div>
                <div class="col-span-1"></div>
            </div>
            <div class="max-h-60 overflow-y-auto custom-scrollbar" id="import-grid-body">
                ${rowsHTML}
            </div>
        </div>

        <div class="flex gap-2 pt-2 border-t border-slate-100">
            <button class="btn-ghost" onclick="closeModal()">Cancelar</button>
            <button class="btn-premium shadow-xl flex-1 bg-gradient-to-r from-indigo-600 to-blue-600" onclick="commitSalesImport()">
                üöÄ PROCESAR Y ANALIZAR
            </button>
        </div>
    `);
}

function updateTempItem(index, field, value) {
    if (tempImportData[index]) {
        if (field === 'qty' || field === 'pvp') {
            tempImportData[index][field] = parseFloat(value) || 0;
        } else {
            tempImportData[index][field] = value;
        }
    }
}

function removeTempItem(index) {
    tempImportData.splice(index, 1);
    const date = document.getElementById('import-date-final').value;
    showEditableImportModal(tempImportData, date); // Refrescar totales
}

// --- 5. GUARDADO DEFINITIVO EN DB ---
function commitSalesImport() {
    const finalDate = document.getElementById('import-date-final').value;
    if (!finalDate) return toast("Fecha obligatoria", "error");
    if (tempImportData.length === 0) return toast("Tabla vac√≠a", "error");

    // A. Ajustar A√±o Fiscal si el archivo es de otro a√±o
    const year = parseInt(finalDate.split('-')[0]);
    if (year !== fiscalYear) fiscalYear = year;

    // B. Evitar duplicados (Borrar carga previa de ese d√≠a)
    const existingIdx = db.sales_history.findIndex(l => l.date === finalDate);
    if (existingIdx >= 0) db.sales_history.splice(existingIdx, 1);

    const log = { id: generateID(), date: finalDate, items: [] };
    let newCount = 0;

    // C. Procesar l√≠neas
    tempImportData.forEach(item => {
        let recId = item.matchId;

        // Si es producto nuevo, crear Receta
        if (!recId) {
            // Re-verificar existencia por nombre
            const exist = db.recetas.find(r => r.n.toLowerCase() === item.name.toLowerCase());
            if (exist) {
                recId = exist.id;
                // Actualizar PVP si viene del excel
                if(item.pvp > 0) exist.pvp = item.pvp; 
            } else {
                recId = generateID();
                db.recetas.push({
                    id: recId,
                    n: item.name,
                    pvp: item.pvp,
                    items: [], // Sin ingredientes a√∫n
                    yield: 1, unit: 'ud', time: 0
                });
                newCount++;
            }
        } else {
            // Actualizar PVP de receta existente para que Omnes sea real
            const r = db.recetas.find(x => x.id === recId);
            if (r && item.pvp > 0) r.pvp = item.pvp;
        }

        // Agregar al log de ventas
        log.items.push({ rid: recId, n: item.name, q: item.qty });

        // D. Descontar Stock (Opcional pero recomendado)
        const r = db.recetas.find(x => x.id === recId);
        if (r && r.items) {
            r.items.forEach(it => {
                if (it.type === 'ing') {
                    const ing = db.ingredientes.find(x => x.id === it.id);
                    if (ing) {
                        const factor = UnitConverter.convert(1, it.unit||ing.unit, ing.unit);
                        const yieldFactor = it.merma ? (1-(it.merma/100)) : 1;
                        const qtyOut = (item.qty * it.q * factor) / yieldFactor;
                        ing.stock -= qtyOut;
                    }
                }
            });
        }
    });

    db.sales_history.push(log);
    
    save(`‚úÖ Datos guardados (${newCount} recetas creadas)`);
    closeModal();
    renderAdmin(document.getElementById('app')); // Recargar para ver los gr√°ficos
}
function renderOmnesPrinciples(data) {
    const prices = data.filter(d => d.pvp > 0).map(d => d.pvp).sort((a,b) => a - b);
    if(prices.length < 2) return '<div class="text-xs text-slate-400">Datos insuficientes para an√°lisis de precios.</div>';

    const min = prices[0], max = prices[prices.length-1];
    const rangeRatio = min > 0 ? max/min : 0;
    
    const step = (max - min) / 3;
    const low = prices.filter(p => p < min + step).length;
    const mid = prices.filter(p => p >= min + step && p < min + step*2).length;
    const high = prices.filter(p => p >= min + step*2).length;
    const curveOk = mid >= low && mid >= high;

    return `
    <div class="space-y-3">
        <div class="flex justify-between text-xs border-b border-dashed border-slate-200 pb-2">
            <span class="text-slate-600">1. Amplitud Gama (Max/Min)</span>
            <span class="font-bold ${rangeRatio <= 3 ? 'text-emerald-600':'text-red-500'}">${rangeRatio.toFixed(2)} (Meta < 3)</span>
        </div>
        <div class="flex justify-between text-xs border-b border-dashed border-slate-200 pb-2">
            <span class="text-slate-600">2. Curva Precios (Campana)</span>
            <span class="font-bold ${curveOk ? 'text-emerald-600':'text-red-500'}">${curveOk ? '‚úÖ Equilibrada' : '‚ö†Ô∏è Desviada'}</span>
        </div>
        <div class="flex h-2 rounded-full overflow-hidden w-full bg-slate-100 mt-1">
            <div class="bg-blue-300" style="width:${(low/prices.length)*100}%" title="Bajos"></div>
            <div class="bg-blue-500" style="width:${(mid/prices.length)*100}%" title="Medios"></div>
            <div class="bg-blue-800" style="width:${(high/prices.length)*100}%" title="Altos"></div>
        </div>
        <div class="flex justify-between text-[8px] text-slate-400 mt-0.5 font-mono">
            <span>BAJOS: ${low}</span><span>MEDIOS: ${mid}</span><span>ALTOS: ${high}</span>
        </div>
    </div>`;
}
// Auxiliar para pintar Omnes limpio
function renderOmnesPrinciples(data) {
    const prices = data.filter(d => d.pvp > 0).map(d => d.pvp).sort((a,b) => a - b);
    if(prices.length < 2) return '<div class="text-xs text-slate-400">Se necesitan m√°s precios para calcular.</div>';

    const min = prices[0], max = prices[prices.length-1];
    const rangeRatio = min > 0 ? max/min : 0;
    
    // C√°lculo de Curva (3 zonas)
    const step = (max - min) / 3;
    const low = prices.filter(p => p < min + step).length;
    const mid = prices.filter(p => p >= min + step && p < min + step*2).length;
    const high = prices.filter(p => p >= min + step*2).length;
    const curveOk = mid >= low && mid >= high;

    return `
    <div class="space-y-3">
        <div class="flex justify-between text-xs border-b border-dashed border-slate-200 pb-2">
            <span class="text-slate-600">1. Amplitud Gama (Max/Min)</span>
            <span class="font-bold ${rangeRatio <= 3 ? 'text-emerald-600':'text-red-500'}">${rangeRatio.toFixed(2)} (Meta < 3)</span>
        </div>
        <div class="flex justify-between text-xs border-b border-dashed border-slate-200 pb-2">
            <span class="text-slate-600">2. Curva Precios (Campana)</span>
            <span class="font-bold ${curveOk ? 'text-emerald-600':'text-red-500'}">${curveOk ? '‚úÖ Equilibrada' : '‚ö†Ô∏è Desviada'}</span>
        </div>
        <div class="flex h-1.5 rounded-full overflow-hidden w-full bg-slate-100 mt-1">
            <div class="bg-blue-300" style="width:${(low/prices.length)*100}%"></div>
            <div class="bg-blue-500" style="width:${(mid/prices.length)*100}%"></div>
            <div class="bg-blue-800" style="width:${(high/prices.length)*100}%"></div>
        </div>
    </div>`;
}
function commitSales() {
    let log = { id: generateID(), date: getTS(), items: [] };
    let hasData = false;
    
    db.recetas.forEach(r => {
        const el = document.getElementById(`sale-${r.id}`);
        const qty = Num.parse(el.value);
        
        if (qty > 0) {
            hasData = true;
            // 1. Registrar venta para estad√≠sticas
            log.items.push({ rid: r.id, n: r.n, q: qty });
            
            // 2. Descontar Stock (Escandallo inverso)
            r.items.forEach(it => {
                if (it.type === 'ing') {
                    const ing = db.ingredientes.find(x => x.id === it.id);
                    if (ing) {
                        // Conversi√≥n de unidad receta -> unidad almac√©n
                        const factor = UnitConverter.convert(1, it.unit||ing.unit, ing.unit);
                        const totalNeeded = (it.q * factor * qty) / (it.merma ? (1-(it.merma/100)) : 1);
                        
                        ing.stock -= totalNeeded;
                        // Registramos movimiento en Kardex
                        logStock(ing.id, totalNeeded, 'OUT', `Venta: ${r.n}`, ing.cost);
                    }
                }
            });
        }
    });

    if (hasData) {
        db.sales_history.push(log);
        save("Ventas procesadas y Stock actualizado");
        closeModal();
        renderAdmin(document.getElementById('app'));
    } else {
        toast("No has introducido cantidades", "error");
    }
}

/* =============================================================
   ‚ö†Ô∏è 11.5 M√ìDULO EVENTOS (ONLYONE) ‚ö†Ô∏è
   ============================================================= */

// Variable global para mantener el ID del evento en edici√≥n
let currentEventId = null;

function renderEventos(c) {
    if (!db.eventos) db.eventos = [];
    
    // Filtrar eventos del periodo actual
    const eventosPeriodo = db.eventos.filter(e => isInPeriod(e.date));
    
    // Calcular totales para "Caja Negra"
    const totalIngresos = eventosPeriodo.reduce((acc, e) => acc + (Num.parse(e.ingreso) || 0), 0);
    const totalPersonalExtra = eventosPeriodo.reduce((acc, e) => acc + (Num.parse(e.personalExtra) || 0), 0);
    
    // Filtrar albaranes de OnlyOne en el periodo
    const albaranesOnlyOne = db.albaranes.filter(a => a.socio === 'OnlyOne' && isInPeriod(a.date));
    const totalAlbaranesOnlyOne = albaranesOnlyOne.reduce((acc, a) => acc + (a.total || 0), 0);
    
    // CAJA NEGRA = Ingresos - Albaranes OnlyOne - Personal Extra
    const cajaNegra = totalIngresos - totalAlbaranesOnlyOne - totalPersonalExtra;
    
    // HTML del formulario de eventos
    const formHTML = `
    <div class="glass-card border-l-4 border-pink-500">
        <h3 class="font-bold text-slate-700 text-sm mb-4 uppercase">Nuevo / Editar Evento</h3>
        
        <div class="grid grid-cols-2 gap-2 mb-3">
            <div>
                <label>Fecha</label>
                <input type="date" id="evt-date" value="${getISO()}" class="input-premium">
            </div>
            <div>
                <label>Tipo de Evento</label>
                <select id="evt-tipo" class="input-premium">
                    <option value="Boda">üíí Boda</option>
                    <option value="Comuni√≥n">‚õ™ Comuni√≥n</option>
                    <option value="Bautizo">üë∂ Bautizo</option>
                    <option value="Cumplea√±os">üéÇ Cumplea√±os</option>
                    <option value="Empresa">üè¢ Evento Empresa</option>
                    <option value="Otro">üìÖ Otro</option>
                </select>
            </div>
        </div>
        
        <div class="mb-3">
            <label>T√≠tulo / Nombre del Evento</label>
            <input id="evt-title" class="input-premium" placeholder="Ej: Boda de Juan y Mar√≠a">
        </div>
        
        <div class="grid grid-cols-2 gap-2 mb-3">
            <div>
                <label>Ingreso Total (‚Ç¨)</label>
                <input type="number" id="evt-ingreso" class="input-premium text-center font-bold text-emerald-700" placeholder="0.00" step="0.01">
            </div>
            <div>
                <label>Personal Extra (‚Ç¨)</label>
                <input type="number" id="evt-personal" class="input-premium text-center font-bold text-orange-600" placeholder="0.00" step="0.01">
            </div>
        </div>
        
        <div class="mb-3">
            <label>Notas / Observaciones</label>
            <textarea id="evt-notes" class="input-premium" rows="2" placeholder="Detalles del evento..."></textarea>
        </div>
        
        <div class="flex gap-2">
            <button class="btn-premium btn-action flex-1" onclick="saveEvent()">üíæ GUARDAR EVENTO</button>
            <button class="btn-ghost" onclick="clearEventForm()">üîÑ LIMPIAR</button>
        </div>
    </div>`;
    
    // HTML de la Caja Negra
    const cajaNegraHTML = `
    <div class="glass-card bg-gradient-to-br from-slate-900 to-slate-800 text-white mb-6 border-none shadow-2xl">
        <h3 class="text-[10px] uppercase font-bold opacity-70 mb-2 tracking-[0.2em]">üí∞ CAJA NEGRA ONLYONE</h3>
        <div class="text-4xl font-black mb-4 ${cajaNegra >= 0 ? 'text-emerald-400' : 'text-red-400'}">${Num.fmt(cajaNegra)}‚Ç¨</div>
        
        <div class="grid grid-cols-3 gap-3 pt-4 border-t border-white/10">
            <div class="text-center">
                <div class="text-[9px] opacity-60 uppercase tracking-widest mb-1">Ingresos</div>
                <div class="font-bold text-emerald-300">+${Num.fmt(totalIngresos)}‚Ç¨</div>
            </div>
            <div class="text-center">
                <div class="text-[9px] opacity-60 uppercase tracking-widest mb-1">Compras</div>
                <div class="font-bold text-red-300">-${Num.fmt(totalAlbaranesOnlyOne)}‚Ç¨</div>
            </div>
            <div class="text-center">
                <div class="text-[9px] opacity-60 uppercase tracking-widest mb-1">Personal</div>
                <div class="font-bold text-orange-300">-${Num.fmt(totalPersonalExtra)}‚Ç¨</div>
            </div>
        </div>
    </div>`;
    
    // HTML de la lista de eventos
    const eventosListHTML = eventosPeriodo.length > 0 ? eventosPeriodo
        .sort((a, b) => b.date.localeCompare(a.date))
        .map(e => `
            <div class="bg-white p-4 rounded-xl shadow-sm mb-3 border border-slate-100 hover:shadow-md transition">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-lg">${getTipoIcon(e.tipo)}</span>
                            <h4 class="font-bold text-slate-800">${clean(e.title || 'Sin t√≠tulo')}</h4>
                        </div>
                        <div class="text-xs text-slate-500 flex gap-3 flex-wrap">
                            <span>üìÖ ${e.date}</span>
                            <span>üíº ${e.tipo || 'Otro'}</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-black text-emerald-600 text-lg">${Num.fmt(e.ingreso || 0)}‚Ç¨</div>
                        <div class="text-[10px] text-slate-400">Ingreso</div>
                    </div>
                </div>
                
                ${e.personalExtra ? `
                <div class="bg-orange-50 px-3 py-1.5 rounded-lg text-xs mb-2">
                    <span class="text-orange-600 font-bold">üë• Personal Extra:</span>
                    <span class="font-black text-orange-700">${Num.fmt(e.personalExtra)}‚Ç¨</span>
                </div>` : ''}
                
                ${e.notes ? `
                <div class="bg-slate-50 px-3 py-2 rounded-lg text-xs text-slate-600 mb-2 italic">
                    "${clean(e.notes)}"
                </div>` : ''}
                
                <div class="flex gap-2 items-center justify-between mt-3 pt-3 border-t border-slate-100">
                    <div class="flex gap-1">
                        <button class="btn-icon btn-edit text-xs" onclick="editEvent('${e.id}')" title="Editar">‚úèÔ∏è</button>
                        <button class="btn-icon btn-delete text-xs" onclick="deleteEvent('${e.id}')" title="Eliminar">üóëÔ∏è</button>
                        <button class="btn-icon btn-log text-xs" onclick="openEventCalendar('${e.id}')" title="Google Calendar">üìÖ</button>
                    </div>
                    <div class="flex gap-1">
                        <button class="btn-ghost text-[10px] px-2 py-1" onclick="printEventBudget('${e.id}')">üñ®Ô∏è IMPRIMIR</button>
                        <span class="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-1 rounded font-bold" title="Compras asociadas a este evento">
                            Compras: ${Num.fmt(sumAlbaranesForEvent(e.date))}‚Ç¨
                        </span>
                    </div>
                </div>
            </div>
        `).join('') 
        : '<div class="text-center p-8 text-slate-400 border-2 border-dashed rounded-xl">Sin eventos este periodo</div>';
    
    // HTML de albaranes OnlyOne
    const albaranesHTML = `
    <div class="glass-card">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-slate-800 flex items-center gap-2">
                <span>üç∏</span>
                <span>COMPRAS ONLYONE</span>
            </h3>
            <div class="bg-slate-100 px-3 py-1 rounded-lg">
                <span class="text-[9px] text-slate-400 uppercase font-bold">Total</span>
                <span class="font-bold text-slate-700 ml-1">${Num.fmt(totalAlbaranesOnlyOne)}‚Ç¨</span>
            </div>
        </div>
        
        <div class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar">
            ${albaranesOnlyOne.length > 0 ? albaranesOnlyOne
                .sort((a, b) => b.date.localeCompare(a.date))
                .map(a => `
                    <div class="bg-white p-3 rounded-lg border border-slate-100 flex justify-between items-center hover:bg-slate-50 transition">
                        <div>
                            <div class="font-bold text-sm text-slate-700">${clean(a.prov)}</div>
                            <div class="text-[10px] text-slate-400">
                                <span>üìÖ ${a.date}</span>
                                ${a.num ? `<span class="ml-2">Ref: ${a.num}</span>` : ''}
                            </div>
                        </div>
                        <div class="font-bold text-slate-800">${Num.fmt(a.total)}‚Ç¨</div>
                    </div>
                `).join('')
                : '<div class="text-center text-slate-400 text-xs py-4">Sin compras OnlyOne este periodo</div>'}
        </div>
    </div>`;
    
    // Renderizado final
    c.innerHTML = `
        ${cajaNegraHTML}
        ${formHTML}
        
        <div class="glass-card mt-6">
            <h3 class="font-bold text-slate-800 mb-4 uppercase text-sm tracking-wide">üìã EVENTOS REGISTRADOS</h3>
            ${eventosListHTML}
        </div>
        
        ${albaranesHTML}
    `;
}

// Funci√≥n auxiliar para obtener el icono del tipo de evento
function getTipoIcon(tipo) {
    const icons = {
        'Boda': 'üíí',
        'Comuni√≥n': '‚õ™',
        'Bautizo': 'üë∂',
        'Cumplea√±os': 'üéÇ',
        'Empresa': 'üè¢',
        'Otro': 'üìÖ'
    };
    return icons[tipo] || 'üìÖ';
}

// Guardar evento (nuevo o edici√≥n)
window.saveEvent = function() {
    const date = document.getElementById('evt-date').value;
    const tipo = document.getElementById('evt-tipo').value;
    const title = document.getElementById('evt-title').value.trim();
    const ingreso = Num.parse(document.getElementById('evt-ingreso').value);
    const personalExtra = Num.parse(document.getElementById('evt-personal').value);
    const notes = document.getElementById('evt-notes').value.trim();
    
    if (!date || !title) {
        return toast("Faltan datos obligatorios", "error");
    }
    
    const evento = {
        id: currentEventId || generateID(),
        date: date,
        tipo: tipo,
        title: title,
        ingreso: ingreso,
        personalExtra: personalExtra,
        notes: notes,
        created: currentEventId ? (db.eventos.find(e => e.id === currentEventId)?.created || getTS()) : getTS()
    };
    
    const idx = db.eventos.findIndex(e => e.id === evento.id);
    if (idx >= 0) {
        db.eventos[idx] = evento;
    } else {
        db.eventos.push(evento);
    }
    
    save("Evento guardado ‚úÖ");
    clearEventForm();
    renderAdmin(document.getElementById('app'));
};

// Editar evento existente
window.editEvent = function(id) {
    const evento = db.eventos.find(e => e.id === id);
    if (!evento) return toast("Evento no encontrado", "error");
    
    currentEventId = id;
    document.getElementById('evt-date').value = evento.date || getISO();
    document.getElementById('evt-tipo').value = evento.tipo || 'Otro';
    document.getElementById('evt-title').value = evento.title || '';
    document.getElementById('evt-ingreso').value = evento.ingreso || '';
    document.getElementById('evt-personal').value = evento.personalExtra || '';
    document.getElementById('evt-notes').value = evento.notes || '';
    
    // Hacer scroll al formulario
    document.getElementById('evt-title').focus();
    document.getElementById('evt-title').scrollIntoView({ behavior: 'smooth', block: 'center' });
};

// Eliminar evento
window.deleteEvent = function(id) {
    if (confirm("¬øEliminar este evento?")) {
        db.eventos = db.eventos.filter(e => e.id !== id);
        save("Evento eliminado");
        renderAdmin(document.getElementById('app'));
    }
};

// Limpiar formulario
window.clearEventForm = function() {
    currentEventId = null;
    document.getElementById('evt-date').value = getISO();
    document.getElementById('evt-tipo').value = 'Boda';
    document.getElementById('evt-title').value = '';
    document.getElementById('evt-ingreso').value = '';
    document.getElementById('evt-personal').value = '';
    document.getElementById('evt-notes').value = '';
};

// Imprimir presupuesto del evento
window.printEventBudget = function(id) {
    const evento = db.eventos.find(e => e.id === id);
    if (!evento) return toast("Evento no encontrado", "error");
    
    const albaranesEvento = db.albaranes.filter(a => 
        a.socio === 'OnlyOne' && a.date === evento.date
    );
    const totalAlbaranes = albaranesEvento.reduce((acc, a) => acc + (a.total || 0), 0);
    const beneficio = (evento.ingreso || 0) - totalAlbaranes - (evento.personalExtra || 0);
    
    const html = `
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>Presupuesto Evento - ${clean(evento.title)}</title>
        <style>
            body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
            h1 { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; }
            .info { margin: 20px 0; }
            .info-row { display: flex; justify-content: space-between; padding: 5px 0; }
            .info-row.bold { font-weight: bold; font-size: 1.2em; border-top: 2px solid #000; margin-top: 10px; padding-top: 10px; }
            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; }
            .total { text-align: right; font-weight: bold; }
        </style>
    </head>
    <body>
        <h1>PRESUPUESTO EVENTO</h1>
        <div class="info">
            <div class="info-row"><span>Evento:</span><span><strong>${clean(evento.title)}</strong></span></div>
            <div class="info-row"><span>Tipo:</span><span>${evento.tipo || 'Otro'}</span></div>
            <div class="info-row"><span>Fecha:</span><span>${evento.date}</span></div>
        </div>
        
        <h2>Detalle Econ√≥mico</h2>
        <table>
            <tr>
                <th>Concepto</th>
                <th style="text-align: right;">Importe</th>
            </tr>
            <tr>
                <td>Ingreso Total</td>
                <td class="total">${Num.fmt(evento.ingreso || 0)}‚Ç¨</td>
            </tr>
            <tr>
                <td>Compras (Albaranes OnlyOne)</td>
                <td class="total">-${Num.fmt(totalAlbaranes)}‚Ç¨</td>
            </tr>
            <tr>
                <td>Personal Extra</td>
                <td class="total">-${Num.fmt(evento.personalExtra || 0)}‚Ç¨</td>
            </tr>
            <tr style="background-color: #f9f9f9;">
                <td><strong>BENEFICIO NETO</strong></td>
                <td class="total"><strong>${Num.fmt(beneficio)}‚Ç¨</strong></td>
            </tr>
        </table>
        
        ${evento.notes ? `
        <div class="info">
            <h3>Observaciones</h3>
            <p>${clean(evento.notes)}</p>
        </div>` : ''}
        
        <p style="text-align: center; margin-top: 40px; font-size: 0.9em; color: #666;">
            Generado el ${new Date().toLocaleString('es-ES')} por ARUME ERP
        </p>
    </body>
    </html>`;
    
    const win = window.open('', '_blank');
    win.document.write(html);
    win.document.close();
    setTimeout(() => win.print(), 250);
};

// Abrir Google Calendar con el evento
window.openEventCalendar = function(id) {
    const evento = db.eventos.find(e => e.id === id);
    if (!evento) return toast("Evento no encontrado", "error");
    
    // Formato de fecha para Google Calendar (YYYYMMDDTHHmmss)
    // Por defecto: eventos de 10:00 a 22:00 (horario t√≠pico de eventos)
    const startDate = evento.date.replace(/-/g, '') + 'T100000';
    const endDate = evento.date.replace(/-/g, '') + 'T220000';
    
    const title = encodeURIComponent(evento.title || 'Evento');
    const details = encodeURIComponent(`${evento.tipo || 'Evento'}\n\nIngreso: ${Num.fmt(evento.ingreso || 0)}‚Ç¨\nPersonal Extra: ${Num.fmt(evento.personalExtra || 0)}‚Ç¨\n\n${evento.notes || ''}`);
    const location = encodeURIComponent('ARUME');
    
    const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${startDate}/${endDate}&details=${details}&location=${location}`;
    
    window.open(url, '_blank');
};

// Sumar albaranes que coincidan con la fecha del evento
window.sumAlbaranesForEvent = function(dateStr) {
    if (!dateStr || !db.albaranes) return 0;
    
    const albaranes = db.albaranes.filter(a => 
        a.socio === 'OnlyOne' && a.date === dateStr
    );
    
    return albaranes.reduce((acc, a) => acc + (a.total || 0), 0);
};

/* =============================================================
   ‚ö†Ô∏è 12. M√ìDULO COCINA PRO (RECETAS, ESCANDALLOS Y FICHA T√âCNICA) ‚ö†Ô∏è
   ============================================================= */

function renderCocina(app) {
    // üõ°Ô∏è AUTO-REPARACI√ìN DE DATOS PERDIDOS
    if (!db.recetas && db.recipes && db.recipes.length > 0) {
        db.recetas = JSON.parse(JSON.stringify(db.recipes)); // Migrar datos viejos
        delete db.recipes; // Limpiar
        save("Recetas recuperadas de versi√≥n anterior");
    }
    if (!db.recetas) db.recetas = [];

    const list = db.recetas.sort((a,b) => a.n.localeCompare(b.n));
    
    app.innerHTML = `
    <div class="glass-card">
        <div class="flex justify-between items-center mb-4">
            <h2 class="font-black text-xl text-slate-800 flex items-center gap-2">
                üç≥ COCINA <span class="bg-indigo-100 text-indigo-600 px-2 rounded-full text-xs">${list.length}</span>
            </h2>
            <button class="btn-premium w-auto px-4 py-3 text-xs" onclick="editRec()">Ôºã NUEVA RECETA</button>
        </div>
        <input placeholder="üîç Buscar escandallo..." onkeyup="filterRec(this.value)" class="input-premium mb-4">
        <div id="rec-grid" class="space-y-3">
            ${renderRecGrid(list)}
        </div>
    </div>`;
}

function renderRecGrid(list) {
    if (!list || !list.length) return '<div class="text-center p-8 text-slate-400 border-2 border-dashed rounded-xl bg-slate-50/50">No hay recetas creadas.<br>Pulsa "NUEVA RECETA" para empezar.</div>';
    
    return list.map(r => {
        const c = calcRecipe(r); 
        const fc = r.pvp > 0 ? (c.t/r.pvp)*100 : 0;
        
        // --- C√ÅLCULO DISPONIBILIDAD (SEM√ÅFORO) ---
        const max = calcMaxProd(r);
        let stockBadge = '';
        
        if (max === Infinity) {
            stockBadge = '<span class="text-[9px] bg-slate-100 text-slate-400 px-2 py-1 rounded border">‚ôæÔ∏è</span>';
        } else if (max < 5) {
            stockBadge = `<span class="text-[9px] bg-red-100 text-red-600 font-black px-2 py-1 rounded animate-pulse border border-red-200">‚ö†Ô∏è SOLO ${max}</span>`;
        } else if (max < 15) {
            stockBadge = `<span class="text-[9px] bg-orange-100 text-orange-600 font-bold px-2 py-1 rounded border border-orange-200">üü† ${max} rac.</span>`;
        } else {
            stockBadge = `<span class="text-[9px] bg-emerald-100 text-emerald-600 font-bold px-2 py-1 rounded border border-emerald-200">‚úÖ ${max} rac.</span>`;
        }

        return `
        <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm cursor-pointer flex justify-between items-center group hover:border-indigo-300 hover:shadow-md transition" onclick="viewRec('${r.id}')">
            <div>
                <div class="font-bold text-slate-800 text-sm mb-1">${clean(r.n)}</div>
                <div class="flex gap-2 items-center">
                    ${stockBadge}
                    <span class="text-[9px] text-slate-400">${(r.items || []).length} ingr.</span>
                </div>
            </div>
            <div class="text-right">
                <div class="font-black text-slate-700">${Num.fmt(c.t)}‚Ç¨</div>
                <div class="text-[10px] font-bold ${fc > 35 ? 'text-red-500' : 'text-emerald-500'}">FC: ${fc.toFixed(1)}%</div>
            </div>
        </div>`;
    }).join('');
}

function filterRec(txt) { 
    if(!db.recetas) return;
    const filtered = db.recetas.filter(r => r.n.toLowerCase().includes(txt.toLowerCase()));
    document.getElementById('rec-grid').innerHTML = renderRecGrid(filtered); 
}
/* =============================================================
   üß† MOTOR DE C√ÅLCULO V.FINAL (Costes Reales + Al√©rgenos Recursivos)
   ============================================================= */
const recipeCache = new Map();

function clearCache() { recipeCache.clear(); }

function calcRecipe(r, visited = new Set()) {
    // Inicializamos al√©rgenos (los propios de la receta si tuviera + los heredados)
    let activeAllergens = new Set(r.alg || []);

    if (!r) return { t: 0, foodCost: 0, laborCost: 0, fixedCost: 0, allergens: [] };
    
    if (recipeCache.has(r.id)) return recipeCache.get(r.id);
    if (visited.has(r.id)) return { t: 0, allergens: [] }; 
    visited.add(r.id);

    let totalIngredientsCost = 0;

    (r.items || []).forEach(it => {
        const merma = it.merma || 0;
        const yieldFactor = 1 - (merma / 100); 
        
        if (it.type === 'ing') {
            const i = db.ingredientes.find(x => x.id === it.id);
            if (i) {
                const qtyInBaseUnit = UnitConverter.convert(it.q, it.unit || i.unit, i.unit);
                totalIngredientsCost += (qtyInBaseUnit / yieldFactor) * i.cost;
                // üî• HERENCIA DE AL√âRGENOS: Si el ingrediente tiene, la receta los hereda
                if(i.alg) i.alg.forEach(a => activeAllergens.add(a));
            }
        } else if (it.type === 'rec') {
            const sub = db.recetas.find(x => x.id === it.id);
            if (sub) {
                const subFull = calcRecipe(sub, new Set(visited)); // Recursividad
                const subCost = subFull.t; 
                const subYield = sub.yield || 1;
                const costPerUnit = subCost / subYield;
                
                const qtyNormalized = UnitConverter.convert(it.q, it.unit, sub.unit || 'rac');
                totalIngredientsCost += (qtyNormalized / yieldFactor) * costPerUnit;
                
                // üî• HERENCIA DE SUB-RECETAS: Heredamos los al√©rgenos de la salsa/relleno
                if(subFull.allergens) subFull.allergens.forEach(a => activeAllergens.add(a));
            }
        }
    });

    // C√°lculos Financieros
    const foodCost = totalIngredientsCost * 1.03; // +3% Mermas ocultas
    const laborCost = ((r.time || 0) / 60) * CONFIG.COST_HOUR;
    const fixedCostPerDish = CONFIG.FIXED_COST_MONTH / CONFIG.EST_MONTHLY_SALES;
    const totalReal = foodCost + laborCost + fixedCostPerDish;
    
    const result = { 
        t: totalReal, 
        foodCost, 
        laborCost, 
        fixedCost: fixedCostPerDish,
        allergens: Array.from(activeAllergens) // Convertimos Set a Array para usarlo luego
    };
    
    recipeCache.set(r.id, result);
    return result;
}
// --- C√ÅLCULO DE M√ÅXIMO PRODUCIBLE (STOCK) ---
function calcMaxProd(r, visited = new Set()) {
    if (!r || !r.items || !r.items.length) return Infinity;
    if (visited.has(r.id)) return Infinity;
    visited.add(r.id);

    let minRatio = Infinity;

    r.items.forEach(it => {
        if (it.type === 'ing') {
            const i = db.ingredientes.find(x => x.id === it.id);
            if (i) {
                // Convertir stock a la unidad de la receta
                const stockInRecipeUnit = UnitConverter.convert(i.stock, i.unit, it.unit);
                const yieldFactor = it.merma ? (1 - (it.merma / 100)) : 1;
                const needed = it.q / yieldFactor;
                if(needed > 0) {
                    const possible = stockInRecipeUnit / needed;
                    if (possible < minRatio) minRatio = possible;
                }
            } else {
                minRatio = 0; // Falta el ingrediente
            }
        } 
        // Nota: Para sub-recetas ser√≠a m√°s complejo, simplificado aqu√≠
    });

    return minRatio === Infinity ? 0 : Math.floor(minRatio);
}
function editRec(id) {
    const r = id ? db.recetas.find(x => x.id === id) : { id: generateID(), n: '', pvp: 0, time: 15, items: [], inst: '', yield: 1, unit: 'rac' }; 
    tempItems = JSON.parse(JSON.stringify(r.items || []));

    showModal('Ficha T√©cnica & Escandallo', `
        <div class="grid grid-cols-12 gap-3 mb-2">
            <div class="col-span-8">
                <label>Nombre Receta</label>
                <input id="er-n" value="${clean(r.n)}" class="input-premium font-bold" placeholder="Ej: Vinagreta Algas">
            </div>
            <div class="col-span-4">
                <label>PVP Venta (‚Ç¨)</label>
                <input id="er-pvp" type="number" value="${r.pvp}" class="input-premium text-center">
            </div>
        </div>

        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 mb-6 shadow-inner relative z-50">
            <label class="mb-2 text-indigo-800 font-bold flex items-center gap-2">üîç A√±adir Ingrediente / Sub-receta</label>
            
            <input type="text" id="smart-search" 
                class="w-full p-3 rounded-lg border-2 border-indigo-200 font-bold text-slate-700 focus:border-indigo-500 focus:outline-none bg-white mb-2" 
                placeholder="Escribe para buscar (ej: Soja, Salsa...)" 
                onkeyup="runSmartSearch(this.value)" autocomplete="off">
            
            <div id="search-results" class="hidden absolute top-[85px] left-4 right-4 bg-white border border-slate-200 rounded-xl shadow-2xl max-h-56 overflow-y-auto z-[60]"></div>

            <div id="add-controls" class="hidden flex gap-2 items-center bg-white p-2 rounded-lg border border-slate-200 mt-2">
                <div class="font-black text-indigo-900 flex-1 truncate px-2 text-xs" id="sel-name"></div>
                <input id="er-q" type="number" class="input-premium w-20 text-center border-indigo-200" placeholder="Cant.">
                <select id="er-u" class="input-premium w-20 text-xs bg-slate-100 font-bold"></select>
                <button class="bg-indigo-600 text-white rounded-lg w-10 h-10 font-bold shadow-lg hover:bg-indigo-700 active:scale-95 transition" onclick="addItemFromSearch()">+</button>
            </div>
        </div>

        <div class="flex justify-between px-2 text-[10px] font-bold text-slate-400 uppercase mb-1">
            <span>Escandallo</span><span>Cantidad</span>
        </div>
        <div id="er-list" class="max-h-40 overflow-y-auto custom-scrollbar bg-white rounded-lg border border-slate-200 p-1 mb-4"></div>

        <div class="flex gap-2">
            <div class="flex-1">
                 <label>Rendimiento</label>
                 <div class="flex gap-1">
                    <input id="er-yield" type="number" value="${r.yield || 1}" class="input-premium text-center">
                    <select id="er-unit" class="input-premium w-20"><option>rac</option><option>l</option><option>kg</option><option>ud</option></select>
                 </div>
            </div>
            <div class="flex-1">
                 <label>Tiempo (min)</label>
                 <input id="er-time" type="number" value="${r.time}" class="input-premium text-center">
            </div>
        </div>

        <label class="mt-4">Instrucciones</label>
        <textarea id="er-inst" class="input-premium mb-4 text-sm" rows="2">${clean(r.inst)}</textarea>
        
        <div class="flex gap-2">
            <button class="btn-premium flex-1" onclick="saveRec('${r.id}')">üíæ GUARDAR FICHA</button>
            ${id ? `<button class="btn-ghost w-auto text-red-500" onclick="delRec('${id}')">üóëÔ∏è</button>` : ''}
        </div>
    `);
    renderRecItems();
}
function renderRecTypes() {
    const sel = document.getElementById('er-sel');
    if(!sel) return;
    
    const ings = db.ingredientes
        .sort((a,b)=>a.n.localeCompare(b.n))
        .map(i=>`<option value="${i.id}" data-t="ing">üì¶ ${clean(i.n)}</option>`)
        .join('');
    
    const recs = db.recetas
        .sort((a,b)=>a.n.localeCompare(b.n))
        .map(r=>`<option value="${r.id}" data-t="rec">üç≤ SUB: ${clean(r.n)}</option>`)
        .join('');
    
    sel.innerHTML = `<optgroup label="--- SEMIELABORADOS ---">${recs}</optgroup><optgroup label="--- MATERIA PRIMA ---">${ings}</optgroup>`;
    updUnit();
}

function updUnit() {
    const sel = document.getElementById('er-sel'); 
    const uSel = document.getElementById('er-u');
    if(!sel || !uSel) return;

    const opt = sel.options[sel.selectedIndex];
    const type = opt ? opt.dataset.t : 'ing';
    
    let opts = [];
    if(type === 'rec') {
        opts = ['rac', 'l', 'kg']; 
    } else {
        opts = ['kg', 'g', 'l', 'ml', 'cl', 'ud', 'oz', 'lb', 'mg'];
    }
    
    uSel.innerHTML = opts.map(u => `<option>${u}</option>`).join('');
}

function addItem() {
    const sel = document.getElementById('er-sel'); 
    if(!sel) return;
    
    const type = sel.options[sel.selectedIndex].dataset.t;
    const q = parseFloat(document.getElementById('er-q').value);
    
    if(q > 0) { 
        tempItems.push({
            type, 
            id: sel.value, 
            q, 
            unit: document.getElementById('er-u').value, 
            merma: 0
        }); 
        renderRecItems();
        // Limpiar input cantidad para agilizar
        document.getElementById('er-q').value = '';
        document.getElementById('er-q').focus();
    } else {
        toast("Cantidad inv√°lida", "error");
    }
}

function renderRecItems() {
    const el = document.getElementById('er-list');
    if(!el) return;

    el.innerHTML = tempItems.map((it,i) => {
        let n="?", icon="üì¶"; 
        if(it.type==='ing'){ const x=db.ingredientes.find(z=>z.id===it.id); if(x)n=x.n; } 
        else { const x=db.recetas.find(z=>z.id===it.id); if(x){n=x.n; icon="üç≤";} }
        
        return `
        <div class="flex justify-between py-2 border-b border-slate-50 last:border-0 text-sm items-center hover:bg-slate-50 px-2 rounded">
            <div class="flex items-center">
                <span class="mr-2 text-xs">${icon}</span>
                <span class="font-medium text-slate-700">${n}</span>
            </div>
            <div class="flex items-center gap-3">
                <span class="font-bold text-slate-900">${it.q} ${it.unit}</span>
                <button class="text-red-400 hover:text-red-600 font-bold" onclick="tempItems.splice(${i},1);renderRecItems()">‚úï</button>
            </div>
        </div>`;
    }).join('');
}

function saveRec(id) {
    const n = document.getElementById('er-n').value; 
    if(!n) return toast("Falta nombre", "error");

    const r = { 
        id, n, 
        pvp: parseFloat(document.getElementById('er-pvp').value) || 0, 
        time: parseFloat(document.getElementById('er-time').value) || 0,
        yield: parseFloat(document.getElementById('er-yield').value) || 1,
        unit: document.getElementById('er-unit').value,
        items: [...tempItems], // Copia segura
        inst: document.getElementById('er-inst').value 
    };

    const idx = db.recetas.findIndex(x => x.id === id);
    if(idx >= 0) db.recetas[idx] = r; else db.recetas.push(r);
    
    clearCache(); 
    save("Ficha T√©cnica Guardada ‚úÖ"); 
    closeModal(); 
    render('Cocina');
}

function delRec(id) { 
    if(confirm("¬øBorrar receta definitivamente?")) { 
        db.recetas = db.recetas.filter(x => x.id !== id); 
        save("Receta borrada"); 
        closeModal(); 
        render('Cocina'); 
    } 
}
/* =============================================================
   üëÅÔ∏è VISOR DE RECETA "MICHELIN STAR" (Gesti√≥n + Operativa)
   ============================================================= */
function viewRec(id) {
    const r = db.recetas.find(x=>x.id===id); if(!r)return;
    const c = calcRecipe(r);

    // Sem√°foro Financiero
    const beneficio = r.pvp - c.t;
    const esRentable = beneficio > 0;
    const colorClass = esRentable ? 'bg-emerald-100 text-emerald-800' : 'bg-red-100 text-red-800 animate-pulse';
    
    // Iconos de al√©rgenos detectados autom√°ticamente
    const algIcons = (c.allergens || []).map(k => {
        const a = ALLERGENS.find(x=>x.k===k);
        return a ? `<span title="${a.k}" class="text-2xl cursor-help drop-shadow-sm">${a.i}</span>` : '';
    }).join(' ');

    showModal(clean(r.n), `
        <div class="flex justify-between items-start mb-4">
            <div class="bg-white border border-slate-200 p-2 rounded-lg shadow-sm text-center min-w-[80px]">
                <div class="text-[8px] uppercase font-bold text-slate-400">Al√©rgenos</div>
                <div class="flex gap-1 justify-center mt-1 min-h-[24px]">${algIcons || '<span class="text-xs text-emerald-500 font-bold">Libre</span>'}</div>
            </div>
            
            <div class="bg-indigo-50 border border-indigo-100 p-2 rounded-lg flex-1 ml-2">
                <div class="text-[9px] font-bold text-indigo-400 uppercase mb-1">üéØ Objetivo de Venta</div>
                <div class="flex items-center gap-2">
                    <span class="text-[9px] text-indigo-800">Si vendo a:</span>
                    <input type="number" value="${r.pvp}" class="w-16 text-center font-bold bg-white border border-indigo-200 rounded text-xs" 
                    oninput="calcTargetMargin(this.value, ${c.t})">
                    <span class="text-[9px] text-indigo-800">Margen: <span id="target-margin" class="font-black">${((1 - c.t/r.pvp)*100).toFixed(0)}%</span></span>
                </div>
            </div>
        </div>

        <div class="bg-slate-50 p-3 rounded-xl border border-slate-200 mb-4 text-xs">
            <div class="flex justify-between mb-1"><span>ü•¶ Materia Prima (FC)</span> <b>${Num.fmt(c.foodCost)}‚Ç¨</b></div>
            <div class="flex justify-between mb-1"><span>üë®‚Äçüç≥ Mano de Obra</span> <b>${Num.fmt(c.laborCost)}‚Ç¨</b></div>
            <div class="flex justify-between mb-1 border-b border-slate-200 pb-1"><span>üí° Estructura (${Num.fmt(CONFIG.FIXED_COST_MONTH)})</span> <b>${Num.fmt(c.fixedCost)}‚Ç¨</b></div>
            <div class="flex justify-between mt-1 text-sm text-slate-800"><span>TOTAL COSTE REAL</span> <b class="font-black">${Num.fmt(c.t)}‚Ç¨</b></div>
        </div>

        <div class="flex justify-between items-center mb-4 ${colorClass} p-3 rounded-xl border border-white shadow-sm">
            <div>
                <div class="text-[10px] uppercase font-bold opacity-70">PVP Actual</div>
                <div class="text-2xl font-black">${Num.fmt(r.pvp)}‚Ç¨</div>
            </div>
            <div class="text-right">
                <div class="text-[10px] uppercase font-bold opacity-70">Beneficio Neto</div>
                <div class="text-xl font-black">${Num.fmt(beneficio)}‚Ç¨</div>
            </div>
        </div>

        <div class="bg-slate-800 text-white p-3 rounded-xl mb-4 flex items-center justify-between shadow-lg">
            <div>
                <div class="text-[10px] font-bold text-slate-400 uppercase">Producir para</div>
                <div class="font-bold text-lg">üìù Escandallo</div>
            </div>
            <div class="flex items-center gap-2 bg-white/10 p-1 rounded-lg">
                <input type="number" value="1" id="scale-factor" class="w-12 text-center font-bold text-lg bg-transparent outline-none text-white" oninput="updateRecQuantities(this.value, '${id}')">
                <span class="text-xs font-bold opacity-70 pr-2">${r.unit}</span>
            </div>
        </div>

        <h6 class="text-xs font-bold text-slate-400 uppercase mb-2">Ingredientes (Peso Neto)</h6>
        <ul id="rec-ing-list" class="text-sm mb-4 bg-white border border-slate-100 rounded-xl p-2 max-h-40 overflow-y-auto custom-scrollbar"></ul>
        
        <div class="grid grid-cols-2 gap-2 mt-4">
            <button class="btn-premium bg-indigo-600 shadow-indigo-200 py-3" onclick="openCookMode('${id}')">üë®‚Äçüç≥ MODO COCINA</button>
            <button class="btn-ghost border-slate-300 text-slate-600 font-bold" onclick="printLabel('${id}')">üè∑Ô∏è ETIQUETA FIFO</button>
        </div>
        <div class="flex gap-2 mt-2">
            <button class="btn-ghost flex-1 text-[10px]" onclick="window.print()">üñ®Ô∏è FICHA A4</button>
            <button class="btn-premium flex-1 py-2 text-xs" onclick="editRec('${id}')">EDITAR DATOS</button>
        </div>
    `);
    
    updateRecQuantities(1, id);
    
    // Exponer funci√≥n para la calculadora inversa
    window.calcTargetMargin = (pvp, cost) => {
        const m = pvp > 0 ? ((1 - cost/pvp)*100) : 0;
        const el = document.getElementById('target-margin');
        if(el) {
            el.innerText = m.toFixed(0) + '%';
            el.className = m > 15 ? 'font-black text-emerald-600' : 'font-black text-red-500';
        }
    };
}
// --- FUNCI√ìN AUXILIAR PARA ESCALAR CANTIDADES EN TIEMPO REAL ---
window.updateRecQuantities = function(factor, id) {
    const r = db.recetas.find(x=>x.id===id);
    if(!r) return;
    
    const list = document.getElementById('rec-ing-list');
    if(!list) return;

    list.innerHTML = r.items.map(it => {
        let n="?", q = it.q * factor;
        let brutoInfo = "";
        
        // Calcular Peso Bruto si hay merma (Lo que el cocinero debe coger del almac√©n)
        if(it.merma > 0) {
            const qBruto = q / (1 - (it.merma/100));
            brutoInfo = `<span class="text-[9px] text-red-400 font-bold ml-1">(Bruto: ${Num.fmt(qBruto)} ${it.unit})</span>`;
        }

        if(it.type==='ing'){ const i=db.ingredientes.find(x=>x.id===it.id); if(i)n=i.n; } 
        else { const s=db.recetas.find(x=>x.id===it.id); if(s)n="ü•£ "+s.n; }
        
        return `
        <li class="flex justify-between py-2 border-b border-slate-50 last:border-0 items-center">
            <span class="text-slate-700 font-medium">${n} ${brutoInfo}</span>
            <span class="font-black text-slate-900 font-mono bg-slate-100 px-2 py-0.5 rounded">${Num.fmt(q)} ${it.unit}</span>
        </li>`;
    }).join('');
};

// --- MODO COCINA (PANTALLA COMPLETA "BULLI STYLE") ---
window.openCookMode = function(id) {
    const r = db.recetas.find(x=>x.id===id);
    const factor = document.getElementById('scale-factor').value || 1;
    
    const content = `
    <div class="fixed inset-0 bg-white z-[999] flex flex-col overflow-hidden">
        <div class="bg-slate-900 text-white p-6 flex justify-between items-center shadow-xl">
            <div>
                <h1 class="text-3xl font-black tracking-tight">${clean(r.n)}</h1>
                <p class="text-slate-400 font-bold text-lg mt-1">Producci√≥n: <span class="text-white">${factor}</span> raciones / unidades</p>
            </div>
            <button onclick="closeModal()" class="bg-white/10 text-white px-6 py-3 rounded-xl font-bold hover:bg-red-500 transition">‚úï SALIR</button>
        </div>
        
        <div class="flex-1 flex overflow-hidden">
            <div class="w-1/3 bg-slate-50 p-6 overflow-y-auto border-r border-slate-200">
                <h3 class="text-slate-400 font-black uppercase tracking-widest mb-6 border-b border-slate-200 pb-2">Mise en Place </h3>
                <div class="space-y-4">
                    ${r.items.map(it => {
                        let n="?"; 
                        if(it.type==='ing'){ const i=db.ingredientes.find(x=>x.id===it.id); if(i)n=i.n; } 
                        else { const s=db.recetas.find(x=>x.id===it.id); if(s)n="ü•£ "+s.n; }
                        
                        const qNeto = it.q * factor;
                        const qBruto = it.merma > 0 ? qNeto / (1-(it.merma/100)) : qNeto;
                        
                        return `
                        <div class="flex items-center gap-4">
                            <input type="checkbox" class="w-6 h-6 accent-emerald-500 cursor-pointer">
                            <div>
                                <div class="text-2xl font-black text-slate-800">${Num.fmt(qBruto)} <span class="text-sm text-slate-500">${it.unit}</span></div>
                                <div class="font-bold text-slate-600 text-lg">${n}</div>
                                ${it.merma > 0 ? `<div class="text-xs text-red-400 font-bold">Merma ${it.merma}% (Neto: ${Num.fmt(qNeto)})</div>` : ''}
                            </div>
                        </div>`;
                    }).join('')}
                </div>
            </div>
            
            <div class="w-2/3 p-8 overflow-y-auto bg-white">
                <h3 class="text-slate-400 font-black uppercase tracking-widest mb-6 border-b border-slate-200 pb-2">Elaboraci√≥n</h3>
                <div class="prose prose-xl text-slate-700 leading-relaxed font-serif">
                    ${clean(r.inst).split('\n').map(line => line.trim() ? `<p class="mb-4 p-4 hover:bg-yellow-50 rounded-xl transition border-l-4 border-transparent hover:border-yellow-400">${line}</p>` : '').join('')}
                </div>
                ${!r.inst ? '<div class="text-center text-slate-300 text-2xl font-bold mt-20">Sin instrucciones escritas</div>' : ''}
            </div>
        </div>
    </div>`;
    
    // Inyectamos esto directamente en el body para tapar todo
    const el = document.createElement('div');
    el.innerHTML = content;
    document.body.appendChild(el);
    
    // Sobrescribimos closeModal temporalmente para destruir esta vista
    const oldClose = window.closeModal;
    window.closeModal = function() {
        el.remove();
        window.closeModal = oldClose; // Restaurar
        // Volver a abrir el modal normal
        viewRec(id);
    };
};
    /* === M√ìDULO DE ESTRUCTURA (GASTOS FIJOS) === */
function renderGastosFijos(c) {
    const list = db.gastos_fijos || [];
    
    // Calcular total mensual aproximado
    const totalMensual = list.reduce((acc, g) => {
        return acc + (g.freq === 'mensual' ? g.amount : g.amount / 12);
    }, 0);

    c.innerHTML = `
    <div class="glass-card">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-slate-800">ESTRUCTURA DE COSTES</h3>
            <div class="text-right">
                <div class="text-[10px] text-slate-400 font-bold uppercase">Coste Fijo Mes</div>
                <div class="font-black text-slate-700 text-lg">${Num.fmt(totalMensual)}‚Ç¨</div>
            </div>
        </div>

        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 mb-6">
            <h4 class="text-xs font-bold text-indigo-800 mb-2 uppercase">A√±adir Gasto Recurrente</h4>
            <div class="grid grid-cols-12 gap-2 mb-2">
                <div class="col-span-5"><input id="gf-n" placeholder="Concepto (ej: Alquiler)" class="input-premium"></div>
                <div class="col-span-3"><input id="gf-a" type="number" placeholder="‚Ç¨" class="input-premium text-center"></div>
                <div class="col-span-4">
                    <select id="gf-f" class="input-premium">
                        <option value="mensual">Mensual</option>
                        <option value="anual">Anual</option>
                        <option value="trimestral">Trimestral</option>
                    </select>
                </div>
            </div>
            <button class="btn-premium btn-action w-full" onclick="addGastoFijo()">GUARDAR GASTO</button>
        </div>

        <div class="space-y-2">
            ${list.length ? list.map((g, i) => `
                <div class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm flex justify-between items-center">
                    <div>
                        <div class="font-bold text-slate-700">${clean(g.n)}</div>
                        <div class="text-[10px] bg-slate-100 px-2 rounded inline-block text-slate-500 uppercase font-bold">${g.freq}</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-black text-slate-800">${Num.fmt(g.amount)}‚Ç¨</span>
                        <button class="text-red-400 hover:text-red-600 font-bold px-2" onclick="delGastoFijo(${i})">‚úï</button>
                    </div>
                </div>
            `).join('') : '<div class="text-center text-slate-400 text-xs py-4">No hay gastos fijos definidos</div>'}
        </div>
    </div>`;
}

function addGastoFijo() {
    const n = document.getElementById('gf-n').value;
    const a = parseFloat(document.getElementById('gf-a').value);
    const f = document.getElementById('gf-f').value;
    
    if (n && a > 0) {
        if (!db.gastos_fijos) db.gastos_fijos = [];
        // Creamos un ID √∫nico y guardamos la fecha para saber cu√°ndo se aplica
        db.gastos_fijos.push({ id: generateID(), n, amount: a, freq: f, date: getISO() });
        save("Gasto fijo a√±adido");
        renderAdmin(document.getElementById('app'));
    } else {
        toast("Revisa los datos", "error");
    }
}

function delGastoFijo(index) {
    if(confirm("¬øEliminar este gasto fijo?")) {
        db.gastos_fijos.splice(index, 1);
        save("Gasto eliminado");
        renderAdmin(document.getElementById('app'));
    }
}
/* =============================================================
   ‚ö†Ô∏è 13. M√ìDULO DE STOCK Y PEDIDOS (COMPLETO Y CORREGIDO) ‚ö†Ô∏è
   ============================================================= */

function renderStock(app) {
    // 1. Preparamos la lista base
    let list = db.ingredientes
        .filter(i => i.n.toLowerCase().includes(searchFilter.toLowerCase()));

    // 2. C√ÅLCULO ABC (Detectar Joyas) üíé
    // Calculamos el valor monetario de cada item (Stock * Coste)
    list.forEach(i => i._val = i.stock * i.cost);
    
    // Ordenamos por valor para encontrar el Top 20%
    const sortedByVal = [...list].sort((a,b) => b._val - a._val);
    const top20Count = Math.ceil(list.length * 0.2); 
    const highValueIds = sortedByVal.slice(0, top20Count).map(i => i.id);

    // 3. Filtros de visualizaci√≥n
    if(activeFamily !== 'Todos' && activeFamily !== 'Joyas') {
        list = list.filter(i => (i.fam || 'General') === activeFamily);
    }
    if (activeFamily === 'Joyas') {
        list = list.filter(i => highValueIds.includes(i.id));
    }

    // Ordenaci√≥n visual (Alfab√©tica por defecto)
    list.sort((a,b) => a.n.localeCompare(b.n));

    // Valor Total del Inventario visible
    const totalStockValue = list.reduce((acc, i) => acc + (i._val), 0);

    // 4. Generar Chips de Categor√≠as
    const cats = [`<button class="px-3 py-1 rounded-full text-[10px] border whitespace-nowrap ${activeFamily==='Joyas' ? 'bg-indigo-600 text-white border-indigo-600 shadow-md' : 'bg-white text-indigo-600 border-indigo-200'}" onclick="activeFamily='Joyas';render('Stock')">üíé JOYAS (Top 20%)</button>`]
        .concat(['Todos', ...FAMILIES].map(c => 
            `<button class="px-3 py-1 rounded-full text-[10px] border whitespace-nowrap ${activeFamily===c ? 'bg-slate-800 text-white' : 'bg-white'}" onclick="activeFamily='${c}';render('Stock')">${c}</button>`
    )).join('');

    app.innerHTML = `
        <div class="glass-card ${inventoryMode ? 'border-l-4 border-orange-500' : ''}">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold flex items-center gap-2">${inventoryMode ? 'üìã MODO AUDITOR√çA' : 'üì¶ ALMAC√âN'}</h3>
                
                <div class="bg-slate-100 px-3 py-1 rounded-lg border border-slate-200">
                    <span class="text-[9px] text-slate-400 uppercase font-bold">Valor Visible</span>
                    <span class="font-bold text-slate-700 ml-1">${Num.fmt(totalStockValue)}‚Ç¨</span>
                </div>
            </div>
            
            <div class="flex justify-end gap-2 mb-3">
                 ${!inventoryMode ? `<button class="btn-whatsapp text-xs px-3" onclick="sendWhatsApp()">üìû PEDIDO</button>` : ''}
                 <button class="btn-ghost text-xs px-3" onclick="toggleInventoryMode()">${inventoryMode ? 'SALIR' : 'AUDITAR'}</button>
            </div>
            
            <input class="input-premium mb-3" placeholder="üîç Buscar producto..." onkeyup="searchFilter=this.value;render('Stock')" value="${searchFilter}">
            
            <div class="flex gap-2 overflow-x-auto pb-2 mb-2 no-scrollbar">${cats}</div>

            <div class="max-h-[60vh] overflow-y-auto space-y-2 pr-1">
                ${list.map(i => {
                    const low = i.stock < (i.min || 0);
                    const isJewel = highValueIds.includes(i.id);
                    
                    // L√≥gica del Chivato de Inflaci√≥n
                    let trend = '';
                    if (i.lastCost) {
                        const diff = i.cost - i.lastCost;
                        const pct = (diff / i.lastCost) * 100;
                        if (pct > 1) trend = `<span class="ml-1 text-[9px] font-black text-red-500 bg-red-50 px-1 rounded">‚Üë${pct.toFixed(0)}%</span>`;
                        else if (pct < -1) trend = `<span class="ml-1 text-[9px] font-black text-emerald-500 bg-emerald-50 px-1 rounded">‚Üì${Math.abs(pct).toFixed(0)}%</span>`;
                    }

                    const jewelIcon = isJewel ? '<span class="text-xs mr-1" title="Producto de Alto Valor">üíé</span>' : '';

                    // VISTA AUDITOR√çA
                    if(inventoryMode) return `
                        <div class="bg-white p-3 rounded-xl border shadow-sm flex justify-between items-center animate-fade-in ${isJewel ? 'border-indigo-200 bg-indigo-50/30' : ''}">
                            <div class="flex-1">
                                <div class="font-bold text-sm flex items-center">${jewelIcon} ${clean(i.n)}</div>
                                <div class="text-[10px] text-slate-400">Te√≥rico: ${i.stock} ${i.unit} ¬∑ Valor: ${Num.fmt(i._val)}‚Ç¨</div>
                            </div>
                            <div class="flex gap-2 items-center">
                                <input id="rs-${i.id}" type="number" placeholder="${i.stock}" class="w-20 text-center bg-orange-50 border border-orange-200 p-2 rounded-lg font-bold text-lg outline-none focus:ring-2 focus:ring-orange-500">
                                <button class="bg-emerald-500 text-white rounded-lg w-10 h-10 flex items-center justify-center font-bold shadow-lg active:scale-95 transition" onclick="adjStock('${i.id}')">‚úî</button>
                            </div>
                        </div>`;
                    
                    // VISTA NORMAL
                    return `
                        <div class="bg-white p-3 rounded-xl border ${low ? 'border-red-300 bg-red-50/20' : 'border-slate-100'} shadow-sm flex justify-between items-center group ${isJewel ? 'border-l-4 border-l-indigo-400' : ''}">
                            <div class="flex-1 cursor-pointer" onclick="editIng('${i.id}')">
                                <div class="font-bold text-slate-800 text-sm flex items-center">${jewelIcon} ${clean(i.n)}</div>
                                <div class="text-xs text-slate-500 flex gap-2 items-center mt-1">
                                    <span class="bg-slate-100 px-2 rounded text-[10px] font-bold border">${parseFloat(i.stock).toFixed(2)} ${i.unit}</span>
                                    <span class="text-[10px] text-slate-400 flex items-center">
                                        ${Num.fmt(i.cost)}‚Ç¨/ud ${trend}
                                    </span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button class="btn-icon btn-merma" onclick="regMerma('${i.id}')">üìâ</button>
                                <button class="btn-icon btn-edit" onclick="editIng('${i.id}')">‚úèÔ∏è</button>
                            </div>
                        </div>`;
                }).join('')}
                ${list.length === 0 ? '<div class="text-center p-8 text-slate-400">No hay productos.</div>' : ''}
            </div>
            ${!inventoryMode ? `<button class="btn-premium mt-4" onclick="editIng(generateID())">Ôºã NUEVO PRODUCTO</button>` : ''}
        </div>`;
}

function toggleInventoryMode() { 
    inventoryMode = !inventoryMode; 
    render('Stock'); 
    if(inventoryMode) toast("Modo Auditor√≠a: Introduce el stock REAL"); 
}

// Ajuste de Stock (Kardex Autom√°tico)
function adjStock(id) {
    const v = parseFloat(document.getElementById(`rs-${id}`).value);
    const i = db.ingredientes.find(x => x.id === id);
    if (!isNaN(v) && i) {
        const diff = v - i.stock;
        if (diff !== 0) {
            logStock(i.id, Math.abs(diff), 'ADJ', 'Auditor√≠a', i.cost);
            i.stock = v; 
            save("Stock Actualizado"); 
            render('Stock');
        } else {
            toast("Stock coincide ‚úÖ", "success");
        }
    }
}

// Generador de Pedidos WhatsApp
function sendWhatsApp() {
    let list = db.ingredientes.filter(i => i.stock < (i.min || 0));
    if (activeFamily !== 'Todos') list = list.filter(i => (i.fam || 'General') === activeFamily);

    if (!list.length) return toast("Stock Correcto ‚úÖ");
    
    let phone = "";
    if (activeFamily !== 'Todos') {
        const prov = db.proveedores.find(p => p.fam === activeFamily);
        if (prov) phone = prov.tel;
    }

    const txt = `üõí *PEDIDO ${activeFamily.toUpperCase()} - ${getTS()}*\n\n` + 
                list.map(i => `- ${Math.ceil(((i.min || 0) - i.stock) * 1.2)} ${i.unit} ${i.n}`).join('\n');
    
    const url = phone ? `https://wa.me/${phone}?text=${encodeURIComponent(txt)}` : `https://wa.me/?text=${encodeURIComponent(txt)}`;
    window.open(url, '_blank');
}

// Historial de Movimientos
function logStock(id, q, t, r, p = 0) { 
    db.kardex.push({ id: generateID(), date: getTS(), ingId: id, type: t, qty: q, reason: r, price: p }); 
}

// Gesti√≥n de Mermas
function regMerma(id) {
    const i = db.ingredientes.find(x => x.id === id);
    showModal('Registrar Merma', `
        <p class="mb-4 text-sm text-slate-500">Producto: <b class="text-slate-800">${clean(i.n)}</b></p>
        <label>Cantidad Perdida (${i.unit})</label>
        <input type="number" id="m-q" class="input-premium mb-4 text-center font-bold text-lg">
        <label>Motivo</label>
        <select id="m-r" class="input-premium mb-4">
            <option>Caducidad</option><option>Rotura</option><option>Error Cocina</option><option>Consumo Personal</option>
        </select>
        <button class="btn-premium bg-red-500 shadow-red-200" onclick="saveMerma('${id}')">CONFIRMAR P√âRDIDA</button>
    `);
}

function saveMerma(id) {
    const q = parseFloat(document.getElementById('m-q').value);
    const r = document.getElementById('m-r').value;
    if (q > 0) { 
        const i = db.ingredientes.find(x => x.id === id); 
        i.stock -= q; 
        db.mermas.push({ date: getISO(), n: i.n, q, reason: r, loss: q * i.cost }); 
        logStock(id, q, 'OUT', `Merma: ${r}`, i.cost); 
        save("Merma registrada"); closeModal(); render('Stock'); 
    }
}

// --- EDICI√ìN DE PRODUCTOS (CON AL√âRGENOS) ---
function editIng(id) {
    const i = db.ingredientes.find(x => x.id === id) || { id, n: '', cost: 0, stock: 0, min: 0, unit: 'kg', fam: 'General', alg: [] };
    const fams = FAMILIES.map(f => `<option ${i.fam === f ? 'selected' : ''}>${f}</option>`).join('');
    
    // üî• CORRECCI√ìN: Clonar array para evitar referencias cruzadas
    tempAlgs = [...(i.alg || [])];

    const algHTML = ALLERGENS.map(a => {
        const active = tempAlgs.includes(a.k);
        return `<button id="btn-alg-${a.k}" onclick="toggleAlg('${a.k}')" class="w-8 h-8 rounded-full border flex items-center justify-center text-sm transition ${active ? 'bg-red-100 border-red-400 scale-110 shadow-sm' : 'bg-slate-50 border-slate-200 opacity-60 grayscale'}">${a.i}</button>`;
    }).join('');
    
    const histBtn = db.ingredientes.find(x => x.id === id) 
        ? `<button class="btn-ghost w-auto text-indigo-600 border-indigo-200 bg-indigo-50" onclick="viewKardex('${id}')">üìú HISTORIAL</button>` 
        : '';

    showModal('Ficha Producto', `
        <label>Nombre</label><input id="ei-n" value="${clean(i.n)}" class="input-premium mb-2">
        <label>Familia</label><select id="ei-f" class="input-premium mb-2">${fams}</select>
        
        <label class="mt-2 mb-1">Al√©rgenos</label>
        <div class="flex flex-wrap gap-2 mb-4 bg-white p-2 rounded-xl border border-slate-100 justify-center">
            ${algHTML}
        </div>

        <div class="grid grid-cols-3 gap-2">
            <div><label>Coste</label><input id="ei-c" type="number" value="${i.cost}" class="input-premium"></div>
            <div><label>Stock</label><input id="ei-s" type="number" value="${i.stock}" class="input-premium"></div>
            <div><label>M√≠n</label><input id="ei-m" type="number" value="${i.min}" class="input-premium"></div>
        </div>
        
        <label>Unidad</label>
        <select id="ei-u" class="input-premium mb-4">
            <option ${i.unit==='kg'?'selected':''}>kg</option>
            <option ${i.unit==='g'?'selected':''}>g</option>
            <option ${i.unit==='mg'?'selected':''}>mg</option>
            <option ${i.unit==='l'?'selected':''}>l</option>
            <option ${i.unit==='ml'?'selected':''}>ml</option>
            <option ${i.unit==='cl'?'selected':''}>cl</option>
            <option ${i.unit==='oz'?'selected':''}>oz</option>
            <option ${i.unit==='lb'?'selected':''}>lb</option>
            <option ${i.unit==='ud'?'selected':''}>ud</option>
        </select>
        
        <div class="flex gap-2">
            <button class="btn-premium flex-1" onclick="saveIng('${id}')">GUARDAR</button>
            ${histBtn}
            ${db.ingredientes.find(x => x.id === id) ? `<button class="btn-ghost w-auto text-red-500" onclick="delIng('${id}')">üóëÔ∏è</button>` : ''}
        </div>
    `);
}

function toggleAlg(k) {
    const btn = document.getElementById(`btn-alg-${k}`);
    if (tempAlgs.includes(k)) {
        tempAlgs = tempAlgs.filter(x => x !== k);
        btn.className = "w-8 h-8 rounded-full border flex items-center justify-center text-sm transition bg-slate-50 border-slate-200 opacity-60 grayscale";
    } else {
        tempAlgs.push(k);
        btn.className = "w-8 h-8 rounded-full border flex items-center justify-center text-sm transition bg-red-100 border-red-400 scale-110 shadow-sm";
    }
}

function saveIng(id) {
    const n = document.getElementById('ei-n').value; 
    if (!n) return toast("Falta nombre", "error");
    
    const newCost = parseFloat(document.getElementById('ei-c').value) || 0;
    
    const existing = db.ingredientes.find(x => x.id === id);
    let lastCost = existing ? (existing.lastCost || 0) : 0;

    if (existing && Math.abs(existing.cost - newCost) > 0.01) {
        lastCost = existing.cost;
    }

    const obj = {
        id, n, 
        fam: document.getElementById('ei-f').value, 
        cost: newCost, 
        stock: parseFloat(document.getElementById('ei-s').value) || 0, 
        min: parseFloat(document.getElementById('ei-m').value) || 0, 
        unit: document.getElementById('ei-u').value,
        alg: tempAlgs, 
        lastCost: lastCost
    };
    
    const idx = db.ingredientes.findIndex(x => x.id === id);
    if (idx >= 0) db.ingredientes[idx] = obj; else db.ingredientes.push(obj);
    
    clearCache(); 
    save("Guardado"); closeModal(); render('Stock');
}

function delIng(id) { 
    if (confirm("¬øEliminar producto?")) { 
        db.ingredientes = db.ingredientes.filter(x => x.id !== id); 
        save("Eliminado"); closeModal(); render('Stock'); 
    } 
}
    /* === HISTORIAL DE MOVIMIENTOS (KARDEX) === */
function viewKardex(id) {
    const i = db.ingredientes.find(x => x.id === id);
    if (!i) return;

    // Filtramos el kardex global buscando solo este ID
    const logs = db.kardex.filter(k => k.ingId === id).sort((a,b) => b.date.localeCompare(a.date)); // Del m√°s nuevo al viejo

    const logHTML = logs.map(l => {
        let color = 'text-slate-500';
        let sign = '';
        if (l.type === 'IN' || l.type === 'ADJ' && l.qty > 0) { color = 'text-emerald-600'; sign = '+'; }
        if (l.type === 'OUT') { color = 'text-red-500'; sign = '-'; }

        return `
        <div class="flex justify-between items-center py-2 border-b border-slate-50 text-xs">
            <div>
                <div class="font-bold text-slate-700">${l.reason}</div>
                <div class="text-[10px] text-slate-400">${l.date}</div>
            </div>
            <div class="font-mono font-bold ${color} text-sm">
                ${sign}${parseFloat(l.qty).toFixed(2)}
            </div>
        </div>`;
    }).join('');

    showModal(`Historial: ${clean(i.n)}`, `
        <div class="bg-slate-50 p-2 rounded mb-4 text-center">
            <span class="text-xs text-slate-400">Stock Actual</span>
            <div class="text-2xl font-black text-slate-800">${parseFloat(i.stock).toFixed(2)} <span class="text-sm font-normal text-slate-400">${i.unit}</span></div>
        </div>
        <div class="max-h-60 overflow-y-auto pr-2 custom-scrollbar">
            ${logs.length ? logHTML : '<div class="text-center text-slate-300 py-4">Sin movimientos registrados</div>'}
        </div>
    `);
}
/* =============================================================
   ‚ö†Ô∏è 14. DIARIO (CIERRE DE CAJA Z) - VERSI√ìN CON DELIVERY ‚ö†Ô∏è
   ============================================================= */

function renderDiario(app) {
    // Buscamos el registro del d√≠a actual
    let r = db.diario.find(d => d.date === currentDiarioDate) || { 
        cash: 0, visa: 0, tpv: 0, madisa: 0, amex: 0, uber: 0, glovo: 0, app: 0, total: 0, expenses: 0 
    };
    
    // Compatibilidad con datos antiguos (si ten√≠a "visa" pero no el desglose)
    if (r.visa && !r.tpv && !r.madisa && !r.amex) { r.tpv = r.visa; }

    // --- L√ìGICA DE HISTORIAL AGRUPADO POR MESES ---
    const hist = db.diario.filter(d => isInPeriod(d.date)).sort((a, b) => b.date.localeCompare(a.date));
    const monthNames = ["", "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    
    const byMonth = {};
    hist.forEach(d => {
        const m = parseInt(d.date.split('-')[1]); 
        if(!byMonth[m]) byMonth[m] = { name: monthNames[m], total: 0, items: [] };
        byMonth[m].items.push(d);
        byMonth[m].total += d.total;
    });

    const sortedMonths = Object.keys(byMonth).sort((a,b) => b - a);
    
    // Generamos el HTML del historial
    let htmlHist = '';
    if(sortedMonths.length === 0) {
        htmlHist = `<div class="text-center p-8 text-slate-400 border-2 border-dashed rounded-xl mt-4">Sin cierres este trimestre</div>`;
    } else {
        htmlHist = sortedMonths.map(mKey => {
            const mData = byMonth[mKey];
            return `
            <div class="glass-card mt-6">
                <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-3">
                    <div>
                        <h3 class="font-black text-slate-800 uppercase text-lg tracking-tight">${mData.name}</h3>
                        <div class="text-[10px] font-bold text-slate-400">Ventas: ${Num.fmt(mData.total)}‚Ç¨</div>
                    </div>
                    <button class="flex items-center gap-2 bg-emerald-50 text-emerald-700 px-3 py-2 rounded-lg text-[10px] font-bold hover:bg-emerald-100 transition" onclick="downloadDiarioCSV(${mKey}, '${mData.name}')">
                        <span>üì• EXCEL</span>
                    </button>
                </div>
                <div class="max-h-60 overflow-y-auto custom-scrollbar space-y-1">
                    ${mData.items.map(d => `
                        <div class="flex justify-between py-2 border-b last:border-0 hover:bg-slate-50 cursor-pointer p-2 rounded items-center" onclick="currentDiarioDate='${d.date}';render('Diario')">
                            <div class="flex items-center gap-3">
                                <span class="text-lg">üìÖ</span>
                                <div>
                                    <div class="font-bold text-slate-700 text-sm">${d.date}</div>
                                    <div class="text-[10px] text-slate-400">Efec: ${Num.fmt(d.cash)}‚Ç¨ ¬∑ Tarj: ${Num.fmt((d.tpv||0)+(d.madisa||0)+(d.amex||0))}‚Ç¨</div>
                                </div>
                            </div>
                            <b class="font-mono text-indigo-600 text-sm">${Num.fmt(d.total)}‚Ç¨</b>
                        </div>
                    `).join('')}
                </div>
            </div>`;
        }).join('');
    }

    // --- RENDERIZADO FINAL ---
    app.innerHTML = `
    <div class="glass-card">
        <div class="flex justify-between items-center mb-6">
            <h3 class="font-bold text-slate-800">CIERRE CAJA</h3>
            <input type="date" value="${currentDiarioDate}" class="bg-slate-100 border-0 rounded-lg p-2 font-bold text-indigo-600 outline-none" onchange="currentDiarioDate=this.value;render('Diario')">
        </div>
        
        <div class="space-y-3">
            <div class="bg-emerald-50 p-3 rounded-xl border border-emerald-100 shadow-sm">
                <h6 class="text-[10px] font-bold text-emerald-600 uppercase mb-2">üíµ Efectivo</h6>
                <div class="flex gap-2">
                    <div class="flex-1"><label>Venta</label><input type="number" id="z-c" value="${r.cash}" class="input-premium text-center font-bold text-lg" onchange="calcZ()" onfocus="this.select()"></div>
                    <div class="flex-1"><label class="text-red-400">Gastos</label><input type="number" id="z-e" value="${r.expenses || 0}" class="input-premium text-center font-bold text-lg text-red-500" onchange="calcZ()" onfocus="this.select()"></div>
                </div>
            </div>
            
            <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 shadow-sm">
                <h6 class="text-[10px] font-bold text-blue-600 uppercase mb-2">üí≥ Tarjetas & Pasarelas</h6>
                <div class="grid grid-cols-3 gap-2">
                    <div><label>TPV</label><input type="number" id="z-tpv" value="${r.tpv || 0}" class="input-premium text-center font-bold" onchange="calcZ()" onfocus="this.select()"></div>
                    <div><label>Madisa</label><input type="number" id="z-madisa" value="${r.madisa || 0}" class="input-premium text-center font-bold" onchange="calcZ()" onfocus="this.select()"></div>
                    <div><label>AMEX</label><input type="number" id="z-amex" value="${r.amex || 0}" class="input-premium text-center font-bold" onchange="calcZ()" onfocus="this.select()"></div>
                </div>
            </div>

            <div class="bg-orange-50 p-3 rounded-xl border border-orange-100 shadow-sm">
                <h6 class="text-[10px] font-bold text-orange-600 uppercase mb-2">üõµ Plataformas</h6>
                <div class="grid grid-cols-3 gap-2">
                    <div><label>Uber</label><input type="number" id="z-uber" value="${r.uber || 0}" class="input-premium text-center font-bold" onchange="calcZ()" onfocus="this.select()"></div>
                    <div><label>Glovo</label><input type="number" id="z-glovo" value="${r.glovo || 0}" class="input-premium text-center font-bold" onchange="calcZ()" onfocus="this.select()"></div>
                    <div><label>App/Otros</label><input type="number" id="z-app" value="${r.app || 0}" class="input-premium text-center font-bold" onchange="calcZ()" onfocus="this.select()"></div>
                </div>
            </div>
            
            <div class="flex justify-between pt-4 border-t border-slate-200 mt-2">
                <span class="font-bold text-slate-400 text-xs tracking-widest uppercase">TOTAL D√çA</span>
                <span class="text-3xl font-black text-slate-800" id="z-t">${Num.fmt(r.total)}‚Ç¨</span>
            </div>
        </div>
        <button class="btn-premium mt-6 shadow-xl shadow-indigo-200" onclick="saveZ()">üíæ GUARDAR CIERRE</button>
    </div>
    
    ${htmlHist}`;
}
function calcZ() {
    // 1. Obtenemos el efectivo ingresado
    const c = parseFloat(document.getElementById('z-c').value) || 0;
    
    // 2. IMPORTANTE: Obtenemos el gasto para restarlo
    const e = parseFloat(document.getElementById('z-e').value) || 0;
    
    // 3. Obtenemos resto de m√©todos de pago
    const tpv = parseFloat(document.getElementById('z-tpv').value) || 0;
    const madisa = parseFloat(document.getElementById('z-madisa').value) || 0;
    const amex = parseFloat(document.getElementById('z-amex').value) || 0;
    
    const uber = parseFloat(document.getElementById('z-uber').value) || 0;
    const glovo = parseFloat(document.getElementById('z-glovo').value) || 0;
    const app = parseFloat(document.getElementById('z-app').value) || 0;
    
    // 4. F√ìRMULA CORREGIDA: (Ingresos) - Gastos
    // Sumamos todo lo que entra y restamos 'e' (gastos)
    const total = (c + tpv + madisa + amex + uber + glovo + app) - e;
    
    document.getElementById('z-t').innerText = Num.fmt(total) + '‚Ç¨';
}

function saveZ() {
    const c = parseFloat(document.getElementById('z-c').value) || 0;
    // Aqu√≠ tambi√©n leemos el gasto para el c√°lculo final
    const e = parseFloat(document.getElementById('z-e').value) || 0;
    
    const tpv = parseFloat(document.getElementById('z-tpv').value) || 0;
    const madisa = parseFloat(document.getElementById('z-madisa').value) || 0;
    const amex = parseFloat(document.getElementById('z-amex').value) || 0;
    
    const uber = parseFloat(document.getElementById('z-uber').value) || 0;
    const glovo = parseFloat(document.getElementById('z-glovo').value) || 0;
    const app = parseFloat(document.getElementById('z-app').value) || 0;

    // F√ìRMULA CORREGIDA TAMBI√âN AL GUARDAR
    const total = (c + tpv + madisa + amex + uber + glovo + app) - e;

    const data = { 
        date: currentDiarioDate, 
        cash: c, 
        tpv: tpv,        
        madisa: madisa, 
        amex: amex,      
        visa: tpv + madisa + amex, // Compatibilidad con versiones viejas
        uber: uber, 
        glovo: glovo, 
        app: app, 
        expenses: e, 
        total: total // Guardamos el total ya restado
    };
    
    const idx = db.diario.findIndex(d => d.date === currentDiarioDate);
    if (idx >= 0) db.diario[idx] = data; else db.diario.push(data);
    
    save("Cierre Desglosado Guardado (Gastos restados) ‚úÖ"); 
    render('Diario');
}
function downloadDiarioCSV(monthIndex, monthName) {
    const list = db.diario.filter(d => {
        if (!isInPeriod(d.date)) return false; 
        const m = parseInt(d.date.split('-')[1]);
        return m === monthIndex;
    }).sort((a,b) => a.date.localeCompare(b.date));

    if (!list.length) return toast("No hay datos", "error");

    const headers = ['Fecha;Total_Caja;Efectivo;Gastos_Caja;TPV;Madisa;AMEX;Uber;Glovo;App_Propia'];
    
    const rows = list.map(d => {
        return `${d.date};${Num.csv(d.total)};${Num.csv(d.cash)};${Num.csv(d.expenses||0)};${Num.csv(d.tpv||0)};${Num.csv(d.madisa||0)};${Num.csv(d.amex||0)};${Num.csv(d.uber||0)};${Num.csv(d.glovo||0)};${Num.csv(d.app||0)}`;
    });

    const csvContent = headers.concat(rows).join('\n');
    const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8' });
    
    const year = (typeof fiscalYear !== 'undefined') ? fiscalYear : new Date().getFullYear();
    
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `Caja_${monthName}_${year}.csv`;
    a.click();
}
/* =============================================================
   ‚ö†Ô∏è 15. SISTEMA, UTILIDADES Y MEN√öS (FINAL) ‚ö†Ô∏è
   ============================================================= */

// --- GESTI√ìN DE COPIAS DE SEGURIDAD ---
function downloadBackup() { 
    const d = secure.enc(db); 
    const a = document.createElement('a'); 
    a.href = URL.createObjectURL(new Blob([d], { type: 'text/plain' })); 
    a.download = `Arume_Backup_${getISO()}.arume`; 
    a.click(); 
}

function restoreBackup(input) { 
    if (!input.files || !input.files[0]) return;
    const r = new FileReader(); 
    r.onload = e => { 
        try { 
            const recovered = secure.dec(e.target.result); 
            // Peque√±a validaci√≥n para no romper la app con archivos basura
            if (!recovered || !recovered.users) throw new Error("Archivo inv√°lido");

            if(confirm("‚ö†Ô∏è ¬øSobreescribir TODOS los datos actuales con esta copia?")) {
                db = recovered; 
                // Forzamos sincronizaci√≥n con la nube para que el backup suba
                save("Restaurado y Subido a Nube"); 
                // Recargamos la p√°gina completa para limpiar memoria
                setTimeout(() => location.reload(), 500);
            }
        } catch (err) { toast("‚ùå Error: Archivo corrupto", "error"); } 
    }; 
    r.readAsText(input.files[0]); 
    input.value = ''; // Limpiar input para permitir recargar el mismo archivo
}

// --- UTILIDADES DE GESTI√ìN (RESET Y IMPORTACI√ìN) ---
// Esta funci√≥n la llamamos desde el bot√≥n rojo de Admin
function resetStockToZero() {
    if (confirm("üõë ¬øEST√ÅS SEGURO?\n\nEsto pondr√° el stock de TODOS los ingredientes a 0.\n√ösalo solo antes de hacer un inventario completo desde cero.")) {
        db.ingredientes.forEach(i => i.stock = 0);
        save("Almac√©n reseteado a 0");
        render('Stock');
    }
}

// Modal para importar lista de proveedores r√°pida (desde el men√∫ opciones)
function importProvsModal() {
    showModal('Importar Proveedores', `
        <p class="text-sm text-slate-500 mb-2">Pega aqu√≠ una lista de nombres (uno por l√≠nea):</p>
        <textarea id="imp-p-text" class="input-premium h-40 text-xs font-mono" placeholder="Makro\nFruter√≠a Paco\nCarnicer√≠a..."></textarea>
        <button class="btn-premium mt-2" onclick="processImportProvs()">PROCESAR LISTA</button>
    `);
}

function processImportProvs() {
    const txt = document.getElementById('imp-p-text').value;
    if (!txt) return;
    const lines = txt.split(/\n/);
    let count = 0;
    lines.forEach(l => {
        const n = l.trim();
        // Si tiene nombre y no existe ya, lo creamos
        if (n && !db.proveedores.find(p => p.n.toLowerCase() === n.toLowerCase())) {
            db.proveedores.push({ id: generateID(), n: n, tel: '', fam: 'General' });
            count++;
        }
    });
    save(`Importados ${count} proveedores`);
    closeModal();
    renderAdmin(document.getElementById('app'));
}

// --- CONTROLADORES DE INTERFAZ (MODALES Y MEN√öS) ---
function showModal(t, c) { 
    document.getElementById('m-title').innerText = t; 
    document.getElementById('m-body').innerHTML = c; 
    document.getElementById('modal-overlay').classList.remove('hidden'); 
}

function closeModal() { 
    document.getElementById('modal-overlay').classList.add('hidden'); 
    document.getElementById('m-body').innerHTML = ''; // Limpiamos para ahorrar memoria
}

// L√≥gica del Men√∫ Desplegable (Header)
function mostrarOpciones() {
    const menu = document.getElementById("misOpciones");
    menu.style.display = (menu.style.display === "block") ? "none" : "block";
}

// Cerrar el men√∫ si se hace clic fuera de √©l
window.onclick = function(event) {
    if (!event.target.matches('.btn-principal')) {
        const dropdowns = document.getElementsByClassName("contenido-opciones");
        for (let i = 0; i < dropdowns.length; i++) {
            const openDropdown = dropdowns[i];
            if (openDropdown.style.display === "block") {
                openDropdown.style.display = "none";
            }
        }
    }
}
// --- CONFIGURACI√ìN FISCAL (EMPRESA) ---
function editConfig() {
    // Si la db es antigua y no tiene config, la inicializamos (doble seguridad)
    if (!db.config) db.config = { empresa: '', nif: '', iban: '', sufijo: '000' };

    showModal('‚öôÔ∏è Configuraci√≥n Fiscal', `
        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 mb-4 text-xs text-indigo-800">
            Datos necesarios para <b>Remesas SEPA</b> y contabilidad.
        </div>
        
        <label>Nombre Fiscal Empresa</label>
        <input id="cfg-nom" value="${clean(db.config.empresa)}" class="input-premium mb-2" placeholder="Ej: RESTAURANTE SL">
        
        <div class="grid grid-cols-3 gap-2 mb-2">
            <div class="col-span-2">
                <label>NIF / CIF</label>
                <input id="cfg-nif" value="${clean(db.config.nif)}" class="input-premium" placeholder="B12345678">
            </div>
            <div>
                 <label>Sufijo SEPA</label>
                 <input id="cfg-suf" value="${clean(db.config.sufijo)}" class="input-premium text-center" placeholder="000">
            </div>
        </div>

        <label>IBAN de Emisi√≥n (Tu banco)</label>
        <input id="cfg-iban" value="${clean(db.config.iban)}" class="input-premium mb-6 font-mono uppercase" placeholder="ES00...">

        <button class="btn-premium" onclick="saveConfig()">üíæ GUARDAR DATOS</button>
    `);
}

function saveConfig() {
    db.config = {
        empresa: document.getElementById('cfg-nom').value,
        nif: document.getElementById('cfg-nif').value.toUpperCase(),
        iban: document.getElementById('cfg-iban').value.toUpperCase().replace(/\s/g, ''),
        sufijo: document.getElementById('cfg-suf').value
    };
    save("Configuraci√≥n actualizada");
    closeModal();
}
/* =============================================================
¬† ¬†‚ö†Ô∏è MOTOR V40: SOLO PEGADO MANUAL (FIABLE Y EDITABLE) ‚ö†Ô∏è
¬† ¬†============================================================= */

let tempImportMatches = []; 

// 1. DESACTIVAR CARGA DE ARCHIVO (Usamos pegado manual por fiabilidad)
function safeImportSales(input) {
    toast("‚ö†Ô∏è Funci√≥n desactivada. Usa 'PEGAR VENTAS' para mayor control.", "info");
}

// 2. PEGADO MANUAL CON FECHA Y FORMATO FLEXIBLE
function openPasteModal() {
    const today = getISO();
    
    // INSTRUCCIONES VISUALES (TU "PROMPT") PARA NO EQUIVOCARSE NUNCA
    const instructions = `
    <div class="bg-blue-50 border-l-4 border-blue-500 p-3 mb-4 rounded-r-lg shadow-sm">
        <div class="font-bold text-blue-800 text-xs flex items-center gap-2 mb-1">
            <span>üí° INSTRUCCIONES DE COPIADO</span>
        </div>
        <p class="text-[10px] text-blue-700 leading-relaxed">
            1. Abre tu archivo <b>.xls</b> o <b>.csv</b>.<br>
            2. Selecciona las filas de productos (puedes incluir la fecha "D√≠a:..." para detecci√≥n auto).<br>
            3. <b>COPIA</b> y <b>PEGA</b> abajo.<br>
            <span class="opacity-70 italic">* El sistema limpiar√° las columnas vac√≠as autom√°ticamente.</span>
        </p>
    </div>`;

    showModal('üìã Importar Ventas (Modo Seguro)', `
        ${instructions}
        
        <div class="mb-4 bg-white p-2 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center">
            <label class="text-[10px] font-black text-slate-400 uppercase ml-2">üìÖ FECHA DE VENTA</label>
            <input type="date" id="paste-date" value="${today}" class="bg-indigo-50 border border-indigo-100 rounded-lg px-3 py-1 font-black text-indigo-700 outline-none text-sm">
        </div>
        
        <textarea id="paste-area" class="input-premium h-48 text-[10px] font-mono border-2 border-slate-200 p-2 leading-tight focus:border-indigo-500 transition" placeholder="Pega aqu√≠ el contenido de tu Excel..."></textarea>
        
        <button class="btn-premium mt-3 w-full shadow-xl bg-gradient-to-r from-indigo-600 to-blue-600 hover:to-indigo-500 transform active:scale-95 transition" onclick="processPastedTextV40()">
            üöÄ ANALIZAR DATOS
        </button>
    `);
    
    // Auto-foco para pegar r√°pido
    setTimeout(() => document.getElementById('paste-area').focus(), 100);
}
/* =============================================================
   ‚ö†Ô∏è NUEVO PROCESADOR DE TEXTO (OPTIMIZADO PARA TU EXCEL) ‚ö†Ô∏è
   ============================================================= */
function processPastedTextV40() {
    const rawText = document.getElementById('paste-area').value;
    let selectedDate = document.getElementById('paste-date').value;

    if (!rawText.trim()) return toast("‚ö†Ô∏è Pega primero los datos", "error");

    const matches = [];
    const unknown = [];
    const normalize = (str) => str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();

    // 1. BUSCAR FECHA EN TODO EL TEXTO (Patr√≥n: "D√≠a: 10/01/2026")
    const dateMatch = rawText.match(/D√≠a:\s*(\d{2})[\/.-](\d{2})[\/.-](\d{4})/);
    if (dateMatch) {
        selectedDate = `${dateMatch[3]}-${dateMatch[2]}-${dateMatch[1]}`;
        document.getElementById('paste-date').value = selectedDate;
        toast(`üìÖ Fecha encontrada: ${dateMatch[1]}/${dateMatch[2]}`, "success");
    }

    const lines = rawText.split(/\n/);

    lines.forEach(line => {
        // Limpiar comillas del CSV
        let cleanLine = line.replace(/"/g, '').trim();
        
        // Ignorar basura
        if (!cleanLine || cleanLine.length < 5 || cleanLine.includes("Informe") || cleanLine.includes("Art√≠culo") || cleanLine.startsWith(",,,")) return;

        // ESTRATEGIA: "Romper" la l√≠nea por huecos grandes (muchas comas o tabs)
        // Tu archivo suele tener: NOMBRE ,,,,,, CANTIDAD ... TOTAL
        
        // 1. Extraemos todos los n√∫meros (incluyendo decimales con punto o coma)
        // Convertimos comas decimales a puntos para JS
        const numbers = cleanLine.match(/-?\d+([.,]\d+)?/g);
        
        if (numbers && numbers.length >= 2) {
            // 2. Extraer Nombre: Es todo lo que hay antes del primer bloque num√©rico denso
            // Pero cuidado con "Coca Cola 33cl".
            // Mejor estrategia: Split por separadores de columna reales (tabs o comas m√∫ltiples)
            const parts = cleanLine.split(/[\t,]+/).filter(p => p.trim() !== '');
            
            // Si hay al menos Nombre, Cantidad y Total
            if (parts.length >= 3) {
                const name = parts[0].trim();
                
                // Parseamos los n√∫meros de la l√≠nea
                const numsInLine = parts.slice(1).map(p => Num.parse(p));
                
                // HEUR√çSTICA ARUME:
                // La Cantidad suele ser el primer n√∫mero positivo (a veces hay un 0.0 antes de clientes)
                let qty = numsInLine.find(n => n > 0 && n < 10000); 
                // El Total Bruto suele ser el √∫ltimo n√∫mero de la l√≠nea
                let total = numsInLine[numsInLine.length - 1];

                // Si por alguna raz√≥n el parser fall√≥, intentamos posiciones fijas relativas al final
                if (!total) total = numsInLine[numsInLine.length - 2]; // A veces hay un % al final

                if (qty > 0 && name.length > 2) {
                    // Calculamos PVP unitario real
                    const unitPvp = total > 0 ? (total / qty) : 0;
                    matchAndPush(name, qty, unitPvp, matches, unknown, normalize);
                }
            }
        }
    });

    if (matches.length === 0 && unknown.length === 0) return toast("‚ùå No pude leer nada. Aseg√∫rate de copiar desde el Nombre hasta el Total.", "error");

    showEditableImportModal([...matches, ...unknown], selectedDate);
}
// 3. L√ìGICA DE MATCHING
function matchAndPush(name, qty, realPvp, matches, unknown, normalize) {
    const searchName = normalize(name);
    const r = db.recetas.find(rec => {
        const recName = normalize(rec.n);
        return searchName.includes(recName) || recName.includes(searchName);
    });

    if (r) {
        let status = 'linked'; 
        if (realPvp > 0 && Math.abs(r.pvp - realPvp) > 0.05) status = 'diff'; 
        matches.push({ id: generateID(), name: r.n, qty: qty, pvp: realPvp, matchId: r.id, status: status });
    } else {
        unknown.push({ id: generateID(), name: name, qty: qty, pvp: realPvp, matchId: null, status: 'new' });
    }
}

// 4. MODAL EDITABLE
function showEditableImportModal(items, dateStr) {
    tempImportMatches = items; 
    items.sort((a,b) => (a.status === 'new' || a.status === 'diff') ? -1 : 1);

    const rowsHTML = items.map((item, index) => {
        let statusIcon = '‚úÖ', statusClass = 'bg-white', statusText = '';
        if (item.status === 'new') { statusIcon = 'üÜï'; statusClass = 'bg-orange-50'; statusText = 'Nueva Receta'; } 
        else if (item.status === 'diff') { statusIcon = '‚ö†Ô∏è'; statusClass = 'bg-yellow-50'; statusText = 'Precio Diferente'; }

        return `
        <div class="grid grid-cols-12 gap-1 items-center border-b border-slate-100 py-1.5 px-1 text-xs ${statusClass}">
            <div class="col-span-1 text-center">${statusIcon}</div>
            <div class="col-span-6">
                <input type="text" value="${clean(item.name)}" class="w-full bg-transparent font-bold text-slate-700 outline-none" onchange="updateTempItem(${index}, 'name', this.value)">
                <div class="text-[8px] text-slate-400">${statusText}</div>
            </div>
            <div class="col-span-2"><input type="number" value="${item.qty}" class="w-full bg-white border border-slate-200 rounded px-1 text-center font-bold" onchange="updateTempItem(${index}, 'qty', this.value)"></div>
            <div class="col-span-2 relative"><input type="number" step="0.01" value="${item.pvp.toFixed(2)}" class="w-full bg-white border border-slate-200 rounded px-1 text-center text-slate-500" onchange="updateTempItem(${index}, 'pvp', this.value)"></div>
            <div class="col-span-1 text-center"><button class="text-red-400 font-bold px-1" onclick="removeTempItem(${index})">‚úï</button></div>
        </div>`;
    }).join('');

    const totalImporte = items.reduce((sum, i) => sum + (i.qty * i.pvp), 0);

    showModal('üìù Revisar Datos Antes de Guardar', `
        <div class="bg-indigo-50 p-2 rounded-lg border border-indigo-100 mb-2 flex justify-between items-center">
            <div><label class="text-[9px] font-bold text-indigo-400 uppercase">FECHA</label><input type="date" id="import-date-final" value="${dateStr}" class="bg-transparent font-black text-indigo-900 outline-none text-sm"></div>
            <div class="text-right"><div class="text-[9px] font-bold text-slate-400 uppercase">Total Bruto</div><div class="text-lg font-black text-slate-800">${Num.fmt(totalImporte)}‚Ç¨</div></div>
        </div>
        <div class="bg-white border border-slate-200 rounded-lg overflow-hidden mb-3 shadow-inner">
            <div class="grid grid-cols-12 gap-1 bg-slate-50 border-b border-slate-200 py-1 px-1 text-[9px] font-black text-slate-400 uppercase text-center"><div class="col-span-1"></div><div class="col-span-6 text-left pl-1">Producto</div><div class="col-span-2">Cant</div><div class="col-span-2">PVP/Ud</div><div class="col-span-1"></div></div>
            <div class="max-h-60 overflow-y-auto custom-scrollbar">${rowsHTML}</div>
        </div>
        <div class="flex gap-2">
            <button class="btn-ghost" onclick="closeModal()">Cancelar</button>
            <button class="btn-premium flex-1 shadow-xl bg-gradient-to-r from-emerald-500 to-teal-500" onclick="commitSalesImport()">üíæ GUARDAR Y ACTUALIZAR</button>
        </div>
    `);
}

function updateTempItem(index, field, value) {
    if (tempImportMatches[index]) {
        if (field === 'qty' || field === 'pvp') tempImportMatches[index][field] = parseFloat(value) || 0;
        else tempImportMatches[index][field] = value;
        const date = document.getElementById('import-date-final').value;
        showEditableImportModal(tempImportMatches, date);
    }
}

function removeTempItem(index) {
    tempImportMatches.splice(index, 1);
    const date = document.getElementById('import-date-final').value;
    showEditableImportModal(tempImportMatches, date);
}

// 5. GUARDADO FINAL
function commitSalesImport() {
    const finalDate = document.getElementById('import-date-final').value;
    if (!finalDate || tempImportMatches.length === 0) return toast("Faltan datos", "error");

    const year = parseInt(finalDate.split('-')[0]);
    if (year !== fiscalYear) fiscalYear = year;

    const existingIdx = db.sales_history.findIndex(l => l.date === finalDate);
    if(existingIdx >= 0) db.sales_history.splice(existingIdx, 1);

    let log = { id: generateID(), date: finalDate, items: [] };
    let createdCount = 0;

    tempImportMatches.forEach(item => {
        let recId = item.matchId;
        if (!recId) {
            const exist = db.recetas.find(r => r.n.toLowerCase() === item.name.toLowerCase());
            if (exist) {
                recId = exist.id;
                if(item.pvp > 0) exist.pvp = item.pvp; 
            } else {
                recId = generateID();
                db.recetas.push({ id: recId, n: item.name, pvp: item.pvp, items: [], yield: 1, unit: 'ud', time: 0 });
                createdCount++;
            }
        } else {
            const r = db.recetas.find(x => x.id === recId);
            if (r && item.pvp > 0) r.pvp = item.pvp;
        }

        log.items.push({ rid: recId, n: item.name, q: item.qty });

        const r = db.recetas.find(x => x.id === recId);
        if (r && r.items) {
            r.items.forEach(it => {
                if (it.type === 'ing') {
                    const ing = db.ingredientes.find(x => x.id === it.id);
                    if (ing) {
                        const factor = UnitConverter.convert(1, it.unit||ing.unit, ing.unit);
                        const yieldFactor = it.merma ? (1-(it.merma/100)) : 1;
                        const qOut = (item.qty * it.q * factor) / yieldFactor;
                        ing.stock -= qOut;
                        logStock(ing.id, qOut, 'OUT', `Venta ${finalDate}`, ing.cost);
                    }
                }
            });
        }
    });

    db.sales_history.push(log);
    save(`‚úÖ Guardado: ${createdCount} recetas nuevas`);
    closeModal();
    renderAdmin(document.getElementById('app'));
}
/* =============================================================
   ‚ö†Ô∏è M√ìDULO EVENTOS PRO (CALENDARIO + FINANZAS) ‚ö†Ô∏è
   ============================================================= */
function renderEventos(c) {
    // 1. Preparar datos del calendario
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const firstDayIndex = new Date(currentYear, currentMonth, 1).getDay(); // 0 dom, 1 lun...
    
    // Ajustar para que semana empiece en Lunes (Espa√±ol)
    const startOffset = firstDayIndex === 0 ? 6 : firstDayIndex - 1;

    // Filtramos eventos futuros y pasados
    const events = db.eventos || [];
    events.sort((a,b) => a.date.localeCompare(b.date));

    // Generar d√≠as del calendario
    let calendarHTML = '';
    for (let i = 0; i < startOffset; i++) calendarHTML += `<div class="h-10"></div>`; // Huecos vac√≠os
    
    for (let d = 1; d <= daysInMonth; d++) {
        const dateStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const evsOfDay = events.filter(e => e.date === dateStr);
        const hasEvent = evsOfDay.length > 0;
        const isToday = d === now.getDate();
        
        calendarHTML += `
        <div class="h-14 border border-slate-100 rounded-lg p-1 relative flex flex-col items-center justify-center cursor-pointer hover:bg-indigo-50 transition ${isToday ? 'bg-indigo-100 ring-2 ring-indigo-300' : 'bg-white'}" onclick="addNewEvent('${dateStr}')">
            <span class="text-[10px] font-bold ${isToday ? 'text-indigo-700' : 'text-slate-400'}">${d}</span>
            ${hasEvent ? `<div class="w-2 h-2 rounded-full bg-pink-500 mt-1"></div>` : ''}
        </div>`;
    }

    // Listado de pr√≥ximos eventos
    const upcoming = events.filter(e => e.date >= getISO()).slice(0, 5);

    c.innerHTML = `
    <div class="glass-card">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-slate-800 flex items-center gap-2">üìÖ CALENDARIO</h3>
            <button class="btn-premium w-auto px-3 py-2 text-xs bg-pink-600 shadow-pink-200" onclick="addNewEvent('${getISO()}')">+ NUEVO</button>
        </div>

        <div class="mb-6">
            <div class="grid grid-cols-7 gap-1 text-center mb-1">
                <div class="text-[9px] font-bold text-slate-400">L</div>
                <div class="text-[9px] font-bold text-slate-400">M</div>
                <div class="text-[9px] font-bold text-slate-400">X</div>
                <div class="text-[9px] font-bold text-slate-400">J</div>
                <div class="text-[9px] font-bold text-slate-400">V</div>
                <div class="text-[9px] font-bold text-slate-400">S</div>
                <div class="text-[9px] font-bold text-slate-400">D</div>
            </div>
            <div class="grid grid-cols-7 gap-1">
                ${calendarHTML}
            </div>
        </div>

        <h4 class="text-xs font-bold text-slate-500 uppercase mb-3">Pr√≥ximos Eventos</h4>
        <div class="space-y-2">
            ${upcoming.length ? upcoming.map(e => `
                <div class="bg-white p-3 rounded-xl border-l-4 border-pink-500 shadow-sm flex justify-between items-center" onclick="editEvent('${e.id}')">
                    <div>
                        <div class="font-bold text-slate-800 text-sm">${clean(e.n)}</div>
                        <div class="text-[10px] text-slate-400">üìÖ ${e.date} ¬∑ üë• ${e.pax} pax</div>
                    </div>
                    <div class="text-right">
                        <div class="font-black text-pink-600 text-sm">${Num.fmt(e.total)}‚Ç¨</div>
                        <div class="text-[9px] ${e.paid ? 'text-emerald-500 font-bold' : 'text-orange-400'}">${e.paid ? 'PAGADO' : 'PENDIENTE'}</div>
                    </div>
                </div>
            `).join('') : '<div class="text-center text-slate-400 text-xs py-4">No hay eventos pr√≥ximos</div>'}
        </div>
        
        <button class="btn-ghost mt-4 text-xs" onclick="viewAllEvents()">VER TODO EL HISTORIAL</button>
    </div>`;
}

function addNewEvent(date) {
    editEvent(null, date);
}

function editEvent(id, dateDefault) {
    const e = id ? db.eventos.find(x => x.id === id) : { 
        id: generateID(), n: '', date: dateDefault || getISO(), pax: 0, price: 0, deposit: 0, menu: '', paid: false, personalExtra: 0 
    };

    showModal(id ? 'Editar Evento' : 'Nuevo Evento', `
        <label>Nombre del Cliente / Evento</label>
        <input id="ev-n" value="${clean(e.n)}" class="input-premium mb-2" placeholder="Ej: Cumplea√±os Mar√≠a">
        
        <div class="grid grid-cols-2 gap-2 mb-2">
            <div><label>Fecha</label><input type="date" id="ev-d" value="${e.date}" class="input-premium"></div>
            <div><label>N¬∫ Personas</label><input type="number" id="ev-pax" value="${e.pax}" class="input-premium text-center"></div>
        </div>

        <div class="bg-pink-50 p-3 rounded-xl border border-pink-100 mb-2">
            <div class="grid grid-cols-2 gap-2">
                <div><label>Precio Men√∫ (‚Ç¨)</label><input type="number" id="ev-price" value="${e.price}" class="input-premium text-center" onchange="calcEvTotal()"></div>
                <div><label>Se√±al / Dep√≥sito</label><input type="number" id="ev-dep" value="${e.deposit}" class="input-premium text-center"></div>
            </div>
            <div class="mt-2 flex justify-between items-center border-t border-pink-200 pt-2">
                <span class="text-xs font-bold text-pink-800 uppercase">Total Previsto</span>
                <span id="ev-tot" class="font-black text-xl text-pink-600">${Num.fmt(e.pax * e.price)}‚Ç¨</span>
            </div>
        </div>

        <label>Coste Personal Extra (Si aplica)</label>
        <input type="number" id="ev-staff" value="${e.personalExtra || 0}" class="input-premium mb-2" placeholder="0">

        <label>Notas / Men√∫ Elegido</label>
        <textarea id="ev-menu" class="input-premium mb-4 h-20 text-xs">${clean(e.menu)}</textarea>

        <div class="flex items-center gap-2 mb-4 bg-slate-50 p-2 rounded-lg">
            <input type="checkbox" id="ev-paid" class="w-5 h-5 accent-emerald-500" ${e.paid ? 'checked' : ''}>
            <label for="ev-paid" class="mb-0 text-slate-700">Evento Finalizado y Cobrado</label>
        </div>

        <div class="flex gap-2">
            <button class="btn-premium flex-1 bg-pink-600" onclick="saveEvent('${e.id}')">GUARDAR</button>
            ${id ? `<button class="btn-ghost w-auto text-red-500" onclick="delEvent('${e.id}')">üóëÔ∏è</button>` : ''}
        </div>
    `);
}

function calcEvTotal() {
    const pax = parseFloat(document.getElementById('ev-pax').value) || 0;
    const price = parseFloat(document.getElementById('ev-price').value) || 0;
    document.getElementById('ev-tot').innerText = Num.fmt(pax * price) + '‚Ç¨';
}

function saveEvent(id) {
    const n = document.getElementById('ev-n').value;
    if(!n) return toast("Falta nombre", "error");

    const pax = parseFloat(document.getElementById('ev-pax').value) || 0;
    const price = parseFloat(document.getElementById('ev-price').value) || 0;
    const total = pax * price;

    const ev = {
        id, n,
        date: document.getElementById('ev-d').value,
        pax: pax,
        price: price,
        deposit: parseFloat(document.getElementById('ev-dep').value) || 0,
        personalExtra: parseFloat(document.getElementById('ev-staff').value) || 0,
        menu: document.getElementById('ev-menu').value,
        paid: document.getElementById('ev-paid').checked,
        total: total,
        ingreso: document.getElementById('ev-paid').checked ? total : (parseFloat(document.getElementById('ev-dep').value) || 0)
    };

    if(!db.eventos) db.eventos = [];
    const idx = db.eventos.findIndex(x => x.id === id);
    if(idx >= 0) db.eventos[idx] = ev; else db.eventos.push(ev);

    save("Evento guardado");
    closeModal();
    renderEventos(document.getElementById('adm-c')); // Refrescar solo el contenedor
}

function delEvent(id) {
    if(confirm("¬øBorrar evento?")) {
        db.eventos = db.eventos.filter(x => x.id !== id);
        save("Evento eliminado");
        closeModal();
        renderEventos(document.getElementById('adm-c'));
    }
}
function viewAllEvents() {
    const list = db.eventos.sort((a,b) => b.date.localeCompare(a.date));
    showModal('Historial Eventos', `
        <div class="space-y-2 max-h-[60vh] overflow-y-auto">
            ${list.map(e => `
                <div class="border-b pb-2 mb-2" onclick="closeModal();editEvent('${e.id}')">
                    <div class="flex justify-between font-bold text-sm"><span>${clean(e.n)}</span><span>${e.date}</span></div>
                    <div class="flex justify-between text-xs text-slate-500"><span>${e.pax} pax</span><span>${Num.fmt(e.total)}‚Ç¨</span></div>
                </div>
            `).join('')}
        </div>
    `);
}
    /* =============================================================
   ‚ö†Ô∏è NUEVAS FUNCIONES AUXILIARES (BUSCADOR Y GR√ÅFICOS) ‚ö†Ô∏è
   ============================================================= */

// --- 1. L√ìGICA DEL BUSCADOR INTELIGENTE (GOOGLE STYLE) ---
let selectedItem = null;

function runSmartSearch(txt) {
    const res = document.getElementById('search-results');
    if (!res) return;
    
    if (txt.length < 2) { res.classList.add('hidden'); return; }

    const matchesIng = db.ingredientes.filter(i => i.n.toLowerCase().includes(txt.toLowerCase()));
    const matchesRec = db.recetas.filter(r => r.n.toLowerCase().includes(txt.toLowerCase()));

    if (!matchesIng.length && !matchesRec.length) { res.classList.add('hidden'); return; }

    let html = '';
    // Sub-recetas primero
    if (matchesRec.length) {
        html += `<div class="bg-indigo-50 px-3 py-1 text-[9px] font-bold text-indigo-500 uppercase tracking-widest sticky top-0">üç≤ Semielaborados</div>`;
        html += matchesRec.map(r => `
            <div class="p-3 border-b border-indigo-50 hover:bg-indigo-50 cursor-pointer flex justify-between items-center group" onclick="selectSearchResult('${r.id}', '${clean(r.n)}', 'rec', '${r.unit}')">
                <span class="font-bold text-indigo-900">${clean(r.n)}</span>
                <span class="text-[10px] bg-white px-2 py-1 rounded text-indigo-400 border border-indigo-100">Rend: ${r.yield} ${r.unit}</span>
            </div>`).join('');
    }
    // Ingredientes
    if (matchesIng.length) {
        html += `<div class="bg-slate-50 px-3 py-1 text-[9px] font-bold text-slate-500 uppercase tracking-widest sticky top-0">üì¶ Materia Prima</div>`;
        html += matchesIng.map(i => `
            <div class="p-3 border-b border-slate-50 hover:bg-slate-50 cursor-pointer flex justify-between items-center" onclick="selectSearchResult('${i.id}', '${clean(i.n)}', 'ing', '${i.unit}')">
                <span class="font-medium text-slate-700">${clean(i.n)}</span>
                <span class="text-[10px] text-slate-400">${Num.fmt(i.cost)}‚Ç¨/${i.unit}</span>
            </div>`).join('');
    }
    res.innerHTML = html;
    res.classList.remove('hidden');
}

function selectSearchResult(id, name, type, unit) {
    selectedItem = { id, type };
    document.getElementById('smart-search').value = '';
    document.getElementById('search-results').classList.add('hidden');
    document.getElementById('add-controls').classList.remove('hidden');
    document.getElementById('add-controls').classList.add('flex');
    document.getElementById('sel-name').innerText = (type === 'rec' ? 'üç≤ ' : 'üì¶ ') + name;
    
    const opts = (type === 'rec') ? ['rac', 'l', 'kg', 'ud'] : ['kg', 'g', 'l', 'ml', 'cl', 'ud', 'oz'];
    document.getElementById('er-u').innerHTML = opts.map(u => `<option ${u === unit ? 'selected' : ''}>${u}</option>`).join('');
    document.getElementById('er-q').focus();
}

function addItemFromSearch() {
    if (!selectedItem) return;
    const q = parseFloat(document.getElementById('er-q').value);
    if (q > 0) {
        tempItems.push({ type: selectedItem.type, id: selectedItem.id, q: q, unit: document.getElementById('er-u').value, merma: 0 });
        renderRecItems();
        document.getElementById('add-controls').classList.add('hidden');
        document.getElementById('smart-search').focus();
    } else { toast("Cantidad inv√°lida", "error"); }
}

// --- 2. L√ìGICA DEL GR√ÅFICO FINANCIERO (CHART.JS) ---
function initChart() {
    const ctx = document.getElementById('financeChart');
    if (!ctx) return;
    
    // Destruir gr√°fico previo si existe para evitar errores de redibujado
    if (myChart) { myChart.destroy(); }

    // Generar datos √∫ltimos 6 meses
    const labels = [], dataIng = [], dataGas = [];
    
    // Gastos fijos MENSUALES
    const fixedMonthly = CONFIG.FIXED_COST_MONTH;

    for (let i = 5; i >= 0; i--) {
        const d = new Date(); d.setMonth(d.getMonth() - i);
        const m = d.getMonth() + 1, y = d.getFullYear();
        labels.push(d.toLocaleString('es-ES', { month: 'short' }));

        // Sumar ingresos del mes
        const ing = db.diario.filter(x => x.date.includes(`${y}-${String(m).padStart(2,'0')}`)).reduce((a,b)=>a+b.total,0);
        
        // Sumar compras del mes
        const gas = db.albaranes.filter(x => x.date.includes(`${y}-${String(m).padStart(2,'0')}`)).reduce((a,b)=>a+b.total,0);
        
        dataIng.push(ing);
        dataGas.push(gas + fixedMonthly); // Sumamos los 40k autom√°ticamente
    }

    myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                { 
                    label: 'Ingresos', 
                    data: dataIng, 
                    borderColor: '#10b981', 
                    backgroundColor: 'rgba(16, 185, 129, 0.1)', 
                    fill: true, 
                    tension: 0.3,
                    pointRadius: 4
                },
                { 
                    label: 'Gastos (Inc. Estructura)', 
                    data: dataGas, 
                    borderColor: '#ef4444', 
                    borderDash: [5,5], 
                    fill: false, 
                    tension: 0.3,
                    pointRadius: 0
                }
            ]
        },
        options: {
            responsive: true, 
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: { 
                legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + Num.fmt(context.parsed.y) + '‚Ç¨';
                        }
                    }
                }
            },
            scales: { 
                y: { 
                    beginAtZero: true,
                    grid: { color: '#f1f5f9' },
                    ticks: { font: { size: 9 } }
                },
                x: {
                    grid: { display: false },
                    ticks: { font: { size: 9 } }
                }
            }
        }
    });
}
    // --- GENERADOR DE ETIQUETAS FIFO (CADUCIDAD) ---
function printLabel(id) {
    const r = db.recetas.find(x => x.id === id);
    if (!r) return;
    
    const today = new Date();
    const expiry = new Date();
    expiry.setDate(today.getDate() + 3); // Caducidad est√°ndar 3 d√≠as (Modificable a mano en la etiqueta si se quiere)
    
    // Calcular al√©rgenos al vuelo para la etiqueta
    const c = calcRecipe(r);
    const algs = (c.allergens || []).map(k => ALLERGENS.find(x=>x.k===k)?.i).join('  ');

    const w = window.open('', '', 'width=400,height=400');
    w.document.write(`
        <html>
        <head>
            <style>
                body { font-family: sans-serif; padding: 15px; border: 3px solid black; width: 300px; text-align: center; }
                h1 { margin: 0 0 10px 0; font-size: 22px; text-transform: uppercase; line-height: 1.1; }
                .row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px; border-bottom: 1px dashed #ccc; padding-bottom: 5px; }
                .alg { font-size: 24px; margin: 15px 0; font-weight: bold; }
                .warn { font-size: 10px; font-weight: bold; text-transform: uppercase; margin-top: 10px; }
                .user { font-size: 10px; margin-top: 5px; color: #666; }
            </style>
        </head>
        <body>
            <h1>${clean(r.n)}</h1>
            <div class="row"><span>ELABORADO:</span> <b>${today.toLocaleDateString()}</b></div>
            <div class="row"><span>CADUCIDAD:</span> <b>${expiry.toLocaleDateString()}</b></div>
            <div class="alg">${algs || 'SIN AL√âRGENOS'}</div>
            <div class="warn">MANTENER REFRIGERADO 0-4¬∫C</div>
            <div class="user">Resp: ${currentUser ? currentUser.n : 'Cocina'}</div>
            <script>window.print(); window.close();<\/script>
        </body>
        </html>
    `);
}
// INICIALIZACI√ìN DE LA APP
init(); 

</script>
</body>
</html>
