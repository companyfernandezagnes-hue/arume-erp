<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>ARUME V152 ¬∑ SUPABASE DIAMOND</title>
    <meta name="description" content="Sistema Integral de Gesti√≥n Hosteler√≠a">
    <meta name="theme-color" content="#0f172a">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* === BASE === */
        :root { --primary: #4f46e5; --dark: #0f172a; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: #f1f5f9; 
            padding-bottom: 120px; /* Espacio para el men√∫ inferior */
            -webkit-tap-highlight-color: transparent; 
            user-select: none; 
            overscroll-behavior-y: none; /* Evita rebote en m√≥vil */
        }

        /* === EST√âTICA DIAMOND (CRISTAL) === */
        .glass-card { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255,255,255,0.5); 
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.08); 
            border-radius: 24px; 
            padding: 24px; 
            margin-bottom: 20px; 
            position: relative;
            overflow: hidden;
        }

        /* === BOTONES PRO === */
        .btn-premium { 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); 
            color: white; padding: 16px; border-radius: 16px; 
            font-weight: 700; font-size: 0.9rem;
            box-shadow: 0 8px 20px -5px rgba(15, 23, 42, 0.3); 
            width: 100%; display: flex; justify-content: center; align-items: center; gap: 8px; cursor: pointer;
            transition: transform 0.1s, box-shadow 0.2s; border: none;
            letter-spacing: 0.5px;
        }
        .btn-premium:active { transform: scale(0.98); box-shadow: 0 4px 10px rgba(15, 23, 42, 0.2); }

        .btn-action { background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%); box-shadow: 0 8px 20px -5px rgba(79, 70, 229, 0.4); } 
        .btn-whatsapp { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; box-shadow: 0 8px 20px -5px rgba(34, 197, 94, 0.4); }
        
        .btn-ghost { background: #f8fafc; color: #64748b; font-weight: 700; padding: 12px; border-radius: 12px; width: 100%; cursor: pointer; border: 1px solid #e2e8f0; transition: 0.2s; }
        .btn-ghost:active { background: #e2e8f0; }
        
        .btn-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 12px; font-size: 1.1rem; cursor: pointer; border: none; transition: 0.2s; }
        .btn-icon:active { transform: scale(0.9); }
        .btn-edit { background: #eff6ff; color: #3b82f6; } 
        .btn-delete { background: #fef2f2; color: #ef4444; } 
        .btn-merma { background: #fff7ed; color: #f97316; } 
        .btn-log { background: #f0fdf4; color: #16a34a; }

        /* === INPUTS MEJORADOS === */
        .input-premium { 
            width: 100%; padding: 14px; background: #f8fafc; 
            border: 2px solid #e2e8f0; border-radius: 14px; 
            outline: none; font-size: 14px; font-weight: 600; color: #334155;
            transition: 0.2s;
        }
        .input-premium:focus { border-color: #4f46e5; background: white; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); }
        label { display: block; font-size: 0.7rem; font-weight: 800; color: #94a3b8; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }

        /* === BARRA DE NAVEGACI√ìN === */
        nav { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: rgba(255,255,255,0.9); backdrop-filter: blur(20px);
            padding: 12px 0; display: flex; justify-content: space-around; 
            box-shadow: 0 -10px 40px rgba(0,0,0,0.05); 
            z-index: 50; border-top: 1px solid rgba(255,255,255,0.5);
            padding-bottom: max(12px, env(safe-area-inset-bottom));
        }
        nav button { flex: 1; background: none; border: none; color: #cbd5e1; display: flex; flex-direction: column; align-items: center; font-size: 0.65rem; font-weight: 700; transition: 0.3s; cursor: pointer; -webkit-tap-highlight-color: transparent; }
        nav button.active { color: #0f172a; transform: translateY(-4px); }
        nav button.active svg { fill: #0f172a; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2)); }
        nav button svg { width: 26px; height: 26px; fill: #cbd5e1; margin-bottom: 6px; transition: 0.3s; }
        nav button.locked { opacity: 0.3; pointer-events: none; filter: grayscale(1); }

        /* === UI ELEMENTS === */
        .modal { background: white; width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto; border-radius: 32px; padding: 24px; box-shadow: 0 40px 60px -20px rgba(0,0,0,0.3); animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.2s; }
        .overlay:not(.hidden) { opacity: 1; pointer-events: auto; }
        .hidden { display: none !important; }

        .tag { font-size: 0.65rem; font-weight: 800; padding: 4px 8px; border-radius: 6px; text-transform: uppercase; }
        .tag-green { background: #dcfce7; color: #166534; }
        .tag-red { background: #fee2e2; color: #991b1b; }

        /* === MODO IMPRESI√ìN (PAPEL) === */
        @media print {
            body { padding: 0; background: white; }
            nav, header, .btn-premium, .btn-ghost, .btn-icon, .input-premium, button, input, select, .overlay { display: none !important; }
            
            /* Forzar visualizaci√≥n del Modal si est√° abierto */
            .overlay:not(.hidden) { position: static; background: none; display: block !important; opacity: 1; }
            .modal { box-shadow: none; border: none; width: 100%; max-width: 100%; padding: 0; overflow: visible; height: auto; }
            
            /* Si hay modal abierto, ocultar el fondo (la app principal) */
            .overlay:not(.hidden) ~ main { display: none; }

            body, h1, h2, h3, div, span, p { color: black !important; -webkit-print-color-adjust: exact; }
            .glass-card, .modal { border: 1px solid #000; box-shadow: none; border-radius: 0; }
            p, li { page-break-inside: avoid; }
        }
    </style>
</head>
<body>

    <div id="loading-overlay" class="hidden fixed inset-0 bg-white/90 z-[300] flex justify-center items-center flex-col backdrop-blur-sm">
        <div class="w-12 h-12 border-4 border-slate-200 border-t-indigo-600 rounded-full animate-spin mb-4"></div>
        <div class="font-black text-slate-400 tracking-[0.3em] text-xs animate-pulse">GUARDANDO EN NUBE...</div>
    </div>

    <div id="toast-container" class="fixed top-6 left-1/2 -translate-x-1/2 z-[400] w-max pointer-events-none space-y-2"></div>
    
    <input type="file" id="backup-input" class="hidden" onchange="restoreBackup(this)">

    <header class="sticky top-0 z-40 px-6 py-4 flex justify-between items-center bg-white/80 backdrop-blur-xl border-b border-white/50 shadow-sm">
        <div>
            <h1 class="text-2xl font-black text-slate-900 tracking-tighter">ARUME <span class="text-emerald-500">PRO</span></h1>
            <p class="text-[9px] text-slate-400 font-bold tracking-widest uppercase">Sistema Cloud Supabase</p>
        </div>
        <div class="bg-slate-100 px-3 py-1.5 rounded-full text-xs font-bold text-slate-600 flex items-center gap-2 cursor-pointer hover:bg-slate-200 transition border border-slate-200" onclick="logout()">
            <div id="sync-dot" class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div> 
            <span id="user-name">Login</span>
        </div>
    </header>

    <main id="app" class="px-4 py-6 max-w-2xl mx-auto"></main>
    
    <nav id="navbar"></nav>

    <div id="modal-overlay" class="overlay hidden">
        <div class="modal">
            <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                <h3 id="m-title" class="text-lg font-black text-slate-800 uppercase tracking-tight"></h3>
                <button onclick="closeModal()" class="w-8 h-8 flex items-center justify-center bg-slate-50 rounded-full text-slate-400 hover:bg-slate-200 hover:text-slate-800 text-lg font-bold transition">‚úï</button>
            </div>
            <div id="m-body"></div>
        </div>
    </div>

    <div id="pin-screen" class="hidden bg-slate-950 fixed inset-0 z-[200] flex flex-col items-center justify-center text-white">
        <div class="mb-12 text-center">
            <h2 class="text-6xl font-black tracking-tighter mb-2">ARUME</h2>
            <p class="text-indigo-500 text-xs tracking-[0.5em] uppercase font-bold">Gesti√≥n Integral</p>
        </div>
        <div id="pin-display" class="text-5xl font-mono mb-12 tracking-[0.5em] h-12 text-center opacity-80 font-bold">****</div>
        <div class="grid grid-cols-3 gap-4 w-72">
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold hover:bg-white/10 active:scale-95 transition" onclick="pin(1)">1</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold hover:bg-white/10 active:scale-95 transition" onclick="pin(2)">2</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold hover:bg-white/10 active:scale-95 transition" onclick="pin(3)">3</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold hover:bg-white/10 active:scale-95 transition" onclick="pin(4)">4</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold hover:bg-white/10 active:scale-95 transition" onclick="pin(5)">5</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold hover:bg-white/10 active:scale-95 transition" onclick="pin(6)">6</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold hover:bg-white/10 active:scale-95 transition" onclick="pin(7)">7</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold hover:bg-white/10 active:scale-95 transition" onclick="pin(8)">8</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold hover:bg-white/10 active:scale-95 transition" onclick="pin(9)">9</button>
            <button class="w-20 h-20 rounded-full bg-red-500/20 border border-red-500/50 text-red-400 font-bold active:scale-95 transition" onclick="pin('C')">C</button>
            <button class="w-20 h-20 rounded-full border border-white/10 text-2xl font-bold hover:bg-white/10 active:scale-95 transition" onclick="pin(0)">0</button>
            <button class="w-20 h-20 rounded-full bg-emerald-500 text-white font-bold shadow-lg shadow-emerald-500/50 active:scale-95 transition" onclick="pin('OK')">OK</button>
       </div>
        <p class="mt-10 text-slate-800/20 text-[8px] font-mono uppercase tracking-[0.3em]">Acceso Restringido ¬∑ Diamond Audit</p>
    </div>
    <script>
/* =============================================================
   ‚ö†Ô∏è 1. CONFIGURACI√ìN DEL MOTOR (SUPABASE) ‚ö†Ô∏è
   ============================================================= */
const SUPABASE_URL = "https://awbgboucnbsuzojocbuy.supabase.co"; 
const SUPABASE_KEY = "sb_publishable_drOQ5PsFA8eox_aRTXNATQ_5kibM6ST";
const CONFIG = { COST_HOUR: 15 };

// Inicializamos el cliente (El puente con la nube)
const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

/* === 2. UTILIDADES MATEM√ÅTICAS Y FORMATO (MEJORADO) === */
const Num = {
    parse: (str) => { 
        if (!str) return 0; 
        if (typeof str === 'number') return str; 
        // 1. Quitamos todo lo que no sea n√∫mero, punto, coma o guion
        let clean = String(str).replace(/[^0-9.,-]/g, '');
        // 2. Si hay coma, reemplazamos por punto para est√°ndar JS
        clean = clean.replace(/,/g, '.');
        // 3. Evitamos m√∫ltiples puntos (ej: 1.500.50 -> 1500.50)
        const parts = clean.split('.');
        if (parts.length > 2) {
            clean = parts.shift() + '.' + parts.join('');
        }
        return parseFloat(clean) || 0; 
    },
    fmt: (n) => (n || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }),
    csv: (n) => String(n || 0).replace('.', ',')
};
function clean(str) { 
    return String(str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); 
}

const generateID = () => Math.random().toString(36).substr(2, 9);
const getISO = () => new Date().toLocaleDateString('en-CA');
const getTS = () => new Date().toLocaleString('es-ES');
/* === 3. CONVERSOR DE UNIDADES INTELIGENTE (MEJORADO) === */
const UnitConverter = {
    normalize: (u) => {
        if (!u) return 'ud';
        u = String(u).toLowerCase().trim().replace('.', '');
        // Peso
        if (['kg', 'kilo', 'k'].includes(u)) return 'kg';
        if (['g', 'gr', 'gramos'].includes(u)) return 'g';
        if (['mg', 'mili'].includes(u)) return 'mg';
        if (['lb', 'libra'].includes(u)) return 'lb';
        if (['oz', 'onza'].includes(u)) return 'oz';
        // Volumen
        if (['l', 'litro', 'lt'].includes(u)) return 'l';
        if (['ml', 'mili'].includes(u)) return 'ml';
        if (['cl', 'centi'].includes(u)) return 'cl';
        return 'ud';
    },
    convert: (q, from, to) => {
        from = UnitConverter.normalize(from);
        to = UnitConverter.normalize(to);
        if (from === to) return q;

        // Tabla de conversi√≥n a base com√∫n (Base peso: g, Base volumen: ml)
        const toG = { 'kg': 1000, 'g': 1, 'mg': 0.001, 'lb': 453.59, 'oz': 28.35 };
        const toMl = { 'l': 1000, 'ml': 1, 'cl': 10 };

        // 1. Si ambos son PESO
        if (toG[from] && toG[to]) return q * (toG[from] / toG[to]);

        // 2. Si ambos son VOLUMEN
        if (toMl[from] && toMl[to]) return q * (toMl[from] / toMl[to]);

        // 3. Conversi√≥n PESO <-> VOLUMEN (Aproximaci√≥n Agua: 1g = 1ml)
        // Convertimos el origen a gramos/ml y luego al destino
        const valInBase = (toG[from] || toMl[from]) * q;
        if (valInBase) {
            const factorDestino = (toG[to] || toMl[to]);
            if (factorDestino) return valInBase / factorDestino;
        }

        // 4. Si es Unidad (ud), no se puede convertir matem√°ticamente sin saber lo que pesa 1 ud
        return q; 
    }
};
/* === 4. ESTRUCTURA DE LA BASE DE DATOS === */
const DB_INIT = { 
    users: [
        {id:'u1', n:'Gerencia', pin:'MDE1MA==', role:'admin'}, 
        {id:'u2', n:'Equipo', pin:'MTExMQ==', role:'staff'}
    ], 
    ingredientes: [], 
    recetas: [], 
    proveedores: [{ id: 'p1', n: 'Makro', tel: '', fam: 'General' }], 
    albaranes: [], 
    facturas: [], 
    diario: [], 
    mermas: [], 
    kardex: [], 
    sales_history: [], 
    lastSync: 0 
};

// Encriptaci√≥n para copias locales
const secure = { 
    enc: (d) => btoa(encodeURIComponent(JSON.stringify(d))), 
    dec: (d) => JSON.parse(decodeURIComponent(atob(d))) 
};

/* === 5. VARIABLES GLOBALES DE ESTADO === */
let db = DB_INIT;
let currentUser = null;
let currentPin = "";
let tempItems = [];
let activeAdminTab = 'dash';
let searchFilter = "";
let currentDiarioDate = getISO();
let inventoryMode = false;
let activeFamily = 'Todos';
let tempAlgs = []; // Variable temporal para al√©rgenos

// C√°lculo autom√°tico del trimestre fiscal
let fiscalYear = new Date().getFullYear();
let fiscalQuarter = Math.floor(new Date().getMonth() / 3) + 1;

// Constantes de negocio
const ALLERGENS = [{k:'glu',i:'üåæ'},{k:'cru',i:'ü¶ê'},{k:'hue',i:'ü•ö'},{k:'pes',i:'üêü'},{k:'cac',i:'ü•ú'},{k:'soj',i:'ü´ò'},{k:'lac',i:'ü•õ'},{k:'fru',i:'üå∞'},{k:'api',i:'ü•¨'},{k:'mos',i:'üå≠'},{k:'ses',i:'üå±'},{k:'sul',i:'üç∑'},{k:'alt',i:'ü´ò'},{k:'mol',i:'üêô'}];
const FAMILIES = ['General', 'Carne', 'Pescado', 'Verdura', 'Secos', 'L√°cteos', 'Congelado', 'Bebida', 'Alcohol', 'Limpieza', 'Packaging'];
/* =============================================================
   ‚ö†Ô∏è 6. MOTOR DE SINCRONIZACI√ìN (CON SEM√ÅFORO) ‚ö†Ô∏è
   ============================================================= */
let isSyncing = false; // El sem√°foro

// Funci√≥n: BAJAR datos de la nube
async function syncDown() {
    if (isSyncing) return; // Si ya est√° trabajando, no molestar
    isSyncing = true;

    try {
        const { data, error } = await sb.from('arume_data').select('data').eq('id', 1).single();
        
        if (data && data.data) {
            const cloudDB = data.data;
            // Solo actualizamos si la nube tiene datos m√°s nuevos
            if ((cloudDB.lastSync || 0) > (db.lastSync || 0)) {
                // SEGURIDAD: No interrumpir si el usuario est√° escribiendo en un modal
                if (!document.getElementById('modal-overlay').classList.contains('hidden')) {
                    console.log("Sync pospuesto: Usuario ocupado");
                    return;
                }
                
                db = cloudDB;
                localStorage.setItem('arume_v152', secure.enc(db));
                refreshCurrentView();
                toast("‚òÅÔ∏è Datos actualizados", "success");
            }
        } else if (error && error.code === 'PGRST116') {
            console.log("Inicializando Nube...");
            await sb.from('arume_data').insert([{ id: 1, data: db }]);
        }
    } catch (e) { 
        console.error("Error Sync:", e); 
    } finally {
        isSyncing = false; // Abrir sem√°foro
    }
}

// Funci√≥n: SUBIR datos a la nube
async function save(msg) {
    loading(true);
    isSyncing = true; // Bloqueamos bajadas mientras subimos
    try {
        db.lastSync = Date.now();
        localStorage.setItem('arume_v152', secure.enc(db)); 
        
        const { error } = await sb.from('arume_data').upsert({ id: 1, data: db });
        if (error) throw error;
        
        if (msg) toast(msg, 'success');
    } catch (e) {
        toast("Guardado en local (Sin red)", "info");
        console.error(e);
    } finally { 
        loading(false); 
        isSyncing = false; 
    }
}
// Auxiliar para refrescar la pantalla actual tras sincronizar
function refreshCurrentView() {
    const activeBtn = document.querySelector('nav button.active');
    const view = activeBtn ? activeBtn.id.replace('btn-', '') : 'Cocina';
    render(view);
}

/* === 7. HERRAMIENTAS VISUALES (UI HELPERS) === */
function loading(show) { 
    document.getElementById('loading-overlay').classList.toggle('hidden', !show); 
}

function toast(msg, type = 'info') { 
    const container = document.getElementById('toast-container'); 
    const el = document.createElement('div'); 
    // Dise√±o de la notificaci√≥n flotante
    el.className = `${type === 'error' ? 'bg-red-500' : 'bg-slate-800'} text-white px-6 py-3 rounded-full shadow-xl font-bold text-xs tracking-wide animate-bounce mb-2`; 
    el.innerText = msg; 
    container.appendChild(el); 
    setTimeout(() => el.remove(), 3000); // Se borra a los 3 segundos
}

// Funci√≥n clave para filtrar fechas (Trimestres)
function isInPeriod(dateStr) { 
    if (!dateStr) return false; 
    const parts = dateStr.split('-'); 
    const year = parseInt(parts[0]); 
    const month = parseInt(parts[1]); 
    
    if (year !== fiscalYear) return false; // Si no es este a√±o, fuera
    if (fiscalQuarter === 0) return true; // Si es "A√ëO", todo dentro
    return Math.ceil(month / 3) === fiscalQuarter; // C√°lculo de trimestre
}
/* === 8. L√ìGICA DE ARRANQUE Y LOGIN (PIN) === */
function init() {
    // 1. Intentamos recuperar datos del navegador por si acaso
    try { 
        const stored = localStorage.getItem('arume_v152'); 
        if (stored) db = secure.dec(stored); 
    } catch(e) { console.warn("Reset DB"); }
    
    // Si la DB est√° corrupta o vac√≠a, usamos la plantilla inicial
    if (!db.users) db = DB_INIT;
    
    // 2. Comprobamos si el usuario ya inici√≥ sesi√≥n antes
    const savedUser = localStorage.getItem('arume_user');
    if (savedUser) { 
        try { 
            currentUser = db.users.find(x => x.id === JSON.parse(savedUser).id); 
        } catch(e){} 
    }

    if (currentUser) {
        // Si hay usuario, entramos directo
        document.getElementById('pin-screen').classList.add('hidden');
        loadApp();
        syncDown(); // Forzamos una descarga de datos al entrar
    } else {
        // Si no, mostramos la pantalla de PIN
        document.getElementById('pin-screen').classList.remove('hidden');
    }
    
    // ACTIVAMOS EL LATIDO: Sincronizar cada 10 segundos (OPTIMIZADO)
    setInterval(syncDown, 10000); 
}
// L√≥gica del teclado num√©rico
function pin(n) {
    if (n === 'C') {
        currentPin = ""; // Borrar
    } else if (n === 'OK') {
        // Comprobar PIN (est√°n guardados en Base64 para privacidad b√°sica)
        const u = db.users.find(x => x.pin === btoa(currentPin));
        if (u) { 
            currentUser = u; 
            localStorage.setItem('arume_user', JSON.stringify(u)); // Recordar usuario
            document.getElementById('pin-screen').classList.add('hidden'); 
            currentPin = ""; 
            loadApp(); 
            syncDown();
        } else { 
            toast("PIN Incorrecto", "error"); 
            currentPin = ""; 
        }
    } else if (currentPin.length < 4) {
        currentPin += n; // A√±adir n√∫mero
    }
    // Mostrar asteriscos
    document.getElementById('pin-display').innerText = currentPin ? '*'.repeat(currentPin.length) : '****';
}

function logout() { 
    if (confirm("¬øCerrar sesi√≥n?")) { 
        localStorage.removeItem('arume_user'); 
        location.reload(); 
    } 
}
        /* =============================================================
   ‚ö†Ô∏è 9. SISTEMA DE NAVEGACI√ìN Y PANTALLAS ‚ö†Ô∏è
   ============================================================= */

// Carga la aplicaci√≥n con el nombre del usuario
function loadApp() { 
    document.getElementById('user-name').innerText = currentUser.n; 
    renderNav(); 
    // Si es admin va a Admin, si es cocinero va a Cocina
    render(currentUser.role === 'admin' ? 'Admin' : 'Cocina'); 
}

// Dibuja la barra de botones inferior seg√∫n permisos
function renderNav() {
    const adm = currentUser?.role === 'admin';
    // Funci√≥n auxiliar para crear botones HTML
    const b = (id, l, i, lk) => `<button id="btn-${id}" class="${lk ? 'locked' : ''}" onclick="render('${id}')"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">${i}</svg><span>${l}</span></button>`;
    
    document.getElementById('navbar').innerHTML = 
        b('Diario', 'Caja', '<path d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>', !adm) +
        b('Admin', 'Gesti√≥n', '<path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>', !adm) +
        b('Cocina', 'Cocina', '<path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>', false) +
        b('Stock', 'Stock', '<path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>', false);
}

// Controlador central de Vistas (El "Director de Orquesta")
function render(v) {
    // Protecci√≥n de seguridad
    if ((v === 'Diario' || v === 'Admin') && currentUser.role !== 'admin') return toast("‚õî Solo Gerencia", "error");
    
    // Efectos visuales de bot√≥n activo
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    document.getElementById(`btn-${v}`)?.classList.add('active');
    
    const app = document.getElementById('app');
    
    // Enrutador
    if (v === 'Diario') renderDiario(app); 
    else if (v === 'Admin') renderAdmin(app); 
    else if (v === 'Cocina') renderCocina(app); 
    else if (v === 'Stock') renderStock(app);
}

/* =============================================================
   ‚ö†Ô∏è 10. M√ìDULO DE ADMINISTRACI√ìN Y GESTI√ìN ‚ö†Ô∏è
   ============================================================= */
/* === WIDGET DE ALERTAS DE STOCK === */
function getStockAlerts() {
    // Filtramos productos por debajo del m√≠nimo definido
    const lowStock = db.ingredientes.filter(i => i.stock <= (i.min || 0));
    
    if (lowStock.length === 0) {
        return `
        <div class="bg-emerald-50 border border-emerald-100 p-4 rounded-2xl flex items-center gap-3 mb-6 shadow-sm">
            <div class="bg-emerald-100 p-2 rounded-full text-emerald-600">‚úÖ</div>
            <div>
                <h4 class="font-bold text-emerald-800 text-sm">Almac√©n Saludable</h4>
                <p class="text-[10px] text-emerald-600">Todo el stock est√° por encima del m√≠nimo.</p>
            </div>
        </div>`;
    }

    // Si hay alertas, las mostramos
    const itemsHtml = lowStock.map(i => {
        const percent = i.min > 0 ? (i.stock / i.min) * 100 : 0;
        let color = percent < 25 ? 'bg-red-500' : 'bg-orange-400';
        
        return `
        <div class="flex justify-between items-center py-2 border-b border-slate-50 last:border-0">
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full ${color} animate-pulse"></div>
                <span class="text-xs font-bold text-slate-700">${clean(i.n)}</span>
            </div>
            <div class="text-right">
                <span class="text-xs font-black text-slate-800">${parseFloat(i.stock).toFixed(1)} ${i.unit}</span>
                <div class="text-[9px] text-red-400 font-bold">M√≠n: ${i.min}</div>
            </div>
        </div>`;
    }).join('');

    return `
    <div class="bg-white border-l-4 border-red-500 shadow-md rounded-xl p-4 mb-6">
        <div class="flex justify-between items-center mb-3">
            <h3 class="font-black text-slate-800 text-xs uppercase tracking-widest flex items-center gap-2">
                ‚ö†Ô∏è ALERTA DE STOCK <span class="bg-red-100 text-red-600 px-2 py-0.5 rounded-full text-[9px]">${lowStock.length}</span>
            </h3>
            <button class="text-[10px] font-bold text-indigo-600 hover:underline" onclick="render('Stock')">VER ALMAC√âN</button>
        </div>
        <div class="max-h-40 overflow-y-auto pr-1 custom-scrollbar">
            ${itemsHtml}
        </div>
        <button class="w-full mt-3 btn-whatsapp text-[10px] py-2" onclick="sendWhatsApp()">üìû GENERAR PEDIDO AUTO</button>
    </div>`;
}
function renderAdmin(app) {
    // 1. C√°lculos Financieros en Tiempo Real
    const tot = db.diario.filter(d => isInPeriod(d.date)).reduce((a, b) => a + (b.total || 0), 0);
    const periodAlbs = db.albaranes.filter(a => isInPeriod(a.date));
    const compras = periodAlbs.reduce((a, b) => a + (b.subtotal || 0), 0);
    const taxes = periodAlbs.reduce((a, b) => a + (b.taxes || 0), 0);
    
    // 2. C√°lculo te√≥rico de Food Cost (CORREGIDO PARA RENDIMIENTO)
    let theoreticalCost = 0;
    db.sales_history.filter(log => isInPeriod(log.date)).forEach(log => {
        log.items.forEach(soldItem => {
            const rec = db.recetas.find(r => r.id === soldItem.rid);
            if (rec) {
                // AQU√ç ESTABA EL ERROR: Ahora dividimos el coste total entre el rendimiento
                const unitCost = calcRecipe(rec).t / (rec.yield || 1);
                theoreticalCost += (unitCost * soldItem.q);
            }
        });
    });
    
    const theoreticalMargin = tot - theoreticalCost;
    const foodCostPercent = tot > 0 ? (theoreticalCost / tot) * 100 : 0;
    const cashFlow = tot - (compras + taxes); 

    // 3. Selector de Trimestre (HTML)
    const qCtrl = `<div class="flex items-center justify-between bg-white p-2 rounded-2xl shadow-sm mb-4 border border-slate-100"><div class="flex items-center gap-2 bg-slate-100 rounded-lg px-2 py-1"><button class="w-8 h-8 flex items-center justify-center hover:bg-white rounded-full transition font-bold" onclick="fiscalYear--;renderAdmin(document.getElementById('app'))">‚Äπ</button><span class="font-black text-slate-700 text-sm tracking-widest">${fiscalYear}</span><button class="w-8 h-8 flex items-center justify-center hover:bg-white rounded-full transition font-bold" onclick="fiscalYear++;renderAdmin(document.getElementById('app'))">‚Ä∫</button></div><div class="flex gap-1 overflow-x-auto no-scrollbar"><button class="px-2 py-1 rounded ${fiscalQuarter===1?'bg-slate-800 text-white':'bg-slate-100 text-slate-500'} text-xs font-bold" onclick="fiscalQuarter=1;renderAdmin(document.getElementById('app'))">1T</button><button class="px-2 py-1 rounded ${fiscalQuarter===2?'bg-slate-800 text-white':'bg-slate-100 text-slate-500'} text-xs font-bold" onclick="fiscalQuarter=2;renderAdmin(document.getElementById('app'))">2T</button><button class="px-2 py-1 rounded ${fiscalQuarter===3?'bg-slate-800 text-white':'bg-slate-100 text-slate-500'} text-xs font-bold" onclick="fiscalQuarter=3;renderAdmin(document.getElementById('app'))">3T</button><button class="px-2 py-1 rounded ${fiscalQuarter===4?'bg-slate-800 text-white':'bg-slate-100 text-slate-500'} text-xs font-bold" onclick="fiscalQuarter=4;renderAdmin(document.getElementById('app'))">4T</button><button class="px-2 py-1 rounded ${fiscalQuarter===0?'bg-slate-800 text-white':'bg-slate-100 text-slate-500'} text-xs font-bold" onclick="fiscalQuarter=0;renderAdmin(document.getElementById('app'))">A√ëO</button></div></div>`;

    // 4. Renderizado HTML
    app.innerHTML = `${qCtrl}
    
    <div class="flex gap-2 mb-6 bg-white p-1 rounded-2xl shadow-sm border border-slate-100 overflow-x-auto no-scrollbar">
        <button class="flex-1 min-w-[80px] py-2.5 rounded-xl font-bold text-xs transition ${activeAdminTab==='dash'?'bg-slate-800 text-white shadow-md':'text-slate-500 hover:bg-slate-50'}" onclick="activeAdminTab='dash';renderAdmin(document.getElementById('app'))">DASHBOARD</button>
        <button class="flex-1 min-w-[80px] py-2.5 rounded-xl font-bold text-xs transition ${activeAdminTab==='omnes'?'bg-slate-800 text-white shadow-md':'text-slate-500 hover:bg-slate-50'}" onclick="activeAdminTab='omnes';renderAdmin(document.getElementById('app'))">OMNES</button>
        <button class="flex-1 min-w-[80px] py-2.5 rounded-xl font-bold text-xs transition ${activeAdminTab==='albs'?'bg-slate-800 text-white shadow-md':'text-slate-500 hover:bg-slate-50'}" onclick="activeAdminTab='albs';renderAdmin(document.getElementById('app'))">COMPRAS</button>
        <button class="flex-1 min-w-[80px] py-2.5 rounded-xl font-bold text-xs transition ${activeAdminTab==='facturas'?'bg-slate-800 text-white shadow-md':'text-slate-500 hover:bg-slate-50'}" onclick="activeAdminTab='facturas';renderAdmin(document.getElementById('app'))">FACTURAS</button>
        <button class="flex-1 min-w-[80px] py-2.5 rounded-xl font-bold text-xs transition ${activeAdminTab==='prov'?'bg-slate-800 text-white shadow-md':'text-slate-500 hover:bg-slate-50'}" onclick="activeAdminTab='prov';renderAdmin(document.getElementById('app'))">AGENDA</button>
    </div>
    
    ${activeAdminTab === 'dash' ? `
        <div class="glass-card bg-gradient-to-br from-indigo-900 to-slate-900 text-white mb-4">
            <h3 class="text-xs uppercase tracking-widest mb-4 font-bold opacity-70">Resultados ${fiscalQuarter===0?'A√ëO':fiscalQuarter+'T'}</h3>
            <div class="flex justify-between items-end mb-4">
                <div><div class="text-3xl font-black">${Num.fmt(theoreticalMargin)}‚Ç¨</div><div class="text-[10px] uppercase font-bold">Margen Bruto</div></div>
                <div class="text-right"><div class="text-xl font-bold ${foodCostPercent > 35 ? 'text-red-400' : 'text-emerald-400'}">${Num.fmt(foodCostPercent)}%</div><div class="text-[10px] uppercase font-bold">Food Cost %</div></div>
            </div>
            <div class="flex text-[10px] gap-4 font-bold text-indigo-200/50 uppercase tracking-wide border-t border-white/10 pt-2">
                <span>Ventas: ${Num.fmt(tot)}‚Ç¨</span><span>Consumo: ${Num.fmt(theoreticalCost)}‚Ç¨</span>
            </div>
        </div>

        <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm mb-6">
            <h3 class="text-[10px] font-bold text-slate-400 uppercase mb-3">Flujo de Caja</h3>
            <div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-slate-600">Entradas</span><span class="font-bold text-emerald-600">+${Num.fmt(tot)}‚Ç¨</span></div>
            <div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-slate-600">Salidas (IVA inc)</span><span class="font-bold text-red-500">-${Num.fmt(compras + taxes)}‚Ç¨</span></div>
            <div class="border-t border-slate-100 pt-2 mt-2 flex justify-between items-center"><span class="text-xs font-black text-slate-800 uppercase">Saldo</span><span class="font-black text-lg ${cashFlow >= 0 ? 'text-slate-800' : 'text-red-600'}">${Num.fmt(cashFlow)}‚Ç¨</span></div>
        </div>

        ${getStockAlerts()} 

       <div class="grid grid-cols-3 gap-2">
            <button class="btn-ghost" onclick="downloadBackup()">üíæ BACKUP</button>
            <button class="btn-ghost text-indigo-600" onclick="document.getElementById('backup-input').click()">üì§ RESTAURAR</button>
            <button class="btn-ghost text-emerald-600 font-black border-emerald-200 bg-emerald-50" onclick="forceCloudDownload()">‚òÅÔ∏è BAJAR</button>
        </div>
    ` : ''}
    <div id="adm-c"></div>`;

    const c = document.getElementById('adm-c');
    if (activeAdminTab === 'omnes') renderOmnes(c);
    if (activeAdminTab === 'albs') renderAlbaranes(c);
    if (activeAdminTab === 'facturas') renderFacturas(c);
    if (activeAdminTab === 'prov') renderProvs(c);
}
// --- SUB-M√ìDULO: PROVEEDORES ---
function renderProvs(c) { 
    // Calcular gasto por proveedor
    const spendMap = {}; 
    db.albaranes.forEach(a => { if (isInPeriod(a.date)) spendMap[a.prov] = (spendMap[a.prov] || 0) + a.total; });
    
    c.innerHTML = `<div class="glass-card"><div class="flex justify-between mb-4"><h3 class="font-bold">PROVEEDORES</h3><button class="btn-premium w-auto px-3 py-1 text-xs" onclick="editProv()">+ NUEVO</button></div><div class="space-y-2">${db.proveedores.map(p => `<div class="bg-white p-3 rounded-xl border flex justify-between items-center" onclick="editProv('${p.id}')"><div><div class="font-bold text-slate-800">${clean(p.n)}</div><div class="text-[10px] bg-slate-100 px-2 rounded inline-block">${p.fam}</div></div><div class="text-right font-bold text-slate-700">${Num.fmt(spendMap[p.n])}‚Ç¨</div></div>`).join('')}</div></div>`; 
}
function editProv(id) { 
    const p = id ? db.proveedores.find(x => x.id === id) : { id: generateID(), n: '', tel: '', fam: 'General' }; 
    const fams = FAMILIES.map(f => `<option ${p.fam === f ? 'selected' : ''}>${f}</option>`).join(''); 
    showModal('Proveedor', `<label>Nombre</label><input id="ep-n" value="${clean(p.n)}" class="input-premium mb-2" placeholder="Nombre"><label>Tel√©fono</label><input id="ep-t" value="${clean(p.tel)}" class="input-premium mb-2" placeholder="Tel√©fono"><label>Familia</label><select id="ep-f" class="input-premium mb-4">${fams}</select><div class="flex gap-2"><button class="btn-premium flex-1" onclick="saveProv('${p.id}')">GUARDAR</button>${id ? `<button class="btn-ghost text-red-500 w-auto" onclick="delProv('${id}')">üóëÔ∏è</button>` : ''}</div>`); 
}
function saveProv(id) { 
    const n = document.getElementById('ep-n').value; 
    if (n) { 
        const p = { id, n, tel: document.getElementById('ep-t').value, fam: document.getElementById('ep-f').value }; 
        const idx = db.proveedores.findIndex(x => x.id === id); 
        if (idx >= 0) db.proveedores[idx] = p; else db.proveedores.push(p); 
        save("Guardado"); closeModal(); renderAdmin(document.getElementById('app')); 
    } 
}
function delProv(id) { 
    if (confirm("¬øBorrar?")) { db.proveedores = db.proveedores.filter(x => x.id !== id); save("Borrado"); closeModal(); renderAdmin(document.getElementById('app')); } 
}
/* === SUB-M√ìDULO: ALBARANES PRO (CON EDICI√ìN) === */

function renderAlbaranes(c) {
    const list = db.albaranes.filter(a => isInPeriod(a.date)).slice().reverse();
    const provOptions = db.proveedores.map(p => `<option value="${clean(p.n)}">`).join('');
    const ingOptions = db.ingredientes.map(i => `<option value="${clean(i.n)}">`).join('');

    c.innerHTML = `
    <div class="glass-card border-l-4 border-indigo-500" id="alb-form-anchor">
        <h3 class="font-bold text-slate-700 text-sm mb-4 uppercase">Nuevo / Editar Albar√°n</h3>
        
        <div class="grid grid-cols-3 gap-3 mb-3">
            <div><label>Proveedor</label><input list="prov-list" id="alb-prov" class="input-premium" placeholder="..." onchange="checkDuplicate()"><datalist id="prov-list">${provOptions}</datalist></div>
            <div><label>Ref / Factura</label><input id="alb-num" class="input-premium font-mono" onkeyup="checkDuplicate()" placeholder="Ref..."></div>
            <div><label>Fecha</label><input type="date" id="alb-date" value="${getISO()}" class="input-premium"></div>
        </div>
        <div id="dup-alert" class="hidden text-[10px] text-red-500 font-bold mb-2 text-center bg-red-50 p-1 rounded">‚ö†Ô∏è FACTURA DUPLICADA</div>

        <datalist id="ing-list">${ingOptions}</datalist>
        <textarea id="alb-input" rows="2" class="input-premium font-mono text-xs mb-2" placeholder="Pegar aqu√≠: Producto TAB Cantidad TAB Precio..."></textarea>
        
        <div class="flex gap-2 mb-4">
            <button class="btn-ghost" onclick="parseAlb()">ü™Ñ LEER TEXTO</button>
            <button class="btn-ghost text-red-400" onclick="tempItems=[];renderAlbGrid()">LIMPIAR</button>
        </div>

        <div class="grid grid-cols-12 gap-1 px-2 mb-1 text-[10px] font-bold text-slate-400 uppercase tracking-wider text-center">
            <div class="col-span-4 text-left">Producto</div><div class="col-span-2">Cant</div><div class="col-span-2">Precio</div><div class="col-span-1">Dto</div><div class="col-span-1">IVA</div><div class="col-span-2 text-right">Total</div>
        </div>
        
        <div id="alb-grid" class="space-y-2 mb-4 max-h-60 overflow-y-auto"></div>
        
        <div class="border-t border-slate-100 pt-3 text-right">
            <div class="text-xs text-slate-400 font-bold">TOTAL A PAGAR</div>
            <div class="text-3xl font-black text-slate-800"><span id="alb-total">0.00‚Ç¨</span></div>
        </div>
        
        <div class="grid grid-cols-2 gap-3 mt-4">
            <button class="btn-premium btn-action" onclick="commitAlb()">GUARDAR Y STOCK</button>
            <button class="btn-ghost" onclick="exportAlbCSV()">CSV</button>
        </div>
    </div>

    <div class="glass-card">
        <h4 class="text-xs font-bold text-slate-400 uppercase mb-4">Historial</h4>
        ${list.length ? list.map(a => `
            <div class="flex justify-between items-center py-3 border-b hover:bg-slate-50 transition px-2 rounded-lg">
                <div class="text-sm font-bold text-slate-700">
                    ${clean(a.prov)} <span class="text-[10px] text-slate-400 font-normal">(${a.date})</span>
                    <div class="text-[10px] text-slate-400 font-mono">Ref: ${a.num || '-'}</div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="font-bold text-sm mr-2">${Num.fmt(a.total)}‚Ç¨</span>
                    <button class="btn-icon btn-ghost" onclick="viewAlbDetails('${a.id}')">üëÅ</button>
                    ${!a.invoiced ? `
                        <button class="btn-icon btn-edit" onclick="editAlb('${a.id}')">‚úèÔ∏è</button>
                        <button class="btn-icon btn-delete" onclick="deleteAlb('${a.id}')">üóëÔ∏è</button>
                    ` : '<span class="text-[10px] bg-emerald-100 text-emerald-700 px-2 py-1 rounded font-bold">FACTURADO</span>'}
                </div>
            </div>`).join('') : '<div class="text-center p-4 text-slate-400">Sin registros</div>'}
    </div>`;
    renderAlbGrid();
}

function checkDuplicate() {
    const num = document.getElementById('alb-num').value.trim();
    const prov = document.getElementById('alb-prov').value.trim();
    const alert = document.getElementById('dup-alert');
    if(num && prov && db.albaranes.some(a => a.num === num && a.prov === prov)) alert.classList.remove('hidden');
    else alert.classList.add('hidden');
}

function parseAlb() {
    const txt = document.getElementById('alb-input').value;
    if (!txt) return toast("Pega texto primero", "error");
    const lines = txt.split(/\r?\n/).filter(l => l.trim() !== '');
    let count = 0;
    lines.forEach(l => {
        let parts = l.replace(/[‚Ç¨$]/g, '').trim().split(/[\t;]|\s{2,}/);
        if (parts.length >= 2) {
            const n = parts[0].trim();
            const q = Num.parse(parts[1]);
            const p = parts[2] ? Num.parse(parts[2]) : 0;
            let u = 'ud'; const unitMatch = parts[1].match(/[a-zA-Z]+/); if(unitMatch) u = UnitConverter.normalize(unitMatch[0]);
            if (n && q > 0) { tempItems.push({ n, q, p, unit: u, d: 0, tax: 10 }); count++; }
        }
    });
    if (count > 0) { document.getElementById('alb-input').value = ''; renderAlbGrid(); toast(`‚úÖ ${count} l√≠neas`); } 
    else toast("‚ö†Ô∏è Formato no reconocido", "error");
}

function renderAlbGrid() {
    const el = document.getElementById('alb-grid'); if (!el) return;
    el.innerHTML = tempItems.map((it, i) => {
        const totalLine = (it.q * it.p * (1 - (it.d||0)/100)) * (1 + (it.tax||10)/100);
        return `<div class="bg-white p-1 rounded-xl border border-slate-100 grid grid-cols-12 gap-1 items-center shadow-sm text-xs">
            <div class="col-span-4"><input value="${clean(it.n)}" class="w-full bg-transparent font-bold outline-none" onchange="tempItems[${i}].n=this.value"></div>
            <div class="col-span-2 flex gap-1"><input type="number" value="${it.q}" class="w-full bg-slate-50 text-center rounded" onchange="tempItems[${i}].q=parseFloat(this.value);renderAlbGrid()"><select onchange="tempItems[${i}].unit=this.value" class="w-10 bg-slate-50 rounded border-0"><option ${it.unit==='kg'?'selected':''}>kg</option><option ${it.unit==='ud'?'selected':''}>ud</option><option ${it.unit==='l'?'selected':''}>l</option></select></div>
            <div class="col-span-2"><input type="number" value="${it.p}" class="w-full bg-slate-50 text-center rounded" onchange="tempItems[${i}].p=parseFloat(this.value);renderAlbGrid()"></div>
            <div class="col-span-1"><input type="number" value="${it.d||0}" class="w-full bg-emerald-50 text-center rounded text-emerald-700" onchange="tempItems[${i}].d=parseFloat(this.value);renderAlbGrid()"></div>
            <div class="col-span-1"><select onchange="tempItems[${i}].tax=parseFloat(this.value);renderAlbGrid()" class="w-full bg-blue-50 rounded text-blue-700"><option ${it.tax===10?'selected':''} value="10">10</option><option ${it.tax===21?'selected':''} value="21">21</option><option ${it.tax===4?'selected':''} value="4">4</option></select></div>
            <div class="col-span-2 text-right font-mono font-bold pr-2">${Num.fmt(totalLine)}‚Ç¨</div>
            <button class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center opacity-0 hover:opacity-100 transition" onclick="tempItems.splice(${i},1);renderAlbGrid()">‚úï</button></div>`;
    }).join('');
    const total = tempItems.reduce((acc, it) => acc + (it.q * it.p * (1 - (it.d||0)/100)) * (1 + (it.tax||10)/100), 0);
    document.getElementById('alb-total').innerText = Num.fmt(total) + '‚Ç¨';
}

function commitAlb() {
    if (!tempItems.length) return toast("Albar√°n vac√≠o", "error");
    const prov = document.getElementById('alb-prov').value.trim();
    const date = document.getElementById('alb-date').value;
    const num = document.getElementById('alb-num').value.trim() || `A-${Date.now().toString().slice(-6)}`;
    if (!prov || !date) return toast("Faltan datos", "error");

    if (!db.proveedores.find(p => p.n.toLowerCase() === prov.toLowerCase())) db.proveedores.push({ id: generateID(), n: prov, tel: '', fam: 'General' });

    let subtotal = 0, taxes = 0;
    tempItems.forEach(it => {
        let ing = db.ingredientes.find(x => x.n.toLowerCase() === it.n.toLowerCase() && x.unit === it.unit);
        const netPrice = it.p * (1 - (it.d || 0) / 100);
        if (!ing) { ing = { id: generateID(), n: it.n, stock: 0, cost: 0, unit: it.unit, fam: 'General', min: 0 }; db.ingredientes.push(ing); }
        
        const totalVal = (ing.stock * ing.cost) + (it.q * netPrice);
        const totalQty = ing.stock + it.q;
        if (totalQty > 0) ing.cost = totalVal / totalQty;
        ing.stock += it.q;
        logStock(ing.id, it.q, 'IN', `Alb: ${num}`, netPrice);
        
        const base = it.q * it.p * (1 - (it.d || 0) / 100);
        subtotal += base; taxes += base * (it.tax / 100);
    });

    db.albaranes.push({ id: generateID(), num, prov, date, items: [...tempItems], total: subtotal + taxes, subtotal, taxes, invoiced: false });
    save(`‚úÖ Albar√°n ${num} guardado`); tempItems = []; renderAdmin(document.getElementById('app'));
}

function viewAlbDetails(id) { 
    const a = db.albaranes.find(x => x.id === id); 
    if (a) showModal(`Detalle ${a.num || ''}`, `<div class="mb-2 text-xs font-bold text-slate-500">${a.prov} - ${a.date}</div><table class="w-full text-xs"><thead><tr class="text-left text-slate-400 border-b"><th>Prod</th><th>Cant</th><th>‚Ç¨/ud</th><th>Total</th></tr></thead><tbody>${a.items.map(i => { const net = i.p * (1-(i.d||0)/100); return `<tr><td class="py-1">${i.n}</td><td>${i.q}${i.unit}</td><td>${Num.fmt(net)}</td><td class="text-right">${Num.fmt(i.q * net * (1+(i.tax||10)/100))}</td></tr>`; }).join('')}</tbody></table><div class="text-right font-black text-xl mt-4">${Num.fmt(a.total)}‚Ç¨</div>`); 
}

function deleteAlb(id) {
    if (confirm("¬øBorrar Albar√°n? (Se descontar√° el stock a√±adido)")) {
        const alb = db.albaranes.find(a => a.id === id);
        if(alb) {
            alb.items.forEach(it => {
                const ing = db.ingredientes.find(x => x.n === it.n && x.unit === it.unit);
                if(ing) { ing.stock -= it.q; logStock(ing.id, it.q, 'OUT', `Anular Alb ${alb.num}`, ing.cost); }
            });
            db.albaranes = db.albaranes.filter(a => a.id !== id);
            save("Albar√°n Eliminado"); renderAdmin(document.getElementById('app'));
        }
    }
}

// Funci√≥n para editar Albaranes
function editAlb(id) {
    const alb = db.albaranes.find(a => a.id === id);
    if (!alb) return;
    
    // Seguridad: No editar si ya est√° en una factura cerrada
    if (alb.invoiced) return toast("‚õî No se puede editar: Ya est√° facturado", "error");

    if(confirm("¬øModificar albar√°n? \nSe cargar√° arriba para editar y se recalcular√° el stock.")) {
        // 1. Revertir el Stock (Restamos lo que se hab√≠a sumado)
        alb.items.forEach(it => {
            const ing = db.ingredientes.find(x => x.n === it.n && x.unit === it.unit);
            if(ing) {
                ing.stock -= it.q;
                // Dejamos un rastro t√©cnico en el Kardex por si acaso
                logStock(ing.id, it.q, 'OUT', `Edici√≥n Alb: ${alb.num}`, ing.cost);
            }
        });

        // 2. Cargar los datos en el formulario de arriba
        document.getElementById('alb-prov').value = alb.prov;
        document.getElementById('alb-num').value = alb.num;
        document.getElementById('alb-date').value = alb.date;

        // 3. Pasar los items a la memoria temporal (tempItems)
        // Usamos JSON parse/stringify para romper la referencia y que sea una copia limpia
        tempItems = JSON.parse(JSON.stringify(alb.items));

        // 4. Borrar el albar√°n antiguo de la base de datos
        db.albaranes = db.albaranes.filter(a => a.id !== id);

        // 5. Refrescar la pantalla
        renderAdmin(document.getElementById('app')); // Recarga todo para ver los cambios
        
        // Un peque√±o truco para hacer scroll hacia arriba y que veas el formulario
        setTimeout(() => {
            document.getElementById('alb-form-anchor').scrollIntoView({ behavior: 'smooth' });
            toast("‚úèÔ∏è Datos cargados. Modifica y pulsa GUARDAR.", "info");
        }, 100);
    }
}

function exportAlbCSV() { 
    if (!tempItems.length) return toast("Tabla vac√≠a", "error"); 
    const rows = tempItems.map(it => [it.n, Num.csv(it.q), it.unit, Num.csv(it.p), Num.csv(it.d || 0), Num.csv((it.q * it.p) * (1 + it.tax / 100))]); 
    const csv = ['Producto;Cantidad;Unidad;Precio;Dto;Total', ...rows.map(r => r.join(';'))].join('\n'); 
    const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8' }); 
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Albaran_Import.csv'; a.click(); 
}
/* =============================================================
   ‚ö†Ô∏è NUEVO M√ìDULO DE FACTURACI√ìN (AGRUPADO + EXCEL + MODAL) ‚ö†Ô∏è
   ============================================================= */

// Variable temporal para guardar datos mientras est√° abierta la ventana modal
let tempInvoiceData = null;

function renderFacturas(c) {
    // 1. L√≥gica de Albaranes Pendientes (Agrupar por proveedor)
    const pends = db.albaranes.filter(a => !a.invoiced);
    const groups = {}; 
    pends.forEach(a => { 
        if (!groups[a.prov]) groups[a.prov] = { c: 0, t: 0, ids: [] }; 
        groups[a.prov].c++; 
        groups[a.prov].t += a.total; 
        groups[a.prov].ids.push(a.id); 
    });
    
    // 2. L√≥gica de Historial (Agrupado por Meses)
    const hist = db.facturas.filter(f => isInPeriod(f.date)).sort((a,b) => b.date.localeCompare(a.date));
    
    // Diccionario de meses
    const monthNames = ["", "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

    // Agrupamos las facturas en "Cajitas" por mes num√©rico (1-12)
    const byMonth = {};
    hist.forEach(f => {
        const m = parseInt(f.date.split('-')[1]); 
        if(!byMonth[m]) byMonth[m] = { name: monthNames[m], total: 0, items: [] };
        byMonth[m].items.push(f);
        byMonth[m].total += f.total;
    });

    // --- HTML PARTE SUPERIOR: PENDIENTES ---
    const htmlPends = Object.keys(groups).length ? 
        `<div class="glass-card mb-6 border-l-4 border-indigo-500">
            <h3 class="font-bold text-xs text-slate-400 mb-3 uppercase tracking-widest">‚ö†Ô∏è Pendientes de Facturar</h3>
            ${Object.entries(groups).map(([p, d]) => `
                <div class="flex justify-between items-center py-3 border-b border-slate-100 last:border-0">
                    <div>
                        <div class="font-bold text-slate-800 text-sm">${clean(p)}</div>
                        <div class="text-[10px] text-slate-400 font-bold bg-slate-50 px-2 rounded inline-block">
                            ${d.c} albaranes
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-black text-slate-700 text-sm">${Num.fmt(d.t)}‚Ç¨</span>
                        <button class="bg-indigo-600 text-white px-3 py-2 rounded-xl text-[10px] font-bold shadow-lg shadow-indigo-200 active:scale-95 transition tracking-wide" onclick="openInvoiceModal('${p}','${d.ids.join(',')}', ${d.t})">
                            GENERAR FACTURA
                        </button>
                    </div>
                </div>`).join('')}
        </div>` : 
        `<div class="glass-card mb-6 flex items-center gap-4 p-4 opacity-70">
            <div class="bg-emerald-100 p-2 rounded-full text-emerald-600">‚úÖ</div>
            <div class="text-xs font-bold text-slate-500">Todo al d√≠a. No hay albaranes pendientes.</div>
         </div>`;

    // --- HTML PARTE INFERIOR: HISTORIAL POR MESES ---
    let htmlHist = '';
    const sortedMonths = Object.keys(byMonth).sort((a,b) => b - a); // Mes m√°s reciente primero

    if(sortedMonths.length === 0) {
        htmlHist = `<div class="text-center p-10 text-slate-300 font-bold border-2 border-dashed border-slate-200 rounded-3xl">Sin facturas este trimestre</div>`;
    } else {
        htmlHist = sortedMonths.map(mKey => {
            const mData = byMonth[mKey];
            return `
            <div class="glass-card mb-6">
                <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-3">
                    <div>
                        <h3 class="font-black text-slate-800 uppercase text-lg tracking-tight">${mData.name}</h3>
                        <div class="text-[10px] font-bold text-slate-400">Total: ${Num.fmt(mData.total)}‚Ç¨</div>
                    </div>
                    <button class="flex items-center gap-2 bg-emerald-50 text-emerald-700 px-3 py-2 rounded-lg text-[10px] font-bold hover:bg-emerald-100 transition" onclick="downloadMonthCSV(${mKey}, '${mData.name}')">
                        <span>üì• EXCEL</span>
                    </button>
                </div>

                <div class="space-y-1">
                ${mData.items.map(f => `
                    <div class="flex justify-between items-center py-2 px-2 hover:bg-slate-50 transition rounded-lg group">
                        <div class="flex items-center gap-3">
                            <div class="bg-slate-100 w-8 h-8 flex items-center justify-center rounded-full text-[10px] font-bold text-slate-500 group-hover:bg-white group-hover:shadow-sm transition">üìÑ</div>
                            <div>
                                <div class="font-bold text-slate-700 text-sm leading-tight">${clean(f.prov)}</div>
                                <div class="text-[10px] text-slate-400 font-mono flex gap-2">
                                    <span>${f.date}</span>
                                    <span class="text-slate-300">|</span>
                                    <span class="text-indigo-400 font-bold">Ref: ${clean(f.num)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-black text-slate-800 text-sm">${Num.fmt(f.total)}‚Ç¨</div>
                            <button onclick="togglePaid('${f.id}')" class="mt-1 text-[9px] font-bold px-2 py-0.5 rounded border transition ${f.paid ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : 'bg-red-50 text-red-500 border-red-100'}">
                                ${f.paid ? 'PAGADO' : 'PENDIENTE'}
                            </button>
                        </div>
                    </div>
                `).join('')}
                </div>
            </div>`;
        }).join('');
    }

    c.innerHTML = htmlPends + htmlHist;
}

// 1. Paso previo: Abrir ventana para pedir datos (N√∫mero de factura real)
function openInvoiceModal(provName, idsString, amount) {
    // Guardamos los datos en memoria temporal
    tempInvoiceData = { 
        prov: provName, 
        ids: idsString.split(','), 
        total: amount 
    };

    const today = getISO();

    showModal('Nueva Factura', `
        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 mb-4 text-center">
            <div class="text-xs text-indigo-400 font-bold uppercase mb-1">Proveedor</div>
            <div class="text-xl font-black text-indigo-900">${clean(provName)}</div>
            <div class="text-2xl font-black text-indigo-600 mt-2">${Num.fmt(amount)}‚Ç¨</div>
        </div>

        <label>N√∫mero de Factura (Obligatorio)</label>
        <input type="text" id="inv-num" class="input-premium mb-3 font-mono text-lg font-bold" placeholder="Ej: F-2024/001">
        
        <label>Fecha de Emisi√≥n</label>
        <input type="date" id="inv-date" value="${today}" class="input-premium mb-6">

        <button class="btn-premium btn-action shadow-indigo-200" onclick="confirmInvoice()">
            ‚úÖ CONFIRMAR Y GUARDAR
        </button>
    `);
    
    // Poner el foco en el input para escribir r√°pido
    setTimeout(() => document.getElementById('inv-num').focus(), 100);
}

// 2. Paso final: Crear la factura real
function confirmInvoice() {
    if (!tempInvoiceData) return closeModal();

    const num = document.getElementById('inv-num').value.trim();
    const date = document.getElementById('inv-date').value;

    if (!num) return toast("‚ö†Ô∏è Falta el n√∫mero de factura", "error");
    if (!date) return toast("‚ö†Ô∏è Falta la fecha", "error");

    // 1. Marcar albaranes como facturados
    tempInvoiceData.ids.forEach(id => {
        const a = db.albaranes.find(x => x.id === id);
        if (a) a.invoiced = true; 
    });

    // 2. Crear la factura en la base de datos
    db.facturas.push({
        id: generateID(),
        num: num,         // El n√∫mero real que acabamos de escribir
        date: date,       // La fecha real
        prov: tempInvoiceData.prov,
        total: tempInvoiceData.total,
        paid: false       // Nace como pendiente de pago
    });

    save(`Factura ${num} Generada ‚úÖ`);
    tempInvoiceData = null; // Limpiar memoria
    closeModal();
    renderAdmin(document.getElementById('app')); // Recargar pantalla
}

// Cambiar estado Pagado/Pendiente
function togglePaid(id) { 
    const f = db.facturas.find(x => x.id === id); 
    if (f) { 
        f.paid = !f.paid; 
        save(); 
        renderAdmin(document.getElementById('app')); 
    } 
}

// Descargar Excel/CSV del mes
function downloadMonthCSV(monthIndex, monthName) {
    // 1. Filtramos facturas solo de este mes y a√±o fiscal
    const list = db.facturas.filter(f => {
        if (!isInPeriod(f.date)) return false; // Primero filtro trimestre/a√±o general
        const m = parseInt(f.date.split('-')[1]);
        return m === monthIndex;
    });

    if (!list.length) return toast("No hay datos para exportar", "error");

    // 2. Cabeceras del CSV
    const headers = ['Fecha;Factura_Num;Proveedor;Estado;Total_EUR'];
    
    // 3. Filas de datos
    const rows = list.map(f => {
        return `${f.date};"${f.num}";"${clean(f.prov)}";${f.paid ? 'PAGADO' : 'PENDIENTE'};${Num.csv(f.total)}`;
    });

    // 4. Crear archivo y descargar
    const csvContent = headers.concat(rows).join('\n');
    const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `Facturas_${monthName}_${fiscalYear}.csv`;
    a.click();
}
        /* =============================================================
   ‚ö†Ô∏è 11. INGENIER√çA DE MEN√ö (MATRIZ OMNES) ‚ö†Ô∏è
   ============================================================= */

function renderOmnes(c) {
    if (!db.recetas || db.recetas.length === 0) { 
        c.innerHTML = `<div class="glass-card text-center"><h3 class="font-bold text-slate-800">No hay datos</h3><p class="text-xs text-slate-400 mb-4">Crea recetas y registra ventas primero.</p><button class="btn-premium" onclick="render('Cocina')">IR A COCINA</button></div>`; 
        return; 
    }

    // 1. C√°lculos de Ingenier√≠a (Matem√°ticas financieras)
    let totalSold = 0, totalRev = 0, totalCost = 0;
    const salesMap = {};
    
    // Sumar ventas del periodo seleccionado
    db.sales_history.filter(log => isInPeriod(log.date)).forEach(log => {
        log.items.forEach(it => {
            const rid = it.rid || db.recetas.find(r => r.n === it.n)?.id;
            if (rid) salesMap[rid] = (salesMap[rid] || 0) + it.q;
        });
    });

    const data = db.recetas.map(r => {
        const cost = calcRecipe(r).t; // Calculamos coste actual de la receta
        const sales = salesMap[r.id] || 0; 
        totalSold += sales;
        totalRev += sales * r.pvp;
        totalCost += sales * cost;
        return { r, sales, cost, margin: r.pvp - cost, pvp: r.pvp };
    });

    if (totalSold === 0) {
        c.innerHTML = `<div class="glass-card text-center p-8 border-2 border-dashed"><h3 class="text-slate-400">Sin ventas este trimestre</h3><button class="btn-premium mt-4" onclick="editSales()">üìù REGISTRAR SERVICIO</button></div>`;
        return;
    }

    // Puntos de corte para la matriz
    const avgMargin = (totalRev - totalCost) / totalSold;
    const popLimit = (100 / data.length) * 0.7; // Regla Omnes (70% de la popularidad media)

    // 2. Renderizado Visual de la Matriz
    let html = data.sort((a,b) => b.sales - a.sales).map(d => {
        if (d.sales === 0) return '';
        const mix = (d.sales / totalSold) * 100;
        
        // Clasificaci√≥n: Popularidad (Mix) vs Rentabilidad (Margen)
        const isPop = mix >= popLimit;
        const isRich = d.margin >= avgMargin;
        
        let type = isPop ? (isRich ? 'üåü ESTRELLA' : 'üêé CABALLO') : (isRich ? 'üß© PUZZLE' : 'üêï PERRO');
        // Colores visuales para identificar r√°pido
        let color = isPop ? (isRich ? 'border-l-4 border-yellow-400' : 'border-l-4 border-blue-400') : (isRich ? 'border-l-4 border-green-400' : 'border-l-4 border-red-400');

        return `
        <div class="bg-white p-3 rounded-xl shadow-sm mb-2 flex justify-between items-center ${color}">
            <div class="flex-1">
                <div class="font-bold text-slate-700 text-sm">${clean(d.r.n)}</div>
                <div class="text-[10px] font-bold text-slate-400">${type}</div>
            </div>
            <div class="text-right">
                <div class="font-black text-slate-800">${d.sales} <span class="text-[9px] font-normal text-slate-400">ut</span></div>
                <div class="text-[10px] text-slate-500">Mg: ${Num.fmt(d.margin)}‚Ç¨</div>
            </div>
        </div>`;
    }).join('');

    c.innerHTML = `
    <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-slate-800">MATRIZ OMNES</h3>
        <button class="btn-premium btn-action w-auto px-4 py-2 text-xs" onclick="editSales()">üìù REGISTRAR SERVICIO</button>
    </div>
    <div class="grid grid-cols-2 gap-2 mb-4 text-center">
        <div class="bg-slate-50 p-2 rounded-lg"><div class="text-[10px] text-slate-400">Margen Medio</div><div class="font-bold">${Num.fmt(avgMargin)}‚Ç¨</div></div>
        <div class="bg-slate-50 p-2 rounded-lg"><div class="text-[10px] text-slate-400">Ticket Medio</div><div class="font-bold">${Num.fmt(totalRev/totalSold)}‚Ç¨</div></div>
    </div>
    ${html}`;
}

function editSales() {
    // Modal r√°pido para introducir ventas del d√≠a
    if (!db.recetas.length) return toast("No hay recetas", "error");
    const list = db.recetas.map(r => `
        <div class="flex justify-between items-center py-2 border-b">
            <span class="text-sm font-medium w-1/2">${clean(r.n)}</span>
            <input type="number" min="0" placeholder="0" id="sale-${r.id}" class="bg-slate-50 border rounded-lg w-20 text-center py-2 font-bold focus:bg-white outline-none">
        </div>`).join('');
        
    showModal('Registro de Ventas', `
        <div class="bg-blue-50 p-3 rounded-lg text-blue-800 text-xs mb-4">
            Introduce las ventas de hoy para descontar stock y calcular Omnes.
        </div>
        <div class="max-h-[50vh] overflow-y-auto pr-1 mb-4">${list}</div>
        <button class="btn-premium btn-action" onclick="commitSales()">PROCESAR Y GUARDAR</button>
    `);
}

function commitSales() {
    let log = { id: generateID(), date: getTS(), items: [] };
    let hasData = false;
    
    db.recetas.forEach(r => {
        const el = document.getElementById(`sale-${r.id}`);
        const qty = Num.parse(el.value);
        
        if (qty > 0) {
            hasData = true;
            // 1. Registrar venta para estad√≠sticas
            log.items.push({ rid: r.id, n: r.n, q: qty });
            
            // 2. Descontar Stock (Escandallo inverso)
            r.items.forEach(it => {
                if (it.type === 'ing') {
                    const ing = db.ingredientes.find(x => x.id === it.id);
                    if (ing) {
                        // Conversi√≥n de unidad receta -> unidad almac√©n
                        const factor = UnitConverter.convert(1, it.unit||ing.unit, ing.unit);
                        const totalNeeded = (it.q * factor * qty) / (it.merma ? (1-(it.merma/100)) : 1);
                        
                        ing.stock -= totalNeeded;
                        // Registramos movimiento en Kardex (definido en siguiente secci√≥n)
                        logStock(ing.id, totalNeeded, 'OUT', `Venta: ${r.n}`, ing.cost);
                    }
                }
            });
        }
    });

    if (hasData) {
        db.sales_history.push(log);
        save("Ventas procesadas y Stock actualizado");
        closeModal();
        renderAdmin(document.getElementById('app'));
    } else {
        toast("No has introducido cantidades", "error");
    }
}

/* =============================================================
   ‚ö†Ô∏è 12. M√ìDULO COCINA PRO (RECETAS Y ESCANDALLOS) ‚ö†Ô∏è
   ============================================================= */

function renderCocina(app) {
    const list = db.recetas.sort((a,b)=>a.n.localeCompare(b.n));
    app.innerHTML = `<div class="glass-card"><div class="flex justify-between items-center mb-4"><h2 class="font-black text-xl text-slate-800">ESCANDALLOS</h2><button class="btn-premium w-auto px-4 py-3 text-xs" onclick="editRec()">Ôºã NUEVA</button></div><input placeholder="üîç Buscar..." onkeyup="filterRec(this.value)" class="input-premium mb-4"><div id="rec-grid" class="space-y-3">${renderRecGrid(list)}</div></div>`;
}

function renderRecGrid(list) {
    if(!list.length) return '<div class="text-center p-8 text-slate-400 border-2 border-dashed rounded-xl">Sin recetas.</div>';
    return list.map(r => {
        const c = calcRecipe(r); 
        const fc = r.pvp > 0 ? (c.t/r.pvp)*100 : 0; // C√°lculo Food Cost %
        return `<div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm cursor-pointer flex justify-between items-center" onclick="viewRec('${r.id}')"><div><div class="font-bold text-slate-800">${clean(r.n)}</div><div class="text-xs text-slate-400">${r.items.length} Ingredientes ¬∑ ${r.time} min</div></div><div class="text-right"><div class="font-black text-slate-700">${Num.fmt(c.t)}‚Ç¨</div><div class="text-[10px] font-bold ${fc>35?'text-red-500':'text-emerald-500'}">FC: ${fc.toFixed(1)}%</div></div></div>`;
    }).join('');
}

function filterRec(txt) { document.getElementById('rec-grid').innerHTML = renderRecGrid(db.recetas.filter(r=>r.n.toLowerCase().includes(txt.toLowerCase()))); }
        
// La funci√≥n Recursiva Maestra (Calcula costes anidados con Rendimiento)
function calcRecipe(r, visited = new Set()) {
    if (!r) return { t: 0 };
    
    // Protecci√≥n contra bucles infinitos
    if (visited.has(r.id)) {
        console.warn("Bucle detectado en receta:", r.n);
        return { t: 0 }; 
    }
    visited.add(r.id);

    let totalCost = 0;

    (r.items || []).forEach(it => {
        const yieldFactor = it.merma ? (1 - (it.merma / 100)) : 1;
        
        if (it.type === 'ing') {
            // Es un ingrediente normal
            const i = db.ingredientes.find(x => x.id === it.id);
            if (i) {
                // Convertimos la unidad usada a la unidad del almac√©n
                const qtyInBaseUnit = UnitConverter.convert(it.q, it.unit || i.unit, i.unit);
                totalCost += (qtyInBaseUnit * i.cost) / yieldFactor;
            }

        } else if (it.type === 'rec') {
            // ¬°ES UNA SUB-RECETA!
            const sub = db.recetas.find(x => x.id === it.id);
            if (sub) {
                // 1. Coste del lote entero
                const subFullCost = calcRecipe(sub, new Set(visited)).t;
                
                // 2. Coste unitario (Coste Lote / Rendimiento)
                const subYield = sub.yield || 1; 
                const costPerUnit = subFullCost / subYield;

                // 3. Conversi√≥n de unidades inteligente
                const qtyNormalized = UnitConverter.convert(it.q, it.unit, sub.unit || 'rac');

                totalCost += qtyNormalized * costPerUnit;
            }
        }
    });

    // A√±adimos mano de obra directa de ESTA receta
    const laborCost = (r.time / 60) * CONFIG.COST_HOUR;
    
    return { t: totalCost + laborCost };
}
function editRec(id) {
    const r = id ? db.recetas.find(x => x.id === id) : { id: generateID(), n: '', pvp: 0, time: 10, items: [], inst: '', yield: 1, unit: 'rac' }; // Por defecto 1 raci√≥n
    
    // Clonamos items para no tocar la memoria directamente
    tempItems = JSON.parse(JSON.stringify(r.items || []));

    // HTML del Modal
    showModal('Ficha T√©cnica & Escandallo', `
        <div class="grid grid-cols-12 gap-3 mb-2">
            <div class="col-span-8">
                <label>Nombre Receta / Semielaborado</label>
                <input id="er-n" value="${clean(r.n)}" class="input-premium font-bold" placeholder="Ej: Salsa Bolo√±esa">
            </div>
            <div class="col-span-4">
                <label>PVP Venta (‚Ç¨)</label>
                <input id="er-pvp" type="number" value="${r.pvp}" class="input-premium text-center">
            </div>
        </div>

        <div class="bg-emerald-50 p-3 rounded-xl border border-emerald-100 mb-4 flex items-center gap-3">
            <div class="bg-emerald-100 p-2 rounded-full text-xl">‚öñÔ∏è</div>
            <div class="flex-1">
                <label class="text-emerald-800 font-bold">Rendimiento (¬øCu√°nto produce?)</label>
                <div class="flex gap-2">
                    <input id="er-yield" type="number" value="${r.yield || 1}" class="input-premium text-center font-bold text-emerald-900">
                    <select id="er-unit" class="input-premium bg-white w-24">
                        <option ${r.unit==='rac'?'selected':''}>rac</option>
                        <option ${r.unit==='l'?'selected':''}>l</option>
                        <option ${r.unit==='kg'?'selected':''}>kg</option>
                        <option ${r.unit==='ud'?'selected':''}>ud</option>
                    </select>
                </div>
            </div>
            <div class="w-1/3">
                 <label>Tiempo (min)</label>
                 <input id="er-time" type="number" value="${r.time}" class="input-premium text-center">
            </div>
        </div>

        <div class="bg-slate-50 p-3 rounded-xl border mb-4">
            <label class="mb-2">A√±adir Ingrediente o Sub-Receta</label>
            <div class="flex gap-2 mb-2">
                <select id="er-sel" class="input-premium text-sm flex-1" onchange="updUnit()"></select>
                <input id="er-q" type="number" class="input-premium w-20 text-center" placeholder="Cant">
                <select id="er-u" class="input-premium w-20 text-xs bg-slate-200"></select>
                <button class="bg-indigo-600 text-white rounded-lg w-10 font-bold shadow-lg hover:bg-indigo-700 transition" onclick="addItem()">+</button>
            </div>
            <div class="flex justify-between px-2 text-[10px] font-bold text-slate-400 uppercase mb-1">
                <span>Producto</span><span>Cantidad</span>
            </div>
            <div id="er-list" class="max-h-40 overflow-y-auto custom-scrollbar bg-white rounded-lg border border-slate-200"></div>
        </div>

        <label>Instrucciones</label>
        <textarea id="er-inst" class="input-premium mb-4 font-normal text-sm" rows="3" placeholder="Paso a paso...">${clean(r.inst)}</textarea>
        
        <div class="flex gap-2">
            <button class="btn-premium flex-1" onclick="saveRec('${r.id}')">GUARDAR FICHA</button>
            ${id ? `<button class="btn-ghost w-auto text-red-500" onclick="delRec('${id}')">üóëÔ∏è</button>` : ''}
        </div>
    `);

    renderRecTypes();
    renderRecItems();
}
function renderRecTypes() {
    const sel = document.getElementById('er-sel');
    
    // 1. Preparamos la lista de Ingredientes (Materia Prima)
    const ings = db.ingredientes
        .sort((a,b)=>a.n.localeCompare(b.n))
        .map(i=>`<option value="${i.id}" data-t="ing">üì¶ ${clean(i.n)}</option>`)
        .join('');
    
    // 2. Preparamos la lista de Recetas (Sub-Recetas)
    const recs = db.recetas
        .sort((a,b)=>a.n.localeCompare(b.n))
        .map(r=>`<option value="${r.id}" data-t="rec">üç≤ SUB: ${clean(r.n)}</option>`)
        .join('');
    
    // 3. Lo mostramos agrupado y bonito
    sel.innerHTML = `<optgroup label="--- SEMIELABORADOS ---">${recs}</optgroup><optgroup label="--- MATERIA PRIMA ---">${ings}</optgroup>`;
    
    updUnit();
}
// Selector inteligente de unidades (LIBERADO)
function updUnit() {
    const sel = document.getElementById('er-sel'); 
    const uSel = document.getElementById('er-u');
    const type = sel.options[sel.selectedIndex]?.dataset.t;
    
    let opts = [];
    
    if(type === 'rec') {
        // Si es una sub-receta, usamos raciones
        opts = ['rac']; 
    } else {
        // Si es ingrediente, DAMOS LIBERTAD TOTAL
        // Ordenadas por uso com√∫n
        opts = ['kg', 'g', 'l', 'ml', 'cl', 'ud', 'oz', 'lb', 'mg'];
    }
    
    uSel.innerHTML = opts.map(u => `<option>${u}</option>`).join('');
}
function addItem() {
    const sel = document.getElementById('er-sel'); const type = sel.options[sel.selectedIndex].dataset.t;
    const q = parseFloat(document.getElementById('er-q').value);
    if(q>0) { tempItems.push({type, id:sel.value, q, unit:document.getElementById('er-u').value, merma:0}); renderRecItems(); }
}

function renderRecItems() {
    document.getElementById('er-list').innerHTML = tempItems.map((it,i) => {
        let n="?", icon="üì¶"; 
        if(it.type==='ing'){ const x=db.ingredientes.find(z=>z.id===it.id); if(x)n=x.n; } 
        else { const x=db.recetas.find(z=>z.id===it.id); if(x){n=x.n; icon="ü•£";} }
        return `<div class="flex justify-between py-2 border-b text-sm items-center"><div><span class="mr-2">${icon}</span><b>${n}</b></div><span>${it.q} ${it.unit}</span><button class="text-red-400 ml-2" onclick="tempItems.splice(${i},1);renderRecItems()">‚úï</button></div>`;
    }).join('');
}
function saveRec(id) {
    const n = document.getElementById('er-n').value; 
    if(!n) return toast("Falta nombre", "error");

    const r = { 
        id, 
        n, 
        pvp: parseFloat(document.getElementById('er-pvp').value) || 0, 
        time: parseFloat(document.getElementById('er-time').value) || 0,
        // NUEVO: Guardamos cu√°nto produce esta receta
        yield: parseFloat(document.getElementById('er-yield').value) || 1,
        unit: document.getElementById('er-unit').value,
        items: tempItems, 
        inst: document.getElementById('er-inst').value 
    };

    const idx = db.recetas.findIndex(x => x.id === id);
    if(idx >= 0) db.recetas[idx] = r; else db.recetas.push(r);
    
    save("Ficha T√©cnica Guardada"); 
    closeModal(); 
    render('Cocina');
}
function delRec(id) { if(confirm("¬øBorrar?")) { db.recetas=db.recetas.filter(x=>x.id!==id); save("Borrada"); closeModal(); render('Cocina'); } }

function viewRec(id) {
    const r = db.recetas.find(x=>x.id===id); if(!r)return;
    // Calculadora din√°mica en el modal
    window.renderIngsForCalc = (f) => r.items.map(it => {
        let n="?", q=it.q*f;
        if(it.type==='ing'){ const i=db.ingredientes.find(x=>x.id===it.id); if(i)n=i.n; } else { const s=db.recetas.find(x=>x.id===it.id); if(s)n="ü•£ "+s.n; }
        return `<li class="flex justify-between py-1 border-b border-slate-50"><span>${n}</span><span class="font-bold text-indigo-600">${Num.fmt(q)} ${it.unit}</span></li>`;
    }).join('');
    
    const c = calcRecipe(r);
    showModal(clean(r.n), `<div class="flex justify-between text-center mb-4 bg-slate-50 p-3 rounded-xl border"><div class="flex-1 border-r"><h6>COSTE</h6><b>${Num.fmt(c.t)}‚Ç¨</b></div><div class="flex-1"><h6>PVP</h6><b>${Num.fmt(r.pvp)}‚Ç¨</b></div></div><div class="bg-indigo-50 p-3 rounded-xl mb-4 flex items-center justify-between"><span>Multiplicador</span><input type="number" value="1" class="w-16 text-center font-bold text-xl bg-white rounded border border-indigo-200" oninput="document.getElementById('v-list').innerHTML=window.renderIngsForCalc(this.value)"></div><ul id="v-list" class="text-sm mb-4">${window.renderIngsForCalc(1)}</ul><p class="text-sm text-slate-600 bg-yellow-50 p-3 rounded-xl mb-4">${clean(r.inst)}</p><div class="flex gap-2"><button class="btn-ghost flex-1" onclick="window.print()">üñ®Ô∏è IMPRIMIR</button><button class="btn-premium flex-1" onclick="editRec('${id}')">EDITAR</button></div>`);
}
/* =============================================================
   ‚ö†Ô∏è 13. M√ìDULO DE STOCK Y PEDIDOS (COMPLETO Y CORREGIDO) ‚ö†Ô∏è
   ============================================================= */
function renderStock(app) {
    // Filtrado y Ordenaci√≥n
    const list = db.ingredientes
        .filter(i => i.n.toLowerCase().includes(searchFilter.toLowerCase()))
        .sort((a,b) => a.n.localeCompare(b.n));
    
    // Filtro por Familia
    let filteredList = list;
    if(activeFamily !== 'Todos') {
        filteredList = list.filter(i => (i.fam || 'General') === activeFamily);
    }

    // --- NUEVO: C√ÅLCULO DE VALOR DEL INVENTARIO ---
    // Sumamos (Stock * Coste) de cada ingrediente para saber el dinero inmovilizado
    const totalStockValue = filteredList.reduce((acc, i) => acc + (i.stock * i.cost), 0);
    // ----------------------------------------------

    // Chips de Categor√≠as
    const cats = ['Todos', ...FAMILIES].map(c => 
        `<button class="px-3 py-1 rounded-full text-[10px] border whitespace-nowrap ${activeFamily===c ? 'bg-slate-800 text-white' : 'bg-white'}" onclick="activeFamily='${c}';render('Stock')">${c}</button>`
    ).join('');

    app.innerHTML = `
        <div class="glass-card ${inventoryMode ? 'border-l-4 border-orange-500' : ''}">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold flex items-center gap-2">${inventoryMode ? 'üìã MODO AUDITOR√çA' : 'üì¶ ALMAC√âN'}</h3>
                
                <div class="bg-slate-100 px-3 py-1 rounded-lg border border-slate-200">
                    <span class="text-[9px] text-slate-400 uppercase font-bold">Valor</span>
                    <span class="font-bold text-slate-700 ml-1">${Num.fmt(totalStockValue)}‚Ç¨</span>
                </div>
            </div>
            
            <div class="flex justify-end gap-2 mb-3">
                 ${!inventoryMode ? `<button class="btn-whatsapp text-xs px-3" onclick="sendWhatsApp()">üìû PEDIDO</button>` : ''}
                 <button class="btn-ghost text-xs px-3" onclick="toggleInventoryMode()">${inventoryMode ? 'SALIR' : 'AUDITAR'}</button>
            </div>
            
            <input class="input-premium mb-3" placeholder="üîç Buscar producto..." onkeyup="searchFilter=this.value;render('Stock')" value="${searchFilter}">
            
            <div class="flex gap-2 overflow-x-auto pb-2 mb-2 no-scrollbar">${cats}</div>

            <div class="max-h-[60vh] overflow-y-auto space-y-2 pr-1">
                ${filteredList.map(i => {
                    const low = i.stock < (i.min || 0);
                    
                    // VISTA AUDITOR√çA
                    if(inventoryMode) return `
                        <div class="bg-white p-3 rounded-xl border shadow-sm flex justify-between items-center animate-fade-in">
                            <div class="flex-1">
                                <div class="font-bold text-sm">${clean(i.n)}</div>
                                <div class="text-[10px] text-slate-400">Te√≥rico: ${i.stock} ${i.unit}</div>
                            </div>
                            <div class="flex gap-2 items-center">
                                <input id="rs-${i.id}" type="number" placeholder="${i.stock}" class="w-20 text-center bg-orange-50 border border-orange-200 p-2 rounded-lg font-bold text-lg outline-none focus:ring-2 focus:ring-orange-500">
                                <button class="bg-emerald-500 text-white rounded-lg w-10 h-10 flex items-center justify-center font-bold shadow-lg active:scale-95 transition" onclick="adjStock('${i.id}')">‚úî</button>
                            </div>
                        </div>`;
                    
                    // VISTA NORMAL
                    return `
                        <div class="bg-white p-3 rounded-xl border ${low ? 'border-red-300 bg-red-50/20' : 'border-slate-100'} shadow-sm flex justify-between items-center group">
                            <div class="flex-1 cursor-pointer" onclick="editIng('${i.id}')">
                                <div class="font-bold text-slate-800 text-sm">${clean(i.n)}</div>
                                <div class="text-xs text-slate-500 flex gap-2">
                                    <span class="bg-slate-100 px-2 rounded text-[10px] font-bold border">${parseFloat(i.stock).toFixed(2)} ${i.unit}</span>
                                    <span class="text-[10px] text-slate-400">${Num.fmt(i.cost)}‚Ç¨/ud</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button class="btn-icon btn-merma" onclick="regMerma('${i.id}')">üìâ</button>
                                <button class="btn-icon btn-edit" onclick="editIng('${i.id}')">‚úèÔ∏è</button>
                            </div>
                        </div>`;
                }).join('')}
                ${filteredList.length === 0 ? '<div class="text-center p-8 text-slate-400">No hay productos.</div>' : ''}
            </div>
            ${!inventoryMode ? `<button class="btn-premium mt-4" onclick="editIng(generateID())">Ôºã NUEVO PRODUCTO</button>` : ''}
        </div>`;
}
function toggleInventoryMode() { 
    inventoryMode = !inventoryMode; 
    render('Stock'); 
    if(inventoryMode) toast("Modo Auditor√≠a: Introduce el stock REAL"); 
}

// Ajuste de Stock (Kardex Autom√°tico)
function adjStock(id) {
    const v = parseFloat(document.getElementById(`rs-${id}`).value);
    const i = db.ingredientes.find(x => x.id === id);
    if (!isNaN(v) && i) {
        const diff = v - i.stock;
        if (diff !== 0) {
            logStock(i.id, Math.abs(diff), 'ADJ', 'Auditor√≠a', i.cost);
            i.stock = v; 
            save("Stock Actualizado"); 
            render('Stock');
        } else {
            toast("Stock coincide ‚úÖ", "success");
        }
    }
}

// Generador de Pedidos WhatsApp
function sendWhatsApp() {
    let list = db.ingredientes.filter(i => i.stock < (i.min || 0));
    if (activeFamily !== 'Todos') list = list.filter(i => (i.fam || 'General') === activeFamily);

    if (!list.length) return toast("Stock Correcto ‚úÖ");
    
    let phone = "";
    if (activeFamily !== 'Todos') {
        const prov = db.proveedores.find(p => p.fam === activeFamily);
        if (prov) phone = prov.tel;
    }

    const txt = `üõí *PEDIDO ${activeFamily.toUpperCase()} - ${getTS()}*\n\n` + 
                list.map(i => `- ${Math.ceil(((i.min || 0) - i.stock) * 1.2)} ${i.unit} ${i.n}`).join('\n');
    
    const url = phone ? `https://wa.me/${phone}?text=${encodeURIComponent(txt)}` : `https://wa.me/?text=${encodeURIComponent(txt)}`;
    window.open(url, '_blank');
}

// Historial de Movimientos
function logStock(id, q, t, r, p = 0) { 
    db.kardex.push({ id: generateID(), date: getTS(), ingId: id, type: t, qty: q, reason: r, price: p }); 
}

// Gesti√≥n de Mermas
function regMerma(id) {
    const i = db.ingredientes.find(x => x.id === id);
    showModal('Registrar Merma', `
        <p class="mb-4 text-sm text-slate-500">Producto: <b class="text-slate-800">${clean(i.n)}</b></p>
        <label>Cantidad Perdida (${i.unit})</label>
        <input type="number" id="m-q" class="input-premium mb-4 text-center font-bold text-lg">
        <label>Motivo</label>
        <select id="m-r" class="input-premium mb-4">
            <option>Caducidad</option><option>Rotura</option><option>Error Cocina</option><option>Consumo Personal</option>
        </select>
        <button class="btn-premium bg-red-500 shadow-red-200" onclick="saveMerma('${id}')">CONFIRMAR P√âRDIDA</button>
    `);
}

function saveMerma(id) {
    const q = parseFloat(document.getElementById('m-q').value);
    const r = document.getElementById('m-r').value;
    if (q > 0) { 
        const i = db.ingredientes.find(x => x.id === id); 
        i.stock -= q; 
        db.mermas.push({ date: getISO(), n: i.n, q, reason: r, loss: q * i.cost }); 
        logStock(id, q, 'OUT', `Merma: ${r}`, i.cost); 
        save("Merma registrada"); closeModal(); render('Stock'); 
    }
}

// --- EDICI√ìN DE PRODUCTOS (CON AL√âRGENOS) ---

function editIng(id) {
    const i = db.ingredientes.find(x => x.id === id) || { id, n: '', cost: 0, stock: 0, min: 0, unit: 'kg', fam: 'General', alg: [] };
    const fams = FAMILIES.map(f => `<option ${i.fam === f ? 'selected' : ''}>${f}</option>`).join('');
    
    // IMPORTANTE: Aseguramos que sea un array
    tempAlgs = Array.isArray(i.alg) ? i.alg : [];

    const algHTML = ALLERGENS.map(a => {
        const active = tempAlgs.includes(a.k);
        return `<button id="btn-alg-${a.k}" onclick="toggleAlg('${a.k}')" class="w-8 h-8 rounded-full border flex items-center justify-center text-sm transition ${active ? 'bg-red-100 border-red-400 scale-110 shadow-sm' : 'bg-slate-50 border-slate-200 opacity-60 grayscale'}">${a.i}</button>`;
    }).join('');
    
    showModal('Ficha Producto', `
        <label>Nombre</label><input id="ei-n" value="${clean(i.n)}" class="input-premium mb-2">
        <label>Familia</label><select id="ei-f" class="input-premium mb-2">${fams}</select>
        
        <label class="mt-2 mb-1">Al√©rgenos</label>
        <div class="flex flex-wrap gap-2 mb-4 bg-white p-2 rounded-xl border border-slate-100 justify-center">
            ${algHTML}
        </div>

        <div class="grid grid-cols-3 gap-2">
            <div><label>Coste</label><input id="ei-c" type="number" value="${i.cost}" class="input-premium"></div>
            <div><label>Stock</label><input id="ei-s" type="number" value="${i.stock}" class="input-premium"></div>
            <div><label>M√≠n</label><input id="ei-m" type="number" value="${i.min}" class="input-premium"></div>
        </div>
        
        <label>Unidad</label>
        <select id="ei-u" class="input-premium mb-4">
            <option ${i.unit==='kg'?'selected':''}>kg</option>
            <option ${i.unit==='g'?'selected':''}>g</option>
            <option ${i.unit==='mg'?'selected':''}>mg</option>
            <option ${i.unit==='l'?'selected':''}>l</option>
            <option ${i.unit==='ml'?'selected':''}>ml</option>
            <option ${i.unit==='cl'?'selected':''}>cl</option>
            <option ${i.unit==='oz'?'selected':''}>oz</option>
            <option ${i.unit==='lb'?'selected':''}>lb</option>
            <option ${i.unit==='ud'?'selected':''}>ud</option>
        </select>
        
        <div class="flex gap-2">
            <button class="btn-premium flex-1" onclick="saveIng('${id}')">GUARDAR</button>
            ${db.ingredientes.find(x => x.id === id) ? `<button class="btn-ghost w-auto text-red-500" onclick="delIng('${id}')">üóëÔ∏è</button>` : ''}
        </div>
    `);
}

function toggleAlg(k) {
    const btn = document.getElementById(`btn-alg-${k}`);
    if (tempAlgs.includes(k)) {
        tempAlgs = tempAlgs.filter(x => x !== k);
        btn.className = "w-8 h-8 rounded-full border flex items-center justify-center text-sm transition bg-slate-50 border-slate-200 opacity-60 grayscale";
    } else {
        tempAlgs.push(k);
        btn.className = "w-8 h-8 rounded-full border flex items-center justify-center text-sm transition bg-red-100 border-red-400 scale-110 shadow-sm";
    }
}

function saveIng(id) {
    const n = document.getElementById('ei-n').value; 
    if (!n) return toast("Falta nombre", "error");
    
    const obj = {
        id, n, 
        fam: document.getElementById('ei-f').value, 
        cost: parseFloat(document.getElementById('ei-c').value) || 0, 
        stock: parseFloat(document.getElementById('ei-s').value) || 0, 
        min: parseFloat(document.getElementById('ei-m').value) || 0, 
        unit: document.getElementById('ei-u').value,
        alg: tempAlgs
    };
    
    const idx = db.ingredientes.findIndex(x => x.id === id);
    if (idx >= 0) db.ingredientes[idx] = obj; else db.ingredientes.push(obj);
    
    save("Guardado"); closeModal(); render('Stock');
}

function delIng(id) { 
    if (confirm("¬øEliminar producto?")) { 
        db.ingredientes = db.ingredientes.filter(x => x.id !== id); 
        save("Eliminado"); closeModal(); render('Stock'); 
    } 
}
/* =============================================================
   ‚ö†Ô∏è 14. DIARIO (CIERRE DE CAJA Z) - VERSI√ìN CON DELIVERY ‚ö†Ô∏è
   ============================================================= */
function renderDiario(app) {
    // Buscamos el registro del d√≠a
    let r = db.diario.find(d => d.date === currentDiarioDate) || { 
        cash: 0, visa: 0, tpv: 0, madisa: 0, amex: 0, uber: 0, glovo: 0, app: 0, total: 0, expenses: 0 
    };

    // COMPATIBILIDAD CON DATOS ANTIGUOS:
    // Si es un cierre viejo que ten√≠a "visa" pero no los campos nuevos, lo pasamos a TPV
    if (r.visa && !r.tpv && !r.madisa && !r.amex) { r.tpv = r.visa; }

    const hist = db.diario.filter(d => isInPeriod(d.date))
        .sort((a, b) => b.date.localeCompare(a.date))
        .map(d => `<div class="flex justify-between py-2 border-b last:border-0 hover:bg-slate-50 cursor-pointer p-2 rounded" onclick="currentDiarioDate='${d.date}';render('Diario')"><span class="font-bold text-slate-700">üìÖ ${d.date}</span><b class="font-mono text-indigo-600">${Num.fmt(d.total)}‚Ç¨</b></div>`)
        .join('');

    app.innerHTML = `
    <div class="glass-card">
        <div class="flex justify-between items-center mb-6">
            <h3 class="font-bold text-slate-800">CIERRE CAJA</h3>
            <input type="date" value="${currentDiarioDate}" class="bg-slate-100 border-0 rounded-lg p-2 font-bold text-indigo-600 outline-none" onchange="currentDiarioDate=this.value;render('Diario')">
        </div>
        
        <div class="space-y-3">
            <div class="bg-emerald-50 p-3 rounded-xl border border-emerald-100 shadow-sm">
                <h6 class="text-[10px] font-bold text-emerald-600 uppercase mb-2">üíµ Efectivo</h6>
                <div class="flex gap-2">
                    <div class="flex-1"><label>Venta</label><input type="number" id="z-c" value="${r.cash}" class="input-premium text-center font-bold text-lg" onchange="calcZ()"></div>
                    <div class="flex-1"><label class="text-red-400">Gastos</label><input type="number" id="z-e" value="${r.expenses || 0}" class="input-premium text-center font-bold text-lg text-red-500" onchange="calcZ()"></div>
                </div>
            </div>
            
            <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 shadow-sm">
                <h6 class="text-[10px] font-bold text-blue-600 uppercase mb-2">üí≥ Tarjetas & Pasarelas</h6>
                <div class="grid grid-cols-3 gap-2">
                    <div><label>TPV</label><input type="number" id="z-tpv" value="${r.tpv || 0}" class="input-premium text-center font-bold" onchange="calcZ()"></div>
                    <div><label>Madisa</label><input type="number" id="z-madisa" value="${r.madisa || 0}" class="input-premium text-center font-bold" onchange="calcZ()"></div>
                    <div><label>AMEX</label><input type="number" id="z-amex" value="${r.amex || 0}" class="input-premium text-center font-bold" onchange="calcZ()"></div>
                </div>
            </div>

            <div class="bg-orange-50 p-3 rounded-xl border border-orange-100 shadow-sm">
                <h6 class="text-[10px] font-bold text-orange-600 uppercase mb-2">üõµ Plataformas</h6>
                <div class="grid grid-cols-3 gap-2">
                    <div><label>Uber</label><input type="number" id="z-uber" value="${r.uber || 0}" class="input-premium text-center font-bold" onchange="calcZ()"></div>
                    <div><label>Glovo</label><input type="number" id="z-glovo" value="${r.glovo || 0}" class="input-premium text-center font-bold" onchange="calcZ()"></div>
                    <div><label>App/Otros</label><input type="number" id="z-app" value="${r.app || 0}" class="input-premium text-center font-bold" onchange="calcZ()"></div>
                </div>
            </div>
            
            <div class="flex justify-between pt-4 border-t border-slate-200 mt-2">
                <span class="font-bold text-slate-400 text-xs tracking-widest uppercase">TOTAL D√çA</span>
                <span class="text-3xl font-black text-slate-800" id="z-t">${Num.fmt(r.total)}‚Ç¨</span>
            </div>
        </div>
        <button class="btn-premium mt-6 shadow-xl shadow-indigo-200" onclick="saveZ()">üíæ GUARDAR CIERRE</button>
    </div>
    
    <div class="glass-card">
        <h3 class="font-bold text-xs text-slate-400 mb-4 uppercase">Historial Trimestre</h3>
        <div class="max-h-40 overflow-y-auto custom-scrollbar">${hist}</div>
    </div>`;
}
function calcZ() {
    const c = parseFloat(document.getElementById('z-c').value) || 0;
    
    // Nuevos campos de tarjeta
    const tpv = parseFloat(document.getElementById('z-tpv').value) || 0;
    const madisa = parseFloat(document.getElementById('z-madisa').value) || 0;
    const amex = parseFloat(document.getElementById('z-amex').value) || 0;
    
    const uber = parseFloat(document.getElementById('z-uber').value) || 0;
    const glovo = parseFloat(document.getElementById('z-glovo').value) || 0;
    const app = parseFloat(document.getElementById('z-app').value) || 0;
    
    // Total sumando todo
    document.getElementById('z-t').innerText = Num.fmt(c + tpv + madisa + amex + uber + glovo + app) + '‚Ç¨';
}
function saveZ() {
    const c = parseFloat(document.getElementById('z-c').value) || 0;
    
    // Capturamos los 3 tipos de tarjeta
    const tpv = parseFloat(document.getElementById('z-tpv').value) || 0;
    const madisa = parseFloat(document.getElementById('z-madisa').value) || 0;
    const amex = parseFloat(document.getElementById('z-amex').value) || 0;
    
    const e = parseFloat(document.getElementById('z-e').value) || 0;
    const uber = parseFloat(document.getElementById('z-uber').value) || 0;
    const glovo = parseFloat(document.getElementById('z-glovo').value) || 0;
    const app = parseFloat(document.getElementById('z-app').value) || 0;

    const total = c + tpv + madisa + amex + uber + glovo + app;

    const data = { 
        date: currentDiarioDate, 
        cash: c, 
        tpv: tpv,       // Guardamos TPV separado
        madisa: madisa, // Guardamos Madisa separado
        amex: amex,     // Guardamos AMEX separado
        visa: tpv + madisa + amex, // Mantenemos 'visa' como suma total para compatibilidad
        uber: uber, 
        glovo: glovo, 
        app: app, 
        expenses: e, 
        total: total 
    };
    
    const idx = db.diario.findIndex(d => d.date === currentDiarioDate);
    if (idx >= 0) db.diario[idx] = data; else db.diario.push(data);
    
    save("Cierre Desglosado Guardado ‚úÖ"); 
    render('Diario');
}
/* =============================================================
   ‚ö†Ô∏è 15. SISTEMA Y UTILIDADES FINALES ‚ö†Ô∏è
   ============================================================= */

function downloadBackup() { 
    const d = secure.enc(db); 
    const a = document.createElement('a'); 
    a.href = URL.createObjectURL(new Blob([d], { type: 'text/plain' })); 
    a.download = `Arume_Backup_${getISO()}.arume`; 
    a.click(); 
}

function restoreBackup(input) { 
    const r = new FileReader(); 
    r.onload = e => { 
        try { 
            db = secure.dec(e.target.result); 
            // Forzamos sincronizaci√≥n con la nube para que el backup suba
            save("Restaurado y Subido a Nube"); 
            loadApp(); 
        } catch (err) { toast("Error archivo", "error"); } 
    }; 
    r.readAsText(input.files[0]); 
}

// Controladores de Ventanas Modales
function showModal(t, c) { 
    document.getElementById('m-title').innerText = t; 
    document.getElementById('m-body').innerHTML = c; 
    document.getElementById('modal-overlay').classList.remove('hidden'); 
}

function closeModal() { 
    document.getElementById('modal-overlay').classList.add('hidden'); 
}

/* =============================================================
   üöÄ ARRANQUE DE LA APLICACI√ìN üöÄ
   ============================================================= */
init();
// Funci√≥n para forzar la descarga de la nube (Soluci√≥n para el m√≥vil)
async function forceCloudDownload() {
    if(confirm("‚ö†Ô∏è ¬øEST√ÅS SEGURO?\n\nEsto borrar√° los datos de ESTE dispositivo y bajar√° la √∫ltima copia de la nube.\n\n√ösalo solo si no ves los datos actualizados.")) {
        loading(true);
        try {
            const { data, error } = await sb.from('arume_data').select('data').eq('id', 1).single();
            if (error) throw error;
            
            if (data && data.data) {
                db = data.data;
                localStorage.setItem('arume_v152', secure.enc(db));
                toast("‚úÖ Datos sincronizados", "success");
                setTimeout(() => location.reload(), 500); 
            } else {
                toast("‚ùå No hay datos en la nube", "error");
            }
        } catch (e) {
            console.error(e);
            toast("Error de conexi√≥n", "error");
        } finally {
            loading(false);
        }
    }
}
</script>
</body>
</html>
