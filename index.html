<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>ARUME V141 ¬∑ Diamond Audit</title>
    <meta name="description" content="Sistema de Gesti√≥n Integral para Hosteler√≠a">
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* EST√âTICA V141 DIAMOND */
        body { font-family: 'Poppins', sans-serif; background: #f8fafc; padding-bottom: 110px; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        .glass-card { 
            background: white; 
            border: 1px solid #e2e8f0; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); 
            border-radius: 20px; 
            padding: 20px; 
            margin-bottom: 20px; 
        }
        
        /* BOTONES OPTIMIZADOS */
        .btn-premium { 
            background: linear-gradient(135deg, #0f172a 0%, #334155 100%); 
            color: white; padding: 14px; border-radius: 12px; 
            font-weight: 700; box-shadow: 0 4px 15px rgba(15, 23, 42, 0.2); 
            width: 100%; display: flex; justify-content: center; align-items: center; gap: 8px; cursor: pointer;
            transition: transform 0.1s;
            border: none;
        }
        .btn-premium:active { transform: scale(0.97); }

        .btn-action { background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%); } 
        .btn-whatsapp { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); }
        .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        
        .btn-ghost { background: #f1f5f9; color: #475569; font-weight: 600; padding: 12px; border-radius: 12px; width: 100%; cursor: pointer; border: 1px solid #cbd5e1; }
        
        .btn-icon { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 1rem; cursor: pointer; border: none; }
        .btn-edit { background: #eff6ff; color: #3b82f6; } 
        .btn-delete { background: #fef2f2; color: #ef4444; } 
        .btn-merma { background: #fff7ed; color: #f97316; } 
        .btn-log { background: #f0fdf4; color: #16a34a; }

        .input-premium { 
            width: 100%; padding: 12px; background: #f8fafc; 
            border: 2px solid #e2e8f0; border-radius: 10px; 
            outline: none; font-size: 14px; font-weight: 500;
        }
        .input-premium:focus { border-color: #4f46e5; background: white; }

        /* NAV BAR */
        nav { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: white; padding: 10px 0; 
            display: flex; justify-content: space-around; 
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05); 
            z-index: 50; border-top: 1px solid #e2e8f0;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
        }
        nav button { flex: 1; background: none; border: none; color: #94a3b8; display: flex; flex-direction: column; align-items: center; font-size: 0.65rem; font-weight: 600; transition: 0.2s; cursor: pointer; }
        nav button.active { color: #0f172a; transform: translateY(-2px); }
        nav button.active svg { fill: #0f172a; }
        nav button svg { width: 24px; height: 24px; fill: #94a3b8; margin-bottom: 4px; }
        nav button.locked { opacity: 0.4; filter: grayscale(1); pointer-events: none; }

        /* UTILS */
        function triggerRestore() {
    // Busca el input oculto y simula un clic
    document.getElementById('backup-input').click();
}
        #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid #4f46e5; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(2px); z-index: 100; display: flex; align-items: center; justify-content: center; }
        .modal { background: white; width: 95%; max-width: 800px; max-height: 90vh; overflow-y: auto; border-radius: 24px; padding: 24px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        .hidden { display: none !important; }
        
        .aller-tag { display: inline-block; width: 20px; height: 20px; text-align: center; line-height: 20px; background: #e0e7ff; border-radius: 50%; font-size: 0.7rem; margin-right: 2px; }
        .tax-pill { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #f1f5f9; color: #64748b; font-weight: 700; border: 1px solid #e2e8f0; }
        .omnes-card { border-left: 4px solid; }
        .omnes-star { border-color: #10b981; background: #ecfdf5; }
        .omnes-plow { border-color: #f59e0b; background: #fffbeb; }
        .omnes-puzz { border-color: #3b82f6; background: #eff6ff; }
        .omnes-dog  { border-color: #ef4444; background: #fef2f2; }
        .period-btn { font-size: 10px; padding: 6px 10px; border-radius: 20px; font-weight: bold; background: #f1f5f9; color: #64748b; transition:0.2s; }
        .period-btn.active { background: #0f172a; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
            /* === MODO IMPRESI√ìN (COCINA) === */
        @media print {
            /* Ocultar todo lo que no sea contenido vital */
            body { padding: 0; background: white; }
            nav, header, .btn-premium, .btn-ghost, .btn-icon, .input-premium, button, input, select { display: none !important; }
            
            /* Mostrar solo el Modal si est√° abierto, o la App si no */
            #modal-overlay { 
                position: static; background: white; padding: 0; display: block !important; 
            }
            .modal { 
                box-shadow: none; border: none; width: 100%; max-width: 100%; padding: 0; 
                overflow: visible; 
            }
            
            /* Si no hay modal, ocultar app base para no imprimir basura */
            #modal-overlay.hidden + #app { display: none; }

            /* Estilos espec√≠ficos para papel */
            body { font-size: 12pt; color: black; }
            h1, h2, h3 { color: black !important; }
            .text-slate-400 { color: #666 !important; }
            .bg-slate-50, .bg-indigo-50 { background: none !important; border: 1px solid #ddd; }
            
            /* Asegurar que las instrucciones se lean bien */
            p, li { page-break-inside: avoid; }
        }
    </style>
</head>
<body>

    <div id="loading-overlay" class="hidden">
        <div class="spinner mb-4"></div>
        <div class="font-bold text-gray-500 tracking-widest text-xs animate-pulse">PROCESANDO...</div>
    </div>

    <div id="toast-container" class="fixed top-5 left-1/2 -translate-x-1/2 z-[300] pointer-events-none w-max"></div>
    <input type="file" id="backup-input" class="hidden" onchange="restoreBackup(this)">

    <header class="sticky top-0 z-40 px-6 py-4 flex justify-between items-center bg-white/90 backdrop-blur border-b border-gray-100">
        <div>
            <h1 class="text-2xl font-black text-slate-900 tracking-tight">ARUME <span class="text-indigo-600">V141</span></h1>
            <p class="text-[10px] text-gray-400 font-bold tracking-widest uppercase">Diamond Audit</p>
        </div>
        <div class="bg-slate-100 px-3 py-1 rounded-full text-xs font-bold text-slate-600 flex items-center gap-2 cursor-pointer hover:bg-slate-200 transition" onclick="logout()">
            <div id="sync-dot" class="w-2 h-2 rounded-full bg-gray-400"></div> <span id="user-name">Login</span>
        </div>
    </header>

    <main id="app" class="px-4 py-6 max-w-4xl mx-auto"></main>
    <nav id="navbar"></nav>

    <div id="modal-overlay" class="overlay hidden">
        <div class="modal">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h3 id="m-title" class="text-lg font-black text-slate-800 uppercase tracking-wide"></h3>
                <button onclick="closeModal()" class="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200 text-lg font-bold transition hover:scale-110">‚úï</button>
            </div>
            <div id="m-body"></div>
        </div>
    </div>

    <div id="pin-screen" class="hidden bg-slate-900 fixed inset-0 z-[200] flex flex-col items-center justify-center text-white">
        <div class="mb-10 text-center">
            <h2 class="text-6xl font-black tracking-tighter mb-2">ARUME</h2>
            <p class="text-indigo-400 text-xs tracking-[0.4em] uppercase">Gesti√≥n Integral</p>
        </div>
        <div id="pin-display" class="text-5xl font-mono mb-12 tracking-[0.5em] h-12 text-center opacity-80">****</div>
        <div class="grid grid-cols-3 gap-6 w-72">
            <button class="pin-btn w-16 h-16 rounded-full border border-white/10 text-xl font-bold hover:bg-white/10" onclick="pin(1)">1</button>
            <button class="pin-btn w-16 h-16 rounded-full border border-white/10 text-xl font-bold hover:bg-white/10" onclick="pin(2)">2</button>
            <button class="pin-btn w-16 h-16 rounded-full border border-white/10 text-xl font-bold hover:bg-white/10" onclick="pin(3)">3</button>
            <button class="pin-btn w-16 h-16 rounded-full border border-white/10 text-xl font-bold hover:bg-white/10" onclick="pin(4)">4</button>
            <button class="pin-btn w-16 h-16 rounded-full border border-white/10 text-xl font-bold hover:bg-white/10" onclick="pin(5)">5</button>
            <button class="pin-btn w-16 h-16 rounded-full border border-white/10 text-xl font-bold hover:bg-white/10" onclick="pin(6)">6</button>
            <button class="pin-btn w-16 h-16 rounded-full border border-white/10 text-xl font-bold hover:bg-white/10" onclick="pin(7)">7</button>
            <button class="pin-btn w-16 h-16 rounded-full border border-white/10 text-xl font-bold hover:bg-white/10" onclick="pin(8)">8</button>
            <button class="pin-btn w-16 h-16 rounded-full border border-white/10 text-xl font-bold hover:bg-white/10" onclick="pin(9)">9</button>
            <button class="pin-btn w-16 h-16 rounded-full bg-red-500/20 border border-red-500/50 text-red-300 font-bold" onclick="pin('C')">C</button>
            <button class="pin-btn w-16 h-16 rounded-full border border-white/10 text-xl font-bold hover:bg-white/10" onclick="pin(0)">0</button>
            <button class="pin-btn w-16 h-16 rounded-full bg-emerald-500/20 border border-emerald-500/50 text-emerald-300 font-bold" onclick="pin('OK')">OK</button>
        </div>
        <p class="mt-8 text-slate-500 text-xs">PIN 0150: Admin | PIN 1111: Equipo</p>
    </div>

<script>
/* ================= 1. CORE UTILS & NUMERICS (AUDIT FIX) ================= */
// Manejo robusto de decimales y sanitizaci√≥n
const Num = {
    // Convierte string "1.200,50" -> float 1200.50
    parse: (str) => {
        if (!str) return 0;
        if (typeof str === 'number') return str;
        // Eliminar puntos de miles y cambiar coma por punto
        const cleanStr = String(str).replace(/\./g, '').replace(',', '.');
        const val = parseFloat(cleanStr);
        return isNaN(val) ? 0 : val;
    },
    // Formatea float -> "1.200,50"
    fmt: (n) => (n||0).toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2}),
    // Formato CSV (Excel espa√±ol usa coma decimal)
    csv: (n) => String(n||0).replace('.', ',')
};

function clean(str) { 
    if(!str) return ''; 
    // Sanitizaci√≥n b√°sica para evitar inyecci√≥n HTML
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); 
}

const generateID = () => Math.random().toString(36).substr(2, 9);
const getISO = () => new Date().toLocaleDateString('en-CA');
const getTS = () => new Date().toLocaleString('es-ES');

/* ================= 2. CONFIGURACI√ìN & DB (MEJORADA V145) ================= */
const CONFIG = { 
    GOOGLE_URL: "https://script.google.com/macros/s/AKfycbxL0hWPiYmQ_590bkFjd1B9xwsfrYQXQtEuUpP2Nraq973bDr2rpEgVnaJCpI3-DH8z/exec", 
    COST_HOUR: 15 
};

const ALLERGENS = [
    {k:'glu',i:'üåæ'},{k:'cru',i:'ü¶ê'},{k:'hue',i:'ü•ö'},{k:'pes',i:'üêü'},
    {k:'cac',i:'ü•ú'},{k:'soj',i:'ü´ò'},{k:'lac',i:'ü•õ'},{k:'fru',i:'üå∞'},
    {k:'api',i:'ü•¨'},{k:'mos',i:'üå≠'},{k:'ses',i:'üå±'},{k:'sul',i:'üç∑'},
    {k:'alt',i:'ü´ò'},{k:'mol',i:'üêô'}
];

const DB_INIT = { 
    users: [{id:'u1', n:'Gerencia', pin:'0150', role:'admin'}, {id:'u2', n:'Equipo', pin:'1111', role:'staff'}], 
    ingredientes: [], 
    recetas: [], 
    // CAMBIO IMPORTANTE: Ahora los proveedores tienen ID, Tel√©fono y Familia
    proveedores: [
        { id: 'p1', n: 'Makro', tel: '', fam: 'General' },
        { id: 'p2', n: 'Frutas y Verduras', tel: '', fam: 'Verdura' }
    ], 
    albaranes: [], facturas: [], diario: [], mermas: [], 
    kardex: [], sales_history: [], lastSync: 0 
};

// "Encriptaci√≥n" ligera para almacenamiento local (No es seguridad militar, evita lectura accidental)
const secure = { 
    enc: (d) => btoa(encodeURIComponent(JSON.stringify(d))), 
    dec: (d) => JSON.parse(decodeURIComponent(atob(d))) 
};

let db = DB_INIT;
let currentUser = null, currentPin = "", tempItems = [], activeAdminTab = 'dash', searchFilter = "";
let currentDiarioDate = new Date().toLocaleDateString('en-CA');
let inventoryMode = false;
let fiscalYear = new Date().getFullYear();
let fiscalQuarter = Math.floor(new Date().getMonth() / 3) + 1;
/* ================= 3. SYSTEM FUNCTIONS ================= */
function loading(show) { document.getElementById('loading-overlay').classList.toggle('hidden', !show); }

function toast(msg, type='info') { 
    const b=document.getElementById('toast-container'); 
    const el=document.createElement('div'); 
    el.className=`${type==='error'?'bg-red-500':'bg-slate-800'} text-white px-6 py-3 rounded-full shadow-xl font-bold text-sm mb-3 animate-bounce transition-all`; 
    el.innerText=msg; 
    b.appendChild(el); 
    setTimeout(()=>el.remove(),3000); 
}

function isInPeriod(dateStr) { 
    if(fiscalQuarter===0) return true; 
    const d=new Date(dateStr); 
    return d.getFullYear()===fiscalYear && (Math.floor(d.getMonth()/3)+1)===fiscalQuarter; 
}

function init() {
    try { 
        const stored=localStorage.getItem('arume_v125'); 
        if(stored) db=secure.dec(stored); 
    } catch(e){ console.warn("DB Integrity Reset"); }
    
    // Migraciones de estructura seguras
    if(!db.users || !db.users.length) db.users=DB_INIT.users;
    if(!db.kardex) db.kardex=[]; 
    if(!db.sales_history) db.sales_history=[];

    // ===> A√ëADE ESTA L√çNEA DE AQU√ç ABAJO PARA CORREGIR PROVEEDORES VIEJOS <===
    // Si los proveedores no tienen ID, los actualizamos
    db.proveedores = db.proveedores.map((p, i) => p.id ? p : { id: 'prov'+i, n: p.n, tel: '', fam: 'General' });

    const u=localStorage.getItem('arume_user');
    if(u){ currentUser=JSON.parse(u); document.getElementById('pin-screen').classList.add('hidden'); loadApp(); }
    else document.getElementById('pin-screen').classList.remove('hidden');
    
    if(CONFIG.GOOGLE_URL) sync();
}
    
    // Migraciones de estructura seguras
    if(!db.users || !db.users.length) db.users=DB_INIT.users;
    if(!db.kardex) db.kardex=[]; 
    if(!db.sales_history) db.sales_history=[];

    const u=localStorage.getItem('arume_user');
    if(u){ currentUser=JSON.parse(u); document.getElementById('pin-screen').classList.add('hidden'); loadApp(); }
    else document.getElementById('pin-screen').classList.remove('hidden');
    
    if(CONFIG.GOOGLE_URL) sync();
}

async function save(msg){
    loading(true); 
    try { 
        db.lastSync=Date.now(); 
        localStorage.setItem('arume_v125', secure.enc(db)); 
        if(CONFIG.GOOGLE_URL) { 
            const c=new AbortController(); 
            setTimeout(()=>c.abort(),4000); 
            // no-cors es necesario para Google Apps Script simple
            await fetch(CONFIG.GOOGLE_URL,{method:'POST',mode:'no-cors',body:JSON.stringify(db),signal:c.signal}).catch(()=>{}); 
        }
        if(msg) toast(msg,'success'); 
    } catch(e){ toast("Error guardando datos locales","error"); } 
    finally{ loading(false); }
}

async function sync(){ 
    if(!CONFIG.GOOGLE_URL) return; 
    try{ 
        const r=await fetch(CONFIG.GOOGLE_URL); 
        const c=await r.json(); 
        if(c&&c.lastSync>(db.lastSync||0)){ 
            db=c; localStorage.setItem('arume_v125',secure.enc(db)); 
            // No recargar, repintar
            loadApp(); toast("Datos sincronizados");
        } 
    }catch(e){} 
}

function pin(n){ 
    if(n==='C') currentPin=""; 
    else if(n==='OK'){ 
        const u=db.users.find(x=>x.pin===currentPin); 
        if(u){ 
            currentUser=u; 
            localStorage.setItem('arume_user',JSON.stringify(u)); 
            document.getElementById('pin-screen').classList.add('hidden'); 
            loadApp(); 
        } else { toast("PIN Incorrecto","error"); currentPin=""; }
    } else if(currentPin.length<4) currentPin+=n; 
    document.getElementById('pin-display').innerText=currentPin?'*'.repeat(currentPin.length):'****'; 
}

function logout(){ if(confirm("¬øCerrar sesi√≥n?")){ localStorage.removeItem('arume_user'); location.reload(); }}

/* ================= 4. LOGIC ENGINE ================= */
const UnitConverter = {
    normalize: (u) => { 
        if(!u) return 'ud'; u=u.toLowerCase().trim(); 
        if(['kg','kilo','kilos'].includes(u)) return 'kg'; 
        if(['g','gr','gramos','gramo'].includes(u)) return 'g'; 
        if(['l','litro','litros'].includes(u)) return 'l'; 
        if(['ml','mililitro'].includes(u)) return 'ml'; 
        return 'ud'; 
    },
    convert: (val,from,to) => { 
        from=UnitConverter.normalize(from); to=UnitConverter.normalize(to); 
        if(from===to) return val; 
        if(from==='kg'&&to==='g') return val*1000; 
        if(from==='g'&&to==='kg') return val/1000; 
        if(from==='l'&&to==='ml') return val*1000; 
        if(from==='ml'&&to==='l') return val/1000; 
        return val; 
    }
};

function logStock(ingId, qty, type, reason, price=0) { 
    const ing=db.ingredientes.find(x=>x.id===ingId); 
    if(ing) db.kardex.push({
        id:generateID(), ts:Date.now(), date:getTS(), 
        ingId, n:ing.n, type, qty, unit:ing.unit, price, reason, user:currentUser.n
    }); 
}

/* ================= 5. UI RENDER & SECURITY ================= */
function loadApp() { 
    document.getElementById('user-name').innerText=currentUser.n; 
    renderNav(); 
    // Redirigir a vista segura si es staff
    render(currentUser.role==='admin' ? 'Admin' : 'Cocina'); 
}

function renderNav() {
    const isAdmin = currentUser?.role==='admin';
    const views = [
        {id:'Diario', l:'Caja', i:'<path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>', restricted:!isAdmin},
        {id:'Admin', l:'Gesti√≥n', i:'<path d="M12 2L3 5v6c0 5 3.8 9.7 9 11 5.2-1.3 9-6 9-11V5l-9-3z"/>', restricted:!isAdmin},
        {id:'Cocina', l:'Cocina', i:'<path d="M12 2C8.1 6 7 8 7 11c0 3.9 3.1 7 7 7s7-3.1 7-7c0-3-1.1-5-5-9z"/>', restricted:false},
        {id:'Stock', l:'Stock', i:'<path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 1-1-.45-1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 1-1-.45-1-1z"/>', restricted:false}
    ];
    document.getElementById('navbar').innerHTML = views.map(v => `<button type="button" id="btn-${v.id}" class="${v.restricted?'locked':''}" onclick="render('${v.id}')"><svg viewBox="0 0 24 24">${v.restricted?'<path d="M12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6-9h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6z"/>':v.i}</svg><span>${v.l}</span></button>`).join('');
}

function render(view) {
    if((view==='Diario'||view==='Admin') && currentUser.role!=='admin') return toast("‚õî Acceso Restringido", "error");
    document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
    document.getElementById(`btn-${view}`)?.classList.add('active');
    const app = document.getElementById('app');
    if(view==='Diario') renderDiario(app); if(view==='Admin') renderAdmin(app); if(view==='Cocina') renderCocina(app); if(view==='Stock') renderStock(app);
}

/* ================= 6. GESTI√ìN (ADMIN) ================= */
function renderAdmin(app) {
    const totalVentas = db.diario.filter(d => isInPeriod(d.date)).reduce((acc, d) => acc + (d.total||0), 0);
    const periodAlbs = db.albaranes.filter(a => isInPeriod(a.date));
    const periodCosts = periodAlbs.reduce((acc, a) => acc + (a.total||0), 0);
    const periodTax = periodAlbs.reduce((acc, a) => acc + (a.taxes||0), 0);
    const profit = totalVentas - periodCosts;

    const qCtrl = `<div class="flex justify-between bg-white p-1 rounded-full shadow-sm mb-6"><button class="period-btn ${fiscalQuarter===1?'active':''}" onclick="fiscalQuarter=1;renderAdmin(document.getElementById('app'))">1T</button><button class="period-btn ${fiscalQuarter===2?'active':''}" onclick="fiscalQuarter=2;renderAdmin(document.getElementById('app'))">2T</button><button class="period-btn ${fiscalQuarter===3?'active':''}" onclick="fiscalQuarter=3;renderAdmin(document.getElementById('app'))">3T</button><button class="period-btn ${fiscalQuarter===4?'active':''}" onclick="fiscalQuarter=4;renderAdmin(document.getElementById('app'))">4T</button><button class="period-btn ${fiscalQuarter===0?'active':''}" onclick="fiscalQuarter=0;renderAdmin(document.getElementById('app'))">A√ëO</button></div>`;

    app.innerHTML = `<div class="text-center font-bold text-slate-400 mb-2">${fiscalYear}</div>${qCtrl}
        <div class="flex gap-2 mb-6 bg-white p-1 rounded-2xl shadow-sm border border-slate-100">
            <button class="flex-1 py-2.5 rounded-xl font-bold text-xs transition ${activeAdminTab==='dash'?'bg-slate-800 text-white shadow-md':'text-slate-500 hover:bg-slate-50'}" onclick="activeAdminTab='dash';renderAdmin(document.getElementById('app'))">RESUMEN</button>
            <button class="flex-1 py-2.5 rounded-xl font-bold text-xs transition ${activeAdminTab==='omnes'?'bg-slate-800 text-white shadow-md':'text-slate-500 hover:bg-slate-50'}" onclick="activeAdminTab='omnes';renderAdmin(document.getElementById('app'))">OMNES</button>
            <button class="flex-1 py-2.5 rounded-xl font-bold text-xs transition ${activeAdminTab==='albaranes'?'bg-slate-800 text-white shadow-md':'text-slate-500 hover:bg-slate-50'}" onclick="activeAdminTab='albaranes';renderAdmin(document.getElementById('app'))">COMPRAS</button>
            <button class="flex-1 py-2.5 rounded-xl font-bold text-xs transition ${activeAdminTab==='facturas'?'bg-slate-800 text-white shadow-md':'text-slate-500 hover:bg-slate-50'}" onclick="activeAdminTab='facturas';renderAdmin(document.getElementById('app'))">FACTURAS</button>
        </div>
        ${activeAdminTab === 'dash' ? `<div class="glass-card bg-gradient-to-br from-slate-900 to-slate-800 text-white border-0"><h3 class="text-xs font-bold text-slate-400 uppercase mb-4 tracking-widest">Resultado ${fiscalQuarter===0?'ANUAL':fiscalQuarter+'T'}</h3><div class="flex justify-between items-end mb-6"><div><div class="text-3xl font-black ${profit>=0?'text-emerald-400':'text-red-400'}">${Num.fmt(profit)}‚Ç¨</div><div class="text-xs opacity-60">Beneficio</div></div><div class="text-right"><div class="text-lg font-bold">${Num.fmt(totalVentas)}‚Ç¨</div><div class="text-xs opacity-60">Ventas</div></div></div><div class="h-2 bg-slate-700 rounded-full overflow-hidden flex"><div class="bg-emerald-500 h-full" style="width:${(totalVentas/(totalVentas+periodCosts)*100)||50}%"></div><div class="bg-red-500 h-full flex-1"></div></div><div class="flex justify-between text-[10px] mt-2 font-bold text-slate-400"><span>INGRESOS</span><span>GASTOS (${Num.fmt(periodCosts)}‚Ç¨)</span></div></div><div class="glass-card"><div class="flex justify-between items-center"><span class="font-bold text-slate-600">IVA Soportado</span><span class="font-black text-xl text-indigo-600">${Num.fmt(periodTax)}‚Ç¨</span></div></div>
        
        <div class="grid grid-cols-2 gap-3">
            <button class="btn-ghost mb-4" onclick="downloadBackup()">üíæ GUARDAR COPIA</button>
            <button class="btn-ghost mb-4 text-indigo-600" onclick="triggerRestore()">üì§ RESTAURAR</button>
        </div>
        ` : ''}
        <div id="adm-c"></div>`;
    
    const c = document.getElementById('adm-c');
    if(activeAdminTab==='omnes') renderOmnes(c);
    if(activeAdminTab==='albaranes') renderAlbaranes(c);
    if(activeAdminTab==='facturas') renderFacturas(c);
}

function renderOmnes(c) {
    if (!db.recetas || db.recetas.length === 0) {
        c.innerHTML = `<div class="glass-card text-center"><h3 class="font-bold text-slate-800">No hay recetas</h3><p class="text-xs text-slate-400 mb-4">Crea platos en Cocina primero.</p><button class="btn-premium w-full" onclick="render('Cocina')">IR A COCINA</button></div>`;
        return;
    }
    let totalSold=0, totalRev=0, totalCost=0;
    const periodSalesMap = {}; 
    db.sales_history.filter(log => isInPeriod(log.date)).forEach(log => { log.items.forEach(it => { const rid = it.rid || db.recetas.find(r=>r.n===it.n)?.id; if(rid) periodSalesMap[rid] = (periodSalesMap[rid] || 0) + it.q; }); });
    const useHistory = db.sales_history.length > 0;
    const recipesData = (db.recetas||[]).map(r => { const costData = calcRecipe(r); const sales = useHistory ? (periodSalesMap[r.id] || 0) : (r.sales || 0); totalSold += sales; totalRev += (sales * r.pvp); totalCost += (sales * costData.t); return { r, sales, margin: r.pvp - costData.t, cost: costData.t }; });
    const avgMargin = totalSold > 0 ? ((totalRev - totalCost) / totalSold) : 0; const popLimit = (totalSold > 0 ? (100 / recipesData.length) : 0) * 0.7;
    let html = ''; recipesData.sort((a,b) => b.sales - a.sales).forEach(d => { if(d.sales > 0) { const isPop = (totalSold > 0 ? (d.sales/totalSold)*100 : 0) >= popLimit; const isRich = d.margin >= avgMargin; let type = isPop ? (isRich ? 'ESTRELLA' : 'CABALLO') : (isRich ? 'PUZZLE' : 'PERRO'); let css = isPop ? (isRich ? 'omnes-star' : 'omnes-plow') : (isRich ? 'omnes-puzz' : 'omnes-dog'); html += `<div class="bg-white p-3 rounded-xl omnes-card mb-2 shadow-sm flex justify-between items-center ${css}"><div class="flex-1"><div class="font-bold text-slate-700">${clean(d.r.n)}</div><div class="text-[10px] font-bold opacity-70">${type}</div></div><div class="text-right"><div class="font-black text-lg">${d.sales}</div><div class="text-[10px]">VENDIDOS</div></div></div>`; } });
    c.innerHTML = `<div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-800">An√°lisis ${fiscalQuarter===0?'ANUAL':fiscalQuarter+'T'}</h3><button class="btn-premium btn-action w-auto px-4 py-2 text-xs" onclick="editSales()">üìù REGISTRAR SERVICIO</button></div>${html || '<div class="text-center p-8 text-slate-400 border-2 border-dashed rounded-xl">Sin ventas en este periodo</div>'}`;
}

function editSales() {
    if (!db.recetas || db.recetas.length === 0) return toast("No hay recetas creadas", "error");
    const html = db.recetas.map(r => `<div class="flex justify-between items-center py-2 border-b border-slate-50"><span class="text-sm font-medium text-slate-700 w-1/2">${clean(r.n)}</span><div class="flex items-center gap-2"><input type="number" min="0" placeholder="0" id="sale-add-${r.id}" onfocus="this.select()" class="bg-white border-2 border-slate-200 rounded-xl w-20 text-center py-2 font-bold text-indigo-600 focus:border-indigo-500 outline-none shadow-sm transition"></div></div>`).join('');
    showModal('Cierre de Ventas', `<div class="bg-blue-50 p-3 rounded-lg text-blue-800 text-xs mb-4">Introduce <b>ventas del d√≠a</b>.</div><div class="max-h-[50vh] overflow-y-auto pr-2 mb-4">${html}</div><div class="flex gap-2"><button class="btn-premium btn-action w-full" onclick="commitSalesSession()">PROCESAR Y DESCONTAR STOCK</button></div>`);
}

function commitSalesSession() {
    let log = { id: generateID(), date: getTS(), items: [] };
    let hasData = false;
    db.recetas.forEach(r => {
        const qty = Num.parse(document.getElementById(`sale-add-${r.id}`).value);
        if(qty > 0) {
            hasData = true;
            r.items.forEach(it => { if(it.type === 'ing') { const ing = db.ingredientes.find(x => x.id === it.id); if(ing) { let needed = it.q * qty; if(it.merma) needed = needed / (1 - (it.merma/100)); const finalQty = UnitConverter.convert(needed, r.unit || 'kg', ing.unit); ing.stock -= finalQty; logStock(ing.id, finalQty, 'OUT', `Venta: ${r.n} (${qty})`); } } });
            r.sales = (r.sales || 0) + qty; log.items.push({ rid: r.id, n: r.n, q: qty });
        }
    });
    if(hasData) { db.sales_history.push(log); save("Ventas procesadas"); closeModal(); renderAdmin(document.getElementById('app')); } else toast("No has introducido cantidades", "error");
}

/* --- ALBARANES --- */
function renderAlbaranes(c) {
    const periodAlbs = db.albaranes.filter(a => isInPeriod(a.date)).slice().reverse();
    const provOptions = db.proveedores.map(p => `<option value="${clean(p.n)}">`).join('');
    const ingOptions = db.ingredientes.map(i => `<option value="${clean(i.n)}">`).join('');

    c.innerHTML = `
    <div class="glass-card border-l-4 border-indigo-500">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-slate-700 text-sm uppercase">Nuevo Albar√°n</h3>
            <label class="flex items-center gap-2 cursor-pointer bg-slate-50 px-3 py-1 rounded-lg border border-slate-200">
                <input type="checkbox" id="alb-socio" class="w-4 h-4 text-indigo-600 rounded">
                <span class="text-xs font-bold text-slate-600">Es Socio/Interno</span>
            </label>
        </div>
        
        <div class="grid grid-cols-3 gap-3 mb-3">
            <div>
                <label>Proveedor</label>
                <input list="prov-list" id="alb-prov" class="input-premium" placeholder="..." onchange="checkDuplicate()">
                <datalist id="prov-list">${provOptions}</datalist>
            </div>
            <div><label>Productor</label><input id="alb-producer" class="input-premium"></div>
            <div>
                <label>Ref / Factura</label>
                <input id="alb-num" class="input-premium font-mono" onkeyup="checkDuplicate()" value="A-${new Date().getFullYear().toString().slice(-2)}-${(db.albaranes.length+1).toString().padStart(4,'0')}">
                <div id="dup-alert" class="hidden text-[10px] text-red-500 font-bold mt-1 animate-pulse">‚ö†Ô∏è POSIBLE DUPLICADO</div>
            </div>
        </div>
        
        <div class="grid grid-cols-2 gap-3 mb-3">
            <div><label>Fecha</label><input type="date" id="alb-date" value="${getISO()}" class="input-premium"></div>
            <div><label>Nota</label><input id="alb-note" class="input-premium"></div>
        </div>

        <datalist id="ing-list">${ingOptions}</datalist>
        
        <textarea id="alb-input" rows="2" class="input-premium font-mono text-xs mb-2" placeholder="Pegar: Producto TAB Cantidad TAB Precio..."></textarea>
        
        <div class="flex gap-2 mb-4">
            <button class="btn-ghost" onclick="parseAlb()">ü™Ñ Leer Texto</button>
            <button class="btn-ghost text-red-400" onclick="tempItems=[];renderAlbGrid()">Limpiar</button>
        </div>

        <div class="grid grid-cols-12 gap-1 px-2 mb-1 text-[10px] font-bold text-slate-400 uppercase tracking-wider text-center">
            <div class="col-span-4 text-left">Producto</div>
            <div class="col-span-2">Cant/Ud</div>
            <div class="col-span-2">Precio</div>
            <div class="col-span-1 text-emerald-600">Dto%</div>
            <div class="col-span-1">IVA</div>
            <div class="col-span-2 text-right">Total</div>
        </div>

        <div id="alb-grid" class="space-y-2 mb-4"></div>
        
        <div class="border-t border-slate-100 pt-3 text-right">
            <div class="text-xs text-slate-400 font-bold">TOTAL A PAGAR</div>
            <div class="text-3xl font-black text-slate-800"><span id="alb-total">0.00‚Ç¨</span></div>
        </div>
        
        <div class="grid grid-cols-2 gap-3 mt-4">
            <button class="btn-premium btn-action" onclick="commitAlb()">CONFIRMAR</button>
            <button class="btn-ghost" onclick="exportAlbCSV()">CSV</button>
        </div>
    </div>

    <div class="glass-card">
        <h4 class="text-xs font-bold text-slate-400 uppercase mb-4">Historial (${fiscalQuarter===0?'A√ëO':fiscalQuarter+'T'})</h4>
        ${periodAlbs.length ? periodAlbs.map(a => `
            <div class="flex justify-between items-center py-3 border-b border-slate-50 hover:bg-slate-50 transition px-2 rounded-lg">
                <div class="text-sm font-bold text-slate-700">
                    ${a.isSocio ? 'ü§ù ' : ''}${clean(a.prov)}
                    <div class="text-[10px] text-slate-400 font-normal flex gap-2">
                        <span>${a.date}</span>
                        <span class="font-mono bg-slate-100 px-1 rounded text-slate-500">Ref: ${a.num}</span>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="font-bold text-sm mr-2 ${a.isSocio ? 'text-indigo-600':''}">${Num.fmt(a.total)}‚Ç¨</span>
                    <button class="btn-icon btn-ghost" onclick="viewAlbDetails('${a.id}')">üëÅ</button>
                    ${!a.invoiced ? `
                        <button class="btn-icon btn-edit" onclick="editAlb('${a.id}')">‚úèÔ∏è</button>
                        <button class="btn-icon btn-delete" onclick="deleteAlb('${a.id}')">üóëÔ∏è</button>
                    ` : '<span class="text-[10px] bg-green-100 text-green-700 px-2 py-1 rounded font-bold">FACTURADO</span>'}
                </div>
            </div>`).join('') 
        : '<div class="text-center p-4 text-slate-400">Sin compras registradas</div>'}
    </div>`;
    
    renderAlbGrid();
}

function checkDuplicate() {
    const num = document.getElementById('alb-num').value.trim();
    const prov = document.getElementById('alb-prov').value.trim();
    const alert = document.getElementById('dup-alert');
    const inputNum = document.getElementById('alb-num');
    
    // Busca si existe alg√∫n albar√°n con el mismo n√∫mero Y proveedor
    const exists = db.albaranes.some(a => a.num.toLowerCase() === num.toLowerCase() && a.prov.toLowerCase() === prov.toLowerCase());
    
    if (exists && num.length > 2) {
        alert.classList.remove('hidden');
        inputNum.classList.add('border-red-500', 'text-red-600');
        inputNum.classList.remove('border-e2e8f0');
    } else {
        alert.classList.add('hidden');
        inputNum.classList.remove('border-red-500', 'text-red-600');
        inputNum.classList.add('border-e2e8f0');
    }
}

function parseAlb() {
    const txt = document.getElementById('alb-input').value.trim();
    if (!txt) return toast("Texto vac√≠o", "error");
    txt.split(/\r?\n/).forEach(l => {
        let parts = l.split(/\t/);
        if (parts.length < 2) parts = l.split(/,(?=\s*\d)/);
        if (parts.length >= 2) {
            const n = parts[0].trim();
            const qS = parts[1].trim();
            const pS = parts[2] ? parts[2].trim() : '0';
            const qM = qS.match(/^([\d\.,]+)\s*([a-zA-Z]+)?$/);
            const qty = qM ? Num.parse(qM[1]) : Num.parse(qS);
            const unit = qM && qM[2] ? UnitConverter.normalize(qM[2]) : 'ud';
            const price = Num.parse(pS);
            if (n && price >= 0) {
                tempItems.push({ n, q: qty, p: price, unit, d: 0, tax: 10 });
            }
        }
    });
    renderAlbGrid();
}

function renderAlbGrid() {
    const el = document.getElementById('alb-grid');
    if (!el) return;
    el.innerHTML = tempItems.map((it, i) => {
        // C√°lculo con descuento
        const lineBase = (it.q * it.p) * (1 - (it.d || 0) / 100);
        const lineTotal = lineBase * (1 + it.tax / 100);
        return `
        <div class="bg-white p-1 rounded-xl border border-slate-100 grid grid-cols-12 gap-1 items-center shadow-sm relative group">
            <div class="col-span-4"><input list="ing-list" value="${clean(it.n)}" class="w-full bg-transparent font-bold text-xs outline-none truncate" placeholder="Producto" onchange="tempItems[${i}].n=this.value"></div>
            <div class="col-span-2 flex gap-1"><input type="number" value="${it.q}" class="w-full bg-slate-50 text-center text-xs p-1 rounded font-bold outline-none" onchange="tempItems[${i}].q=parseFloat(this.value);renderAlbGrid()"><select onchange="tempItems[${i}].unit=this.value" class="w-10 bg-slate-50 text-[10px] p-0 rounded border-0 text-slate-500"><option ${it.unit==='ud'?'selected':''} value="ud">ud</option><option ${it.unit==='kg'?'selected':''} value="kg">kg</option><option ${it.unit==='l'?'selected':''} value="l">l</option></select></div>
            <div class="col-span-2"><input type="number" value="${it.p}" class="w-full bg-slate-50 text-center text-xs p-1 rounded outline-none" onchange="tempItems[${i}].p=parseFloat(this.value);renderAlbGrid()"></div>
            <div class="col-span-1"><input type="number" value="${it.d||0}" class="w-full bg-emerald-50 text-emerald-700 text-center text-xs p-1 rounded font-bold outline-none" placeholder="%" onchange="tempItems[${i}].d=parseFloat(this.value);renderAlbGrid()"></div>
            <div class="col-span-1"><select onchange="tempItems[${i}].tax=parseFloat(this.value);renderAlbGrid()" class="w-full bg-blue-50 text-blue-700 font-bold text-[10px] p-1 rounded border-0"><option ${it.tax===10?'selected':''} value="10">10</option><option ${it.tax===21?'selected':''} value="21">21</option><option ${it.tax===4?'selected':''} value="4">4</option><option ${it.tax===0?'selected':''} value="0">0</option></select></div>
            <div class="col-span-2 text-right font-mono font-bold text-xs pr-2">${Num.fmt(lineTotal)}‚Ç¨</div>
            <button class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-[10px] opacity-0 group-hover:opacity-100 transition shadow-sm" onclick="tempItems.splice(${i},1);renderAlbGrid()">‚úï</button>
        </div>`;
    }).join('');
    const total = tempItems.reduce((acc, it) => acc + (it.q * it.p * (1 - (it.d || 0) / 100)) * (1 + it.tax / 100), 0);
    document.getElementById('alb-total').innerText = Num.fmt(total) + '‚Ç¨';
}

function commitAlb() {
    if (!tempItems.length) return toast("Vac√≠o", "error");
    const prov = document.getElementById('alb-prov').value;
    const date = document.getElementById('alb-date').value;
    const num = document.getElementById('alb-num').value;
    const isSocio = document.getElementById('alb-socio').checked;
    
    if (!prov || !date) return toast("Faltan datos", "error");

    // Alerta final de duplicado
    const exists = db.albaranes.some(a => a.num === num && a.prov === prov);
    if (exists && !confirm(`‚ö†Ô∏è DUPLICADO DETECTADO: ${num}\n¬øGuardar de todas formas?`)) return;

    if (!db.proveedores.find(p => p.n === prov)) db.proveedores.push({ n: prov });

    tempItems.forEach(it => {
        const cleanName = it.n.trim();
        let ing = db.ingredientes.find(x => x.n.trim().toLowerCase() === cleanName.toLowerCase() && x.unit === it.unit);
        if (!ing) { ing = { id: generateID(), n: cleanName, stock: 0, cost: 0, unit: it.unit, aller: [] }; db.ingredientes.push(ing); }
        
        // Coste real descontado
        const realUnitCost = it.p * (1 - (it.d || 0) / 100);
        const totalQty = Math.max(0, ing.stock) + it.q;
        ing.cost = totalQty > 0 ? ((Math.max(0, ing.stock) * ing.cost) + (it.q * realUnitCost)) / totalQty : realUnitCost;
        ing.stock += it.q;
        logStock(ing.id, it.q, 'IN', `Alb: ${prov} ${isSocio?'(Socio)':''}`, realUnitCost);
    });

    let totalBase = 0, totalTax = 0;
    tempItems.forEach(it => {
        const base = (it.q * it.p) * (1 - (it.d || 0) / 100);
        totalBase += base;
        totalTax += base * (it.tax / 100);
    });

    db.albaranes.push({
        id: generateID(), num, prov, productor: document.getElementById('alb-producer').value,
        date, items: JSON.parse(JSON.stringify(tempItems)),
        total: totalBase + totalTax, taxes: totalTax, subtotal: totalBase,
        invoiced: false, isSocio, note: document.getElementById('alb-note').value
    });

    save("Entrada OK"); tempItems = []; renderAdmin(document.getElementById('app'));
}

function editAlb(id) {
    const alb = db.albaranes.find(a => a.id === id);
    if (!alb) return;
    if (confirm("¬øEditar? Se revertir√° el stock.")) {
        alb.items.forEach(it => {
            const ing = db.ingredientes.find(x => x.n.trim().toLowerCase() === it.n.trim().toLowerCase() && x.unit === it.unit);
            if (ing) { ing.stock -= it.q; logStock(ing.id, it.q, 'OUT', `Correcci√≥n Alb`); }
        });
        tempItems = JSON.parse(JSON.stringify(alb.items));
        document.getElementById('alb-prov').value = alb.prov;
        document.getElementById('alb-num').value = alb.num;
        document.getElementById('alb-date').value = alb.date;
        document.getElementById('alb-producer').value = alb.productor || '';
        document.getElementById('alb-note').value = alb.note || '';
        document.getElementById('alb-socio').checked = alb.isSocio || false;
        
        db.albaranes = db.albaranes.filter(a => a.id !== id);
        renderAlbGrid(); window.scrollTo(0, 0); toast("Modo Edici√≥n");
    }
}

function deleteAlb(id) {
    const alb = db.albaranes.find(a => a.id === id);
    if (!alb) return;
    if (confirm("¬øBorrar?")) {
        alb.items.forEach(it => {
            const ing = db.ingredientes.find(x => x.n.trim().toLowerCase() === it.n.trim().toLowerCase() && x.unit === it.unit);
            if (ing) { ing.stock -= it.q; logStock(ing.id, it.q, 'OUT', `Borrado Alb`); }
        });
        db.albaranes = db.albaranes.filter(a => a.id !== id);
        save("Borrado"); renderAdmin(document.getElementById('app'));
    }
}

function viewAlbDetails(id) {
    const a = db.albaranes.find(x => x.id === id);
    if (a) showModal(`Detalle ${a.num}`, `<div class="mb-2 text-xs">${a.isSocio ? 'ü§ù SOCIO | ':''}${a.prov}</div><table class="w-full text-xs"><thead><tr><th>Prod</th><th>Cant</th><th>Dto</th><th>‚Ç¨</th></tr></thead><tbody>${a.items.map(i => { const p = i.p * (1 - (i.d || 0) / 100); return `<tr><td>${i.n}</td><td class="text-center">${i.q}${i.unit}</td><td class="text-center text-red-400">${i.d||'-'}%</td><td class="text-right">${Num.fmt(i.q * p)}</td></tr>`; }).join('')}</tbody></table><div class="text-right font-black text-xl mt-4">${Num.fmt(a.total)}‚Ç¨</div>`);
}

function exportAlbCSV() {
    if (!tempItems.length) return toast("Vac√≠o", "error");
    const rows = tempItems.map(it => [it.n, Num.csv(it.q), it.unit, Num.csv(it.p), Num.csv(it.d || 0), Num.csv((it.q * it.p * (1 - (it.d || 0) / 100)) * (1 + it.tax / 100))]);
    const csv = ['Prod;Cant;Ud;Precio;Dto;Total', ...rows.map(r => r.join(';'))].join('\n');
    const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Albaran.csv'; a.click();
}
function renderFacturas(c) { const pends = db.albaranes.filter(a=>!a.invoiced); const groups={}; pends.forEach(a=>{ if(!groups[a.prov]) groups[a.prov]={c:0,t:0,ids:[]}; groups[a.prov].c++; groups[a.prov].t+=a.total; groups[a.prov].ids.push(a.id); }); const hist = db.facturas.filter(f => isInPeriod(f.date)).slice().reverse(); c.innerHTML = `${Object.keys(groups).length ? `<div class="glass-card"><h3 class="font-bold text-xs text-slate-400 mb-3 uppercase">Pendiente</h3>${Object.entries(groups).map(([p,d])=>`<div class="flex justify-between items-center py-2 border-b"><div><div class="font-bold text-slate-800">${clean(p)}</div><div class="text-xs text-slate-400">${d.c} albaranes</div></div><div class="flex items-center gap-3"><span class="font-bold">${Num.fmt(d.t)}‚Ç¨</span><button class="bg-indigo-600 text-white px-3 py-1 rounded-lg text-xs font-bold" onclick="invoice('${p}','${d.ids}')">GENERAR</button></div></div>`).join('')}</div>` : ''} <div class="glass-card"><h3 class="font-bold text-xs text-slate-400 mb-4 uppercase">Hist√≥rico (${fiscalQuarter===0?'A√ëO':fiscalQuarter+'T'})</h3>${hist.length ? hist.map(f => `<div class="flex justify-between items-center py-3 border-b"><div class="text-sm font-bold text-slate-800">${clean(f.prov)}<div class="text-[10px] text-slate-400 font-normal">${f.date}</div></div><div class="text-right"><div class="font-mono font-bold">${Num.fmt(f.total)}‚Ç¨</div><div class="text-[10px] font-bold cursor-pointer ${f.paid?'text-emerald-500':'text-red-400'}" onclick="togglePaid('${f.id}')">${f.paid?'PAGADO':'PENDIENTE'}</div></div></div>`).join('') : '<div class="text-center p-4 text-slate-400">Sin facturas</div>'}</div>`; }
function invoice(p,ids){ const l=ids.split(','); l.forEach(id=>{ const a=db.albaranes.find(x=>x.id===id); if(a) a.invoiced=true; }); const t=l.reduce((ac,id)=>ac+(db.albaranes.find(x=>x.id===id)?.total||0),0); db.facturas.push({id:generateID(), date:getISO(), prov:p, total:t, paid:false}); save("Factura OK"); renderAdmin(document.getElementById('app')); }
function togglePaid(id){ const f=db.facturas.find(x=>x.id===id); if(f){ f.paid=!f.paid; save(); renderAdmin(document.getElementById('app')); }}

/* ================= 7. COCINA ================= */
function renderCocina(app) {
    // Ordenar recetas alfab√©ticamente
    const sorted = db.recetas.sort((a,b) => a.n.localeCompare(b.n));

    app.innerHTML = `
    <div class="glass-card">
        <div class="flex justify-between items-center mb-4">
            <h2 class="font-black text-xl text-slate-800 tracking-tight">ESCANDALLOS PRO</h2>
            <button class="btn-premium w-auto px-4 py-2 text-xs shadow-lg shadow-indigo-500/30" onclick="editRec()">+ NUEVA FICHA</button>
        </div>
        
        <input placeholder="üîç Buscar plato o elaboraci√≥n..." onkeyup="filterRec(this.value)" class="input-premium mb-4">

        <div id="rec-grid" class="space-y-3">
            ${renderRecGrid(sorted)}
        </div>
    </div>`;
}

function renderRecGrid(list) {
    if(!list.length) return '<div class="text-center p-8 text-slate-400 italic">No hay recetas definidas</div>';
    
    return list.map(r => { 
        const c = calcRecipe(r); 
        const fc = r.pvp > 0 ? (c.t / r.pvp) * 100 : 0;
        
        // L√≥gica del Sem√°foro
        let semColor = 'bg-slate-200';
        let semText = 'N/A';
        if(r.pvp > 0) {
            if(fc < 30) { semColor = 'bg-emerald-500'; semText = 'üü¢ TOP'; }
            else if(fc < 40) { semColor = 'bg-orange-400'; semText = 'üü† OK'; }
            else { semColor = 'bg-red-500'; semText = 'üî¥ ALTO'; }
        }

        return `
        <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm cursor-pointer hover:shadow-md transition group relative overflow-hidden" onclick="viewRec('${r.id}')">
            <div class="absolute left-0 top-0 bottom-0 w-1.5 ${semColor}"></div>
            
            <div class="flex justify-between items-start pl-2">
                <div>
                    <div class="font-bold text-slate-800 text-lg leading-tight">${clean(r.n)}</div>
                    <div class="text-[10px] text-slate-400 mt-1 uppercase font-bold tracking-wider">
                        ${r.items.length} Ingredientes ¬∑ ${r.time} min
                    </div>
                </div>
                <div class="text-right">
                    <div class="font-black text-xl text-slate-700">${Num.fmt(c.t)}‚Ç¨</div>
                    <div class="text-[10px] font-bold ${r.pvp > 0 && fc > 40 ? 'text-red-500' : 'text-slate-400'}">
                        FC: ${fc.toFixed(1)}%
                    </div>
                </div>
            </div>
            
            <div class="mt-3 pl-2 flex flex-wrap gap-1">
                ${c.all.length ? c.all.map(k=>`<span class="text-[10px] bg-indigo-50 text-indigo-600 px-1.5 py-0.5 rounded border border-indigo-100">${ALLERGENS.find(a=>a.k==k)?.i}</span>`).join('') : '<span class="text-[10px] text-slate-300">Sin al√©rgenos</span>'}
            </div>
        </div>`;
    }).join('');
}

function filterRec(txt) {
    const term = txt.toLowerCase();
    const filtered = db.recetas.filter(r => r.n.toLowerCase().includes(term));
    document.getElementById('rec-grid').innerHTML = renderRecGrid(filtered);
}

// L√≥gica Recursiva para Subrecetas
function calcRecipe(r, visited = new Set()) { 
    // Evitar bucles infinitos (Receta A usa Receta B usa Receta A)
    if (visited.has(r.id)) return { t: 0, all: [] };
    visited.add(r.id);

    let t = 0, all = new Set(); 
    
    (r.items || []).forEach(it => { 
        const yieldFactor = (it.merma && it.merma > 0) ? (1 - (it.merma/100)) : 1;
        
        if (it.type === 'ing') { 
            // Es un Ingrediente normal
            const i = db.ingredientes.find(x => x.id === it.id); 
            if (i) { 
                const costUnit = UnitConverter.convert(1, r.unit || 'kg', i.unit); 
                t += (it.q * costUnit * i.cost) / yieldFactor; 
                (i.aller || []).forEach(k => all.add(k)); 
            } 
        } else if (it.type === 'rec') {
            // Es una Subreceta (Escandallo dentro de escandallo)
            const subR = db.recetas.find(x => x.id === it.id);
            if (subR) {
                // Recursividad: calculamos el coste de la subreceta
                const subC = calcRecipe(subR, new Set(visited));
                // Asumimos que la subreceta se a√±ade como "1 unidad" o "1 raci√≥n"
                // Si quisieras ser preciso con Kilos, habr√≠a que definir el "Yield" de la subreceta.
                // Aqu√≠ simplificamos: el coste de la subreceta entera se multiplica por la cantidad usada.
                // (Ej: Usas 0.5 de la receta "Salsa Tomate")
                t += (subC.t * it.q);
                subC.all.forEach(k => all.add(k));
            }
        }
    }); 
    
    // Mano de obra
    t += (r.time / 60) * CONFIG.COST_HOUR; 
    return { t, all: Array.from(all) }; 
}

function editRec(id) { 
    const r = id ? db.recetas.find(x => x.id === id) : { id: generateID(), n: '', pvp: 0, time: 10, items: [], sales: 0, unit: 'ud', inst: '' }; 
    tempItems = JSON.parse(JSON.stringify(r.items)); 
    
    showModal('Ficha T√©cnica 3.0', `
    <div class="grid grid-cols-12 gap-3 mb-4">
        <div class="col-span-8">
            <label>Nombre del Plato / Elaboraci√≥n</label>
            <input id="er-n" value="${clean(r.n)}" class="input-premium font-bold text-lg" placeholder="Ej: Salsa Brava">
        </div>
        <div class="col-span-4">
            <label>PVP (‚Ç¨)</label>
            <input type="number" id="er-pvp" value="${r.pvp}" class="input-premium text-center">
        </div>
    </div>
    
    <div class="flex gap-4 mb-4">
        <div class="flex-1">
            <label>Tiempo Elaboraci√≥n (min)</label>
            <input type="number" id="er-time" value="${r.time}" class="input-premium">
        </div>
        <div class="flex-1">
            <label>Raciones Resultantes</label>
            <input type="number" id="er-yield" value="1" disabled class="input-premium bg-slate-100 text-slate-400" title="Pr√≥ximamente">
        </div>
    </div>

    <div class="bg-slate-50 p-3 rounded-xl border border-slate-200 mb-4">
        <div class="flex gap-2 mb-2 text-xs font-bold text-slate-500 uppercase tracking-widest">
            <label class="flex items-center gap-1 cursor-pointer">
                <input type="radio" name="itemType" value="ing" checked onclick="toggleRecType('ing')"> Ingrediente
            </label>
            <label class="flex items-center gap-1 cursor-pointer">
                <input type="radio" name="itemType" value="rec" onclick="toggleRecType('rec')"> Sub-Receta
            </label>
        </div>
        
        <div class="flex gap-2 items-center">
            <div class="flex-1">
                <select id="er-sel" class="input-premium mb-0 text-sm"></select>
            </div>
            <div class="w-20">
                <input id="er-q" type="number" class="input-premium mb-0 text-center" placeholder="Cant">
            </div>
            <div class="w-16">
                <input id="er-m" type="number" class="input-premium mb-0 text-center" placeholder="Merma%">
            </div>
            <button class="bg-indigo-600 text-white rounded-lg w-10 h-10 flex items-center justify-center font-bold shadow-lg shadow-indigo-200" onclick="addItemToRec()">+</button>
        </div>
        <div class="text-[10px] text-slate-400 mt-1 pl-1" id="type-hint">Selecciona materia prima del almac√©n</div>
    </div>

    <div class="bg-white border border-slate-100 rounded-xl mb-4 max-h-48 overflow-y-auto" id="er-list"></div>

    <label class="font-bold text-slate-700 text-sm">Instrucciones de Elaboraci√≥n</label>
    <textarea id="er-inst" rows="4" class="input-premium mb-4 text-sm" placeholder="1. Cortar la cebolla...">${clean(r.inst || '')}</textarea>

    <div class="grid grid-cols-2 gap-3 mt-4">
        <button class="btn-premium" onclick="saveRec('${r.id}')">GUARDAR FICHA</button>
        ${id ? `<button class="btn-ghost text-red-400" onclick="deleteRec('${id}')">ELIMINAR</button>` : ''}
    </div>
    `);
    
    toggleRecType('ing'); // Cargar ingredientes por defecto
    renderRecItems(); 
}

function toggleRecType(type) {
    const sel = document.getElementById('er-sel');
    const hint = document.getElementById('type-hint');
    const radioRec = document.querySelector('input[value="rec"]');
    const radioIng = document.querySelector('input[value="ing"]');
    
    // Sincronizar UI si se llama program√°ticamente
    if(type === 'ing') radioIng.checked = true;
    else radioRec.checked = true;

    if (type === 'ing') {
        sel.innerHTML = db.ingredientes.sort((a,b)=>a.n.localeCompare(b.n))
            .map(i => `<option value="${i.id}">${clean(i.n)} (${i.unit})</option>`).join('');
        hint.innerText = "A√±adiendo Materia Prima desde Almac√©n";
        document.getElementById('er-m').disabled = false;
    } else {
        // Filtrar para no poder a√±adirse a s√≠ misma (si estamos editando)
        // Nota: `tempItems` no tiene el ID de la receta actual, es una variable global. 
        // Para simplificar, mostramos todas. `calcRecipe` evita el bucle infinito.
        sel.innerHTML = db.recetas.sort((a,b)=>a.n.localeCompare(b.n))
            .map(r => `<option value="${r.id}">ü•£ ${clean(r.n)}</option>`).join('');
        hint.innerText = "A√±adiendo otra receta como ingrediente (Ej: Salsa Base)";
        document.getElementById('er-m').disabled = true; // Subreceta no suele tener merma al a√±adirla, ya est√° elaborada
        document.getElementById('er-m').value = 0;
    }
    // Guardamos el tipo actual en el dataset del select para usarlo al a√±adir
    sel.dataset.type = type;
}

function addItemToRec() { 
    const sel = document.getElementById('er-sel');
    const id = sel.value; 
    const type = sel.dataset.type || 'ing';
    const q = parseFloat(document.getElementById('er-q').value); 
    const m = parseFloat(document.getElementById('er-m').value) || 0; 
    
    if (id && q > 0) { 
        tempItems.push({ type, id, q, merma: m }); 
        renderRecItems(); 
        document.getElementById('er-q').value = '';
    } 
}

function renderRecItems() { 
    document.getElementById('er-list').innerHTML = tempItems.map((it, i) => { 
        let name = "???";
        let icon = "üì¶";
        if(it.type === 'ing') {
            const ing = db.ingredientes.find(x => x.id === it.id);
            name = ing ? ing.n : 'Borrado';
        } else {
            const rec = db.recetas.find(x => x.id === it.id);
            name = rec ? rec.n : 'Borrado';
            icon = "ü•£";
        }
        
        return `
        <div class="flex justify-between items-center text-sm border-b border-slate-50 p-3 hover:bg-slate-50 transition">
            <div class="flex items-center gap-2">
                <span class="text-base">${icon}</span>
                <div>
                    <div class="font-bold text-slate-700">${clean(name)}</div>
                    <div class="text-[10px] text-slate-400">Cant: ${it.q} ¬∑ Merma: ${it.merma}%</div>
                </div>
            </div>
            <button onclick="tempItems.splice(${i},1);renderRecItems()" class="text-red-400 hover:bg-red-50 p-1 rounded">‚úï</button>
        </div>`; 
    }).join(''); 
}

function saveRec(id) { 
    const idx = db.recetas.findIndex(x => x.id === id); 
    const r = { 
        id, 
        n: document.getElementById('er-n').value, 
        pvp: parseFloat(document.getElementById('er-pvp').value), 
        time: parseFloat(document.getElementById('er-time').value), 
        items: tempItems, 
        inst: document.getElementById('er-inst').value, // Guardar instrucciones
        sales: (db.recetas.find(x => x.id === id)?.sales || 0) 
    }; 
    
    if(!r.n) return toast("Falta el nombre", "error");

    if (idx >= 0) db.recetas[idx] = r; 
    else db.recetas.push(r); 
    
    save("Ficha Guardada"); 
    closeModal(); 
    render('Cocina'); 
}

function deleteRec(id) { 
    if (confirm("¬øEliminar ficha? Esto podr√≠a afectar a otras recetas que la usen.")) { 
        db.recetas = db.recetas.filter(x => x.id !== id); 
        save("Eliminada"); 
        closeModal(); 
        render('Cocina'); 
    } 
}

function viewRec(id) { 
    const r = db.recetas.find(x => x.id === id); 
    const c = calcRecipe(r); 
    
    // C√°lculos de m√°rgenes
    const pvp = r.pvp || 0;
    const profit = pvp - c.t;
    const foodCost = pvp > 0 ? (c.t / pvp) * 100 : 0;
    
    // Colores sem√°foro
    let semColor = 'text-slate-400';
    if(pvp > 0) {
        if(foodCost < 30) semColor = 'text-emerald-500';
        else if(foodCost < 40) semColor = 'text-orange-500';
        else semColor = 'text-red-500';
    }

    showModal(clean(r.n), `
    <div class="grid grid-cols-3 gap-2 mb-6">
        <div class="bg-slate-50 p-3 rounded-xl text-center border border-slate-100">
            <div class="text-[10px] text-slate-400 font-bold uppercase">Coste</div>
            <div class="text-xl font-black text-slate-800">${Num.fmt(c.t)}‚Ç¨</div>
        </div>
        <div class="bg-slate-50 p-3 rounded-xl text-center border border-slate-100">
            <div class="text-[10px] text-slate-400 font-bold uppercase">PVP</div>
            <div class="text-xl font-black text-slate-800">${Num.fmt(pvp)}‚Ç¨</div>
        </div>
        <div class="bg-slate-50 p-3 rounded-xl text-center border border-slate-100">
            <div class="text-[10px] text-slate-400 font-bold uppercase">Food Cost</div>
            <div class="text-xl font-black ${semColor}">${foodCost.toFixed(1)}%</div>
        </div>
    </div>

    <div class="mb-6">
        <h4 class="font-bold text-slate-800 text-xs uppercase mb-2 border-b pb-1">Ingredientes & Subrecetas</h4>
        <ul class="text-sm space-y-2">
            ${r.items.map(it => {
                let n = "???", detail = "";
                if(it.type === 'ing') {
                    const i = db.ingredientes.find(x=>x.id===it.id);
                    n = i ? i.n : 'Eliminado';
                    detail = `${it.q} ${i?.unit || 'ud'}`;
                } else {
                    const rec = db.recetas.find(x=>x.id===it.id);
                    n = rec ? `ü•£ ${rec.n}` : 'Eliminado';
                    detail = `${it.q} ud`;
                }
                return `<li class="flex justify-between text-slate-600"><span>${n}</span> <span class="font-mono font-bold text-slate-400">${detail}</span></li>`;
            }).join('')}
        </ul>
        <div class="mt-2 text-right text-xs text-slate-400 italic">+ Mano de obra (${r.time} min)</div>
    </div>

    ${r.inst ? `
    <div class="mb-6 bg-yellow-50 p-4 rounded-xl border border-yellow-100 relative">
        <div class="absolute -top-2 left-4 bg-yellow-100 text-yellow-700 text-[10px] font-bold px-2 rounded">ELABORACI√ìN</div>
        <p class="text-sm text-slate-700 whitespace-pre-line leading-relaxed">${clean(r.inst)}</p>
    </div>` : ''}

    <div class="flex flex-wrap gap-2 mb-6 justify-center">
        ${c.all.map(k=>`<span class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-xs border border-blue-100 font-bold">${ALLERGENS.find(a=>a.k==k)?.i} ${ALLERGENS.find(a=>a.k==k)?.n}</span>`).join('')}
    </div>
    
    <button class="btn-ghost w-full" onclick="editRec('${r.id}')">‚úèÔ∏è EDITAR FICHA T√âCNICA</button>
    `); 
}
/* ================= 8. STOCK PRO (V144) ================= */
const FAMILIES = ['General', 'Carne', 'Pescado', 'Verdura', 'Secos', 'L√°cteos', 'Congelado', 'Bebida', 'Alcohol', 'Limpieza', 'Packaging'];
let activeFamily = 'Todos';

function renderStock(app) {
    const isAdmin = currentUser?.role === 'admin';
    
    // Filtro combinado: Texto + Familia
    let filtered = db.ingredientes.filter(i => 
        i.n.toLowerCase().includes(searchFilter.toLowerCase())
    );
    
    if (activeFamily !== 'Todos') {
        filtered = filtered.filter(i => (i.fam || 'General') === activeFamily);
    }
    
    // Ordenar alfab√©ticamente
    filtered.sort((a,b) => a.n.localeCompare(b.n));

    // Calcular Valor del Inventario (Dinero en estanter√≠as)
    const totalStockValue = filtered.reduce((acc, i) => acc + (i.stock * i.cost), 0);

    // Generar botones de categor√≠as (Chips)
    const catChips = ['Todos', ...FAMILIES].map(cat => 
        `<button class="px-3 py-1 rounded-full text-[10px] font-bold border transition whitespace-nowrap 
        ${activeFamily===cat ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-100'}" 
        onclick="activeFamily='${cat}';render('Stock')">${cat}</button>`
    ).join('');

    app.innerHTML = `
        <div class="glass-card">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-slate-800">ALMAC√âN</h3>
                <div class="flex gap-2">
                    <button class="btn-whatsapp text-xs font-bold px-3 py-1 rounded-lg border-0" onclick="sendWhatsApp()">üìû PEDIDO</button>
                    <button class="bg-emerald-50 text-emerald-600 px-3 py-1 rounded-lg text-xs font-bold border border-emerald-200" onclick="toggleInventoryMode()">
                        ${inventoryMode ? '‚ùå SALIR' : 'üìã AUDITOR√çA'}
                    </button>
                </div>
            </div>
            
            <input placeholder="üîç Buscar..." onkeyup="searchFilter=this.value;render('Stock')" value="${searchFilter}" class="input-premium mb-2">
            
            <div class="flex gap-2 overflow-x-auto pb-2 mb-2 no-scrollbar">
                ${catChips}
            </div>

            <div class="max-h-[55vh] overflow-y-auto pr-1 space-y-2">
                ${filtered.map(i => { 
                    const lowStock = i.stock < (i.min||0);
                    const famLabel = i.fam && i.fam !== 'General' ? `<span class="text-[8px] bg-slate-100 text-slate-500 px-1 rounded ml-1 uppercase tracking-wider">${i.fam}</span>` : '';
                    
                    if(inventoryMode) { 
                        return `
                        <div class="bg-white p-3 rounded-xl border-2 ${lowStock?'border-red-100':'border-slate-100'} flex justify-between items-center">
                            <div class="flex-1">
                                <div class="font-bold text-slate-800 flex items-center">${clean(i.n)} ${famLabel}</div>
                                <div class="text-xs text-slate-400">Te√≥rico: ${i.stock} ${i.unit}</div>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="number" id="real-stock-${i.id}" placeholder="${i.stock}" class="w-20 bg-indigo-50 border border-indigo-200 rounded p-2 text-center font-bold text-indigo-700 outline-none">
                                <span class="text-xs font-bold text-slate-500 w-6">${i.unit}</span>
                                <button class="btn-icon bg-emerald-100 text-emerald-600 hover:bg-emerald-200" onclick="adjustStock('${i.id}')">‚úî</button>
                            </div>
                        </div>`; 
                    } else { 
                        return `
                        <div class="bg-white p-3 rounded-xl border ${lowStock?'border-red-300 bg-red-50/30':'border-slate-100'} flex justify-between items-center group relative">
                            <div onclick="showKardex('${i.id}')" class="flex-1 cursor-pointer">
                                <div class="font-bold text-slate-800 flex items-center">${clean(i.n)} ${famLabel}</div>
                                <div class="text-xs text-slate-500 flex items-center gap-1 mt-1">
                                    ${(i.aller||[]).map(k=>`<span class="aller-tag">${ALLERGENS.find(a=>a.k==k)?.i}</span>`).join('')}
                                    <span class="font-mono font-bold ${lowStock?'text-red-600':''} bg-slate-50 px-1 rounded border border-slate-200">
                                        ${parseFloat(i.stock).toFixed(2)} ${i.unit}
                                    </span> 
                                    ${isAdmin ? `<span class="text-[10px] ml-1">x ${Num.fmt(i.cost)}‚Ç¨ = <b>${Num.fmt(i.stock*i.cost)}‚Ç¨</b></span>` : ''}
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button class="btn-icon btn-merma" onclick="regMerma('${i.id}')">üìâ</button>
                                ${isAdmin ? `<button class="btn-icon btn-log" onclick="showKardex('${i.id}')">üìú</button>` : ''}
                                <button class="btn-icon bg-slate-50 text-slate-400 hover:text-indigo-600" onclick="editIng('${i.id}')">‚úèÔ∏è</button>
                            </div>
                        </div>`; 
                    } 
                }).join('')}
                
                ${filtered.length === 0 ? '<div class="text-center p-4 text-slate-400 text-xs">Nada por aqu√≠...</div>' : ''}
            </div>
            
            ${isAdmin && !inventoryMode ? `
                <div class="mt-4 flex justify-between items-center bg-slate-900 text-white p-3 rounded-xl shadow-lg">
                    <div class="text-xs font-bold text-slate-400 uppercase tracking-widest">Valor Inventario</div>
                    <div class="text-xl font-black">${Num.fmt(totalStockValue)}‚Ç¨</div>
                </div>
                <button class="btn-premium mt-4" onclick="editIng(generateID())">+ A√ëADIR PRODUCTO</button>
            ` : ''}
        </div>`;
}

function sendWhatsApp() { 
    // Filtramos solo los que est√°n por debajo del m√≠nimo Y (opcional) de la categor√≠a activa
    let listItems = db.ingredientes.filter(i => i.stock < (i.min || 0));
    
    if(activeFamily !== 'Todos') {
        listItems = listItems.filter(i => (i.fam || 'General') === activeFamily);
    }

    const list = listItems.map(i => `- ${i.n}: Pedir ${((i.min||0) - i.stock + (i.min*0.2)).toFixed(2)} ${i.unit}`).join('%0A'); 
    
    if(!list) return toast("Todo el Stock OK", "success"); 
    
    const title = activeFamily !== 'Todos' ? `PEDIDO ${activeFamily.toUpperCase()}` : 'PEDIDO GENERAL';
    window.open(`https://wa.me/?text=${encodeURIComponent(`üõí *${title} ARUME*\n\n`)}${list}`, '_blank'); 
}

function toggleInventoryMode() { inventoryMode = !inventoryMode; render('Stock'); }

function adjustStock(id) { 
    const realQty = Num.parse(document.getElementById(`real-stock-${id}`).value); 
    const i = db.ingredientes.find(x => x.id === id); 
    if (!isNaN(realQty) && i) { 
        const diff = realQty - i.stock; 
        if (diff !== 0) { 
            logStock(i.id, Math.abs(diff), 'ADJ', 'Inventario Real', i.cost); 
            i.stock = realQty; 
            save("Ajustado"); 
            render('Stock'); 
        } 
    } 
}

function showKardex(id) { 
    if (currentUser.role !== 'admin') return; 
    const i = db.ingredientes.find(x => x.id === id); 
    const logs = db.kardex.filter(k => k.ingId === id).reverse().slice(0, 50); 
    showModal(`Kardex: ${clean(i.n)}`, `
        <div class="text-xs text-slate-400 mb-2 font-bold uppercase">Movimientos recientes</div>
        <div class="max-h-60 overflow-y-auto bg-slate-50 rounded-xl p-2 border border-slate-100">
            ${logs.map(l => `
                <div class="flex justify-between py-2 border-b border-slate-200 last:border-0">
                    <div>
                        <div class="font-bold text-slate-700">${l.date}</div>
                        <div class="text-[10px] text-slate-500">${l.reason}</div>
                    </div>
                    <div class="text-right">
                        <div class="${l.type==='IN'?'text-emerald-500':'text-red-500'} font-bold">
                            ${l.type==='IN'?'+':'-'} ${l.qty} ${l.unit}
                        </div>
                        <div class="text-[10px] text-slate-400">${Num.fmt(l.price)}‚Ç¨/ud</div>
                    </div>
                </div>`).join('')}
        </div>`); 
}

function regMerma(id) { 
    const i = db.ingredientes.find(x => x.id === id); 
    showModal('Merma', `
        <p class="text-sm text-slate-500 mb-4">Producto: <b>${clean(i.n)}</b></p>
        <label>Cantidad Perdida (${i.unit})</label>
        <input type="number" id="m-q" class="input-premium">
        <label>Motivo</label>
        <select id="m-r" class="input-premium"><option>Caducidad</option><option>Rotura</option><option>Error Cocina</option><option>Consumo Personal</option></select>
        <button class="btn-premium btn-danger mt-4 border-0" onclick="saveMerma('${id}')">REGISTRAR P√âRDIDA</button>
    `); 
}

function saveMerma(id) { 
    const i = db.ingredientes.find(x => x.id === id); 
    const q = parseFloat(document.getElementById('m-q').value); 
    const r = document.getElementById('m-r').value; 
    if (q > 0) { 
        i.stock -= q; 
        db.mermas.push({ date: getISO(), n: i.n, q, reason: r, loss: q * i.cost }); 
        logStock(i.id, q, 'OUT', `Merma: ${r}`); 
        save("Merma registrada"); 
        closeModal(); 
        render('Stock'); 
    } 
}

function editIng(id) { 
    const i = db.ingredientes.find(x => x.id === id) || { id, n: '', cost: 0, stock: 0, min: 0, unit: 'kg', fam: 'General', aller: [] }; 
    
    // Generador de opciones de familia
    const famOptions = FAMILIES.map(f => `<option value="${f}" ${i.fam===f?'selected':''}>${f}</option>`).join('');

    showModal('Ficha Almac√©n', `
        <label>Nombre del Producto</label>
        <input id="ei-n" value="${clean(i.n)}" class="input-premium" placeholder="Ej: Harina Trigo">
        
        <label>Familia / Categor√≠a</label>
        <select id="ei-fam" class="input-premium mb-4">${famOptions}</select>

        <div class="grid grid-cols-3 gap-2">
            <div><label>Coste/Ud (‚Ç¨)</label><input id="ei-c" type="number" value="${i.cost}" class="input-premium"></div>
            <div><label>Stock Actual</label><input id="ei-s" type="number" value="${i.stock}" class="input-premium"></div>
            <div><label>Stock M√≠nimo</label><input id="ei-m" type="number" value="${i.min || 0}" class="input-premium"></div>
        </div>
        
        <label>Unidad Base</label>
        <select id="ei-unit" class="input-premium">
            <option ${i.unit === 'kg' ? 'selected' : ''} value="kg">kg (Kilos)</option>
            <option ${i.unit === 'g' ? 'selected' : ''} value="g">g (Gramos)</option>
            <option ${i.unit === 'l' ? 'selected' : ''} value="l">l (Litros)</option>
            <option ${i.unit === 'ml' ? 'selected' : ''} value="ml">ml (Mililitros)</option>
            <option ${i.unit === 'ud' ? 'selected' : ''} value="ud">ud (Unidad)</option>
        </select>
        
        <label>Al√©rgenos</label>
        <div class="flex flex-wrap gap-2 mt-2">
            ${ALLERGENS.map(a => `
                <div class="p-2 border rounded-lg cursor-pointer transition select-none flex items-center gap-1 ${i.aller.includes(a.k) ? 'bg-indigo-100 border-indigo-500 text-indigo-700' : 'bg-white border-slate-200 text-slate-400'}" 
                onclick="this.classList.toggle('bg-indigo-100');this.classList.toggle('border-indigo-500');this.classList.toggle('text-indigo-700');this.classList.toggle('bg-white');this.classList.toggle('text-slate-400');this.classList.toggle('active')">
                    <span class="text-lg">${a.i}</span>
                </div>
            `).join('')}
        </div>
        
        <div class="flex gap-3 mt-6">
            <button class="btn-premium flex-1" onclick="saveIng('${i.id}')">GUARDAR</button>
            ${db.ingredientes.find(x => x.id === id) ? `<button class="btn-icon btn-delete w-auto px-4" onclick="deleteIng('${id}')">üóëÔ∏è</button>` : ''}
        </div>
    `); 
    
    // Marcar al√©rgenos activos visualmente (hack r√°pido para el modal)
    setTimeout(() => { 
        const divs = document.querySelectorAll('#m-body .flex div'); 
        i.aller.forEach(k => { 
            const idx = ALLERGENS.findIndex(a => a.k === k); 
            if (divs[idx]) divs[idx].classList.add('active'); // Clase l√≥gica para el guardado
        }); 
    }, 50); 
}

function saveIng(id) { 
    // Recoger al√©rgenos
    const divs = document.querySelectorAll('#m-body .flex div'); 
    const aller = []; 
    divs.forEach((d, i) => { 
        if (d.classList.contains('active')) aller.push(ALLERGENS[i].k) 
    }); 
    
    const ing = { 
        id, 
        n: document.getElementById('ei-n').value, 
        fam: document.getElementById('ei-fam').value, // Guardar familia
        cost: parseFloat(document.getElementById('ei-c').value), 
        stock: parseFloat(document.getElementById('ei-s').value), 
        min: parseFloat(document.getElementById('ei-m').value), 
        unit: document.getElementById('ei-unit').value || 'kg', 
        aller 
    }; 
    
    const idx = db.ingredientes.findIndex(x => x.id === id); 
    if (idx >= 0) db.ingredientes[idx] = ing; 
    else db.ingredientes.push(ing); 
    
    save(); 
    closeModal(); 
    render('Stock'); 
}

function deleteIng(id) { 
    if (confirm("¬øEliminar producto del almac√©n?")) { 
        db.ingredientes = db.ingredientes.filter(i => i.id !== id); 
        save("Borrado"); 
        closeModal(); 
        render('Stock'); 
    } 
}
/* ================= 9. DIARIO & CAJA V141 ================= */
function renderDiario(app){
    const r = db.diario.find(d => d.date === currentDiarioDate) || { cash:0, visa:0, tpv:0, amex:0, glovo:0, uber:0, apper:0, expenses:0 };
    const totalVenta = (r.cash||0) + (r.visa||0) + (r.tpv||0) + (r.amex||0) + (r.glovo||0) + (r.uber||0) + (r.apper||0);
    const realCash = (r.cash||0) - (r.expenses||0);
    const historyRows = db.diario.filter(d => isInPeriod(d.date)).sort((a,b) => b.date.localeCompare(a.date)).map(d => `<div class="flex justify-between items-center py-2 border-b text-sm ${d.date===currentDiarioDate?'bg-indigo-50 -mx-2 px-2 rounded':''}"> <div class="font-bold text-slate-700 cursor-pointer" onclick="currentDiarioDate='${d.date}';render('Diario')">${d.date}</div> <div class="font-mono font-bold">${Num.fmt(d.total)}‚Ç¨</div> </div>` ).join('');

    app.innerHTML = `
    <div class="glass-card"><div class="section-header flex justify-between items-center mb-6"><h3 class="font-bold text-slate-800">CIERRE CAJA</h3><input type="date" value="${currentDiarioDate}" class="bg-slate-100 border-0 rounded p-1 font-bold text-indigo-600" onchange="currentDiarioDate=this.value;render('Diario')"></div>
    <div class="space-y-4">
        <div class="bg-emerald-50/50 p-4 rounded-xl border border-emerald-100"><div class="text-xs font-bold text-emerald-800 mb-2 uppercase tracking-wider">Efectivo</div><div class="grid grid-cols-2 gap-4"><div><label>Venta Efectivo</label><input type="number" id="z-cash" value="${r.cash||0}" class="input-premium text-center font-bold" oninput="calcTotal()" onclick="this.select()"></div><div><label class="text-red-500">Gastos Caja</label><input type="number" id="z-expenses" value="${r.expenses||0}" class="input-premium text-center text-red-600 font-bold" oninput="calcTotal()" onclick="this.select()"></div></div><div class="text-right mt-2 text-xs font-bold text-emerald-700">En Caj√≥n: <span id="z-real-cash">${Num.fmt(realCash)}</span>‚Ç¨</div></div>
        <div class="bg-blue-50/50 p-4 rounded-xl border border-blue-100"><div class="text-xs font-bold text-blue-800 mb-2 uppercase tracking-wider">Tarjetas</div><div class="grid grid-cols-3 gap-2"><div><label>Visa</label><input type="number" id="z-visa" value="${r.visa||0}" class="input-premium text-center" oninput="calcTotal()" onclick="this.select()"></div><div><label>TPV</label><input type="number" id="z-tpv" value="${r.tpv||0}" class="input-premium text-center" oninput="calcTotal()" onclick="this.select()"></div><div><label>Amex</label><input type="number" id="z-amex" value="${r.amex||0}" class="input-premium text-center" oninput="calcTotal()" onclick="this.select()"></div></div></div>
        <div class="bg-orange-50/50 p-4 rounded-xl border border-orange-100"><div class="text-xs font-bold text-orange-800 mb-2 uppercase tracking-wider">Delivery</div><div class="grid grid-cols-3 gap-2"><div><label>Glovo</label><input type="number" id="z-glovo" value="${r.glovo||0}" class="input-premium text-center" oninput="calcTotal()" onclick="this.select()"></div><div><label>Uber</label><input type="number" id="z-uber" value="${r.uber||0}" class="input-premium text-center" oninput="calcTotal()" onclick="this.select()"></div><div><label>Apper</label><input type="number" id="z-apper" value="${r.apper||0}" class="input-premium text-center" oninput="calcTotal()" onclick="this.select()"></div></div></div>
        <div class="flex justify-between items-center pt-4 border-t border-slate-200"><span class="font-bold text-slate-400">VENTA TOTAL</span><span id="z-total-display" class="text-4xl font-black text-indigo-600">${Num.fmt(totalVenta)}‚Ç¨</span></div>
    </div><button class="btn-premium mt-6" onclick="saveZ()">GUARDAR CIERRE</button></div>
    <div class="glass-card"><h3 class="font-bold text-xs text-slate-400 mb-4 uppercase">Hist√≥rico (${fiscalQuarter===0?'A√ëO':fiscalQuarter+'T'})</h3><div class="max-h-60 overflow-y-auto mb-4">${historyRows}</div><button class="btn-ghost w-full" onclick="exportDiarioCSV()">üìä DESCARGAR EXCEL CAJAS</button></div>`;
}
function calcTotal() { const v = (id) => Num.parse(document.getElementById(id).value); const cash = v('z-cash'), exp = v('z-expenses'); const total = cash + v('z-visa') + v('z-tpv') + v('z-amex') + v('z-glovo') + v('z-uber') + v('z-apper'); document.getElementById('z-total-display').innerText = Num.fmt(total)+'‚Ç¨'; document.getElementById('z-real-cash').innerText = Num.fmt(cash - exp); }
function saveZ(){ const v = (id) => Num.parse(document.getElementById(id).value); const data = { date: currentDiarioDate, cash: v('z-cash'), expenses: v('z-expenses'), visa: v('z-visa'), tpv: v('z-tpv'), amex: v('z-amex'), glovo: v('z-glovo'), uber: v('z-uber'), apper: v('z-apper'), total: v('z-cash') + v('z-visa') + v('z-tpv') + v('z-amex') + v('z-glovo') + v('z-uber') + v('z-apper') }; const idx = db.diario.findIndex(d => d.date === currentDiarioDate); if(idx>=0) db.diario[idx] = data; else db.diario.push(data); save("Cierre Guardado"); render('Diario'); }
function exportDiarioCSV() { if(!db.diario.length) return toast("Vac√≠o", "error"); const header = ['Fecha', 'Efectivo', 'Gastos', 'Visa', 'TPV', 'Amex', 'Glovo', 'Uber', 'Apper', 'Total']; const rows = db.diario.filter(d=>isInPeriod(d.date)).sort((a,b)=>b.date.localeCompare(a.date)).map(d => [d.date, Num.csv(d.cash), Num.csv(d.expenses), Num.csv(d.visa), Num.csv(d.tpv), Num.csv(d.amex), Num.csv(d.glovo), Num.csv(d.uber), Num.csv(d.apper), Num.csv(d.total)]); const csv = [header.join(';'), ...rows.map(r=>r.join(';'))].join('\n'); const blob = new Blob(["\uFEFF"+csv], {type:'text/csv;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`Cajas_${fiscalYear}_Q${fiscalQuarter}.csv`; a.click(); }

/* ================= 10. UTILS & BACKUP ================= */
function showModal(t,c){ document.getElementById('m-title').innerText=t; document.getElementById('m-body').innerHTML=c; document.getElementById('modal-overlay').classList.remove('hidden'); }
function closeModal(){ document.getElementById('modal-overlay').classList.add('hidden'); }
function downloadBackup(){ if(currentUser.role!=='admin') return toast("‚õî Solo Gerencia", "error"); const data = secure.enc(db); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([data], {type: 'text/plain'})); a.download = `Arume_Backup_${getISO()}.arume`; a.click(); }
function restoreBackup(input){ 
    const r = new FileReader(); 
    r.onload = e => { 
        try { 
            const d = secure.dec(e.target.result); 
            if(d && d.users) { 
                db=d; 
                save("Restaurado correctamente"); 
                // No usar reload, repintar
                loadApp();
            } else throw new Error(); 
        } catch(err) { toast("Archivo corrupto", "error"); } 
    }; 
    r.readAsText(input.files[0]); 
}

/* ================= INIT ================= */
init();
</script>
</body>
</html>
