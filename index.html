<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>ARUME V52 ¬∑ Financial Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg: #f8fafc; --paper: #ffffff; --text: #0f172a; --sub: #64748b;
            --primary: #0f172a; --accent: #2563eb; 
            --success: #16a34a; --danger: #dc2626; --warn: #d97706;
            --border: #e2e8f0; --radius: 12px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 110px; min-height: 100vh; }

        /* HEADER */
        header { background: var(--paper); padding: 15px 20px; position: sticky; top: 0; z-index: 50; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        h1 { margin: 0; font-size: 1.3rem; font-weight: 900; letter-spacing: -0.5px; color: var(--primary); display:flex; align-items:center; gap:8px; }
        .badge { padding: 6px 12px; border-radius: 99px; font-size: 0.75rem; background: #f1f5f9; color: var(--text); font-weight: 700; border: 1px solid var(--border); cursor: pointer; display: flex; align-items:center; gap:8px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; } .dot.ok { background: var(--success); box-shadow: 0 0 6px var(--success); }

        /* LAYOUT */
        main { max-width: 900px; margin: 0 auto; padding: 20px; animation: fade 0.3s ease-out; }
        @keyframes fade { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
        
        .card { background: var(--paper); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .section-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f8fafc; padding-bottom: 12px; margin-bottom: 15px; }
        .title { font-size: 0.85rem; font-weight: 900; color: var(--primary); text-transform: uppercase; letter-spacing: 0.5px; }
        .row { display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; } .col { flex: 1; min-width: 140px; }

        /* KPIs FINANCIEROS */
        .kpi-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .kpi-card { flex:1; background: var(--primary); color: white; padding: 15px; border-radius: var(--radius); text-align: center; }
        .kpi-val { font-size: 1.4rem; font-weight: 900; }
        .kpi-lbl { font-size: 0.7rem; opacity: 0.8; text-transform: uppercase; margin-top: 4px; }

        /* LISTAS & TABLAS */
        .table-wrap { overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 100%; }
        th { text-align: left; background: #f8fafc; color: var(--sub); padding: 12px 10px; font-size: 0.7rem; text-transform: uppercase; border-bottom: 1px solid var(--border); }
        td { padding: 14px 10px; border-bottom: 1px solid #f1f5f9; white-space: nowrap; }
        tr:last-child td { border: none; }
        
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 16px 10px; border-bottom: 1px solid #f1f5f9; transition: 0.1s; cursor: pointer; }
        .list-item:active { background: #f1f5f9; }
        .list-item:last-child { border: none; }

        /* INPUTS */
        label { display: block; font-size: 0.7rem; font-weight: 700; color: var(--sub); margin-bottom: 5px; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; font-size: 15px; background: #fff; font-family: inherit; margin-bottom: 10px; outline: none; }
        input:focus, select:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px #bfdbfe; }
        .search-bar { background: #fff; border: 1px solid var(--border); margin-bottom: 15px; box-shadow: 0 4px 6px -2px rgba(0,0,0,0.03); padding: 10px; border-radius:10px; }

        /* BOTONES */
        .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; font-size: 1rem; text-align: center; margin-top: 5px; transition: 0.1s; display: inline-flex; justify-content:center; align-items:center; gap:8px; }
        .btn:active { transform: scale(0.97); opacity: 0.9; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-accent { background: var(--accent); color: white; }
        .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        .btn-sm { width: auto; padding: 8px 16px; font-size: 0.8rem; margin: 0; }
        
        .status-btn { padding: 6px 12px; border-radius: 8px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; cursor: pointer; border: none; transition: 0.2s; }
        .status-btn.paid { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .status-btn.pending { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }

        /* ALBARAN GRID */
        .alb-row { display: flex; gap: 5px; margin-bottom: 8px; align-items: center; background: #fff; border: 1px solid #f1f5f9; padding: 5px; border-radius: 8px; }
        .alb-row input { margin: 0; padding: 8px; font-size: 0.9rem; }
        .alb-name { flex: 3; min-width: 120px; }
        .alb-num { flex: 1; min-width: 50px; text-align: right; }

        /* NAV */
        nav { position: fixed; bottom: 0; width: 100%; background: rgba(255,255,255,0.96); backdrop-filter: blur(8px); border-top: 1px solid var(--border); display: flex; justify-content: space-around; gap:4px; padding:6px; z-index:60; }
        nav button { background: none; border: none; flex: 1; display: flex; flex-direction: column; align-items: center; gap: 5px; color: var(--sub); font-size: 0.65rem; font-weight: 700; padding: 5px 8px; border-radius:8px; }
        nav button.active { opacity: 1; color: var(--accent); transform: translateY(-3px); }
        nav button svg { width: 26px; height: 26px; fill: currentColor; }

        /* MODAL */
        .hidden { display: none !important; }
        .overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); z-index: 100; backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; }
        .modal { background: white; width: 95%; max-width: 700px; max-height: 90vh; overflow-y: auto; padding: 25px; border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }

        /* PIN PAD */
        #pin-screen { background: #0f172a; color: white; }
        .pin-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 30px; max-width: 320px; margin-left: auto; margin-right: auto; }
        .pin-btn { height: 75px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); font-size: 1.8rem; color: white; cursor: pointer; font-weight: 600; }
        .pin-btn:active { background: rgba(255,255,255,0.2); }

        /* TOAST */
        #toast-container { position: fixed; bottom: 110px; left: 50%; transform: translateX(-50%); z-index: 200; width: 90%; max-width: 400px; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: #1e293b; color: white; padding: 14px 20px; border-radius: 12px; font-size: 0.95rem; font-weight: 600; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); animation: slideUp 0.3s ease forwards; pointer-events: auto; }
        .toast.success { border-bottom: 4px solid var(--success); }
        .toast.error { border-bottom: 4px solid var(--danger); }
        @keyframes slideUp { from{opacity:0; transform:translateY(20px) translateX(-50%)} to{opacity:1; transform:translateY(0) translateX(-50%)} }

        /* small helpers */
        .matrix-grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; }
        .matrix-box { padding:12px; border-radius:8px; background:#f8fafc; text-align:center; }
    </style>
</head>
<body>

    <div id="toast-container"></div>
    <input type="file" id="backup-input" style="display:none" accept=".json" onchange="restoreBackup(this)">

    <header>
        <h1>ARUME <span style="font-size:0.6em; opacity:0.6; font-weight:400">V52</span></h1>
        <button id="user-display" class="badge" onclick="logout()">
            <div id="sync-dot" class="dot"></div> <span id="user-name">...</span>
        </button>
    </header>

    <main id="app"></main>

    <nav id="navbar"></nav>

    <div id="modal-overlay" class="overlay hidden">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
                <h3 id="m-title" style="margin:0; font-size:1.2rem; font-weight:900; color:var(--primary)"></h3>
                <button onclick="closeModal()" style="background:none;border:none;font-size:2rem;cursor:pointer;color:var(--sub);line-height:1">&times;</button>
            </div>
            <div id="m-body"></div>
        </div>
    </div>

    <div id="pin-screen" class="overlay" style="opacity:1">
        <div class="modal" style="text-align:center; background:transparent; box-shadow:none; color:white">
            <h2 style="font-size:3rem; margin:0; letter-spacing:2px; font-weight:900">ARUME</h2>
            <p style="opacity:0.6; margin-bottom:40px; letter-spacing:1px; text-transform:uppercase">Sistema de Gesti√≥n Integral</p>
            <div id="pin-display" style="font-size:3rem; font-weight:800; letter-spacing:15px; min-height:60px">****</div>
            <div class="pin-grid">
                <button class="pin-btn" onclick="pinInput('1')">1</button><button class="pin-btn" onclick="pinInput('2')">2</button><button class="pin-btn" onclick="pinInput('3')">3</button>
                <button class="pin-btn" onclick="pinInput('4')">4</button><button class="pin-btn" onclick="pinInput('5')">5</button><button class="pin-btn" onclick="pinInput('6')">6</button>
                <button class="pin-btn" onclick="pinInput('7')">7</button><button class="pin-btn" onclick="pinInput('8')">8</button><button class="pin-btn" onclick="pinInput('9')">9</button>
                <button class="pin-btn" style="color:var(--danger); border-color:rgba(239,68,68,0.3)" onclick="pinClear()">C</button>
                <button class="pin-btn" onclick="pinInput('0')">0</button>
                <button class="pin-btn" style="background:var(--success); border:none; color:#022c22" onclick="pinCheck()">OK</button>
            </div>
        </div>
    </div>

<script>
/* ================= 1. CONFIGURACI√ìN ================= */
const generateID = () => crypto.randomUUID ? crypto.randomUUID() : Date.now().toString() + Math.random().toString(36).substring(2);
const CONFIG = { GOOGLE_URL: "https://script.google.com/macros/s/AKfycbxL0hWPiYmQ_590bkFjd1B9xwsfrYQXQtEuUpP2Nraq973bDr2rpEgVnaJCpI3-DH8z/exec", COST_HOUR: 15 };

const DB_INIT = {
    users: [{id:'u1', n:'Gerencia', pin:'0150', role:'admin'}, {id:'u2', n:'Cocina', pin:'1111', role:'staff'}],
    ingredientes: [],
    recetas: [],
    proveedores: [{n:'Makro'}, {n:'Tokyo-ya'}, {n:'Frutas Daniel'}],
    albaranes: [], facturas: [], diario: [], mermas: [], lastSync: 0
};

let db = JSON.parse(localStorage.getItem('arume_v52')) || DB_INIT;
let currentUser = null;
let currentPin = "";
let chartInstance = null;
let tempItems = []; 
let searchFilter = "";

/* ================= 2. CORE UTILS ================= */
function showToast(msg, type='success') {
    const box = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = type==='success' ? `‚úÖ ${msg}` : `‚ùå ${msg}`;
    box.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function init() {
    const u = localStorage.getItem('arume_user');
    if(u) { currentUser=JSON.parse(u); document.getElementById('pin-screen').classList.add('hidden'); loadApp(); }
    if(CONFIG.GOOGLE_URL) sync();
}

function save(msg){
    // Post-save: try to persist to remote (if CORS allows). Update lastSync only on success would be ideal,
    // but we keep a local lastSync timestamp to indicate local change time.
    db.lastSync = Date.now();
    localStorage.setItem('arume_v52', JSON.stringify(db));
    if(CONFIG.GOOGLE_URL) {
        // send data, but endpoint should accept CORS for proper response
        fetch(CONFIG.GOOGLE_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(db)
        }).catch(()=>{ /* ignore network errors for now */ });
    }
    if(msg) showToast(msg, 'success');
}

async function sync(){
    if(!CONFIG.GOOGLE_URL) return;
    try {
        const r = await fetch(CONFIG.GOOGLE_URL);
        if (!r.ok) return;
        const c = await r.json();
        if (c && c.lastSync && c.lastSync > (db.lastSync || 0)) {
            db = c;
            localStorage.setItem('arume_v52', JSON.stringify(db));
            showToast("Datos actualizados");
            setTimeout(()=>location.reload(), 500);
        }
        document.getElementById('sync-dot').classList.add('ok');
    } catch(e){
        // silently ignore; could log to console
        console.warn("Sync error", e);
    }
}

/* ================= 3. AUTH ================= */
function pinInput(n){ if(currentPin.length<4)currentPin+=n; document.getElementById('pin-display').innerText="‚Ä¢".repeat(currentPin.length); }
function pinClear(){ currentPin=""; document.getElementById('pin-display').innerText="PIN"; }
function pinCheck(){
    const u = db.users.find(x=>x.pin===currentPin);
    if(u){ currentUser=u; localStorage.setItem('arume_user',JSON.stringify(u)); document.getElementById('pin-screen').classList.add('hidden'); loadApp(); }
    else { showToast("C√≥digo incorrecto", "error"); pinClear(); }
}
function logout(){ localStorage.removeItem('arume_user'); location.reload(); }

/* ================= 4. UI RENDER ================= */
function loadApp() {
    document.getElementById('user-name').innerText = currentUser.n;
    renderNav();
    render(currentUser.role==='admin'?'Admin':'Diario');
}

function renderNav() {
    const nav = document.getElementById('navbar'); nav.innerHTML='';
    const views = {
        'Diario': {icon:'<path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>', label:'CAJA Z'},
        'Admin': {icon:'<path d="M12 2L3 5v6c0 5 3.8 9.7 9 11 5.2-1.3 9-6 9-11V5l-9-3z"/>', label:'GESTI√ìN'},
        'Cocina': {icon:'<path d="M12 2C8.1 6 7 8 7 11c0 3.9 3.1 7 7 7s7-3.1 7-7c0-3-1.1-5-5-9z"/>', label:'COCINA'},
        'Stock': {icon:'<path d="M3 3h18v2H3V3zm2 4h14v12H5V7zm2 2v8h10V9H7z"/>', label:'STOCK'}
    };
    
    for(const [k,v] of Object.entries(views)){
        if((k==='Admin') && currentUser.role!=='admin') continue;
        const b = document.createElement('button');
        b.innerHTML = `<svg viewBox="0 0 24 24" aria-hidden="true">${v.icon}</svg>${v.label}`;
        b.id = `btn-${k}`; b.onclick = () => { searchFilter=""; render(k); };
        nav.appendChild(b);
    }
}

function render(view) {
    document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
    document.getElementById(`btn-${view}`)?.classList.add('active');
    const app = document.getElementById('app'); app.innerHTML='';

    // --- DIARIO ---
    if(view === 'Diario') {
        const today = new Date().toISOString().split('T')[0];
        const report = db.diario.find(d => d.date === today);
        app.innerHTML = `
        <div class="card">
            <div class="section-header"><div class="title">CIERRE DIARIO</div><div class="title">${today}</div></div>
            <div class="row">
                <div class="col"><label>Total Z (‚Ç¨)</label><input type="number" id="z-total" value="${report?report.total:''}" placeholder="0.00"></div>
                <div class="col"><label>Efectivo</label><input type="number" id="z-cash" value="${report?report.cash:''}" placeholder="0.00"></div>
            </div>
            <div class="row">
                <div class="col"><label>Tarjeta</label><input type="number" id="z-card" value="${report?report.card:''}" placeholder="0.00"></div>
                <div class="col"><label>Invitaciones</label><input type="number" id="z-inv" value="${report?report.inv:''}" placeholder="0.00"></div>
            </div>
            <button class="btn btn-primary" onclick="saveZ()">üíæ GUARDAR CIERRE</button>
        </div>
        <div class="card">
            <div class="section-header"><div class="title">EVOLUCI√ìN SEMANAL</div></div>
            <canvas id="chartZ" style="max-height:200px"></canvas>
        </div>`;
        setTimeout(renderChart, 100);
    }

    // --- ADMIN (CON IMPORTAR/EXPORTAR) ---
    if(view === 'Admin') {
        app.innerHTML = `
        <div class="row">
            <button class="btn btn-ghost col" onclick="renderAlbaran()">üì• Albar√°n</button>
            <button class="btn btn-ghost col" onclick="renderContabilidad()">üìë Facturas</button>
            <button class="btn btn-ghost col" onclick="renderEngineering()">üìä Men√∫</button>
        </div>
        <div id="admin-panel"></div>`;
        renderContabilidad(); 
    }

    // --- COCINA ---
    if(view === 'Cocina') {
        const filtered = db.recetas.filter(r => (r.n||'').toLowerCase().includes(searchFilter.toLowerCase()));
        app.innerHTML = `
        <div class="card">
            <div class="section-header"><div class="title">FICHAS T√âCNICAS</div><button class="btn btn-sm btn-ghost" onclick="editRecipe()">+ Nueva</button></div>
            <input class="search-bar" placeholder="üîç Buscar receta..." value="${searchFilter}" oninput="searchFilter=this.value; render('Cocina')">
            ${filtered.map(r => {
                const c = calcRecipe(r);
                return `<div class="list-item" onclick="viewRecipe('${r.id}')">
                    <div><b>${r.n}</b> <small>(${r.cat||''})</small></div>
                    <div style="text-align:right"><span class="status-btn ${(r.pvp||0) > (c.total||0)*3 ? 'paid' : 'pending'}" style="font-size:0.75rem">${(c.total||0).toFixed(2)}‚Ç¨</span></div>
                </div>`;
            }).join('')}
        </div>`;
    }

    // --- STOCK ---
    if(view === 'Stock') {
        const filtered = db.ingredientes.filter(i => (i.n||'').toLowerCase().includes(searchFilter.toLowerCase()));
        const totalValue = db.ingredientes.reduce((acc, i) => acc + ((i.stock||0) * (i.cost||0)), 0);
        
        app.innerHTML = `
        <div class="kpi-row">
             <div class="kpi-card"><div class="kpi-val">${totalValue.toFixed(2)}‚Ç¨</div><div class="kpi-lbl">Valor Stock</div></div>
             <div class="kpi-card" style="background:var(--accent); cursor:pointer" onclick="renderShoppingList()"><div class="kpi-val">üõí</div><div class="kpi-lbl">Generar Compra</div></div>
        </div>
        <div class="card">
            <div class="section-header">
                <div class="title">INVENTARIO</div>
                <div style="display:flex; gap:5px"><button class="btn btn-sm btn-danger" onclick="modalMerma()">Merma</button><button class="btn btn-sm btn-accent" onclick="newIng()">+ Nuevo</button></div>
            </div>
            <input class="search-bar" placeholder="üîç Buscar ingrediente..." value="${searchFilter}" oninput="searchFilter=this.value; render('Stock')">
            ${filtered.map(i => `
                <div class="list-item" onclick="editIng('${i.id}')">
                    <div><b>${i.n}</b> <small style="color:${(i.stock||0) < (i.min||0) ? 'red' : 'gray'}">${(i.cost||0).toFixed(2)}‚Ç¨/${i.unit||'ud'}</small></div>
                    <div style="text-align:right"><b>${(i.stock||0).toFixed(2)} ${(i.unit||'ud')}</b><br><small>Min: ${i.min||0}</small></div>
                </div>`).join('')}
        </div>`;
    }
}

/* ================= 5. GESTI√ìN ALBARANES (IVA, DTO, NOTAS) ================= */
function renderAlbaran() {
    document.getElementById('admin-panel').innerHTML = `
    <div class="card" style="border-top:4px solid var(--accent)">
        <div class="section-header"><div class="title">RECEPCI√ìN MERCANC√çA</div></div>
        <div class="row">
            <div class="col"><label>Proveedor</label>
                <input list="prov-list" id="alb-prov" placeholder="Escribe o selecciona..." onfocus="this.value=''>
                <datalist id="prov-list">${db.proveedores.map(p=>`<option value="${p.n}">`).join('')}</datalist>
            </div>
            <div class="col"><label>Fecha</label><input type="date" id="alb-date" value="${new Date().toISOString().split('T')[0]}"></div>
        </div>
        <textarea id="alb-input" rows="3" placeholder="Pegar: Producto | Cantidad | Precio"></textarea>
        <button class="btn btn-sm btn-ghost" onclick="parseAlb()">ü™Ñ LECTURA M√ÅGICA</button>
        <div id="alb-body" style="margin-top:15px"></div>
        <div style="text-align:right; font-weight:800; margin:10px 0; font-size:1.1rem" id="alb-sum">Total: 0.00‚Ç¨</div>
        
        <label>Observaciones (Incidencias)</label>
        <textarea id="alb-note" rows="2" placeholder="Ej: Faltan gambas, botella rota..."></textarea>

        <button class="btn btn-primary" onclick="commitAlb()">CONFIRMAR ENTRADA</button>
    </div>`;
    tempItems = [];
}

function parseAlb() {
    const txt = document.getElementById('alb-input').value || '';
    tempItems = [];
    txt.split(/\r?\n/).forEach(line => {
        line = line.trim();
        if(!line) return;
        // Try to extract numbers; assume pattern: "Nombre ... qty price" or "Nombre ... price"
        // Tokenize but allow product names with spaces
        const parts = line.split(/\s{2,}|\t|;/).filter(Boolean);
        // If there are parts separated by double spaces or semicolons, try to parse last parts as numbers
        let name = parts[0];
        let q = 1, p = 0;
        if(parts.length >= 2) {
            // try parse last two tokens for numbers
            const tail = parts.slice(1).join(' ').split(/\s+/);
            const nums = [];
            const texts = [];
            tail.forEach(tok => {
                const cleanVal = tok.replace('‚Ç¨','').replace('$','').replace(',','.').trim();
                if(cleanVal !== "" && !isNaN(cleanVal) && /\d/.test(cleanVal)) nums.push(parseFloat(cleanVal));
                else texts.push(tok);
            });
            if(nums.length >= 2) { q = nums[0]; p = nums[1]; }
            else if (nums.length === 1) { p = nums[0]; }
            // rebuild name if there were textParts
            if(texts.length) name = [parts[0], ...texts].join(' ');
        } else {
            // fallback: split by spaces and extract numbers as before
            const tokens = line.split(/\s+/);
            const numParts = []; const textParts = [];
            tokens.forEach(part => {
                let cleanVal = part.replace('‚Ç¨','').replace('$','').replace(',','.').trim();
                if(!isNaN(cleanVal) && cleanVal !== "" && /\d/.test(cleanVal)) {
                    numParts.push(parseFloat(cleanVal));
                } else {
                    textParts.push(part);
                }
            });
            name = textParts.join(" ") || name;
            if(numParts.length >= 2) { q = numParts[0]; p = numParts[1]; } 
            else if (numParts.length === 1) { p = numParts[0]; }
        }
        if(p > 0 || q > 1) {
            tempItems.push({ n: name.trim(), q: Number(q) || 1, p: Number(p) || 0, d:0, iva:10 }); // Default IVA 10%
        }
    });
    renderAlbGrid();
}

function renderAlbGrid() {
    const div = document.getElementById('alb-body');
    let total = 0;
    div.innerHTML = tempItems.map((item, i) => {
        // Calculo: (Precio * Cantidad) * (1 - Dto) * (1 + IVA)
        const bruto = (Number(item.p) || 0) * (Number(item.q) || 0);
        const conDto = bruto * (1 - (Number(item.d || 0)/100));
        const final = conDto * (1 + (Number(item.iva || 0)/100));
        total += final;

        return `<div class="alb-row">
            <input value="${item.n}" onchange="tempItems[${i}].n=this.value" class="alb-name" placeholder="Producto">
            <input type="number" value="${item.q}" onchange="tempItems[${i}].q=parseFloat(this.value)||0;renderAlbGrid()" class="alb-num" placeholder="Cant">
            <input type="number" value="${item.p}" onchange="tempItems[${i}].p=parseFloat(this.value)||0;renderAlbGrid()" class="alb-num" placeholder="‚Ç¨/ud">
            <input type="number" value="${item.d}" onchange="tempItems[${i}].d=parseFloat(this.value)||0;renderAlbGrid()" class="alb-num" placeholder="%Dto" style="color:blue">
            <input type="number" value="${item.iva}" onchange="tempItems[${i}].iva=parseFloat(this.value)||0;renderAlbGrid()" class="alb-num" placeholder="%IVA" style="color:var(--sub)">
            <button onclick="tempItems.splice(${i},1);renderAlbGrid()" style="background:none;border:none;color:var(--danger);font-weight:bold;padding:0 10px">‚úï</button>
        </div>`;
    }).join('');
    document.getElementById('alb-sum').innerText = `Total: ${total.toFixed(2)}‚Ç¨`;
}

function commitAlb() {
    if(!tempItems.length) return showToast("Vac√≠o", "error");
    const provName = (document.getElementById('alb-prov').value || '').trim();
    const note = document.getElementById('alb-note').value || '';
    if(!provName) return showToast("Falta Proveedor", "error");
    if(!db.proveedores.find(p => p.n.toLowerCase() === provName.toLowerCase())) { db.proveedores.push({n: provName}); save("Nuevo proveedor"); }
    const date = document.getElementById('alb-date').value || new Date().toISOString().split('T')[0];
    
    // Calcular total real sumando l√≠neas
    const total = tempItems.reduce((acc, it) => acc + ((Number(it.p)||0) * (Number(it.q)||0) * (1-(Number(it.d||0)/100)) * (1+(Number(it.iva||0)/100))), 0);
    
    tempItems.forEach(item => {
        // unitNetCost: coste por unidad sin IVA ni dto
        const qty = Number(item.q) || 1;
        const price = Number(item.p) || 0;
        const dto = Number(item.d) || 0;
        const unitNetCost = qty > 0 ? ((price * (1 - dto/100)) / qty) : (price * (1 - dto/100));
        let i = db.ingredientes.find(ing => (ing.n||'').toLowerCase().trim() === (item.n||'').toLowerCase().trim());
        if(i) {
            // Actualizaci√≥n por media ponderada
            const prevTotal = (Number(i.stock) || 0) * (Number(i.cost) || 0);
            const addedTotal = qty * unitNetCost;
            const newStock = (Number(i.stock) || 0) + qty;
            i.cost = newStock > 0 ? ((prevTotal + addedTotal) / newStock) : unitNetCost;
            i.stock = newStock;
        } else { 
            db.ingredientes.push({ id: generateID(), n: item.n, stock: qty, cost: unitNetCost || 0, min:0, unit: 'ud', yield: 1, aller: [] }); 
        }
    });
    db.albaranes.push({ id: generateID(), date, prov: provName, items: JSON.parse(JSON.stringify(tempItems)), total, note, invoiced: false });
    save("Entrada confirmada"); renderContabilidad();
}

/* ================= 6. CONTABILIDAD & VISOR ================= */
function renderContabilidad() {
    const pendientes = db.albaranes.filter(a => !a.invoiced);
    const grupos = {};
    pendientes.forEach(a => {
        if(!grupos[a.prov]) grupos[a.prov] = {count:0, total:0, ids:[]};
        grupos[a.prov].count++; grupos[a.prov].total += a.total; grupos[a.prov].ids.push(a.id);
    });

    const lastAlbs = db.albaranes.slice().reverse().slice(0,5);

    document.getElementById('admin-panel').innerHTML = `
    <div class="card" style="border-left:4px solid var(--warn)">
        <div class="section-header"><div class="title">PENDIENTE FACTURAR</div></div>
        ${Object.entries(grupos).map(([prov, d]) => `
            <div class="list-item">
                <div><b>${prov}</b> <small>(${d.count} alb)</small></div>
                <div style="text-align:right"><b>${d.total.toFixed(2)}‚Ç¨</b> <button class="btn btn-sm btn-accent" onclick="invoiceModal('${prov}','${d.ids.join(',')}',${d.total})">Facturar</button></div>
            </div>`).join('')}
    </div>

    <div class="card">
        <div class="section-header"><div class="title">√öLTIMOS ALBARANES (VER)</div></div>
        ${lastAlbs.map(a => `
            <div class="list-item" onclick="viewAlbaran('${a.id}')">
                <div><span>${a.date.substring(5)}</span> <b>${a.prov}</b></div>
                <div style="text-align:right"><b>${a.total.toFixed(2)}‚Ç¨</b> <span style="font-size:1.2rem">üëÅÔ∏è</span></div>
            </div>
        `).join('')}

    <div class="card">
        <div class="section-header">
            <div class="title">COPIAS DE SEGURIDAD</div>
        </div>
        <div class="row">
            <button class="btn btn-ghost col" onclick="downloadBackup()">üíæ Exportar</button>
            <button class="btn btn-ghost col" style="color:var(--accent); border-color:var(--accent)" onclick="document.getElementById('backup-input').click()">üìÇ Importar</button>
        </div>
    </div>
    <div class="card">
        <div class="section-header"><div class="title">HIST√ìRICO FACTURAS</div></div>
        <div class="table-wrap">
            <table><thead><tr><th>Fecha</th><th>Prov</th><th>N¬∫</th><th>Total</th><th>Estado</th></tr></thead>
            <tbody>${(db.facturas||[]).slice().reverse().map(f => `
                <tr><td>${(f.date||'').substring(5)}</td><td>${f.prov}</td><td>${f.code||''}</td><td><b>${(f.total||0).toFixed(2)}‚Ç¨</b></td>
                <td><button class="status-btn ${(f.paid)?'paid':'pending'}" onclick="togglePaid('${f.id}')">${(f.paid)?'PAGADO':'PENDIENTE'}</button></td></tr>
            `).join('')}</tbody></table>
        </div>
    </div>`
}
