<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>ARUME V60 DEFINITIVE ¬∑ Complete ERP</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --bg: #f8fafc; --paper: #ffffff; --text: #0f172a; --sub: #64748b;
            --primary: #0f172a; --accent: #2563eb; 
            --success: #16a34a; --danger: #dc2626; --warn: #d97706;
            --border: #e2e8f0; --radius: 12px;
            --green: #10b981; --yellow: #f59e0b; --red: #ef4444;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 110px; min-height: 100vh; }

        /* HEADER */
        header { background: var(--paper); padding: 15px 20px; position: sticky; top: 0; z-index: 50; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        h1 { margin: 0; font-size: 1.3rem; font-weight: 900; letter-spacing: -0.5px; color: var(--primary); display:flex; align-items:center; gap:8px; }
        .badge { padding: 6px 12px; border-radius: 99px; font-size: 0.75rem; background: #f1f5f9; color: var(--text); font-weight: 700; border: 1px solid var(--border); cursor: pointer; display: flex; align-items:center; gap:8px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; } .dot.ok { background: var(--success); box-shadow: 0 0 6px var(--success); }

        /* LAYOUT */
        main { max-width: 900px; margin: 0 auto; padding: 20px; animation: fade 0.3s ease-out; }
        @keyframes fade { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
        
        .card { background: var(--paper); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .section-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f8fafc; padding-bottom: 12px; margin-bottom: 15px; }
        .title { font-size: 0.85rem; font-weight: 900; color: var(--primary); text-transform: uppercase; letter-spacing: 0.5px; }
        .row { display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; } .col { flex: 1; min-width: 140px; }

        /* KPIs FINANCIEROS */
        .kpi-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .kpi-card { flex:1; background: var(--primary); color: white; padding: 15px; border-radius: var(--radius); text-align: center; }
        .kpi-val { font-size: 1.4rem; font-weight: 900; }
        .kpi-lbl { font-size: 0.7rem; opacity: 0.8; text-transform: uppercase; margin-top: 4px; }

        /* LISTAS & TABLAS */
        .table-wrap { overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 100%; }
        th { text-align: left; background: #f8fafc; color: var(--sub); padding: 12px 10px; font-size: 0.7rem; text-transform: uppercase; border-bottom: 1px solid var(--border); }
        td { padding: 14px 10px; border-bottom: 1px solid #f1f5f9; white-space: nowrap; }
        tr:last-child td { border: none; }
        
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 16px 10px; border-bottom: 1px solid #f1f5f9; transition: 0.1s; cursor: pointer; }
        .list-item:active { background: #f1f5f9; }
        .list-item:last-child { border: none; }

        /* INPUTS */
        label { display: block; font-size: 0.7rem; font-weight: 700; color: var(--sub); margin-bottom: 5px; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; font-size: 15px; background: #fff; font-family: inherit; margin-bottom: 10px; outline: none; }
        input:focus, select:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px #bfdbfe; }
        .search-bar { background: #fff; border: 1px solid var(--border); margin-bottom: 15px; box-shadow: 0 4px 6px -2px rgba(0,0,0,0.03); padding: 10px; border-radius:10px; }

        /* BOTONES */
        .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; font-size: 1rem; text-align: center; margin-top: 5px; transition: 0.1s; display: inline-flex; justify-content:center; align-items:center; gap:8px; }
        .btn:active { transform: scale(0.97); opacity: 0.9; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-accent { background: var(--accent); color: white; }
        .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        .btn-sm { width: auto; padding: 8px 16px; font-size: 0.8rem; margin: 0; }
        
        .status-btn { padding: 6px 12px; border-radius: 8px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; cursor: pointer; border: none; transition: 0.2s; }
        .status-btn.paid { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .status-btn.pending { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }

        /* ALBARAN GRID */
        .alb-row { display: flex; gap: 5px; margin-bottom: 8px; align-items: center; background: #fff; border: 1px solid #f1f5f9; padding: 5px; border-radius: 8px; }
        .alb-row input { margin: 0; padding: 8px; font-size: 0.9rem; }
        .alb-name { flex: 3; min-width: 120px; }
        .alb-num { flex: 1; min-width: 50px; text-align: right; }

        /* NAV */
        nav { position: fixed; bottom: 0; width: 100%; background: rgba(255,255,255,0.96); backdrop-filter: blur(8px); border-top: 1px solid var(--border); display: flex; justify-content: space-around; gap:4px; padding:6px; z-index:60; }
        nav button { background: none; border: none; flex: 1; display: flex; flex-direction: column; align-items: center; gap: 5px; color: var(--sub); font-size: 0.65rem; font-weight: 700; padding: 5px 8px; border-radius:8px; }
        nav button.active { opacity: 1; color: var(--accent); transform: translateY(-3px); }
        nav button svg { width: 26px; height: 26px; fill: currentColor; }

        /* MODAL */
        .hidden { display: none !important; }
        .overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); z-index: 100; backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; }
        .modal { background: white; width: 95%; max-width: 700px; max-height: 90vh; overflow-y: auto; padding: 25px; border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }

        /* PIN PAD */
        #pin-screen { background: #0f172a; color: white; }
        .pin-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 30px; max-width: 320px; margin-left: auto; margin-right: auto; }
        .pin-btn { height: 75px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); font-size: 1.8rem; color: white; cursor: pointer; font-weight: 600; }
        .pin-btn:active { background: rgba(255,255,255,0.2); }

        /* TOAST */
        #toast-container { position: fixed; bottom: 110px; left: 50%; transform: translateX(-50%); z-index: 200; width: 90%; max-width: 400px; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: #1e293b; color: white; padding: 14px 20px; border-radius: 12px; font-size: 0.95rem; font-weight: 600; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); animation: slideUp 0.3s ease forwards; pointer-events: auto; }
        .toast.success { border-bottom: 4px solid var(--success); }
        .toast.error { border-bottom: 4px solid var(--danger); }
        @keyframes slideUp { from{opacity:0; transform:translateY(20px) translateX(-50%)} to{opacity:1; transform:translateY(0) translateX(-50%)} }

        /* small helpers */
        .matrix-grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; }
        .matrix-box { padding:12px; border-radius:8px; background:#f8fafc; text-align:center; }
        
        /* ALLERGEN ICONS */
        .allergen-icon { display: inline-block; width: 26px; height: 26px; border-radius: 50%; 
            text-align: center; line-height: 26px; font-size: 0.7rem; margin: 2px; cursor: pointer; 
            border: 2px solid transparent; transition: 0.2s; }
        .allergen-icon.active { border-color: var(--accent); box-shadow: 0 0 8px var(--accent); }
        .allergen-icon:hover { transform: scale(1.1); }
        
        /* Traffic lights for price changes */
        .price-indicator { width: 20px; height: 20px; border-radius: 50%; display: inline-block; margin-left: 8px; }
        .price-indicator.green { background: var(--green); }
        .price-indicator.yellow { background: var(--yellow); }
        .price-indicator.red { background: var(--red); box-shadow: 0 0 8px var(--red); }
        
        /* Blind mode overlay */
        .blind-mode { filter: blur(5px); pointer-events: none; }
        
        /* Excel export button style */
        .btn-excel { background: #217346; color: white; }
    </style>
</head>
<body>

    <div id="toast-container"></div>
    <input type="file" id="backup-input" style="display:none" accept=".json" onchange="restoreBackup(this)">

    <header>
        <h1>ARUME <span style="font-size:0.6em; opacity:0.6; font-weight:400">V60</span></h1>
        <button id="user-display" class="badge" onclick="logout()">
            <div id="sync-dot" class="dot"></div> <span id="user-name">...</span>
        </button>
    </header>

    <main id="app"></main>

    <nav id="navbar"></nav>

    <div id="modal-overlay" class="overlay hidden">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
                <h3 id="m-title" style="margin:0; font-size:1.2rem; font-weight:900; color:var(--primary)"></h3>
                <button onclick="closeModal()" style="background:none;border:none;font-size:2rem;cursor:pointer;color:var(--sub);line-height:1">&times;</button>
            </div>
            <div id="m-body"></div>
        </div>
    </div>

    <div id="pin-screen" class="overlay" style="opacity:1">
        <div class="modal" style="text-align:center; background:transparent; box-shadow:none; color:white">
            <h2 style="font-size:3rem; margin:0; letter-spacing:2px; font-weight:900">ARUME</h2>
            <p style="opacity:0.6; margin-bottom:40px; letter-spacing:1px; text-transform:uppercase">Sistema de Gesti√≥n Integral</p>
            <div id="pin-display" style="font-size:3rem; font-weight:800; letter-spacing:15px; min-height:60px">****</div>
            <div class="pin-grid">
                <button class="pin-btn" onclick="pinInput('1')">1</button><button class="pin-btn" onclick="pinInput('2')">2</button><button class="pin-btn" onclick="pinInput('3')">3</button>
                <button class="pin-btn" onclick="pinInput('4')">4</button><button class="pin-btn" onclick="pinInput('5')">5</button><button class="pin-btn" onclick="pinInput('6')">6</button>
                <button class="pin-btn" onclick="pinInput('7')">7</button><button class="pin-btn" onclick="pinInput('8')">8</button><button class="pin-btn" onclick="pinInput('9')">9</button>
                <button class="pin-btn" style="color:var(--danger); border-color:rgba(239,68,68,0.3)" onclick="pinClear()">C</button>
                <button class="pin-btn" onclick="pinInput('0')">0</button>
                <button class="pin-btn" style="background:var(--success); border:none; color:#022c22" onclick="pinCheck()">OK</button>
            </div>
        </div>
    </div>

<script>
/* ================= 1. CONFIGURACI√ìN ================= */
const generateID = () => crypto.randomUUID ? crypto.randomUUID() : Date.now().toString() + Math.random().toString(36).substring(2);
const MAX_RECIPE_DEPTH = 5; // Maximum depth for sub-recipe recursion
const CONFIG = { 
    GOOGLE_URL: "", // Left empty for future configuration
    COST_HOUR: 15 
};

// Allergens database
const ALLERGENS = {
    gluten: {emoji: 'üåæ', name: 'Gluten', color: '#f59e0b'},
    crustaceos: {emoji: 'ü¶ê', name: 'Crust√°ceos', color: '#ef4444'},
    huevos: {emoji: 'ü•ö', name: 'Huevos', color: '#fbbf24'},
    pescado: {emoji: 'üêü', name: 'Pescado', color: '#3b82f6'},
    cacahuetes: {emoji: 'ü•ú', name: 'Cacahuetes', color: '#92400e'},
    soja: {emoji: 'ü´ò', name: 'Soja', color: '#84cc16'},
    lacteos: {emoji: 'ü•õ', name: 'L√°cteos', color: '#f8fafc'},
    frutos_secos: {emoji: 'üå∞', name: 'Frutos Secos', color: '#78350f'},
    apio: {emoji: 'ü•¨', name: 'Apio', color: '#22c55e'},
    mostaza: {emoji: 'üü°', name: 'Mostaza', color: '#eab308'},
    sesamo: {emoji: '‚ö™', name: 'S√©samo', color: '#d6d3d1'},
    sulfitos: {emoji: 'üç∑', name: 'Sulfitos', color: '#7c2d12'},
    altramuces: {emoji: 'ü´õ', name: 'Altramuces', color: '#65a30d'},
    moluscos: {emoji: 'üêö', name: 'Moluscos', color: '#0ea5e9'}
};

const DB_INIT = {
    users: [{id:'u1', n:'Gerencia', pin:'0150', role:'admin'}, {id:'u2', n:'Cocina', pin:'1111', role:'staff'}],
    ingredientes: [],
    recetas: [],
    proveedores: [{n:'Makro'}, {n:'Tokyo-ya'}, {n:'Frutas Daniel'}],
    albaranes: [], 
    facturas: [], 
    diario: [], 
    mermas: [], 
    priceHistory: [], // Track price changes
    lastSync: 0
};

let db = JSON.parse(localStorage.getItem('arume_v60')) || DB_INIT;
let currentUser = null;
let currentPin = "";
let chartInstance = null;
let tempItems = []; 
let searchFilter = "";
let blindMode = false; // For blind inventory
let imageDB = null; // IndexedDB for images

/* ================= 2. CORE UTILS ================= */
// Initialize IndexedDB for images
function initImageDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open('ArumeImagesDB', 1);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
            imageDB = request.result;
            resolve(imageDB);
        };
        request.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains('images')) {
                db.createObjectStore('images', { keyPath: 'id' });
            }
        };
    });
}

// Save image to IndexedDB
async function saveImage(id, imageData) {
    if (!imageDB) await initImageDB();
    return new Promise((resolve, reject) => {
        const transaction = imageDB.transaction(['images'], 'readwrite');
        const store = transaction.objectStore('images');
        const request = store.put({ id, data: imageData, timestamp: Date.now() });
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

// Get image from IndexedDB
async function getImage(id) {
    if (!imageDB) await initImageDB();
    return new Promise((resolve, reject) => {
        const transaction = imageDB.transaction(['images'], 'readonly');
        const store = transaction.objectStore('images');
        const request = store.get(id);
        request.onsuccess = () => resolve(request.result?.data);
        request.onerror = () => reject(request.error);
    });
}

function showToast(msg, type='success') {
    const box = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = type==='success' ? `‚úÖ ${msg}` : `‚ùå ${msg}`;
    box.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

async function init() {
    await initImageDB();
    const u = localStorage.getItem('arume_user');
    if(u) { currentUser=JSON.parse(u); document.getElementById('pin-screen').classList.add('hidden'); loadApp(); }
    if(CONFIG.GOOGLE_URL) sync();
}

function save(msg){
    // Post-save: try to persist to remote (if CORS allows). Update lastSync only on success would be ideal,
    // but we keep a local lastSync timestamp to indicate local change time.
    db.lastSync = Date.now();
    localStorage.setItem('arume_v60', JSON.stringify(db));
    if(CONFIG.GOOGLE_URL) {
        // send data, but endpoint should accept CORS for proper response
        fetch(CONFIG.GOOGLE_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(db)
        }).catch(()=>{ /* ignore network errors for now */ });
    }
    if(msg) showToast(msg, 'success');
}

async function sync(){
    if(!CONFIG.GOOGLE_URL) return;
    try {
        const r = await fetch(CONFIG.GOOGLE_URL);
        if (!r.ok) return;
        const c = await r.json();
        if (c && c.lastSync && c.lastSync > (db.lastSync || 0)) {
            db = c;
            localStorage.setItem('arume_v60', JSON.stringify(db));
            showToast("Datos actualizados");
            setTimeout(()=>location.reload(), 500);
        }
        document.getElementById('sync-dot').classList.add('ok');
    } catch(e){
        // silently ignore; could log to console
        console.warn("Sync error", e);
    }
}

/* ================= 3. AUTH ================= */
function pinInput(n){ if(currentPin.length<4)currentPin+=n; document.getElementById('pin-display').innerText="‚Ä¢".repeat(currentPin.length); }
function pinClear(){ currentPin=""; document.getElementById('pin-display').innerText="PIN"; }
function pinCheck(){
    const u = db.users.find(x=>x.pin===currentPin);
    if(u){ currentUser=u; localStorage.setItem('arume_user',JSON.stringify(u)); document.getElementById('pin-screen').classList.add('hidden'); loadApp(); }
    else { showToast("C√≥digo incorrecto", "error"); pinClear(); }
}
function logout(){ localStorage.removeItem('arume_user'); location.reload(); }

/* ================= 4. UI RENDER ================= */
function loadApp() {
    document.getElementById('user-name').innerText = currentUser.n;
    renderNav();
    render(currentUser.role==='admin'?'Admin':'Diario');
}

function renderNav() {
    const nav = document.getElementById('navbar'); nav.innerHTML='';
    const views = {
        'Diario': {icon:'<path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>', label:'CAJA Z'},
        'Admin': {icon:'<path d="M12 2L3 5v6c0 5 3.8 9.7 9 11 5.2-1.3 9-6 9-11V5l-9-3z"/>', label:'GESTI√ìN'},
        'Cocina': {icon:'<path d="M12 2C8.1 6 7 8 7 11c0 3.9 3.1 7 7 7s7-3.1 7-7c0-3-1.1-5-5-9z"/>', label:'COCINA'},
        'Stock': {icon:'<path d="M3 3h18v2H3V3zm2 4h14v12H5V7zm2 2v8h10V9H7z"/>', label:'STOCK'}
    };
    
    for(const [k,v] of Object.entries(views)){
        if((k==='Admin') && currentUser.role!=='admin') continue;
        const b = document.createElement('button');
        b.innerHTML = `<svg viewBox="0 0 24 24" aria-hidden="true">${v.icon}</svg>${v.label}`;
        b.id = `btn-${k}`; b.onclick = () => { searchFilter=""; render(k); };
        nav.appendChild(b);
    }
}

function render(view) {
    document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
    document.getElementById(`btn-${view}`)?.classList.add('active');
    const app = document.getElementById('app'); app.innerHTML='';

    // --- DIARIO ---
    if(view === 'Diario') {
        const today = new Date().toISOString().split('T')[0];
        const report = db.diario.find(d => d.date === today);
        app.innerHTML = `
        <div class="card">
            <div class="section-header"><div class="title">CIERRE DIARIO</div><div class="title">${today}</div></div>
            <div class="row">
                <div class="col"><label>Total Z (‚Ç¨)</label><input type="number" id="z-total" value="${report?report.total:''}" placeholder="0.00"></div>
                <div class="col"><label>Efectivo</label><input type="number" id="z-cash" value="${report?report.cash:''}" placeholder="0.00"></div>
            </div>
            <div class="row">
                <div class="col"><label>Tarjeta</label><input type="number" id="z-card" value="${report?report.card:''}" placeholder="0.00"></div>
                <div class="col"><label>Invitaciones</label><input type="number" id="z-inv" value="${report?report.inv:''}" placeholder="0.00"></div>
            </div>
            <button class="btn btn-primary" onclick="saveZ()">üíæ GUARDAR CIERRE</button>
        </div>
        <div class="card">
            <div class="section-header"><div class="title">EVOLUCI√ìN SEMANAL</div></div>
            <canvas id="chartZ" style="max-height:200px"></canvas>
        </div>`;
        setTimeout(renderChart, 100);
    }

    // --- ADMIN (CON IMPORTAR/EXPORTAR) ---
    if(view === 'Admin') {
        app.innerHTML = `
        <div class="row">
            <button class="btn btn-ghost col" onclick="renderAlbaran()">üì• Albar√°n</button>
            <button class="btn btn-ghost col" onclick="renderContabilidad()">üìë Facturas</button>
            <button class="btn btn-ghost col" onclick="renderEngineering()">üìä Men√∫</button>
        </div>
        <div class="row">
            <button class="btn btn-ghost col" onclick="viewPriceHistory()">üìà Hist√≥rico Precios</button>
            <button class="btn btn-excel col" onclick="exportToExcel()">üìó Exportar Excel</button>
        </div>
        <div id="admin-panel"></div>`;
        renderContabilidad(); 
    }

    // --- COCINA ---
    if(view === 'Cocina') {
        const filtered = db.recetas.filter(r => (r.n||'').toLowerCase().includes(searchFilter.toLowerCase()));
        app.innerHTML = `
        <div class="card">
            <div class="section-header"><div class="title">FICHAS T√âCNICAS</div><button class="btn btn-sm btn-ghost" onclick="editRecipe()">+ Nueva</button></div>
            <input class="search-bar" placeholder="üîç Buscar receta..." value="${searchFilter}" oninput="searchFilter=this.value; render('Cocina')">
            ${filtered.map(r => {
                const c = calcRecipe(r);
                return `<div class="list-item" onclick="viewRecipe('${r.id}')">
                    <div><b>${r.n}</b> <small>(${r.cat||''})</small></div>
                    <div style="text-align:right"><span class="status-btn ${(r.pvp||0) > (c.total||0)*3 ? 'paid' : 'pending'}" style="font-size:0.75rem">${(c.total||0).toFixed(2)}‚Ç¨</span></div>
                </div>`;
            }).join('')}
        </div>`;
    }

    // --- STOCK ---
    if(view === 'Stock') {
        const filtered = db.ingredientes.filter(i => (i.n||'').toLowerCase().includes(searchFilter.toLowerCase()));
        const totalValue = db.ingredientes.reduce((acc, i) => acc + ((i.stock||0) * (i.cost||0)), 0);
        
        app.innerHTML = `
        <div class="kpi-row">
             <div class="kpi-card"><div class="kpi-val">${totalValue.toFixed(2)}‚Ç¨</div><div class="kpi-lbl">Valor Stock</div></div>
             <div class="kpi-card" style="background:var(--accent); cursor:pointer" onclick="renderShoppingList()"><div class="kpi-val">üõí</div><div class="kpi-lbl">Generar Compra</div></div>
        </div>
        <div class="card ${blindMode ? 'blind-mode' : ''}">
            <div class="section-header">
                <div class="title">INVENTARIO</div>
                <div style="display:flex; gap:5px">
                    <button class="btn btn-sm ${blindMode ? 'btn-accent' : 'btn-ghost'}" onclick="toggleBlindMode()">${blindMode ? 'üëÅÔ∏è Ver' : 'üôà Ocultar'}</button>
                    <button class="btn btn-sm btn-danger" onclick="modalMerma()">Merma</button>
                    <button class="btn btn-sm btn-accent" onclick="newIng()">+ Nuevo</button>
                </div>
            </div>
            <input class="search-bar" placeholder="üîç Buscar ingrediente..." value="${searchFilter}" oninput="searchFilter=this.value; render('Stock')">
            ${filtered.map(i => {
                const allergenIcons = (i.aller || []).map(a => {
                    const info = ALLERGENS[a];
                    return info ? `<span class="allergen-icon" style="background:${info.color}; width:20px; height:20px; line-height:20px; font-size:0.6rem" title="${info.name}">${info.emoji}</span>` : '';
                }).join('');
                
                return `<div class="list-item" onclick="editIng('${i.id}')">
                    <div>
                        <b>${i.n}</b> 
                        <small style="color:${(i.stock||0) < (i.min||0) ? 'red' : 'gray'}">${(i.cost||0).toFixed(2)}‚Ç¨/${i.unit||'ud'}</small>
                        <div style="margin-top:5px">${allergenIcons}</div>
                    </div>
                    <div style="text-align:right"><b>${(i.stock||0).toFixed(2)} ${(i.unit||'ud')}</b><br><small>Min: ${i.min||0}</small></div>
                </div>`;
            }).join('')}
        </div>`;
    }
}

/* ================= 5. GESTI√ìN ALBARANES (IVA, DTO, NOTAS) ================= */
function renderAlbaran() {
    document.getElementById('admin-panel').innerHTML = `
    <div class="card" style="border-top:4px solid var(--accent)">
        <div class="section-header"><div class="title">RECEPCI√ìN MERCANC√çA</div></div>
        <div class="row">
            <div class="col"><label>Proveedor</label>
                <input list="prov-list" id="alb-prov" placeholder="Escribe o selecciona..." onfocus="this.value=''">
                <datalist id="prov-list">${db.proveedores.map(p=>`<option value="${p.n}">`).join('')}</datalist>
            </div>
            <div class="col"><label>Fecha</label><input type="date" id="alb-date" value="${new Date().toISOString().split('T')[0]}"></div>
        </div>
        <textarea id="alb-input" rows="3" placeholder="Pegar: Producto | Cantidad | Precio"></textarea>
        <button class="btn btn-sm btn-ghost" onclick="parseAlb()">ü™Ñ LECTURA M√ÅGICA</button>
        <div id="alb-body" style="margin-top:15px"></div>
        <div style="text-align:right; font-weight:800; margin:10px 0; font-size:1.1rem" id="alb-sum">Total: 0.00‚Ç¨</div>
        
        <label>Observaciones (Incidencias)</label>
        <textarea id="alb-note" rows="2" placeholder="Ej: Faltan gambas, botella rota..."></textarea>

        <label>Foto del Albar√°n (Opcional)</label>
        <input type="file" id="alb-photo" accept="image/*" style="margin-bottom:10px">
        <div id="alb-photo-preview" style="margin:10px 0"></div>

        <button class="btn btn-primary" onclick="commitAlb()">CONFIRMAR ENTRADA</button>
    </div>`;
    tempItems = [];
    
    // Add photo preview handler
    document.getElementById('alb-photo').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                document.getElementById('alb-photo-preview').innerHTML = `
                    <img src="${event.target.result}" style="max-width:100%; max-height:200px; border-radius:8px; border:1px solid var(--border)">
                `;
            };
            reader.readAsDataURL(file);
        }
    });
}

function parseAlb() {
    const txt = document.getElementById('alb-input').value || '';
    tempItems = [];
    txt.split(/\r?\n/).forEach(line => {
        line = line.trim();
        if(!line) return;
        // Try to extract numbers; assume pattern: "Nombre ... qty price" or "Nombre ... price"
        // Tokenize but allow product names with spaces
        const parts = line.split(/\s{2,}|\t|;/).filter(Boolean);
        // If there are parts separated by double spaces or semicolons, try to parse last parts as numbers
        let name = parts[0];
        let q = 1, p = 0;
        if(parts.length >= 2) {
            // try parse last two tokens for numbers
            const tail = parts.slice(1).join(' ').split(/\s+/);
            const nums = [];
            const texts = [];
            tail.forEach(tok => {
                const cleanVal = tok.replace(/‚Ç¨/g,'').replace(/\$/g,'').replace(/,/g,'.').trim();
                if(cleanVal !== "" && !isNaN(cleanVal) && /\d/.test(cleanVal)) nums.push(parseFloat(cleanVal));
                else texts.push(tok);
            });
            if(nums.length >= 2) { q = nums[0]; p = nums[1]; }
            else if (nums.length === 1) { p = nums[0]; }
            // rebuild name if there were textParts
            if(texts.length) name = [parts[0], ...texts].join(' ');
        } else {
            // fallback: split by spaces and extract numbers as before
            const tokens = line.split(/\s+/);
            const numParts = []; const textParts = [];
            tokens.forEach(part => {
                let cleanVal = part.replace(/‚Ç¨/g,'').replace(/\$/g,'').replace(/,/g,'.').trim();
                if(!isNaN(cleanVal) && cleanVal !== "" && /\d/.test(cleanVal)) {
                    numParts.push(parseFloat(cleanVal));
                } else {
                    textParts.push(part);
                }
            });
            name = textParts.join(" ") || name;
            if(numParts.length >= 2) { q = numParts[0]; p = numParts[1]; } 
            else if (numParts.length === 1) { p = numParts[0]; }
        }
        if(p > 0 || q > 1) {
            tempItems.push({ n: name.trim(), q: Number(q) || 1, p: Number(p) || 0, d:0, iva:10 }); // Default IVA 10%
        }
    });
    renderAlbGrid();
}

function renderAlbGrid() {
    const div = document.getElementById('alb-body');
    let total = 0;
    div.innerHTML = tempItems.map((item, i) => {
        // Calculo: (Precio * Cantidad) * (1 - Dto) * (1 + IVA)
        const bruto = (Number(item.p) || 0) * (Number(item.q) || 0);
        const conDto = bruto * (1 - (Number(item.d || 0)/100));
        const final = conDto * (1 + (Number(item.iva || 0)/100));
        total += final;
        
        // Check for price changes
        const existingIng = db.ingredientes.find(ing => (ing.n||'').toLowerCase().trim() === (item.n||'').toLowerCase().trim());
        let priceIndicator = '';
        
        if (existingIng && item.p > 0) {
            const qty = Number(item.q) || 1;
            const price = Number(item.p) || 0;
            const dto = Number(item.d) || 0;
            const unitNetCost = qty > 0 ? ((price * (1 - dto/100)) / qty) : (price * (1 - dto/100));
            const oldPrice = Number(existingIng.cost) || 0;
            
            if (oldPrice > 0) {
                const changePercent = ((unitNetCost - oldPrice) / oldPrice) * 100;
                
                if (changePercent > 10) {
                    priceIndicator = '<span class="price-indicator red" title="Subida >10%"></span>';
                } else if (changePercent > 5) {
                    priceIndicator = '<span class="price-indicator yellow" title="Subida 5-10%"></span>';
                } else if (changePercent < -5) {
                    priceIndicator = '<span class="price-indicator green" title="Bajada >5%"></span>';
                } else {
                    priceIndicator = '<span class="price-indicator green" title="Sin cambios significativos"></span>';
                }
            }
        }

        return `<div class="alb-row">
            <input value="${item.n}" onchange="tempItems[${i}].n=this.value" class="alb-name" placeholder="Producto">
            ${priceIndicator}
            <input type="number" value="${item.q}" onchange="tempItems[${i}].q=parseFloat(this.value)||0;renderAlbGrid()" class="alb-num" placeholder="Cant">
            <input type="number" value="${item.p}" onchange="tempItems[${i}].p=parseFloat(this.value)||0;renderAlbGrid()" class="alb-num" placeholder="‚Ç¨/ud">
            <input type="number" value="${item.d}" onchange="tempItems[${i}].d=parseFloat(this.value)||0;renderAlbGrid()" class="alb-num" placeholder="%Dto" style="color:blue">
            <input type="number" value="${item.iva}" onchange="tempItems[${i}].iva=parseFloat(this.value)||0;renderAlbGrid()" class="alb-num" placeholder="%IVA" style="color:var(--sub)">
            <button onclick="tempItems.splice(${i},1);renderAlbGrid()" style="background:none;border:none;color:var(--danger);font-weight:bold;padding:0 10px">‚úï</button>
        </div>`;
    }).join('');
    document.getElementById('alb-sum').innerText = `Total: ${total.toFixed(2)}‚Ç¨`;
}

function commitAlb() {
    if(!tempItems.length) return showToast("Vac√≠o", "error");
    const provName = (document.getElementById('alb-prov').value || '').trim();
    const note = document.getElementById('alb-note').value || '';
    if(!provName) return showToast("Falta Proveedor", "error");
    if(!db.proveedores.find(p => p.n.toLowerCase() === provName.toLowerCase())) { 
        db.proveedores.push({n: provName}); 
        save("Nuevo proveedor"); 
    }
    const date = document.getElementById('alb-date').value || new Date().toISOString().split('T')[0];
    
    // Calcular total real sumando l√≠neas
    const total = tempItems.reduce((acc, it) => acc + ((Number(it.p)||0) * (Number(it.q)||0) * (1-(Number(it.d||0)/100)) * (1+(Number(it.iva||0)/100))), 0);
    
    const albaranId = generateID();
    
    // Handle photo if present
    const photoInput = document.getElementById('alb-photo');
    if (photoInput && photoInput.files && photoInput.files[0]) {
        const file = photoInput.files[0];
        const reader = new FileReader();
        reader.onload = async function(event) {
            await saveImage(albaranId, event.target.result);
            finalizeAlbaran(albaranId, date, provName, tempItems, total, note);
        };
        reader.readAsDataURL(file);
    } else {
        finalizeAlbaran(albaranId, date, provName, tempItems, total, note);
    }
}

function finalizeAlbaran(albaranId, date, provName, items, total, note) {
    const photoInput = document.getElementById('alb-photo');
    
    items.forEach(item => {
        // unitNetCost: coste por unidad sin IVA ni dto
        const qty = Number(item.q) || 1;
        const price = Number(item.p) || 0;
        const dto = Number(item.d) || 0;
        const unitNetCost = qty > 0 ? ((price * (1 - dto/100)) / qty) : (price * (1 - dto/100));
        
        let i = db.ingredientes.find(ing => (ing.n||'').toLowerCase().trim() === (item.n||'').toLowerCase().trim());
        
        if(i) {
            // Track price change before updating
            const oldPrice = Number(i.cost) || 0;
            const priceChange = oldPrice > 0 ? ((unitNetCost - oldPrice) / oldPrice) * 100 : 0;
            
            // Store price history
            if (!db.priceHistory) db.priceHistory = [];
            db.priceHistory.push({
                date,
                ingredientId: i.id,
                ingredientName: i.n,
                oldPrice,
                newPrice: unitNetCost,
                changePercent: priceChange,
                provider: provName
            });
            
            // Actualizaci√≥n por media ponderada
            const prevTotal = (Number(i.stock) || 0) * (Number(i.cost) || 0);
            const addedTotal = qty * unitNetCost;
            const newStock = (Number(i.stock) || 0) + qty;
            i.cost = newStock > 0 ? ((prevTotal + addedTotal) / newStock) : unitNetCost;
            i.stock = newStock;
            
            // Add traffic light indicator to item for display
            item.priceChange = priceChange;
        } else { 
            db.ingredientes.push({ 
                id: generateID(), 
                n: item.n, 
                stock: qty, 
                cost: unitNetCost || 0, 
                min:0, 
                unit: 'ud', 
                yield: 1, 
                aller: [] 
            }); 
        }
    });
    
    db.albaranes.push({ 
        id: albaranId, 
        date, 
        prov: provName, 
        items: JSON.parse(JSON.stringify(items)), 
        total, 
        note, 
        invoiced: false,
        hasPhoto: photoInput && photoInput.files && photoInput.files.length > 0
    });
    
    save("Entrada confirmada"); 
    renderContabilidad();
}

/* ================= 6. CONTABILIDAD & VISOR ================= */
function renderContabilidad() {
    const pendientes = db.albaranes.filter(a => !a.invoiced);
    const grupos = {};
    pendientes.forEach(a => {
        if(!grupos[a.prov]) grupos[a.prov] = {count:0, total:0, ids:[]};
        grupos[a.prov].count++; grupos[a.prov].total += a.total; grupos[a.prov].ids.push(a.id);
    });

    const lastAlbs = db.albaranes.slice().reverse().slice(0,5);

    document.getElementById('admin-panel').innerHTML = `
    <div class="card" style="border-left:4px solid var(--warn)">
        <div class="section-header"><div class="title">PENDIENTE FACTURAR</div></div>
        ${Object.entries(grupos).map(([prov, d]) => `
            <div class="list-item">
                <div><b>${prov}</b> <small>(${d.count} alb)</small></div>
                <div style="text-align:right"><b>${d.total.toFixed(2)}‚Ç¨</b> <button class="btn btn-sm btn-accent" onclick="invoiceModal('${prov}','${d.ids.join(',')}',${d.total})">Facturar</button></div>
            </div>`).join('')}
    </div>

    <div class="card">
        <div class="section-header"><div class="title">√öLTIMOS ALBARANES (VER)</div></div>
        ${lastAlbs.map(a => `
            <div class="list-item" onclick="viewAlbaran('${a.id}')">
                <div><span>${a.date.substring(5)}</span> <b>${a.prov}</b></div>
                <div style="text-align:right"><b>${a.total.toFixed(2)}‚Ç¨</b> <span style="font-size:1.2rem">üëÅÔ∏è</span></div>
            </div>
        `).join('')}
    </div>

    <div class="card">
        <div class="section-header">
            <div class="title">COPIAS DE SEGURIDAD</div>
        </div>
        <div class="row">
            <button class="btn btn-ghost col" onclick="downloadBackup()">üíæ Exportar</button>
            <button class="btn btn-ghost col" style="color:var(--accent); border-color:var(--accent)" onclick="document.getElementById('backup-input').click()">üìÇ Importar</button>
        </div>
    </div>
    <div class="card">
        <div class="section-header"><div class="title">HIST√ìRICO FACTURAS</div></div>
        <div class="table-wrap">
            <table><thead><tr><th>Fecha</th><th>Prov</th><th>N¬∫</th><th>Total</th><th>Estado</th></tr></thead>
            <tbody>${(db.facturas||[]).slice().reverse().map(f => `
                <tr><td>${(f.date||'').substring(5)}</td><td>${f.prov}</td><td>${f.code||''}</td><td><b>${(f.total||0).toFixed(2)}‚Ç¨</b></td>
                <td><button class="status-btn ${(f.paid)?'paid':'pending'}" onclick="togglePaid('${f.id}')">${(f.paid)?'PAGADO':'PENDIENTE'}</button></td></tr>
            `).join('')}</tbody></table>
        </div>
    </div>`;
}

function viewAlbaran(id) {
    const a = db.albaranes.find(x => x.id === id);
    if(!a) return;
    
    // Reconstruir lista HTML
    const itemsHtml = (a.items||[]).map(it => `
        <tr>
            <td>${it.n}</td>
            <td>${it.q}</td>
            <td>${it.p}‚Ç¨</td>
            <td>${it.d||0}%</td>
            <td>${it.iva||0}%</td>
            <td><b>${((it.q * it.p * (1-(it.d||0)/100) * (1+(it.iva||0)/100))||0).toFixed(2)}‚Ç¨</b></td>
        </tr>
    `).join('');

    // Try to load photo if exists
    let photoHtml = '';
    if (a.hasPhoto) {
        photoHtml = '<div id="alb-photo-display" style="margin:15px 0">Cargando foto...</div>';
        setTimeout(async () => {
            const photoData = await getImage(a.id);
            if (photoData) {
                document.getElementById('alb-photo-display').innerHTML = `
                    <img src="${photoData}" style="max-width:100%; border-radius:8px; border:1px solid var(--border)" onclick="window.open('${photoData}', '_blank')">
                    <p style="font-size:0.7rem; color:var(--sub); margin-top:5px">üì∏ Click para ampliar</p>
                `;
            } else {
                document.getElementById('alb-photo-display').innerHTML = '<p style="color:var(--sub)">Foto no disponible</p>';
            }
        }, 100);
    }

    showModal(`Albar√°n ${a.prov}`, `
        <div style="margin-bottom:15px; font-size:0.9rem; color:var(--sub)">
            Fecha: <b>${a.date}</b><br>
            Estado: <b>${a.invoiced ? 'FACTURADO' : 'PENDIENTE'}</b>
        </div>
        ${photoHtml}
        <div class="table-wrap" style="margin-bottom:15px">
            <table style="font-size:0.8rem">
                <thead><tr><th>Prod</th><th>Cant</th><th>Pre</th><th>Dto</th><th>IVA</th><th>Tot</th></tr></thead>
                <tbody>${itemsHtml}</tbody>
            </table>
        </div>
        <div style="text-align:right; font-size:1.2rem; font-weight:800; margin-bottom:10px">Total: ${(a.total||0).toFixed(2)}‚Ç¨</div>
        ${a.note ? `<div style="background:#fffbeb; padding:10px; border-radius:8px; font-size:0.9rem">üìù <b>Nota:</b> ${a.note}</div>` : ''}
    `);
}

function invoiceModal(prov, idsStr, total) {
    // idsStr expected to be comma-separated IDs (string)
    const ids = (typeof idsStr === 'string') ? idsStr : (Array.isArray(idsStr) ? idsStr.join(',') : '');
    showModal("Nueva Factura", `
        <p>Prov: <b>${prov}</b> | Total: <b>${Number(total||0).toFixed(2)}‚Ç¨</b></p>
        <label>N¬∫ Factura</label><input id="inv-code" placeholder="0000">
        <div style="display:flex; gap:8px; margin-top:10px">
            <button class="btn btn-primary" onclick="createInvoice('${prov}','${ids}',${Number(total||0)})">Crear Factura</button>
            <button class="btn btn-ghost" onclick="closeModal()">Cancelar</button>
        </div>
    `);
}
function createInvoice(prov, idsStr, total) {
    const code = (document.getElementById('inv-code')?.value || '').trim();
    if(!code) return showToast("Falta N¬∫", "error");
    const ids = (''+idsStr).split(',').map(s=>s.trim()).filter(Boolean);
    ids.forEach(id => { const a = db.albaranes.find(x=>x.id==id); if(a) a.invoiced = true; });
    db.facturas = db.facturas || [];
    db.facturas.push({ id:generateID(), date:new Date().toISOString().split('T')[0], prov, code, total: Number(total||0), paid:false });
    save("Factura Creada"); closeModal(); renderContabilidad();
}
function togglePaid(fid) { const f = db.facturas.find(x=>x.id==fid); if(f) { f.paid = !f.paid; save(f.paid?"Pagado":"Pendiente"); renderContabilidad(); } }

/* ================= 8. EXTRAS ================= */
function saveZ() {
    const d = {
        date: new Date().toISOString().split('T')[0],
        total: parseFloat(document.getElementById('z-total')?.value) || 0,
        cash: parseFloat(document.getElementById('z-cash')?.value) || 0,
        card: parseFloat(document.getElementById('z-card')?.value) || 0,
        inv: parseFloat(document.getElementById('z-inv')?.value) || 0
    };
    const idx = db.diario.findIndex(x=>x.date===d.date);
    if(idx>=0) db.diario[idx]=d; else db.diario.push(d);
    save("Cierre guardado"); render('Diario');
}
function renderChart(){
    const ctx = document.getElementById('chartZ');
    if(!ctx) return;
    if(chartInstance) chartInstance.destroy();
    const data = (db.diario||[]).slice(-7);
    chartInstance = new Chart(ctx, { type:'bar', data:{ labels:data.map(x=>x.date.substring(5)), datasets:[{label:'Ventas', data:data.map(x=>x.total||0), backgroundColor:'#2563eb', borderRadius:6}]} });
}

/* ================= 9. RECETAS ================= */
function calcRecipe(r, depth = 0) {
    if (depth > MAX_RECIPE_DEPTH) return { mat: 0, mo: 0, total: 0, allergens: [] }; // Prevent infinite recursion
    
    let mat = 0;
    let allergens = new Set();
    
    (r.items || []).forEach(it => {
        // Check if it's an ingredient or a sub-recipe
        const ing = db.ingredientes.find(x => x.id === it.id);
        const subRecipe = db.recetas.find(x => x.id === it.id);
        
        if (ing) {
            // It's an ingredient
            const yieldFactor = (ing.yield && ing.yield > 0) ? ing.yield : 1;
            mat += (Number(it.q) || 0) / yieldFactor * (Number(ing.cost) || 0);
            // Inherit allergens from ingredient
            (ing.aller || []).forEach(a => allergens.add(a));
        } else if (subRecipe) {
            // It's a sub-recipe
            const subCalc = calcRecipe(subRecipe, depth + 1);
            mat += (Number(it.q) || 0) * subCalc.total;
            // Inherit allergens from sub-recipe
            (subCalc.allergens || []).forEach(a => allergens.add(a));
        }
    });
    
    const mo = ((Number(r.time) || 0) / 60) * (Number(CONFIG.COST_HOUR) || 0);
    const total = mat + mo;
    
    return { mat, mo, total, allergens: Array.from(allergens) };
}

// Calculate inverse BOM (from target price to ingredient costs)
function calcInverseBOM(targetPrice, recipe) {
    const current = calcRecipe(recipe);
    if (current.total === 0) return {};
    
    const ratio = targetPrice / current.total;
    const adjustments = {};
    
    (recipe.items || []).forEach(it => {
        const ing = db.ingredientes.find(x => x.id === it.id);
        if (ing) {
            const currentCost = (Number(it.q) || 0) * (Number(ing.cost) || 0);
            adjustments[ing.n] = {
                currentCost,
                targetCost: currentCost * ratio,
                maxPrice: (Number(ing.cost) || 0) * ratio
            };
        }
    });
    
    return adjustments;
}

function viewRecipe(id){
    const r = db.recetas.find(x=>x.id===id);
    if(!r) return;
    const c = calcRecipe(r);
    const margin = (Number(r.pvp) || 0) - (c.total || 0);

    const itemsHtml = (r.items || []).map(it => {
        const i = db.ingredientes.find(x => x.id === it.id);
        const subR = db.recetas.find(x => x.id === it.id);
        
        if (i) {
            const yieldFactor = (i.yield && i.yield > 0) ? i.yield : 1;
            const net = ((Number(it.q) || 0) / yieldFactor) * (Number(i.cost) || 0);
            return `<tr>
                <td>${i.n} <small style="color:var(--sub)">[Ing]</small></td>
                <td style="text-align:right">${it.q}</td>
                <td style="text-align:right">${(Number(i.cost)||0).toFixed(2)}‚Ç¨</td>
                <td style="text-align:right">${net.toFixed(2)}‚Ç¨</td>
            </tr>`;
        } else if (subR) {
            const subCalc = calcRecipe(subR);
            const net = (Number(it.q) || 0) * subCalc.total;
            return `<tr>
                <td>${subR.n} <small style="color:var(--accent)">[Sub-receta]</small></td>
                <td style="text-align:right">${it.q}</td>
                <td style="text-align:right">${subCalc.total.toFixed(2)}‚Ç¨</td>
                <td style="text-align:right">${net.toFixed(2)}‚Ç¨</td>
            </tr>`;
        }
        return '';
    }).join('');
    
    // Allergen display
    const allergenHtml = c.allergens.length > 0 
        ? c.allergens.map(a => {
            const info = ALLERGENS[a];
            return info ? `<span class="allergen-icon active" style="background:${info.color}" title="${info.name}">${info.emoji}</span>` : '';
        }).join('')
        : '<small style="color:var(--sub)">Sin al√©rgenos declarados</small>';

    showModal(r.n, `
        <div class="row">
            <div class="col" style="text-align:center;background:#f8fafc;padding:10px;border-radius:8px"><b>${c.mat.toFixed(2)}‚Ç¨</b><br><small>Materia</small></div>
            <div class="col" style="text-align:center;background:#f8fafc;padding:10px;border-radius:8px"><b>${c.total.toFixed(2)}‚Ç¨</b><br><small>Total</small></div>
            <div class="col" style="text-align:center;color:${margin>0?'#16a34a':'#ef4444'}"><b>${margin.toFixed(2)}‚Ç¨</b><br><small>Mg.</small></div>
        </div>
        
        <h4 style="margin:15px 0 5px 0; font-size:0.8rem; color:var(--sub)">AL√âRGENOS</h4>
        <div style="padding:10px; background:#f8fafc; border-radius:8px; margin-bottom:15px">${allergenHtml}</div>
        
        <h4 style="margin:15px 0 5px 0; font-size:0.8rem; color:var(--sub)">INGREDIENTES</h4>
        <div class="table-wrap" style="margin-top:8px">
            <table style="width:100%; font-size:0.85rem">
                <thead><tr><th>Componente</th><th style="text-align:right">Cant</th><th style="text-align:right">‚Ç¨/ud</th><th style="text-align:right">Subtotal</th></tr></thead>
                <tbody>${itemsHtml}</tbody>
            </table>
        </div>
        <div style="display:flex; gap:8px; margin-top:15px">
            <button class="btn btn-sm btn-ghost" onclick="showAllergenCard('${r.id}')">üè• Ficha Al√©rgenos</button>
            <button class="btn btn-sm btn-ghost" onclick="showInverseBOM('${r.id}')">üí∞ BOM Inverso</button>
            <button class="btn btn-sm btn-accent" onclick="editRecipe('${r.id}')">‚úèÔ∏è Editar</button>
        </div>
    `);
}

function showAllergenCard(recipeId) {
    const r = db.recetas.find(x=>x.id===recipeId);
    if(!r) return;
    const c = calcRecipe(r);
    
    const allergenList = Object.entries(ALLERGENS).map(([key, info]) => {
        const hasIt = c.allergens.includes(key);
        return `<div style="display:flex; justify-content:space-between; padding:12px; background:${hasIt?'#fee2e2':'#f0fdf4'}; margin-bottom:8px; border-radius:8px; border:2px solid ${hasIt?'#dc2626':'#16a34a'}">
            <span><span class="allergen-icon" style="background:${info.color}">${info.emoji}</span> <b>${info.name}</b></span>
            <span style="font-weight:900; font-size:1.2rem">${hasIt?'‚úó':'‚úì'}</span>
        </div>`;
    }).join('');
    
    showModal(`üè• Ficha de Al√©rgenos - ${r.n}`, `
        <div style="text-align:center; margin-bottom:20px; padding:15px; background:var(--accent); color:white; border-radius:8px">
            <h3 style="margin:0">MODO INSPECCI√ìN SANITARIA</h3>
            <p style="margin:5px 0 0 0; opacity:0.9; font-size:0.9rem">Plato: ${r.n}</p>
        </div>
        ${allergenList}
        <button class="btn btn-primary" onclick="closeModal()">Cerrar</button>
    `);
}

function showInverseBOM(recipeId) {
    const r = db.recetas.find(x=>x.id===recipeId);
    if(!r) return;
    
    showModal('üí∞ C√°lculo BOM Inverso', `
        <p style="color:var(--sub); margin-bottom:15px">Introduce el precio objetivo de venta y calcula los costes m√°ximos de ingredientes:</p>
        <label>Precio Objetivo (‚Ç¨)</label>
        <input type="number" id="target-price" value="${r.pvp||0}" step="0.01">
        <button class="btn btn-accent" onclick="calculateInverseBOM('${r.id}')">Calcular</button>
        <div id="inverse-bom-result" style="margin-top:15px"></div>
    `);
}

function calculateInverseBOM(recipeId) {
    const r = db.recetas.find(x=>x.id===recipeId);
    if(!r) return;
    
    const targetPrice = parseFloat(document.getElementById('target-price').value) || 0;
    if(targetPrice <= 0) return showToast("Precio inv√°lido", "error");
    
    const adjustments = calcInverseBOM(targetPrice, r);
    const current = calcRecipe(r);
    
    let html = `<div style="background:#f8fafc; padding:15px; border-radius:8px; margin-bottom:15px">
        <b>Coste Actual:</b> ${current.total.toFixed(2)}‚Ç¨<br>
        <b>Precio Objetivo:</b> ${targetPrice.toFixed(2)}‚Ç¨<br>
        <b>Margen Objetivo:</b> ${(targetPrice - current.total).toFixed(2)}‚Ç¨
    </div>`;
    
    html += '<div class="table-wrap"><table style="font-size:0.85rem"><thead><tr><th>Ingrediente</th><th>Coste Actual</th><th>Coste Objetivo</th><th>Precio M√°x/ud</th></tr></thead><tbody>';
    
    Object.entries(adjustments).forEach(([name, data]) => {
        html += `<tr>
            <td>${name}</td>
            <td>${data.currentCost.toFixed(2)}‚Ç¨</td>
            <td style="color:var(--accent); font-weight:bold">${data.targetCost.toFixed(2)}‚Ç¨</td>
            <td style="color:var(--success); font-weight:bold">${data.maxPrice.toFixed(2)}‚Ç¨</td>
        </tr>`;
    });
    
    html += '</tbody></table></div>';
    document.getElementById('inverse-bom-result').innerHTML = html;
}

function editRecipe(id) {
    const r = id ? db.recetas.find(x=>x.id===id) : {id:generateID(), n:'', cat:'', pvp:0, time:0, items:[]};
    tempItems = JSON.parse(JSON.stringify(r.items || []));
    
    // Create combined list of ingredients and recipes for selection
    const ingredientOptions = (db.ingredientes||[]).map(i=>`<option value="ing_${i.id}">[ING] ${i.n}</option>`).join('');
    const recipeOptions = (db.recetas||[]).filter(rec => rec.id !== r.id).map(rec=>`<option value="rec_${rec.id}">[RECETA] ${rec.n}</option>`).join('');
    
    showModal(id ? "Editar" : "Nueva", `
        <label>Nombre</label><input id="er-n" value="${r.n || ''}">
        <div class="row">
            <div class="col"><label>PVP</label><input id="er-pvp" type="number" value="${r.pvp || 0}"></div>
            <div class="col"><label>Cat</label><input id="er-cat" value="${r.cat || ''}"></div>
            <div class="col"><label>Tiempo (min)</label><input id="er-time" type="number" value="${r.time || 5}"></div>
        </div>
        <label>Componentes (Ingredientes o Sub-recetas)</label>
        <div id="er-list" style="background:#f8fafc;padding:10px;margin-bottom:10px;border-radius:8px;max-height:150px;overflow-y:auto"></div>
        <div class="row" style="align-items:center">
            <select id="er-ing" style="flex:2">
                <optgroup label="Ingredientes">${ingredientOptions}</optgroup>
                <optgroup label="Sub-recetas">${recipeOptions}</optgroup>
            </select>
            <input id="er-q" placeholder="Cant" style="flex:1" type="number">
            <button class="btn btn-sm btn-ghost" onclick="addRecItem()">A√±adir</button>
        </div>
        <button class="btn btn-primary" style="margin-top:10px" onclick="saveRecipe('${r.id}')">Guardar</button>
    `);
    renderRecItems();
}

function renderRecItems(){
    document.getElementById('er-list').innerHTML = (tempItems || []).map((it,i) => {
        const ing = db.ingredientes.find(x=>x.id==it.id);
        const rec = db.recetas.find(x=>x.id==it.id);
        const name = ing ? `${ing.n} [ING]` : (rec ? `${rec.n} [SUB-RECETA]` : 'Desconocido');
        
        return `<div class="list-item" style="padding:8px">
            <span>${name}</span>
            <span style="display:flex;gap:8px;align-items:center">
                <input type="number" value="${it.q}" onchange="tempItems[${i}].q=parseFloat(this.value) || 0; renderRecItems()" style="width:80px;padding:6px" />
                <button onclick="tempItems.splice(${i},1); renderRecItems()" style="background:none;border:none;color:var(--danger);font-weight:bold">‚úï</button>
            </span>
        </div>`;
    }).join('');
}

function addRecItem(){
    const selectedValue = document.getElementById('er-ing').value;
    const q = parseFloat(document.getElementById('er-q').value);
    
    if (!selectedValue) return showToast("Selecciona componente", "error");
    if (!q || q <= 0) return showToast("Cantidad inv√°lida", "error");
    
    // Parse the value to determine if it's an ingredient or recipe
    const [type, id] = selectedValue.split('_');
    
    tempItems.push({ id, q });
    document.getElementById('er-q').value = '';
    renderRecItems();
}

function saveRecipe(id){
    const r = {
        id,
        n: (document.getElementById('er-n')?.value) || 'Sin nombre',
        cat: (document.getElementById('er-cat')?.value) || '',
        pvp: parseFloat(document.getElementById('er-pvp')?.value) || 0,
        time: parseFloat(document.getElementById('er-time')?.value) || 5,
        items: tempItems,
        sales: (db.recetas.find(x=>x.id===id)?.sales) || 0
    };
    const idx = db.recetas.findIndex(x => x.id === id);
    if (idx >= 0) db.recetas[idx] = r; else db.recetas.push(r);
    save("Receta guardada");
    closeModal();
    render('Cocina');
}

/* ================= 10. BACKUP & RESTORE ================= */
function downloadBackup() {
    const a = document.createElement('a');
    const payload = JSON.stringify(db, null, 2);
    a.href = "data:text/json;charset=utf-8," + encodeURIComponent(payload);
    a.download = `arume_backup_${new Date().toISOString().slice(0,19).replace(/[:T]/g, '_')}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    showToast("Backup descargado");
}

function restoreBackup(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const json = JSON.parse(e.target.result);
            if(json.users && json.ingredientes && json.recetas) {
                db = json;
                save("Backup restaurado con √©xito");
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast("Archivo no v√°lido", "error");
            }
        } catch(err) { showToast("Error al leer archivo", "error"); }
    };
    reader.readAsText(file);
}

/* ================= 11. STOCK / MERMAS ================= */
function showModal(t,h){ document.getElementById('m-title').innerText=t; document.getElementById('m-body').innerHTML=h; document.getElementById('modal-overlay').classList.remove('hidden'); }
function closeModal(){ document.getElementById('modal-overlay').classList.add('hidden'); }

function newIng(){ 
    const n=prompt("Nombre:"); 
    if(n){ 
        db.ingredientes.push({
            id:generateID(), 
            n, 
            cost:0, 
            stock:0, 
            min:0, 
            unit:'kg', 
            yield:1, 
            aller:[]
        }); 
        save("Ingrediente creado"); 
        render('Stock'); 
    }
}

function editIng(id){ 
    const i=db.ingredientes.find(x=>x.id==id); 
    if(!i) return showToast("Ingrediente no encontrado", "error");
    
    // Generate allergen checkboxes
    const allergenHtml = Object.entries(ALLERGENS).map(([key, info]) => {
        const checked = (i.aller || []).includes(key) ? 'checked' : '';
        return `<label style="display:inline-flex; align-items:center; margin:5px 10px 5px 0; cursor:pointer">
            <input type="checkbox" value="${key}" ${checked} style="width:auto; margin-right:5px"> 
            <span class="allergen-icon" style="background:${info.color}">${info.emoji}</span>
            <span style="margin-left:5px">${info.name}</span>
        </label>`;
    }).join('');
    
    showModal("Editar Stock", `
        <label>Nombre</label><input id="ei-n" value="${i.n}">
        <div class="row">
            <div class="col"><label>Coste (‚Ç¨/${i.unit||'ud'})</label><input type="number" id="ei-c" value="${i.cost}"></div>
            <div class="col"><label>Stock Actual</label><input type="number" id="ei-s" value="${i.stock}"></div>
        </div>
        <div class="row">
            <div class="col"><label>Stock M√≠nimo</label><input type="number" id="ei-m" value="${i.min}"></div>
            <div class="col"><label>Rendimiento</label><input type="number" id="ei-y" value="${i.yield}" step="0.01"></div>
        </div>
        <label>Al√©rgenos</label>
        <div id="ei-aller" style="background:#f8fafc; padding:10px; border-radius:8px; margin-bottom:10px">
            ${allergenHtml}
        </div>
        <div style="text-align:right;margin-top:10px">
            <button class="btn btn-primary" onclick="saveIng('${i.id}')">Guardar</button>
        </div>
    `);
}

function saveIng(id){
    const i=db.ingredientes.find(x=>x.id==id);
    if(!i) return;
    
    i.n = document.getElementById('ei-n').value;
    i.cost = parseFloat(document.getElementById('ei-c').value) || 0;
    i.stock = parseFloat(document.getElementById('ei-s').value) || 0;
    i.min = parseFloat(document.getElementById('ei-m').value) || 0;
    i.yield = parseFloat(document.getElementById('ei-y').value) || 1;
    
    // Get selected allergens
    const checkboxes = document.querySelectorAll('#ei-aller input[type="checkbox"]:checked');
    i.aller = Array.from(checkboxes).map(cb => cb.value);
    
    save("Ingrediente actualizado"); 
    closeModal(); 
    render('Stock');
}

function renderShoppingList(){
    const toBuy = (db.ingredientes||[]).filter(i => (i.stock || 0) < (i.min || 0));
    if(toBuy.length === 0) return showToast("Stock OK (Nada que comprar)");
    
    let txt = "üõí LISTA DE COMPRA ARUME:\n\n";
    toBuy.forEach(i => {
        const needed = (i.min || 0) - (i.stock || 0);
        txt += `- ${i.n}: Pedir ${needed.toFixed(2)} ${i.unit || 'ud'} (Stock: ${i.stock} / Min: ${i.min})\n`;
    });
    txt += "\n--\nGenerado autom√°ticamente por ARUME V60";
    
    // Escape text for safe HTML interpolation
    const escapedText = txt.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    const encodedForWhatsApp = encodeURIComponent(txt);
    
    // Show modal with WhatsApp button
    showModal("üõí Lista de Compra", `
        <textarea readonly style="min-height:200px; font-family:monospace">${escapedText}</textarea>
        <div style="display:flex; gap:8px; margin-top:10px">
            <button class="btn btn-accent" onclick="copyToClipboard(${JSON.stringify(txt)})">üìã Copiar</button>
            <button class="btn btn-primary" onclick="sendWhatsApp('${encodedForWhatsApp}')">üì± WhatsApp</button>
        </div>
    `);
}

function copyToClipboard(text) {
    try { 
        navigator.clipboard.writeText(text); 
        showToast("Copiado al portapapeles"); 
    } catch(e) { 
        showToast("Error al copiar", "error"); 
    }
}

function sendWhatsApp(encodedText) {
    // Open WhatsApp with pre-filled message
    const url = `https://wa.me/?text=${encodedText}`;
    window.open(url, '_blank');
    showToast("Abriendo WhatsApp...");
}

function modalMerma(){ 
    const html=`<select id="m-ing">${(db.ingredientes||[]).map(i=>`<option value="${i.id}">${i.n}</option>`).join('')}</select><input id="m-q" placeholder="Cantidad perdida" type="number"><button class="btn btn-danger" onclick="saveMerma()">Registrar</button>`;
    showModal("Merma", html);
}

function saveMerma(){
    const id=document.getElementById('m-ing').value, q=parseFloat(document.getElementById('m-q').value);
    const i=db.ingredientes.find(x=>x.id==id);
    if(i && q && q>0){ 
        i.stock-=q; 
        db.mermas.push({date:new Date().toISOString(), n:i.n, q}); 
        save("Merma registrada"); 
        closeModal(); 
        render('Stock'); 
    } else showToast("Valores inv√°lidos", "error");
}

function toggleBlindMode() {
    blindMode = !blindMode;
    const stockList = document.querySelector('.card');
    if (blindMode) {
        stockList?.classList.add('blind-mode');
        showToast("Modo Inventario Ciego ACTIVADO");
    } else {
        stockList?.classList.remove('blind-mode');
        showToast("Modo Normal");
    }
    render('Stock');
}

/* ================= 12. INGENIER√çA DE MEN√ö ================= */
function renderEngineering() {
    const prices = (db.recetas||[]).map(r => r.pvp).filter(p => p > 0).sort((a,b)=>a-b);
    const minP = prices[0] || 0;
    const maxP = prices[prices.length-1] || 0;
    const omnesAlert = (minP > 0 && maxP/minP > 3) ? "‚ö†Ô∏è Rango > 3 (Revisar precios)" : "‚úÖ Rango Precios OK";

    let totalSales = 0;
    (db.recetas||[]).forEach(r => totalSales += (r.sales||0));
    let stars=0, plows=0, puzzles=0, dogs=0;
    const avgPop = totalSales > 0 ? (100 / (db.recetas||[]).length) * 0.7 : 0; 

    (db.recetas||[]).forEach(r => {
        const c = calcRecipe(r);
        const margin = (r.pvp || 0) - (c.total || 0);
        const pop = totalSales > 0 ? ((r.sales || 0) / totalSales) * 100 : 0;
        if(pop >= avgPop && margin >= 6) stars++;
        else if(pop >= avgPop && margin < 6) plows++;
        else if(pop < avgPop && margin >= 6) puzzles++;
        else dogs++;
    });
    
    // Calculate total wastage value
    const totalWastage = (db.mermas || []).reduce((acc, m) => {
        const ing = db.ingredientes.find(i => i.n === m.n);
        return acc + (m.q * (ing?.cost || 0));
    }, 0);
    
    // Calculate total sales value from diario
    const totalDiarioSales = (db.diario || []).reduce((acc, d) => acc + (d.total || 0), 0);

    document.getElementById('admin-panel').innerHTML = `
    <div class="card">
        <div class="section-header"><div class="title">OMNES (AMPLITUD PRECIOS)</div></div>
        <div class="row">
            <div class="col" style="text-align:center; background:#f1f5f9; padding:10px; border-radius:8px">Min <b>${minP.toFixed(2)}‚Ç¨</b></div>
            <div class="col" style="text-align:center; background:#f1f5f9; padding:10px; border-radius:8px">Max <b>${maxP.toFixed(2)}‚Ç¨</b></div>
        </div>
        <div style="text-align:center; margin-top:10px; font-weight:bold">${omnesAlert}</div>
    </div>
    <div class="card">
        <div class="section-header"><div class="title">MATRIZ BCG</div></div>
        <div class="matrix-grid">
            <div class="matrix-box" style="background:#dcfce7"><div style="font-size:1.5rem; font-weight:900">${stars}</div><div style="font-size:0.7rem; color:var(--sub)">‚≠ê Estrellas</div></div>
            <div class="matrix-box" style="background:#dbeafe"><div style="font-size:1.5rem; font-weight:900">${plows}</div><div style="font-size:0.7rem; color:var(--sub)">üê¥ Caballos</div></div>
            <div class="matrix-box" style="background:#fef3c7"><div style="font-size:1.5rem; font-weight:900">${puzzles}</div><div style="font-size:0.7rem; color:var(--sub)">üß© Puzzles</div></div>
            <div class="matrix-box" style="background:#fee2e2"><div style="font-size:1.5rem; font-weight:900">${dogs}</div><div style="font-size:0.7rem; color:var(--sub)">üêï Perros</div></div>
        </div>
        <button class="btn btn-accent" style="width:100%;margin-top:15px" onclick="editSales()">üìù Introducir Ventas (TPV)</button>
    </div>
    <div class="card">
        <div class="section-header"><div class="title">VENTAS VS MERMAS</div></div>
        <div class="row">
            <div class="col" style="text-align:center; background:#dcfce7; padding:15px; border-radius:8px">
                <div style="font-size:1.5rem; font-weight:900; color:#16a34a">${totalDiarioSales.toFixed(2)}‚Ç¨</div>
                <div style="font-size:0.7rem; color:var(--sub)">VENTAS TOTALES</div>
            </div>
            <div class="col" style="text-align:center; background:#fee2e2; padding:15px; border-radius:8px">
                <div style="font-size:1.5rem; font-weight:900; color:#dc2626">${totalWastage.toFixed(2)}‚Ç¨</div>
                <div style="font-size:0.7rem; color:var(--sub)">MERMAS TOTALES</div>
            </div>
        </div>
        <canvas id="chartSalesWastage" style="max-height:200px; margin-top:15px"></canvas>
    </div>`;
    
    setTimeout(renderSalesWastageChart, 100);
}

function renderSalesWastageChart() {
    const ctx = document.getElementById('chartSalesWastage');
    if(!ctx) return;
    
    if(chartInstance) chartInstance.destroy();
    
    // Get last 7 days of sales
    const last7Days = (db.diario || []).slice(-7);
    const labels = last7Days.map(d => d.date.substring(5));
    const salesData = last7Days.map(d => d.total || 0);
    
    // Calculate wastage per day (approximate distribution)
    const wastagePerDay = (db.mermas || []).reduce((acc, m) => {
        const date = m.date.substring(0, 10);
        const ing = db.ingredientes.find(i => i.n === m.n);
        const value = m.q * (ing?.cost || 0);
        acc[date] = (acc[date] || 0) + value;
        return acc;
    }, {});
    
    const wastageData = last7Days.map(d => wastagePerDay[d.date] || 0);
    
    chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [
                {
                    label: 'Ventas',
                    data: salesData,
                    backgroundColor: '#16a34a',
                    borderRadius: 6
                },
                {
                    label: 'Mermas',
                    data: wastageData,
                    backgroundColor: '#dc2626',
                    borderRadius: 6
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function editSales() {
    const html = `<div style="max-height:60vh;overflow-y:auto">
        <p style="color:var(--sub);font-size:0.8rem;margin-bottom:15px">Ventas periodo (unidades):</p>
        ${(db.recetas||[]).map(r => `
            <div class="list-item">
                <span>${r.n}</span>
                <input type="number" style="width:90px;margin:0;padding:10px;text-align:right" value="${r.sales||0}" onchange="updateSale('${r.id}', this.value)">
            </div>
        `).join('')}
    </div>`;
    showModal("Actualizar Ventas", html);
}
function updateSale(rid, val) { const r = db.recetas.find(x => x.id === rid); if(r) { r.sales = parseFloat(val)||0; save(); } }

/* ================= 13. PRICE HISTORY & EXCEL EXPORT ================= */
function viewPriceHistory() {
    if (!db.priceHistory || db.priceHistory.length === 0) {
        return showToast("No hay hist√≥rico de precios a√∫n");
    }
    
    const history = db.priceHistory.slice().reverse().slice(0, 50); // Last 50 changes
    
    const historyHtml = history.map(h => {
        const changeColor = h.changePercent > 10 ? 'red' : (h.changePercent > 5 ? '#f59e0b' : '#16a34a');
        return `<tr>
            <td>${h.date.substring(5)}</td>
            <td>${h.ingredientName}</td>
            <td>${h.provider}</td>
            <td>${h.oldPrice.toFixed(2)}‚Ç¨</td>
            <td>${h.newPrice.toFixed(2)}‚Ç¨</td>
            <td style="color:${changeColor}; font-weight:bold">${h.changePercent > 0 ? '+' : ''}${h.changePercent.toFixed(1)}%</td>
        </tr>`;
    }).join('');
    
    showModal('üìà Hist√≥rico de Cambios de Precio', `
        <p style="color:var(--sub); margin-bottom:15px">√öltimos 50 cambios detectados en recepciones de mercanc√≠a:</p>
        <div class="table-wrap" style="max-height:400px; overflow-y:auto">
            <table style="font-size:0.8rem">
                <thead>
                    <tr><th>Fecha</th><th>Ingrediente</th><th>Proveedor</th><th>Precio Ant.</th><th>Precio Nuevo</th><th>Cambio</th></tr>
                </thead>
                <tbody>${historyHtml}</tbody>
            </table>
        </div>
    `);
}

function exportToExcel() {
    if (typeof XLSX === 'undefined') {
        return showToast("Error: SheetJS library not loaded. Check internet connection or CDN availability.", "error");
    }
    
    // Create workbook
    const wb = XLSX.utils.book_new();
    
    // Sheet 1: Ingredientes
    const ingredientesData = [
        ['Nombre', 'Stock', 'Coste', 'M√≠nimo', 'Unidad', 'Rendimiento', 'Al√©rgenos'],
        ...(db.ingredientes || []).map(i => [
            i.n,
            i.stock || 0,
            i.cost || 0,
            i.min || 0,
            i.unit || 'ud',
            i.yield || 1,
            (i.aller || []).map(a => ALLERGENS[a]?.name || a).join(', ')
        ])
    ];
    const ws1 = XLSX.utils.aoa_to_sheet(ingredientesData);
    XLSX.utils.book_append_sheet(wb, ws1, 'Ingredientes');
    
    // Sheet 2: Recetas
    const recetasData = [
        ['Nombre', 'Categor√≠a', 'PVP', 'Coste', 'Margen', 'Ventas'],
        ...(db.recetas || []).map(r => {
            const calc = calcRecipe(r);
            return [
                r.n,
                r.cat || '',
                r.pvp || 0,
                calc.total.toFixed(2),
                (r.pvp - calc.total).toFixed(2),
                r.sales || 0
            ];
        })
    ];
    const ws2 = XLSX.utils.aoa_to_sheet(recetasData);
    XLSX.utils.book_append_sheet(wb, ws2, 'Recetas');
    
    // Sheet 3: Hist√≥rico Precios
    if (db.priceHistory && db.priceHistory.length > 0) {
        const priceHistoryData = [
            ['Fecha', 'Ingrediente', 'Proveedor', 'Precio Anterior', 'Precio Nuevo', 'Cambio %'],
            ...(db.priceHistory || []).map(h => [
                h.date,
                h.ingredientName,
                h.provider,
                h.oldPrice.toFixed(2),
                h.newPrice.toFixed(2),
                h.changePercent.toFixed(2)
            ])
        ];
        const ws3 = XLSX.utils.aoa_to_sheet(priceHistoryData);
        XLSX.utils.book_append_sheet(wb, ws3, 'Hist√≥rico Precios');
    }
    
    // Sheet 4: Albaranes
    const albaranesData = [
        ['Fecha', 'Proveedor', 'Total', 'Facturado', 'Nota'],
        ...(db.albaranes || []).map(a => [
            a.date,
            a.prov,
            a.total.toFixed(2),
            a.invoiced ? 'S√ç' : 'NO',
            a.note || ''
        ])
    ];
    const ws4 = XLSX.utils.aoa_to_sheet(albaranesData);
    XLSX.utils.book_append_sheet(wb, ws4, 'Albaranes');
    
    // Sheet 5: Diario
    const diarioData = [
        ['Fecha', 'Total Z', 'Efectivo', 'Tarjeta', 'Invitaciones'],
        ...(db.diario || []).map(d => [
            d.date,
            d.total || 0,
            d.cash || 0,
            d.card || 0,
            d.inv || 0
        ])
    ];
    const ws5 = XLSX.utils.aoa_to_sheet(diarioData);
    XLSX.utils.book_append_sheet(wb, ws5, 'Diario');
    
    // Generate and download
    const fileName = `ARUME_Export_${new Date().toISOString().slice(0,10)}.xlsx`;
    XLSX.writeFile(wb, fileName);
    showToast("Excel exportado correctamente");
}

init();
</script>
</body>
</html>
